<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Auto-Recovery Pilot</title>
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=84b62e85ed3ec32fca558717eda26006&libraries=services"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
        }

        #status {
            font-weight: bold;
            margin-bottom: 20px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 4px;
        }

        #results {
            width: 100%;
            height: 300px;
            font-family: monospace;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #map {
            width: 100%;
            height: 300px;
            margin-top: 20px;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üõ†Ô∏è Auto-Recovery Pilot (Top 10)</h1>
        <div id="status">Ready to start...</div>

        <button id="startBtn" class="btn" onclick="startRecovery()">Start Auto-Recovery</button>
        <button id="copyBtn" class="btn" onclick="copyResults()" style="background:#4CAF50; display:none;">Copy
            JSON</button>

        <textarea id="results" readonly></textarea>
        <div id="map"></div>
    </div>

    <script>
        // Pilot List generated by Python
        const targets = [
    {
        "n": "Ìô©Í∏àÎ≥µÍ∂åÎ∞©",
        "a": "Î∂ÄÏÇ∞ Î∂ÄÏÇ∞ÏßÑÍµ¨ Í∞ÄÏïºÎåÄÎ°ú 613",
        "lat": 35.1554783619337,
        "lng": 129.039157640643,
        "status": "VERIFIED_READY"
    },
    {
        "n": "Î≥µÍ∂åÎ™ÖÎãπ",
        "a": "ÎåÄÍµ¨ ÏàòÏÑ±Íµ¨ Îì§ÏïàÎ°ú 243",
        "lat": 35.8517462942895,
        "lng": 128.616648593278,
        "status": "VERIFIED_READY"
    },
    {
        "n": "Í∞ÄÌåêÏ†ê(2Ìò∏ÏÑ†)",
        "a": "ÏÑúÏö∏ Íµ¨Î°úÍµ¨ ÏÉàÎßêÎ°ú 117-24",
        "lat": 37.5078567262654,
        "lng": 126.891886432046,
        "status": "VERIFIED_READY"
    },
    {
        "n": "Î™©ÌôîÌú¥Í≤åÏÜå",
        "a": "Í≤ΩÎÇ® ÏÇ¨Ï≤úÏãú ÏÇ¨Ï≤úÎåÄÎ°ú 912",
        "lat": 35.0017600909728,
        "lng": 128.054209521477,
        "status": "VERIFIED_READY"
    },
    {
        "n": "Î≥µÍ∂åÌåêÎß§Ï†ê",
        "a": "Ï†ÑÎÇ® Íµ¨Î°ÄÍµ∞ Íµ¨Î°ÄÏùç Î¥âÏÑ±Î°ú 18",
        "lat": 35.2038150954151,
        "lng": 127.464498465473,
        "status": "VERIFIED_READY"
    }
];

        let map, rvClient;
        let finalResults = [];

        window.onload = function () {
            const container = document.getElementById('map');
            const options = { center: new kakao.maps.LatLng(37.566826, 126.9786567), level: 3 };
            map = new kakao.maps.Map(container, options);
            rvClient = new kakao.maps.RoadviewClient();
        };

        async function startRecovery() {
            document.getElementById('startBtn').disabled = true;
            finalResults = [];

            for (let i = 0; i < targets.length; i++) {
                const shop = targets[i];
                updateStatus(`Processing ${i + 1}/${targets.length}: ${shop.n}...`);

                try {
                    const result = await processShop(shop);
                    if (result) {
                        finalResults.push(result);
                        logResult(result);
                    } else {
                        logError(shop);
                    }
                } catch (e) {
                    console.error(e);
                    logError(shop);
                }

                // Small delay to be safe
                await new Promise(r => setTimeout(r, 500));
            }

            updateStatus("Completed! Copy the JSON above.");
            document.getElementById('copyBtn').style.display = 'inline-block';
            document.getElementById('results').value = JSON.stringify(finalResults, null, 2);
        }

        function processShop(shop) {
            return new Promise((resolve) => {
                const position = new kakao.maps.LatLng(shop.lat, shop.lng);
                map.setCenter(position); // Visual feedback

                rvClient.getNearestPanoId(position, 300, function (panoId) {
                    if (panoId) {
                        // We need the Pano location to compute angle
                        // But getNearestPanoId only gives ID. 
                        // We need to set it on a hidden Roadview to get metadata? 
                        // No, we can use `getNearesetPanoId` logic or assumes minimal distance.

                        // BUT `RoadviewClient` has `getNearestPanoId`... does it give coords?
                        // The callback receives `panoId`.

                        // We need to use `Roadview` object to get coordinates of the panoId?
                        // Let's assume for this "Blind Pilot", we just get the ID.
                        // The ANGLE is hard to compute without Pano lat/lng.

                        // Workaround: We will restore with Default Angle (0) or try to find it.
                        // Wait, `getNearestPanoId` callback only gives ID.
                        // However, usually the nearest pano is "facing" the road.
                        // Let's just capture the ID for now. Angle can be manual adjusted if needed.

                        // Better: We can try to use `getNearestPanoId` with standard radius.

                        resolve({
                            name: shop.n,
                            addr: shop.a,
                            panoid: panoId, // Keep as string or int
                            pov: { pan: 0, tilt: 0, zoom: 0 },
                            // Note: We set pan to 0 (North). User can adjust.
                            // This is still 100x better than nothing.
                            lat: shop.lat,
                            lng: shop.lng
                        });
                    } else {
                        resolve(null);
                    }
                });
            });
        }

        function updateStatus(msg) {
            document.getElementById('status').innerText = msg;
        }

        function logResult(obj) {
            const ta = document.getElementById('results');
            ta.value += `[SUCCESS] ${obj.name} -> ID: ${obj.panoid}\n`;
            ta.scrollTop = ta.scrollHeight;
        }

        function logError(shop) {
            const ta = document.getElementById('results');
            ta.value += `[FAILED] ${shop.n} (No Pano nearby)\n`;
            ta.scrollTop = ta.scrollHeight;
        }

        function copyResults() {
            const ta = document.getElementById('results');
            ta.select();
            document.execCommand('copy');
            alert("Copied JSON to clipboard!");
        }
    </script>
</body>

</html>