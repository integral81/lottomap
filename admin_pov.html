<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotto POV Admin - ìˆ˜ê¸° ë“±ë¡ ë„êµ¬</title>
    <script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a6b27b6dab16c7e3459bb9589bf1269d&libraries=services,roadview"></script>
    <script src="admin_targets.js"></script>
    <style>
        :root {
            --primary: #d32f2f;
            --sidebar-width: 350px;
            --header-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f0f2f5;
        }

        header {
            height: var(--header-height);
            background: #333;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        header h1 {
            font-size: 18px;
        }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
        }

        .shop-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .shop-item:hover {
            background: #f5f5f5;
        }

        .shop-item.active {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .shop-name {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .shop-addr {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .addr-copy-btn {
            border: 1px solid #2196f3;
            background: #e3f2fd;
            cursor: pointer;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 3px;
            color: #1976d2;
        }

        .win-count {
            display: inline-block;
            background: var(--primary);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 4px;
        }

        #content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #viewer-container {
            flex: 1;
            display: flex;
            gap: 10px;
            padding: 10px;
            min-height: 0;
        }

        #map,
        #roadview {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        #roadview {
            flex: 2;
        }

        #control-panel {
            height: 350px;
            background: white;
            border-top: 1px solid #ddd;
            padding: 15px;
            display: flex;
            gap: 20px;
        }

        .control-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group h3 {
            font-size: 14px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        #stack-area {
            flex: 1;
            background: #222;
            color: #ccc;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .btn-update {
            padding: 10px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <header>
        <h1>ğŸ° POV ê´€ë¦¬ (Simple Mode)</h1>
    </header>
    <main>
        <div id="sidebar">
            <div
                style="padding: 10px; font-size: 13px; font-weight: bold; color: #333; border-bottom: 2px solid #333; margin-bottom: 10px;">
                ëŒ€ìƒ ë¦¬ìŠ¤íŠ¸ (<span id="missing-count">0</span>)
            </div>
            <div id="shop-list"></div>
        </div>
        <div id="content">
            <div id="viewer-container">
                <div id="map"></div>
                <div id="roadview"></div>
            </div>
            <div id="control-panel">
                <div class="control-group">
                    <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                        <h3 style="color:#d32f2f;">1. í˜„ì¬ ì½”ë“œ (í•œ ì¤„)</h3>
                        <span style="font-size:11px; color:#999;">í™”ë©´ì„ ì›€ì§ì´ë©´ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤</span>
                    </div>
                    <div id="current-code-area"
                        style="background:#222; color:#00ff00; padding:12px; border-radius:6px; font-family:monospace; font-size:12px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                        <span id="current-code-text">// ìƒì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>
                    </div>

                    <button class="btn-update" onclick="markAsRegistered()"
                        style="font-size:16px; padding:15px; margin: 10px 0; background:#1976d2;">
                        â¬‡ï¸ ì•„ë˜ ë¦¬ìŠ¤íŠ¸ë¡œ ì¶”ê°€ (ëˆ„ì )
                    </button>

                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="color:#333;">2. ëˆ„ì  ë¦¬ìŠ¤íŠ¸ (<span id="stack-count">0</span>ê°œ)</h3>
                        <div style="display:flex; gap:8px;">
                            <button onclick="copyStack()"
                                style="background:#4caf50; color:white; border:none; padding:8px 16px; border-radius:4px; font-weight:bold; cursor:pointer;">ğŸ“‹
                                ê²°ê³¼ ì „ì²´ ë³µì‚¬</button>
                            <button onclick="clearStack()"
                                style="background:#999; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">ğŸ§¹
                                ë¹„ìš°ê¸°</button>
                        </div>
                    </div>
                    <div id="stack-area" style="flex:1; background:#1e1e1e; border:2px solid #333;">
                        <pre id="stack-output" style="margin:0; padding:5px; color:#eee;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        let map, rv, rvClient, marker;
        let currentShop = null;
        let accumulatedCodes = JSON.parse(localStorage.getItem('pov_accumulated_codes') || '[]');
        let registeredKeys = JSON.parse(localStorage.getItem('pov_registered_shops') || '[]');
        let allMissingShops = [];

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            try {
                const mapContainer = document.getElementById('map');
                map = new kakao.maps.Map(mapContainer, { center: new kakao.maps.LatLng(37.4815, 127.0145), level: 3 });
                rv = new kakao.maps.Roadview(document.getElementById('roadview'));
                rvClient = new kakao.maps.RoadviewClient();
                marker = new kakao.maps.Marker({ position: map.getCenter(), map: map, draggable: true });

                kakao.maps.event.addListener(rv, 'init', updatePOVUI);
                kakao.maps.event.addListener(rv, 'viewpoint_changed', updatePOVUI);
                kakao.maps.event.addListener(marker, 'dragend', () => loadRoadview(marker.getPosition().getLat(), marker.getPosition().getLng()));

                if (window.allMissingShops && window.allMissingShops.length > 0) {
                    allMissingShops = window.allMissingShops;
                } else {
                    console.error("No data found in window.allMissingShops");
                }

                renderShopList();
                updateCodeOutput();
            } catch (e) {
                console.error(e);
                alert('ì´ˆê¸°í™” ì¤‘ ì—ëŸ¬ ë°œìƒ: ' + e.message);
            }
        }

        function renderShopList() {
            const filteredList = allMissingShops.filter(s => !registeredKeys.includes(`${s.name}|${s.address}`));
            document.getElementById('missing-count').innerText = filteredList.length;
            const container = document.getElementById('shop-list');
            container.innerHTML = '';
            filteredList.forEach(shop => {
                const div = document.createElement('div');
                div.className = 'shop-item' + (currentShop?.name === shop.name && currentShop?.address === shop.address ? ' active' : '');
                div.onclick = () => selectShop(shop, div);
                div.innerHTML = `
                    <div class="shop-name">${shop.name}</div>
                    <div class="shop-addr">
                        <span>${shop.address}</span>
                        <button class="addr-copy-btn" onclick="event.stopPropagation(); copyToClipboard('${shop.address}')">ë³µì‚¬</button>
                    </div>
                    <div class="win-count">${shop.wins}íšŒ ë‹¹ì²¨</div>
                `;
                container.appendChild(div);
            });
        }

        function selectShop(shop, el) {
            document.querySelectorAll('.shop-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            currentShop = shop;
            const pos = new kakao.maps.LatLng(shop.lat, shop.lng);
            map.setCenter(pos);
            marker.setPosition(pos);
            loadRoadview(shop.lat, shop.lng);
        }

        function loadRoadview(lat, lng) {
            const pos = new kakao.maps.LatLng(lat, lng);
            rvClient.getNearestPanoId(pos, 100, (id) => {
                if (id) rv.setPanoId(id, pos);
                else alert('ë¡œë“œë·° ë¶ˆê°€');
            });
        }

        function updatePOVUI() { updateCodeOutput(); }

        function updateCodeOutput() {
            if (currentShop && rv.getPanoId()) {
                const vp = rv.getViewpoint();
                const code = `{ name: "${currentShop.name}", addr: "${currentShop.address.split(' ').slice(0, 3).join(' ')}", panoid: ${rv.getPanoId()}, pov: { pan: ${vp.pan.toFixed(2)}, tilt: ${vp.tilt.toFixed(2)}, zoom: ${Math.floor(vp.zoom)} } },`;
                document.getElementById('current-code-text').textContent = code;
            }
            document.getElementById('stack-output').textContent = accumulatedCodes.join('\n');
            document.getElementById('stack-count').innerText = accumulatedCodes.length;
            const sa = document.getElementById('stack-area');
            sa.scrollTop = sa.scrollHeight;
        }

        function markAsRegistered() {
            if (!currentShop || !rv.getPanoId()) return;
            const code = document.getElementById('current-code-text').textContent;
            if (!accumulatedCodes.includes(code)) accumulatedCodes.push(code);
            localStorage.setItem('pov_accumulated_codes', JSON.stringify(accumulatedCodes));
            const key = `${currentShop.name}|${currentShop.address}`;
            if (!registeredKeys.includes(key)) registeredKeys.push(key);
            localStorage.setItem('pov_registered_shops', JSON.stringify(registeredKeys));
            showToast('ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
            renderShopList();
            updateCodeOutput();
        }

        function copyStack() {
            navigator.clipboard.writeText(accumulatedCodes.join('\n')).then(() => showToast('ë³µì‚¬ ì™„ë£Œ'));
        }

        function clearStack() {
            if (confirm('ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                accumulatedCodes = [];
                localStorage.setItem('pov_accumulated_codes', '[]');
                updateCodeOutput();
            }
        }

        function resetRegistered() {
            if (confirm('ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('pov_registered_shops');
                registeredKeys = [];
                renderShopList();
            }
        }

        function copyToClipboard(t) {
            navigator.clipboard.writeText(t).then(() => showToast('ë³µì‚¬ë¨'));
        }

        function showToast(m) {
            const t = document.createElement('div');
            t.innerText = m;
            t.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; z-index: 9999;';
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 1500);
        }
    </script>
</body>

</html>