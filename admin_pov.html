<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotto POV Admin - ìˆ˜ê¸° ë“±ë¡ ë„êµ¬</title>
    <script>
        function handleSDKError() {
            console.error('Kakao Maps SDK Load Failed');
            alert('ì¹´ì¹´ì˜¤ ì§€ë„ SDKë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²° ë° ë„ë©”ì¸ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            // Even if SDK fails, try to render the list
            if (typeof renderShopList === 'function') renderShopList();
        }
    </script>
    <script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a6b27b6dab16c7e3459bb9589bf1269d&libraries=services,roadview"
        onerror="handleSDKError()"></script>
    <style>
        :root {
            --primary: #d32f2f;
            --sidebar-width: 350px;
            --header-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f0f2f5;
        }

        header {
            height: var(--header-height);
            background: #333;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        header h1 {
            font-size: 18px;
        }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
        }

        .shop-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .shop-item:hover {
            background: #f5f5f5;
        }

        .shop-item.active {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .shop-name {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .shop-addr {
            font-size: 12px;
            color: #666;
        }

        .win-count {
            display: inline-block;
            background: var(--primary);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 4px;
        }

        #content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #viewer-container {
            flex: 1;
            display: flex;
            gap: 10px;
            padding: 10px;
        }

        #map {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        #roadview {
            flex: 2;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        #control-panel {
            height: 250px;
            background: white;
            border-top: 1px solid #ddd;
            padding: 15px;
            display: flex;
            gap: 20px;
        }

        .control-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group h3 {
            font-size: 14px;
            margin-bottom: 5px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .input-row label {
            width: 60px;
            color: #555;
        }

        .input-row input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #result-area {
            flex: 1.5;
            background: #2d2d2d;
            color: #a9dc76;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            position: relative;
            overflow-y: auto;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 12px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background: #45a049;
        }

        .btn-update {
            padding: 8px 16px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
        }

        .btn-update:hover {
            background: #1976d2;
        }
    </style>
</head>

<body>
    <header>
        <h1>ğŸ° POV ê´€ë¦¬ ì–´ë“œë¯¼ (Admin Template)</h1>
        <div>
            <span id="status-text" style="font-size: 13px; opacity: 0.8;">ëŒ€ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
        </div>
    </header>

    <main>
        <div id="sidebar">
            <div
                style="padding: 10px; font-size: 13px; font-weight: bold; color: #333; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                POI ëˆ„ë½ ë¦¬ìŠ¤íŠ¸ (<span id="missing-count">0</span>)
            </div>
            <div id="shop-list"></div>
        </div>

        <div id="content">
            <div id="viewer-container">
                <div id="map"></div>
                <div id="roadview"></div>
            </div>

            <div id="control-panel">
                <div class="control-group">
                    <h3>POV ì‹¤ì‹œê°„ ì¢Œí‘œ</h3>
                    <div class="input-row">
                        <label>Lat</label>
                        <input type="text" id="cur-lat" readonly>
                    </div>
                    <div class="input-row">
                        <label>Lng</label>
                        <input type="text" id="cur-lng" readonly>
                    </div>
                    <button class="btn-update" onclick="syncMapToRV()">ë¡œë“œë·° ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™</button>
                </div>

                <div class="control-group">
                    <h3>POV íŒŒë¼ë¯¸í„°</h3>
                    <div class="input-row">
                        <label>PanoID</label>
                        <input type="text" id="rv-pano" readonly>
                    </div>
                    <div class="input-row">
                        <label>Pan</label>
                        <input type="text" id="rv-pan">
                    </div>
                    <div class="input-row">
                        <label>Tilt</label>
                        <input type="text" id="rv-tilt">
                    </div>
                    <div class="input-row">
                        <label>Zoom</label>
                        <input type="text" id="rv-zoom">
                    </div>
                </div>

                <div class="control-group" style="flex: 1.5;">
                    <h3>ë“±ë¡ ì½”ë“œ ìƒì„±</h3>
                    <div id="result-area">
                        <button class="copy-btn" onclick="copyCode()">ë³µì‚¬</button>
                        <pre id="code-output">// ìƒì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</pre>
                    </div>
                    <!-- New Button for marking as registered -->
                    <button class="btn-update" style="margin-top:10px; background: #4caf50; width: 100%;"
                        onclick="markAsRegistered()">ì´ ìƒì  ë“±ë¡ ì™„ë£Œ (ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°)</button>
                    <button onclick="resetRegistered()"
                        style="margin-top:10px; font-size:11px; background:none; border:none; color:#999; text-decoration:underline; cursor:pointer;">ë“±ë¡
                        ì™„ë£Œ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        let map, rv, rvClient, marker;
        let currentShop = null;
        let allMissingShops = [
            {
                "name": "ì„¸ì§„ì „ìí†µì‹ ",
                "address": "ëŒ€êµ¬ ì„œêµ¬ í‰ë¦¬ë™ 1094-4",
                "wins": 16,
                "lat": 35.8718884870855,
                "lng": 128.555196544539,
                "has_coords": true
            },
            {
                "name": "ì˜¤ì¼€ì´ìƒì‚¬",
                "address": "ì„œìš¸ ì„œì´ˆêµ¬ ì‹ ë°˜í¬ë¡œ 176 ì„¼íŠ¸ëŸ´ì‹œí‹°ë‚´100í˜¸ë§¤ì ",
                "wins": 8,
                "lat": 37.5039351769908,
                "lng": 127.002413006799,
                "has_coords": true
            },
            {
                "name": "ë³µê¶Œë°±í™”ì ",
                "address": "ê²½ê¸° íŒŒì£¼ì‹œ ê¸ˆì´Œ2ë™ 329-135",
                "wins": 7,
                "lat": 37.3984223865984,
                "lng": 126.726256461664,
                "has_coords": true
            },
            {
                "name": "ì ì‹¤ë§¤ì ",
                "address": "ì„œìš¸ ì†¡íŒŒêµ¬ ì‹ ì²œë™ 7-18ë²ˆì§€ ì ì‹¤ì—­ 8ë²ˆì¶œêµ¬ ì• ê°€íŒ",
                "wins": 7,
                "lat": 37.5144542739603,
                "lng": 127.1007349885,
                "has_coords": true
            },
            {
                "name": "ëª©í™”íœ´ê²Œì†Œ",
                "address": "ê²½ë‚¨ ì‚¬ì²œì‹œ ì‚¬ì²œëŒ€ë¡œ 912",
                "wins": 6,
                "lat": 35.0017600909728,
                "lng": 128.054209521477,
                "has_coords": true
            },
            {
                "name": "ëŒ€ë°•ì²œí•˜ë§ˆíŠ¸",
                "address": "ì¸ì²œ ë¶€í‰êµ¬ ê°ˆì‚°ë™ 367ë²ˆì§€",
                "wins": 6,
                "lat": 37.5115855704108,
                "lng": 126.726366374514,
                "has_coords": true
            },
            {
                "name": "ë…¸ë‹¤ì§€ë³µê¶Œë°©",
                "address": "ê²½ê¸° ìš©ì¸ì‹œ ì²˜ì¸êµ¬ ë§ˆí‰ë™ 735-1",
                "wins": 6,
                "lat": 37.2350997738575,
                "lng": 127.210525773714,
                "has_coords": true
            },
            {
                "name": "í–‰ë³µí•œì‚¬ëŒë“¤ (í¥ë¶€ë„¤)",
                "address": "ê²½ê¸° ê´‘ì£¼ì‹œ ê²½ì¶©ëŒ€ë¡œ 763",
                "wins": 5,
                "lat": 37.3555798712105,
                "lng": 127.32540015887,
                "has_coords": true
            },
            {
                "name": "ë…¸ë‹¤ì§€ë³µê¶Œë°©",
                "address": "ê²½ê¸° ìš©ì¸ì‹œ ì²˜ì¸êµ¬ ê¸ˆë ¹ë¡œ 130",
                "wins": 5,
                "lat": 37.2351637037009,
                "lng": 127.210500032181,
                "has_coords": true
            },
            {
                "name": "ì•Œë¦¬ë°”ì´(ë‚˜ì£¼ì )",
                "address": "ì „ë‚¨ ë‚˜ì£¼ì‹œ ë‚˜ì£¼ë¡œ 142 ì•Œë¦¬ë°”ì´",
                "wins": 5,
                "lat": 35.0313297380285,
                "lng": 126.717157991346,
                "has_coords": true
            },
            {
                "name": "ë…¸ë‹¤ì§€ë³µê¶Œë°©",
                "address": "ê²½ê¸° ì‹œí¥ì‹œ ëŒ€ì•¼ë™ 345-16 1ì¸µìƒê°€",
                "wins": 5,
                "lat": 37.448416258611,
                "lng": 126.791926293123,
                "has_coords": true
            },
            {
                "name": "ì˜¤ì¼€ì´ìƒì‚¬",
                "address": "ì„œìš¸ ì„œì´ˆêµ¬ ë°˜í¬ë™ 19-3ë²ˆì§€ ì„¼íŠ¸ëŸ´ì‹œí‹°ë‚´100í˜¸ë§¤ì ",
                "wins": 5,
                "lat": 37.5043641148563,
                "lng": 127.003620888061,
                "has_coords": true
            },
            {
                "name": "ì˜¤ì²œì–µë³µê¶Œë°©",
                "address": "ê´‘ì£¼ ì„œêµ¬ í™”ì •ë™ 782-14",
                "wins": 5,
                "lat": 35.1529734232587,
                "lng": 126.88072111789,
                "has_coords": true
            },
            {
                "name": "ë¯¸ë‚˜ì‹í’ˆ(ë¡œë˜íŒë§¤ì )",
                "address": "ì„œìš¸ ê°•ì„œêµ¬ ë°©í™”ë™ 484-23",
                "wins": 5,
                "lat": 37.5735042394953,
                "lng": 126.810684180076,
                "has_coords": true
            },
            {
                "name": "ë³µê¶Œì „ë¬¸ì ",
                "address": "ì¸ì²œ ë¶€í‰êµ¬ ì²­ì²œë™ 236-20",
                "wins": 5,
                "lat": 37.5038435469501,
                "lng": 126.715130703363,
                "has_coords": true
            },
            {
                "name": "ë³µê¶Œëª…ë‹¹",
                "address": "ì¶©ë‚¨ ê³µì£¼ì‹œ ì‹ ê´€ë™ 585-12",
                "wins": 5,
                "lat": 36.471840773738,
                "lng": 127.133136987861,
                "has_coords": true
            },
            {
                "name": "ì˜í™”ìœ í†µ(1ë“±ë³µê¶Œë°©)",
                "address": "ìš¸ì‚° ë‚¨êµ¬ ë‹¬ë™ 758ì‚¼ì„±ì•„íŒŒíŠ¸ìƒê°€204-101",
                "wins": 5,
                "lat": 35.5338146134567,
                "lng": 129.322041642891,
                "has_coords": true
            }
        ];
        let registeredKeys = JSON.parse(localStorage.getItem('pov_registered_shops') || '[]');

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            try {
                // Initialize Map
                if (typeof kakao !== 'undefined' && kakao.maps) {
                    const mapContainer = document.getElementById('map');
                    const mapOption = { center: new kakao.maps.LatLng(37.4815, 127.0145), level: 3 };
                    map = new kakao.maps.Map(mapContainer, mapOption);

                    const rvContainer = document.getElementById('roadview');
                    rv = new kakao.maps.Roadview(rvContainer);
                    rvClient = new kakao.maps.RoadviewClient();

                    marker = new kakao.maps.Marker({
                        position: map.getCenter(),
                        map: map,
                        draggable: true
                    });

                    // Roadview Events
                    kakao.maps.event.addListener(rv, 'init', updatePOVUI);
                    kakao.maps.event.addListener(rv, 'viewpoint_changed', updatePOVUI);
                    kakao.maps.event.addListener(rv, 'position_changed', updatePOVUI);

                    // Map Marker Events
                    kakao.maps.event.addListener(marker, 'dragend', function () {
                        const pos = marker.getPosition();
                        loadRoadview(pos.getLat(), pos.getLng());
                    });

                    // Manual Input Events
                    ['rv-pan', 'rv-tilt', 'rv-zoom'].forEach(id => {
                        document.getElementById(id).addEventListener('input', applyPOV);
                    });
                } else {
                    console.warn('Kakao SDK not loaded, map features disabled.');
                    document.getElementById('status-text').innerText = 'ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨ (ë¦¬ìŠ¤íŠ¸ëŠ” í™•ì¸ ê°€ëŠ¥)';
                }
            } catch (err) {
                console.error('Error during init:', err);
                document.getElementById('status-text').innerText = 'ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ (ë¦¬ìŠ¤íŠ¸ëŠ” í™•ì¸ ê°€ëŠ¥)';
            }

            // Render the list always
            renderShopList();
        }

        function renderShopList() {
            // Filter out registered shops
            const filteredList = allMissingShops.filter(shop => {
                const key = `${shop.name}|${shop.address}`;
                return !registeredKeys.includes(key);
            });

            document.getElementById('missing-count').innerText = filteredList.length;
            document.getElementById('status-text').innerText = `ë‚¨ì€ ëŒ€ìƒ: ${filteredList.length}ê°œ / ì „ì²´: ${allMissingShops.length}ê°œ`;

            const listContainer = document.getElementById('shop-list');
            listContainer.innerHTML = '';

            filteredList.forEach((shop, index) => {
                const div = document.createElement('div');
                div.className = 'shop-item';
                if (currentShop && currentShop.name === shop.name && currentShop.address === shop.address) {
                    div.classList.add('active');
                }
                div.innerHTML = `
                    <div class="shop-name">${shop.name}</div>
                    <div class="shop-addr">${shop.address}</div>
                    <div class="win-count">${shop.wins}íšŒ ë‹¹ì²¨</div>
                `;
                div.onclick = () => selectShop(shop, div);
                listContainer.appendChild(div);
            });

            if (filteredList.length === 0 && allMissingShops.length > 0) {
                listContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">ğŸ‰ ëª¨ë“  ìƒì ì˜ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
            }
        }

        function selectShop(shop, element) {
            document.querySelectorAll('.shop-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            currentShop = shop;

            const moveLatLon = new kakao.maps.LatLng(shop.lat, shop.lng);
            map.setCenter(moveLatLon);
            marker.setPosition(moveLatLon);

            loadRoadview(shop.lat, shop.lng);
        }

        function loadRoadview(lat, lng) {
            const position = new kakao.maps.LatLng(lat, lng);
            rvClient.getNearestPanoId(position, 100, function (panoId) {
                if (panoId) {
                    rv.setPanoId(panoId, position);
                } else {
                    alert('ë°˜ê²½ 100m ì´ë‚´ì— ë¡œë“œë·° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            });
        }

        function updatePOVUI() {
            if (!rv.getPanoId()) return;

            const panoId = rv.getPanoId();
            const viewpoint = rv.getViewpoint();
            const position = rv.getPosition();

            document.getElementById('rv-pano').value = panoId;
            document.getElementById('rv-pan').value = viewpoint.pan.toFixed(2);
            document.getElementById('rv-tilt').value = viewpoint.tilt.toFixed(2);
            document.getElementById('rv-zoom').value = viewpoint.zoom;

            if (position) {
                document.getElementById('cur-lat').value = position.getLat().toFixed(6);
                document.getElementById('cur-lng').value = position.getLng().toFixed(6);
            }

            updateCodeOutput();
        }

        function applyPOV() {
            const pan = parseFloat(document.getElementById('rv-pan').value);
            const tilt = parseFloat(document.getElementById('rv-tilt').value);
            const zoom = parseInt(document.getElementById('rv-zoom').value);

            if (!isNaN(pan) && !isNaN(tilt)) {
                rv.setViewpoint({ pan, tilt, zoom });
            }
        }

        function syncMapToRV() {
            const pos = rv.getPosition();
            if (pos) {
                map.setCenter(pos);
                marker.setPosition(pos);
            }
        }

        function updateCodeOutput() {
            if (!currentShop) return;

            const panoId = rv.getPanoId();
            const vp = rv.getViewpoint();

            const addr = currentShop.address;
            const code = `{ name: "${currentShop.name}", addr: "${addr}", panoId: ${panoId}, pov: { pan: ${vp.pan.toFixed(2)}, tilt: ${vp.tilt.toFixed(2)}, zoom: ${vp.zoom} } },`;
            document.getElementById('code-output').innerText = code;
        }

        function copyCode() {
            const text = document.getElementById('code-output').innerText;
            if (text.startsWith('//')) return;
            navigator.clipboard.writeText(text).then(() => {
                alert('ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            });
        }

        function markAsRegistered() {
            if (!currentShop) {
                alert('ë¨¼ì € ìƒì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const key = `${currentShop.name}|${currentShop.address}`;
            if (!registeredKeys.includes(key)) {
                registeredKeys.push(key);
                localStorage.setItem('pov_registered_shops', JSON.stringify(registeredKeys));
                alert(`'${currentShop.name}' ìƒì ì´ ë“±ë¡ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                currentShop = null;
                renderShopList();
                document.getElementById('code-output').innerText = '// ìƒì ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
            }
        }

        function resetRegistered() {
            if (confirm('ëª¨ë“  ë“±ë¡ ì™„ë£Œ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì‚­ì œëœ ë¦¬ìŠ¤íŠ¸ê°€ ë‹¤ì‹œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤)')) {
                registeredKeys = [];
                localStorage.removeItem('pov_registered_shops');
                renderShopList();
            }
        }
    </script>
</body>

</html>