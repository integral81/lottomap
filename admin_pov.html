<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lotto Map - POV Admin (v2.1)</title>
    <!-- Use the original API Key which likely supports file:// or user's domain -->
    <script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a6b27b6dab16c7e3459bb9589bf1269d&libraries=services,roadview"></script>
    <!-- Load data as JS variable 'lottoData' to avoid CORS on file:// -->
    <script src="lotto_data.js"></script>
    <style>
        :root {
            --primary: #d32f2f;
            --sidebar-width: 350px;
            --header-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f0f2f5;
        }

        header {
            height: var(--header-height);
            background: #333;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        header h1 {
            font-size: 18px;
        }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
        }

        .shop-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .shop-item:hover {
            background: #f5f5f5;
        }

        .shop-item.active {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .shop-name {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .shop-addr {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .addr-copy-btn {
            border: 1px solid #2196f3;
            background: #e3f2fd;
            cursor: pointer;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 3px;
            color: #1976d2;
        }

        .win-count {
            display: inline-block;
            background: var(--primary);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 4px;
        }

        #content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #viewer-container {
            flex: 1;
            display: flex;
            gap: 10px;
            padding: 10px;
            min-height: 0;
        }

        #map,
        #roadview {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        #roadview {
            flex: 2;
        }

        #control-panel {
            height: 350px;
            background: white;
            border-top: 1px solid #ddd;
            padding: 15px;
            display: flex;
            gap: 20px;
        }

        .control-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group h3 {
            font-size: 14px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        #stack-area {
            flex: 1;
            background: #222;
            color: #ccc;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .btn-update {
            padding: 10px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <header>
        <h1>ğŸ° POV ê´€ë¦¬ (Local File Mode)</h1>
    </header>
    <main>
        <div id="sidebar">
            <div
                style="padding: 10px; font-size: 13px; font-weight: bold; color: #333; border-bottom: 2px solid #333; margin-bottom: 10px;">
                ëŒ€ìƒ ë¦¬ìŠ¤íŠ¸ (<span id="missing-count">0</span>)
            </div>
            <div id="shop-list"></div>
        </div>
        <div id="content">
            <div id="viewer-container">
                <div id="map"></div>
                <div id="roadview" tabindex="0"></div>
            </div>
            <div id="control-panel">
                <div class="control-group">
                    <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                        <h3 style="color:#d32f2f;">1. í˜„ì¬ ì½”ë“œ (í•œ ì¤„)</h3>
                        <span style="font-size:11px; color:#999;">í™”ë©´ì„ ì›€ì§ì´ë©´ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤</span>
                    </div>
                    <div id="current-code-area"
                        style="background:#222; color:#00ff00; padding:12px; border-radius:6px; font-family:monospace; font-size:12px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                        <span id="current-code-text">// ìƒì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>
                    </div>

                    <button class="btn-update" onclick="markAsRegistered()"
                        style="font-size:16px; padding:15px; margin: 10px 0; background:#1976d2;">
                        â¬‡ï¸ ì•„ë˜ ë¦¬ìŠ¤íŠ¸ë¡œ ì¶”ê°€ (ëˆ„ì )
                    </button>

                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="color:#333;">2. ëˆ„ì  ë¦¬ìŠ¤íŠ¸ (<span id="stack-count">0</span>ê°œ)</h3>
                        <div style="display:flex; gap:8px;">
                            <button onclick="copyStack()"
                                style="background:#4caf50; color:white; border:none; padding:8px 16px; border-radius:4px; font-weight:bold; cursor:pointer;">ğŸ“‹
                                ê²°ê³¼ ì „ì²´ ë³µì‚¬</button>
                            <button onclick="clearStack()"
                                style="background:#999; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">ğŸ§¹
                                ë¹„ìš°ê¸°</button>
                        </div>
                    </div>
                    <div id="stack-area" style="flex:1; background:#1e1e1e; border:2px solid #333;">
                        <pre id="stack-output" style="margin:0; padding:5px; color:#eee;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        let map, rv, rvClient, marker;
        let currentShop = null;
        let accumulatedCodes = JSON.parse(localStorage.getItem('pov_accumulated_codes') || '[]');
        let registeredKeys = JSON.parse(localStorage.getItem('pov_registered_shops') || '[]');
        let allMissingShops = [];
        const SEOUL = { lat: 37.5665, lng: 126.9780 };

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            try {
                // Map Init
                const mapContainer = document.getElementById('map');
                const mapOption = {
                    center: new kakao.maps.LatLng(37.4815, 127.0145),
                    level: 3,
                    draggable: true,
                    scrollwheel: true
                };

                map = new kakao.maps.Map(mapContainer, mapOption);
                // Zoom Control
                var zoomControl = new kakao.maps.ZoomControl();
                map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

                rv = new kakao.maps.Roadview(document.getElementById('roadview'));
                rvClient = new kakao.maps.RoadviewClient();
                marker = new kakao.maps.Marker({ position: map.getCenter(), map: map, draggable: true });

                kakao.maps.event.addListener(rv, 'init', updatePOVUI);
                kakao.maps.event.addListener(rv, 'viewpoint_changed', updatePOVUI);
                kakao.maps.event.addListener(marker, 'dragend', () => loadRoadview(marker.getPosition().getLat(), marker.getPosition().getLng()));

                kakao.maps.event.addListener(map, 'click', function (mouseEvent) {
                    const latlng = mouseEvent.latLng;
                    marker.setPosition(latlng);
                    map.setCenter(latlng);
                    loadRoadview(latlng.getLat(), latlng.getLng());
                });

                // Load Data from JS variable
                processLottoData();
                updateCodeOutput();

            } catch (e) {
                console.error(e);
                alert('ì´ˆê¸°í™” ì¤‘ ì—ëŸ¬ ë°œìƒ: ' + e.message);
            }
        }

        function processLottoData() {
            if (typeof lottoData === 'undefined') {
                alert("lotto_data.js ë¡œë“œ ì‹¤íŒ¨! ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const mapObj = {};
            const HOT_TARGETS = ['ë¡œë˜ë§ˆíŠ¸', 'ë†í˜‘ì¤‘ì•™íšŒ ì• ê°€íŒ', 'ì´ë¦„ë¯¸ìƒ(í™”ëª…ë™)', 'ë†í˜‘ ì• ê°€íŒì ', 'ì²­í™”ë¹Œë”©', 'ë¡œë˜ ëª…ë‹¹ ê°€íŒì ', '153ë¡œë˜íŒë§¤ì ', '119ë³µê¶Œë°©'];

            lottoData.forEach(item => {
                if (!item.n) return;
                // ì´ë¦„ê³¼ ì£¼ì†Œ ì•ë¶€ë¶„ì„ ì¡°í•©í•˜ì—¬ ê°™ì€ ì´ë¦„ì˜ ë‹¤ë¥¸ ë§¤ì¥ì„ êµ¬ë¶„í•©ë‹ˆë‹¤.
                const key = item.n + (item.a || "").substring(0, 10);
                if (!mapObj[key]) {
                    mapObj[key] = {
                        name: item.n, address: item.a || "",
                        lat: Number(item.lat), lng: Number(item.lng),
                        wins: 0, pov: item.pov, hidden: item.hidden, closed: item.closed
                    };
                }

                // í†µí•©ëœ ë°ì´í„°ì˜ ê²½ìš° 'count' ì†ì„±ì„ ì‚¬ìš©í•˜ê³ , ì•„ë‹ˆë©´ 1ì„ ë”í•©ë‹ˆë‹¤.
                const addWins = item.count ? Number(item.count) : 1;
                mapObj[key].wins += addWins;

                if (item.closed) mapObj[key].closed = true;
                if (item.hidden) mapObj[key].hidden = true;
                if (item.pov && (item.pov.id || item.pov.panoid)) mapObj[key].pov = item.pov;
            });

            const TARGET_LIST = [
                { n: "ë‹¤ë‹ˆì—˜ì‚¬", a: "ê²½ê¸° ì•ˆì‚°ì‹œ ë‹¨ì›êµ¬ ì´ˆì§€ë™ 796" },
                { n: "ì²œí•˜ëª…ë‹¹ë³µê¶Œë°©", a: "ì¶©ë‚¨ í™ì„±êµ° í™ì„±ì ì˜¤ê´€ë¦¬ 321-4" },
                { n: "í–‰ë³µì¶©ì „ì†Œ", a: "ê²½ê¸° í‰íƒì‹œ ì²­ë¶ì í˜„ê³¡ë¦¬ 286" },
                { n: "ë¡œë˜ë³µê¶Œë‘ì •ì ", a: "ì¶©ë‚¨ ì²œì•ˆì‹œ ì„œë¶êµ¬ ë‘ì •ë¡œ 251 ëŒ€ì›ë¹Œë”©104í˜¸" },
                { n: "ì•Œë¦¬ë°”ì´", a: "ê´‘ì£¼ ê´‘ì‚°êµ¬ ìˆ˜ë“±ë¡œ 253 1ì¸µ ì•Œë¦¬ë°”ì´" },
                { n: "ì˜¬ì¸ (all in)", a: "ê²½ê¸° í™”ì„±ì‹œ 3.1ë§Œì„¸ë¡œ 1147" },
                { n: "ë¡œë˜í‚¹", a: "ì„œìš¸ ì˜ë“±í¬êµ¬ ì˜ì¤‘ë¡œ 2 1ì¸µ" },
                { n: "ì—ìŠ¤ë¹„ ìƒì‚¬", a: "ì„œìš¸ ì¤‘êµ¬ í‡´ê³„ë¡œ86ê¸¸ 29" },
                { n: "ëŒ€ë°•ë§ˆíŠ¸ë³µê¶Œë°©", a: "ì¶©ë‚¨ ì•„ì‚°ì‹œ ìŒë´‰ë¡œ 844 íƒœí™”ìƒê°€1ì¸µ103í˜¸" },
                { n: "ì¬ë§ˆíŠ¸", a: "ì¶©ë¶ ì²­ì£¼ì‹œ í¥ë•êµ¬ ì§„ì¬ë¡œ23ë²ˆê¸¸ 25" },
                { n: "ëª…ë‹¹ê³¨ë³µê¶Œë°©", a: "ê²½ê¸° ìˆ˜ì›ì‹œ ê¶Œì„ êµ¬ ë™ìˆ˜ì›ë¡œ242ë²ˆê¸¸ 15 104í˜¸" },
                { n: "ì˜¤ì¼€ì´ìƒì‚¬", a: "ì„œìš¸ ì„œì´ˆêµ¬ ì‹ ë°˜í¬ë¡œ 176" },
                { n: "ë¯¸ë‚˜ì‹í’ˆ(ë¡œë˜íŒë§¤ì )", a: "ì„œìš¸ ê°•ì„œêµ¬ ê¸ˆë‚­í™”ë¡œ 91-12" },
                { n: "ë²„ìŠ¤í‘œê°€íŒì ", a: "ê²½ê¸° ì•ˆì–‘ì‹œ ë™ì•ˆêµ¬ í˜¸ê³„ë™ 1039-2" },
                { n: "ë³µê¶Œë°±í™”ì ", a: "ê²½ê¸° íŒŒì£¼ì‹œ ê¸ˆì´Œ2ë™ 329-135" },
                { n: "ëˆë²¼ë½ë§ëŠ”ê³³", a: "ë¶€ì‚° ë™êµ¬ ë²”ì¼ë™ 833-5ë²ˆì§€" },
                { n: "ëª©í™”íœ´ê²Œì†Œ", a: "ê²½ë‚¨ ì‚¬ì²œì‹œ ì‚¬ì²œëŒ€ë¡œ 912" },
                { n: "ì˜í™”ìœ í†µ(1ë“±ë³µê¶Œë°©)", a: "ê²½ë¶ í¬í•­ì‹œ ë¶êµ¬ ì–‘í•™ì²œë¡œ 15" },
                { n: "ì¤‘êµ¬-ê°€ë¡œê°€íŒëŒ€-37", a: "ì„œìš¸ ì¤‘êµ¬ ë‚¨ëŒ€ë¬¸ë¡œ 20-2" },
                { n: "ì²œí•˜ëª…ë‹¹ë³µê¶Œë°©", a: "ê²½ê¸° ìˆ˜ì›ì‹œ íŒ”ë‹¬êµ¬ ë§¤ì‚°ë¡œ 2" },
                { n: "ì¼ë“±ë³µê¶Œí¸ì˜ì ", a: "ëŒ€êµ¬ ë‹¬ì„œêµ¬ ë³¸ë¦¬ë™ 2-16ë²ˆì§€ 1ì¸µ" },
                { n: "í–‰ìš´ë³µê¶Œë°© ë³´ìƒë‹¹ê±´ê°•ì›", a: "ì „ë¶ ìµì‚°ì‹œ ë¬´ì™•ë¡œ 1268" },
                { n: "í–‰ìš´ë³µê¶Œë°©", a: "ê²½ê¸° í¬ì²œì‹œ ì†”ëª¨ë£¨ë¡œ 86-1" },
                { n: "ì ì‹¤ë§¤ì ", a: "ì„œìš¸ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 269 1ì¸µ ì ì‹¤ì—­ 8ë²ˆì¶œêµ¬ ì•" },
                { n: "ì„¸ì§„ì „ìí†µì‹ ", a: "ëŒ€êµ¬ ì„œêµ¬ ì„œëŒ€êµ¬ë¡œ 376" },
                { n: "ì²œí•˜ëª…ë‹¹ë³µê¶Œë°©", a: "ê²½ë‚¨ ê±°ì œì‹œ ì˜¥í¬ì„±ì•ˆë¡œ 60" },
                { n: "NG24", a: "ê²½ë¶ ì¹ ê³¡êµ° ë¶ì¤‘ë¦¬3ê¸¸ 59" },
                { n: "ëŒ€ë°•ì²œí•˜ë§ˆíŠ¸", a: "ì¸ì²œ ë¶€í‰êµ¬ êµ´í¬ë¡œ 48" },
                { n: "ì¢…í•©ë³µê¶ŒìŠˆí¼", a: "ê²½ê¸° ì‹œí¥ì‹œ ë§ˆìœ ë¡œ 336 ì •ì¼ë¹Œë”©104" },
                { n: "í–‰ë³µí•œì‚¬ëŒë“¤ (í¥ë¶€ë„¤)", a: "ê²½ê¸° ê´‘ì£¼ì‹œ ê³¤ì§€ì•”ì ê²½ì¶©ëŒ€ë¡œ 763" },
                { n: "ë¬µë™ì‹í’ˆ", a: "ì„œìš¸ ì¤‘ë‘êµ¬ ë™ì¼ë¡œ 919" },
                { n: "ë‹¤ëª¨ì•„ë³µê¶Œ", a: "ì„œìš¸ êµ¬ë¡œêµ¬ ì˜¤ë¥˜ë™ 315-14" },
                { n: "ì²œí•˜ëª…ë‹¹ë³µê¶Œ", a: "ëŒ€êµ¬ ë¶êµ¬ ì¹ ê³¡ì¤‘ì•™ëŒ€ë¡œ 545" },
                { n: "í•œê¿ˆë³µê¶Œë°©", a: "ìš¸ì‚° ì¤‘êµ¬ ë²ˆì˜ë¡œ 586" },
                { n: "ë…¸ë‹¤ì§€ë³µê¶Œë°©", a: "ê²½ê¸° ìš©ì¸ì‹œ ì²˜ì¸êµ¬ ê¸ˆë ¹ë¡œ 130" },
                { n: "ë˜ë˜ë³µê¶Œë°©", a: "ì „ë¶ ìµì‚°ì‹œ ê³ ë´‰ë¡œ32ê¸¸ 3" },
                { n: "ì œì´ë³µê¶Œë°©", a: "ì„œìš¸ ì¢…ë¡œêµ¬ ì¢…ë¡œ5ê°€ 58 í‰ì°½ë¹Œë”© 1ì¸µ 103í˜¸" },
                { n: "ì•Œë¦¬ë°”ì´(ë‚˜ì£¼ì )", a: "ì „ë‚¨ ë‚˜ì£¼ì‹œ ë‚˜ì£¼ë¡œ 142 ì•Œë¦¬ë°”ì´" },
                { n: "ì¢…í•©ê°€íŒì ", a: "ì„œìš¸ ë™ëŒ€ë¬¸êµ¬ ì™•ì‚°ë¡œ 206 ê°€ë¡œíŒë§¤ëŒ€" },
                { n: "í˜„ëŒ€ì¥ë¯¸ìŠˆí¼", a: "ì „ë¶ ìµì‚°ì‹œ ë™ì„œë¡œ61ê¸¸ 41 ì–´ì–‘ë™ í˜„ëŒ€A ìƒê°€ë™ 108í˜¸" },
                { n: "ë²„ìŠ¤í‘œíŒë§¤ì†Œ", a: "ê²½ê¸° ê³ ì–‘ì‹œ ë•ì–‘êµ¬ í™”ì‹ ë¡œ 76 ìƒ˜í„°ë§ˆì„1ë‹¨ì§€ì•„íŒŒíŠ¸ 971ì„ " },
                { n: "í–‰ìš´ì˜ì§‘ì œ1í˜¸ì ", a: "ê²½ë¶ ì•ˆë™ì‹œ ê²½ë™ë¡œ 663" },
                { n: "ë³µê¶Œëª…ë‹¹(ì„œë¶€ì )", a: "ëŒ€êµ¬ ë‹¬ì„œêµ¬ ì›”ë°°ë¡œ 452" },
                { n: "ë¼ì´í”„ë§ˆíŠ¸", a: "ì¸ì²œ ì¤‘êµ¬ ì—°ì•ˆë¶€ë‘ë¡œ53ë²ˆê¸¸ 36 5í˜¸" },
                { n: "ê°ˆë ™ë¶„ì‹í•œì‹", a: "ì„œìš¸ ì¤‘ë‘êµ¬ ìš©ë§ˆì‚°ë¡œ115ê¸¸ 92" },
                { n: "ë²„ìŠ¤íŒë§¤ì†Œ", a: "ì„œìš¸ ì˜ë“±í¬êµ¬ ì˜ì¤‘ë¡œ 13 ì‹ ì„¸ê³„ì•" }
            ];

            const list = Object.values(mapObj)
                .filter(s => {
                    const isTarget = TARGET_LIST.some(t => t.n === s.name && s.address.includes(t.a.substring(0, 15)));
                    return isTarget && !s.hidden && !s.closed;
                })
                .map(s => {
                    s.dist = getDistanceFromLatLonInKm(SEOUL.lat, SEOUL.lng, s.lat, s.lng);
                    s.isPriority = HOT_TARGETS.includes(s.name);
                    return s;
                })
                .sort((a, b) => {
                    // Priority 1: Win count descending
                    if (b.wins !== a.wins) return b.wins - a.wins;

                    // Priority 2: Hot targets
                    if (a.isPriority && !b.isPriority) return -1;
                    if (!a.isPriority && b.isPriority) return 1;

                    // Priority 3: Distance (closest first)
                    return a.dist - b.dist;
                });

            allMissingShops = list;
            renderShopList();
        }

        function renderShopList() {
            const container = document.getElementById('shop-list');
            document.getElementById('missing-count').innerText = allMissingShops.length;
            container.innerHTML = '';

            allMissingShops.forEach(shop => {
                const div = document.createElement('div');
                div.className = 'shop-item' + (currentShop?.name === shop.name ? ' active' : '');
                div.onclick = () => selectShop(shop, div);

                const hasPov = !!(shop.pov && shop.pov.id);
                // Check local storage stack
                const isStacked = accumulatedCodes.some(c => c.includes(`name: "${shop.name}"`));

                let icon = 'ğŸ”´';
                if (hasPov) icon = 'âœ…';
                else if (isStacked) icon = 'ğŸ’¾';

                div.innerHTML = `
                    <div class="shop-name">${icon} ${shop.name}</div>
                    <div class="shop-addr">
                        <span style="font-size:11px;">${shop.address}</span>
                        <button class="addr-copy-btn" onclick="event.stopPropagation(); copyToClipboard('${shop.address}')">ë³µì‚¬</button>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="win-count">${shop.wins}íšŒ</span>
                        <span style="font-size:10px; color:#888;">${shop.dist.toFixed(1)}km</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function selectShop(shop, el) {
            document.querySelectorAll('.shop-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            currentShop = shop;
            const pos = new kakao.maps.LatLng(shop.lat, shop.lng);
            map.setCenter(pos);
            marker.setPosition(pos);

            if (shop.pov && shop.pov.id) {
                rv.setPanoId(shop.pov.id, pos);
                rv.setViewpoint({ pan: shop.pov.pan, tilt: shop.pov.tilt, zoom: shop.pov.zoom });
            } else {
                loadRoadview(shop.lat, shop.lng);
            }

            setTimeout(() => {
                const rvDiv = document.getElementById('roadview');
                rvDiv.focus();
                rvDiv.click();
            }, 500);
        }

        function loadRoadview(lat, lng) {
            const pos = new kakao.maps.LatLng(lat, lng);
            rvClient.getNearestPanoId(pos, 500, (id) => {
                if (id) rv.setPanoId(id, pos);
                else {
                    // No need to alert, just stays blank or old view
                }
            });
        }

        function updatePOVUI() { updateCodeOutput(); }

        function updateCodeOutput() {
            if (currentShop && rv.getPanoId()) {
                const vp = rv.getViewpoint();
                const code = `{ name: "${currentShop.name}", addr: "${currentShop.address}", panoid: ${rv.getPanoId()}, pov: { pan: ${vp.pan.toFixed(2)}, tilt: ${vp.tilt.toFixed(2)}, zoom: ${Math.floor(vp.zoom)} } },`;
                document.getElementById('current-code-text').textContent = code;
            } else {
                document.getElementById('current-code-text').textContent = '{ ... }';
            }
            document.getElementById('stack-output').textContent = accumulatedCodes.join('\n');
            document.getElementById('stack-count').innerText = accumulatedCodes.length;
            const sa = document.getElementById('stack-area');
            sa.scrollTop = sa.scrollHeight;
        }

        function markAsRegistered() {
            if (!currentShop || !rv.getPanoId()) return;
            const code = document.getElementById('current-code-text').textContent;
            if (!accumulatedCodes.includes(code)) accumulatedCodes.push(code);
            localStorage.setItem('pov_accumulated_codes', JSON.stringify(accumulatedCodes));

            // Auto-Remove from Target List
            currentShop.hidden = true;
            allMissingShops = allMissingShops.filter(s => s.name !== currentShop.name);
            currentShop = null;

            renderShopList();
            updateCodeOutput();
            showToast('ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë¨');
        }

        function copyStack() {
            navigator.clipboard.writeText(accumulatedCodes.join('\n')).then(() => showToast('ë³µì‚¬ ì™„ë£Œ'));
        }

        function clearStack() {
            if (confirm('ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                accumulatedCodes = [];
                localStorage.setItem('pov_accumulated_codes', '[]');
                updateCodeOutput();
            }
        }

        function copyToClipboard(t) {
            navigator.clipboard.writeText(t).then(() => showToast('ë³µì‚¬ë¨'));
        }

        function showToast(m) {
            const t = document.createElement('div');
            t.innerText = m;
            t.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; z-index: 9999;';
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 1500);
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c;
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180)
        }
    </script>
</body>

</html>