<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotto POV Admin - 3 Wins (Local/Dist Sort)</title>
    <!-- Use the original API Key which likely supports file:// or user's domain -->
    <script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a6b27b6dab16c7e3459bb9589bf1269d&libraries=services,roadview"></script>
    <!-- Load data as JS variable 'lottoData' to avoid CORS on file:// -->
    <script src="lotto_data.js"></script>
    <style>
        :root {
            --primary: #d32f2f;
            --sidebar-width: 350px;
            --header-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f0f2f5;
        }

        header {
            height: var(--header-height);
            background: #333;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        header h1 {
            font-size: 18px;
        }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
        }

        .shop-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .shop-item:hover {
            background: #f5f5f5;
        }

        .shop-item.active {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .shop-name {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .shop-addr {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .addr-copy-btn {
            border: 1px solid #2196f3;
            background: #e3f2fd;
            cursor: pointer;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 3px;
            color: #1976d2;
        }

        .win-count {
            display: inline-block;
            background: var(--primary);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 4px;
        }

        #content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #viewer-container {
            flex: 1;
            display: flex;
            gap: 10px;
            padding: 10px;
            min-height: 0;
        }

        #map,
        #roadview {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        #roadview {
            flex: 2;
        }

        #control-panel {
            height: 350px;
            background: white;
            border-top: 1px solid #ddd;
            padding: 15px;
            display: flex;
            gap: 20px;
        }

        .control-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group h3 {
            font-size: 14px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        #stack-area {
            flex: 1;
            background: #222;
            color: #ccc;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .btn-update {
            padding: 10px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <header>
        <h1>üé∞ POV Í¥ÄÎ¶¨ (Local File Mode)</h1>
    </header>
    <main>
        <div id="sidebar">
            <div
                style="padding: 10px; font-size: 13px; font-weight: bold; color: #333; border-bottom: 2px solid #333; margin-bottom: 10px;">
                ÎåÄÏÉÅ Î¶¨Ïä§Ìä∏ (<span id="missing-count">0</span>)
            </div>
            <div id="shop-list"></div>
        </div>
        <div id="content">
            <div id="viewer-container">
                <div id="map"></div>
                <div id="roadview" tabindex="0"></div>
            </div>
            <div id="control-panel">
                <div class="control-group">
                    <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                        <h3 style="color:#d32f2f;">1. ÌòÑÏû¨ ÏΩîÎìú (Ìïú Ï§Ñ)</h3>
                        <span style="font-size:11px; color:#999;">ÌôîÎ©¥ÏùÑ ÏõÄÏßÅÏù¥Î©¥ ÏûêÎèô Í∞±Ïã†Îê©ÎãàÎã§</span>
                    </div>
                    <div id="current-code-area"
                        style="background:#222; color:#00ff00; padding:12px; border-radius:6px; font-family:monospace; font-size:12px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                        <span id="current-code-text">// ÏÉÅÏ†êÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</span>
                    </div>

                    <button class="btn-update" onclick="markAsRegistered()"
                        style="font-size:16px; padding:15px; margin: 10px 0; background:#1976d2;">
                        ‚¨áÔ∏è ÏïÑÎûò Î¶¨Ïä§Ìä∏Î°ú Ï∂îÍ∞Ä (ÎàÑÏ†Å)
                    </button>

                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="color:#333;">2. ÎàÑÏ†Å Î¶¨Ïä§Ìä∏ (<span id="stack-count">0</span>Í∞ú)</h3>
                        <div style="display:flex; gap:8px;">
                            <button onclick="copyStack()"
                                style="background:#4caf50; color:white; border:none; padding:8px 16px; border-radius:4px; font-weight:bold; cursor:pointer;">üìã
                                Í≤∞Í≥º Ï†ÑÏ≤¥ Î≥µÏÇ¨</button>
                            <button onclick="clearStack()"
                                style="background:#999; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">üßπ
                                ÎπÑÏö∞Í∏∞</button>
                        </div>
                    </div>
                    <div id="stack-area" style="flex:1; background:#1e1e1e; border:2px solid #333;">
                        <pre id="stack-output" style="margin:0; padding:5px; color:#eee;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        let map, rv, rvClient, marker;
        let currentShop = null;
        let accumulatedCodes = JSON.parse(localStorage.getItem('pov_accumulated_codes') || '[]');
        let registeredKeys = JSON.parse(localStorage.getItem('pov_registered_shops') || '[]');
        let allMissingShops = [];
        const SEOUL = { lat: 37.5665, lng: 126.9780 };

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            try {
                // Map Init
                const mapContainer = document.getElementById('map');
                const mapOption = {
                    center: new kakao.maps.LatLng(37.4815, 127.0145),
                    level: 3,
                    draggable: true,
                    scrollwheel: true
                };

                map = new kakao.maps.Map(mapContainer, mapOption);
                // Zoom Control
                var zoomControl = new kakao.maps.ZoomControl();
                map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

                rv = new kakao.maps.Roadview(document.getElementById('roadview'));
                rvClient = new kakao.maps.RoadviewClient();
                marker = new kakao.maps.Marker({ position: map.getCenter(), map: map, draggable: true });

                kakao.maps.event.addListener(rv, 'init', updatePOVUI);
                kakao.maps.event.addListener(rv, 'viewpoint_changed', updatePOVUI);
                kakao.maps.event.addListener(marker, 'dragend', () => loadRoadview(marker.getPosition().getLat(), marker.getPosition().getLng()));

                kakao.maps.event.addListener(map, 'click', function (mouseEvent) {
                    const latlng = mouseEvent.latLng;
                    marker.setPosition(latlng);
                    map.setCenter(latlng);
                    loadRoadview(latlng.getLat(), latlng.getLng());
                });

                // Load Data from JS variable
                processLottoData();
                updateCodeOutput();

            } catch (e) {
                console.error(e);
                alert('Ï¥àÍ∏∞Ìôî Ï§ë ÏóêÎü¨ Î∞úÏÉù: ' + e.message);
            }
        }

        function processLottoData() {
            if (typeof lottoData === 'undefined') {
                alert("lotto_data.js Î°úÎìú Ïã§Ìå®! Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
                return;
            }

            // Aggregate wins
            const mapObj = {};
            const HOT_TARGETS = ['Ïò•Ï¢åÎ°úÎòêÏ†ê', 'GooddayÎ≥µÍ∂åÏ†ÑÎ¨∏Ï†ê', 'ÏôÑÏõîÎ°úÎòê', 'Ï±ÑÎÑêÌÅê', 'Ìï¥ÌîºÎ≥µÍ∂å', 'ÎèÑÏÜåÎß§Î≥µÍ∂åÎ∞©'];

            lottoData.forEach(item => {
                if (!item.n) return;
                if (!mapObj[item.n]) {
                    mapObj[item.n] = {
                        name: item.n, address: item.a || "",
                        lat: Number(item.lat), lng: Number(item.lng),
                        wins: 0, pov: item.pov, hidden: item.hidden, closed: item.closed // Track closed status
                    };
                }
                mapObj[item.n].wins++;
                if (item.closed) mapObj[item.n].closed = true; // Ensure aggregated shop is marked closed if any entry is
            });

            // Filter 3 Wins + Sort by distance (desc)
            const list = Object.values(mapObj)
                .filter(s => {
                    const isHot = HOT_TARGETS.some(ht => s.name.includes(ht));
                    // For HOT_TARGETS, show them even if registered (to allow re-POV work)
                    if (isHot) return true;
                    return s.wins === 3 && !s.hidden && !s.closed && !(s.pov && (s.pov.id || s.pov.panoid));
                })
                .map(s => {
                    s.isHot = HOT_TARGETS.some(ht => s.name.includes(ht));
                    s.dist = getDistanceFromLatLonInKm(SEOUL.lat, SEOUL.lng, s.lat, s.lng);
                    return s;
                })
                .sort((a, b) => {
                    if (a.isHot && !b.isHot) return -1;
                    if (!a.isHot && b.isHot) return 1;
                    return b.dist - a.dist;
                });

            allMissingShops = list;
            renderShopList();
        }

        function renderShopList() {
            const container = document.getElementById('shop-list');
            document.getElementById('missing-count').innerText = allMissingShops.length;
            container.innerHTML = '';

            allMissingShops.forEach(shop => {
                const div = document.createElement('div');
                div.className = 'shop-item' + (currentShop?.name === shop.name ? ' active' : '');
                div.onclick = () => selectShop(shop, div);

                const hasPov = !!(shop.pov && shop.pov.id);
                // Check local storage stack
                const isStacked = accumulatedCodes.some(c => c.includes(`name: "${shop.name}"`));

                let icon = 'üî¥';
                if (hasPov) icon = '‚úÖ';
                else if (isStacked) icon = 'üíæ';

                div.innerHTML = `
                    <div class="shop-name">${icon} ${shop.name}</div>
                    <div class="shop-addr">
                        <span style="font-size:11px;">${shop.address}</span>
                        <button class="addr-copy-btn" onclick="event.stopPropagation(); copyToClipboard('${shop.address}')">Î≥µÏÇ¨</button>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="win-count">${shop.wins}Ìöå</span>
                        <span style="font-size:10px; color:#888;">${shop.dist.toFixed(1)}km</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function selectShop(shop, el) {
            document.querySelectorAll('.shop-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            currentShop = shop;
            const pos = new kakao.maps.LatLng(shop.lat, shop.lng);
            map.setCenter(pos);
            marker.setPosition(pos);

            if (shop.pov && shop.pov.id) {
                rv.setPanoId(shop.pov.id, pos);
                rv.setViewpoint({ pan: shop.pov.pan, tilt: shop.pov.tilt, zoom: shop.pov.zoom });
            } else {
                loadRoadview(shop.lat, shop.lng);
            }

            setTimeout(() => {
                const rvDiv = document.getElementById('roadview');
                rvDiv.focus();
                rvDiv.click();
            }, 500);
        }

        function loadRoadview(lat, lng) {
            const pos = new kakao.maps.LatLng(lat, lng);
            rvClient.getNearestPanoId(pos, 500, (id) => {
                if (id) rv.setPanoId(id, pos);
                else {
                    // No need to alert, just stays blank or old view
                }
            });
        }

        function updatePOVUI() { updateCodeOutput(); }

        function updateCodeOutput() {
            if (currentShop && rv.getPanoId()) {
                const vp = rv.getViewpoint();
                const code = `{ name: "${currentShop.name}", addr: "${currentShop.address}", panoid: ${rv.getPanoId()}, pov: { pan: ${vp.pan.toFixed(2)}, tilt: ${vp.tilt.toFixed(2)}, zoom: ${Math.floor(vp.zoom)} } },`;
                document.getElementById('current-code-text').textContent = code;
            } else {
                document.getElementById('current-code-text').textContent = '{ ... }';
            }
            document.getElementById('stack-output').textContent = accumulatedCodes.join('\n');
            document.getElementById('stack-count').innerText = accumulatedCodes.length;
            const sa = document.getElementById('stack-area');
            sa.scrollTop = sa.scrollHeight;
        }

        function markAsRegistered() {
            if (!currentShop || !rv.getPanoId()) return;
            const code = document.getElementById('current-code-text').textContent;
            if (!accumulatedCodes.includes(code)) accumulatedCodes.push(code);
            localStorage.setItem('pov_accumulated_codes', JSON.stringify(accumulatedCodes));

            // Auto-Remove from Target List
            currentShop.hidden = true;
            allMissingShops = allMissingShops.filter(s => s.name !== currentShop.name);
            currentShop = null;

            renderShopList();
            updateCodeOutput();
            showToast('Î¶¨Ïä§Ìä∏Ïóê Ï∂îÍ∞ÄÎê®');
        }

        function copyStack() {
            navigator.clipboard.writeText(accumulatedCodes.join('\n')).then(() => showToast('Î≥µÏÇ¨ ÏôÑÎ£å'));
        }

        function clearStack() {
            if (confirm('ÎπÑÏö∞ÏãúÍ≤†ÏäµÎãàÍπå?')) {
                accumulatedCodes = [];
                localStorage.setItem('pov_accumulated_codes', '[]');
                updateCodeOutput();
            }
        }

        function copyToClipboard(t) {
            navigator.clipboard.writeText(t).then(() => showToast('Î≥µÏÇ¨Îê®'));
        }

        function showToast(m) {
            const t = document.createElement('div');
            t.innerText = m;
            t.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; z-index: 9999;';
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 1500);
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c;
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180)
        }
    </script>
</body>

</html>