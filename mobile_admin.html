<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LottoMap Admin v2.5 (Fix Crash)</title>
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a6b27b6dab16c7e3459bb9589bf1269d&libraries=services,clusterer"
        onerror="log('Kakao Map Script Load Failed!', 'error')"></script>
    <style>
        body,
        html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden;
            background-color: #f0f2f5;
        }

        #map-view {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #list-view {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            background: #f0f2f5;
            overflow-y: auto;
            display: none;
            padding-bottom: 80px;
            -webkit-overflow-scrolling: touch;
        }

        #roadview-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3000;
            background: black;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }

        #roadview-container.active {
            transform: translateY(0);
        }

        #roadview {
            width: 100%;
            height: 100%;
        }

        .controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3001;
            display: flex;
            gap: 10px;
            width: 90%;
            justify-content: center;
        }

        .btn {
            border: none;
            padding: 14px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: transform 0.1s;
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(0.96) translateX(-50%);
        }

        .btn-primary {
            background-color: #fae100;
            color: #3c1e1e;
            flex: 2;
        }

        .btn-secondary {
            background-color: white;
            color: #333;
            flex: 1;
        }

        .btn-danger {
            background-color: #ff4444;
            color: white;
            flex: 1;
        }

        .btn-warning {
            background-color: #ff9800;
            color: white;
            flex: 1;
        }

        #nav-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: white;
            border-top: 1px solid #ddd;
            z-index: 2000;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            color: #888;
            font-size: 12px;
            font-weight: bold;
        }

        .nav-item.active {
            color: #333;
        }

        .nav-icon {
            font-size: 20px;
            display: block;
            margin-bottom: 3px;
        }

        #header-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            z-index: 1000;
            padding: 0 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(5px);
            border-bottom: 1px solid #eee;
            padding-top: env(safe-area-inset-top);
        }

        #search-box {
            flex: 1;
            background: #f2f2f7;
            border-radius: 10px;
            height: 36px;
            display: flex;
            align-items: center;
            padding: 0 10px;
        }

        #keyword {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 16px;
            outline: none;
        }

        .list-header {
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .shop-item {
            background: white;
            margin: 10px 15px;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .shop-info {
            flex: 1;
        }

        .shop-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .shop-addr {
            font-size: 13px;
            color: #666;
        }

        .shop-wins {
            font-size: 12px;
            background: #e8f5e9;
            color: #2e7d32;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .status-dot.done {
            background: #4CAF50;
        }

        .status-dot.todo {
            background: #ff4444;
        }

        #toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
            z-index: 5000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            white-space: nowrap;
        }

        /* DEBUG CONSOLE */
        #debug-console {
            width: 100%;
            height: 150px;
            background: #000;
            color: #0f0;
            font-family: monospace;
            font-size: 10px;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: scroll;
            border-top: 2px solid #333;
        }

        .log-entry {
            margin-bottom: 2px;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }

        .log-error {
            color: #fe5555;
        }

        .log-warn {
            color: #feca57;
        }
    </style>
</head>

<body>

    <div id="toast">Message</div>

    <!-- Header -->
    <div id="header-bar">
        <div id="search-box">
            <input type="text" id="keyword" placeholder="Îß§Ïû•Î™Ö Í≤ÄÏÉâ">
        </div>
        <button id="filter-btn" class="btn-secondary" style="padding: 8px 12px; border-radius: 8px; font-size:13px;">ÌïÑÌÑ∞:
            3ÌöåÎãπÏ≤®</button>
    </div>

    <!-- Map View -->
    <div id="map-view"></div>

    <!-- List View -->
    <div id="list-view">
        <div class="list-header">
            <div>
                <span id="list-title">Îß§Ïû• Î™©Î°ù</span>
                <span style="font-size:12px; color:#ff0000; font-weight:bold;">(DEBUG v2.5)</span>
            </div>
            <button onclick="window.location.reload()"
                style="padding:6px 10px; font-size:12px; border:1px solid #ddd; background:white; border-radius:6px;">üîÑ
                ÏÉàÎ°úÍ≥†Ïπ®</button>
        </div>

        <div id="status-msg" style="padding:20px; text-align:center; color:#666; display:none;"></div>

        <!-- Shop List -->
        <div id="shop-list-container"></div>

        <!-- Debug Console -->
        <div id="debug-console">
            <div>=== DEBUG LOG STARTED ===</div>
        </div>
    </div>

    <!-- Navigation -->
    <div id="nav-bar">
        <div class="nav-item active" onclick="switchTab('map')">
            <span class="nav-icon">üó∫Ô∏è</span>ÏßÄÎèÑ
        </div>
        <div class="nav-item" onclick="switchTab('list')">
            <span class="nav-icon">üìã</span>Î™©Î°ù (ÌôîÏû•Ïã§Î™®Îìú)
        </div>
    </div>

    <!-- Roadview Overlay -->
    <div id="roadview-container">
        <div id="roadview"></div>
        <div class="controls">
            <button id="close-rv-btn" class="btn btn-secondary">Îã´Í∏∞</button>
            <button id="hide-btn" class="btn btn-warning">Ïà®ÍπÄ</button>
            <button id="delete-btn" class="btn btn-danger">ÏÇ≠Ï†ú</button>
            <button id="save-pov-btn" class="btn btn-primary">üíæ Ï†ÄÏû•</button>
        </div>
    </div>

    <script>
        // --- Debug Logger ---
        function log(msg, type = 'info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + (type === 'error' ? 'log-error' : (type === 'warn' ? 'log-warn' : ''));
            const time = new Date().toLocaleTimeString().split(' ')[0]; // simple time
            entry.innerText = `[${time}] ${msg}`;
            const c = document.getElementById('debug-console');
            if (c) {
                c.prepend(entry);
            }
            console.log(msg);
        }

        window.onerror = function (msg, url, line) {
            log(`Global Error: ${msg} (L${line})`, 'error');
            return false;
        };

        // --- State ---
        let map, rv, rvClient;
        let isKakaoLoaded = false;
        let groupedShops = [];
        let currentShop = null;
        let markers = [];
        let clusterer;
        let currentTab = 'map';
        let filterMode = '3WINS'; // Default start mode

        // --- Init ---
        window.onload = async function () {
            log("Window Loaded. Starting Init...");

            // 1. Try Map Init (Can fail)
            try {
                if (typeof kakao !== 'undefined' && kakao.maps) {
                    initMap();
                    initRoadview();
                    isKakaoLoaded = true;
                    log("Kakao Map Loaded Successfully.");
                } else {
                    log("Kakao Object Missing! Map features disabled.", 'error');
                }
            } catch (e) {
                log("Map Init Failed: " + e.message, 'error');
            }

            // 2. Load Data (MUST RUN regardless of Map)
            try {
                await loadData(true);
            } catch (e) {
                log("Data Load Failed: " + e.message, 'error');
            }

            // Events
            const kEl = document.getElementById('keyword');
            if (kEl) kEl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') search(e.target.value);
            });

            const fBtn = document.getElementById('filter-btn');
            if (fBtn) fBtn.onclick = cycleFilter;
        };

        function initMap() {
            const container = document.getElementById('map-view');
            map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(36.5, 127.8), level: 13 });
            clusterer = new kakao.maps.MarkerClusterer({ map: map, averageCenter: true, minLevel: 10 });
        }

        function initRoadview() {
            rv = new kakao.maps.Roadview(document.getElementById('roadview'));
            rvClient = new kakao.maps.RoadviewClient();

            document.getElementById('close-rv-btn').onclick = closeRoadview;
            document.getElementById('save-pov-btn').onclick = savePov;
            document.getElementById('hide-btn').onclick = hideShop;
            document.getElementById('delete-btn').onclick = deleteShop;
        }

        // --- Data ---
        async function loadData(forceRefresh) {
            const statusEl = document.getElementById('status-msg');
            statusEl.style.display = 'block';
            statusEl.innerText = "Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...";
            log("Fetching lotto_data.json...");

            try {
                const res = await fetch('lotto_data.json?t=' + Date.now());
                if (!res.ok) throw new Error("HTTP " + res.status);

                const data = await res.json();
                log(`JSON Fetched. Total: ${data.length}`);

                // Grouping
                const mapObj = {};
                data.forEach(item => {
                    if (!item.n) return; // skip empty names
                    if (!mapObj[item.n]) {
                        mapObj[item.n] = {
                            n: item.n, a: item.a || "", lat: Number(item.lat), lng: Number(item.lng),
                            count: 0, pov: item.pov || null, isHidden: !!item.hidden
                        };
                    }
                    mapObj[item.n].count++;
                    if (item.pov && !mapObj[item.n].pov) mapObj[item.n].pov = item.pov;
                    if (item.hidden) mapObj[item.n].isHidden = true; // Sync hidden status
                });

                groupedShops = Object.values(mapObj);
                log(`Unique shops: ${groupedShops.length}`);

                const threeWins = groupedShops.filter(s => s.count === 3);
                log(`Found ${threeWins.length} items with exactly 3 wins.`);

                statusEl.innerText = `Î°úÎìú ÏôÑÎ£å: ${groupedShops.length}Í∞ú`;
                setTimeout(() => { statusEl.style.display = 'none'; }, 1000);

                // Force Apply Filter
                setFilter('3WINS');

                // Switch to list
                switchTab('list');

            } catch (e) {
                statusEl.innerText = "Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®";
                log("LoadData Error: " + e.message, 'error');
                alert("Load Fail: " + e.message);
            }
        }

        function cycleFilter() {
            if (filterMode === 'ALL') setFilter('UNFINISHED');
            else if (filterMode === 'UNFINISHED') setFilter('3WINS');
            else setFilter('ALL');
        }

        function setFilter(mode) {
            filterMode = mode;
            log(`Filter Changed: ${mode}`);
            const btn = document.getElementById('filter-btn');

            if (mode === 'ALL') btn.innerText = "ÌïÑÌÑ∞: Ï†ÑÏ≤¥";
            else if (mode === 'UNFINISHED') btn.innerText = "ÌïÑÌÑ∞: ÎØ∏ÏôÑÎ£å";
            else if (mode === '3WINS') btn.innerText = "ÌïÑÌÑ∞: 3ÌöåÎãπÏ≤®(ÏÑúÏö∏ÏõêÍ±∞Î¶¨Ïàú)";

            render();
        }

        function getFilteredList() {
            let list = groupedShops.filter(s => !s.isHidden);
            // log(`Base list: ${list.length}`);

            if (filterMode === 'UNFINISHED') {
                list = list.filter(s => !s.pov || !s.pov.id);
            } else if (filterMode === '3WINS') {
                const exact3 = list.filter(s => s.count === 3);

                // Sort by Distance from Seoul (Desc) - Farthest first
                const SEOUL = { lat: 37.5665, lng: 126.9780 };
                exact3.forEach(s => {
                    s.dist = getDistanceFromLatLonInKm(SEOUL.lat, SEOUL.lng, s.lat, s.lng);
                });

                if (exact3.length > 0) {
                    // Farthest First
                    list = exact3.sort((a, b) => b.dist - a.dist).slice(0, 50);
                } else {
                    log(`No exact-3 items! Random fallback.`);
                    list = list.sort(() => 0.5 - Math.random()).slice(0, 50);
                }
            }
            log(`Render List Size: ${list.length}`);
            return list;
        }

        function render() {
            const list = getFilteredList();
            // Don't render map if broken
            if (currentTab === 'map' && isKakaoLoaded) renderMap(list);
            else if (currentTab === 'map' && !isKakaoLoaded) {
                document.getElementById('map-view').innerHTML = '<div style="padding:50px; text-align:center;">‚ö†Ô∏è ÏßÄÎèÑ Î°úÎìú Ïã§Ìå® (Î°úÍ∑∏ÌôïÏù∏)</div>';
            }
            else renderList(list);
        }

        function renderMap(list) {
            if (!isKakaoLoaded || !clusterer) return;
            clusterer.clear();
            markers = [];
            list.forEach(shop => {
                const hasPov = !!(shop.pov && shop.pov.id);
                const src = hasPov ?
                    "http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png" :
                    "http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png";

                // Safe check just in case
                if (window.kakao && kakao.maps) {
                    const marker = new kakao.maps.Marker({
                        position: new kakao.maps.LatLng(shop.lat, shop.lng),
                        image: new kakao.maps.MarkerImage(src, new kakao.maps.Size(24, 35)),
                        title: shop.n
                    });
                    kakao.maps.event.addListener(marker, 'click', () => openShop(shop));
                    markers.push(marker);
                }
            });
            if (clusterer) clusterer.addMarkers(markers);
        }

        function renderList(list) {
            const container = document.getElementById('shop-list-container');
            container.innerHTML = '';
            document.getElementById('list-title').innerText = `Îß§Ïû• Î™©Î°ù (${list.length}Í∞ú)`;

            if (list.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:50px; color:#999;">Ï°∞Í±¥Ïóê ÎßûÎäî Îß§Ïû•Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }

            list.forEach(shop => {
                const hasPov = !!(shop.pov && shop.pov.id);
                const item = document.createElement('div');
                item.className = 'shop-item';
                item.onclick = () => openShop(shop);

                item.innerHTML = `
                    <div class="shop-info">
                        <div class="shop-name">
                            <span class="status-dot ${hasPov ? 'done' : 'todo'}"></span>
                            ${shop.n}
                            <span class="shop-wins">${shop.count}Ìöå</span>
                        </div>
                        <div class="shop-addr">${shop.a}</div>
                    </div>
                    <div style="font-size:20px; color:#ccc;">‚Ä∫</div>
                `;
                container.appendChild(item);
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            // log(`Switch Tab: ${tab}`);
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

            const mapView = document.getElementById('map-view');
            const listView = document.getElementById('list-view');

            if (tab === 'map') {
                mapView.style.display = 'block';
                listView.style.display = 'none';
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
                renderMap(getFilteredList());
            } else {
                mapView.style.display = 'none';
                listView.style.display = 'block';
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                renderList(getFilteredList());
            }
        }

        function openShop(shop) {
            currentShop = shop;
            log(`Opening: ${shop.n}`);

            if (!isKakaoLoaded) {
                alert("‚ö†Ô∏è ÏßÄÎèÑ API Î°úÎìú Ïã§Ìå®Î°ú Î°úÎìúÎ∑∞Î•º Ïó¥ Ïàò ÏóÜÏäµÎãàÎã§.\nÏù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÍ±∞ÎÇò, Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.");
                return;
            }

            const hasPov = !!(shop.pov && shop.pov.id);
            document.getElementById('save-pov-btn').innerText = hasPov ? "üíæ ÏàòÏ†ï Ï†ÄÏû•" : "üíæ Ï†ÄÏû•";
            document.getElementById('roadview-container').classList.add('active');

            const position = new kakao.maps.LatLng(shop.lat, shop.lng);
            if (hasPov) {
                if (rv) {
                    rv.setPanoId(shop.pov.id, position);
                    const initHandler = function () {
                        rv.setViewpoint({ pan: shop.pov.pan, tilt: shop.pov.tilt, zoom: shop.pov.zoom });
                        kakao.maps.event.removeListener(rv, 'init', initHandler);
                    };
                    kakao.maps.event.addListener(rv, 'init', initHandler);
                }
            } else {
                if (rvClient && rv) {
                    rvClient.getNearestPanoId(position, 50, (id) => {
                        if (id) rv.setPanoId(id, position);
                        else showToast("‚ö†Ô∏è Í∑ºÏ≤ò Î°úÎìúÎ∑∞ ÏóÜÏùå");
                    });
                }
            }
        }

        function closeRoadview() {
            document.getElementById('roadview-container').classList.remove('active');
        }

        function savePov() {
            if (!currentShop || !isKakaoLoaded) return;
            const pov = rv.getViewpoint();
            const pid = rv.getPanoId();
            const payload = {
                name: currentShop.n,
                pov: { id: pid, pan: parseFloat(pov.pan.toFixed(1)), tilt: parseFloat(pov.tilt.toFixed(1)), zoom: parseInt(pov.zoom) }
            };
            showToast("Ï†ÄÏû• Ï§ë...");
            fetch('/api/update_pov', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            }).then(r => r.json()).then(d => {
                if (d.success) {
                    showToast("‚úÖ DB Ï†ÑÏÜ° ÏôÑÎ£å");
                    alert("DB Ï†ÑÏÜ° ÏôÑÎ£å");
                    currentShop.pov = payload.pov;
                    // closeRoadview(); // User requested to keep it open
                    render();
                } else showToast("Ïã§Ìå®: " + d.message);
            });
        }

        function hideShop() {
            if (!currentShop) return;
            fetch('/api/hide_shop', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: currentShop.n })
            }).then(r => r.json()).then(d => {
                if (d.success) {
                    currentShop.isHidden = true;
                    showToast("Î™©Î°ùÏóêÏÑú Ïà®ÍπÄ (DB Ï†ÄÏû•Îê®)");
                    closeRoadview();
                    render();
                } else showToast("Ïã§Ìå®: " + d.message);
            });
        }

        function deleteShop() {
            if (!confirm("DBÏóêÏÑú ÏòÅÍµ¨ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Î≥µÍµ¨Î∂àÍ∞Ä)")) return;
            fetch('/api/delete_shop', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: currentShop.n })
            }).then(r => r.json()).then(d => {
                if (d.success) {
                    showToast("üóëÔ∏è ÏÇ≠Ï†ú ÏôÑÎ£å");
                    groupedShops = groupedShops.filter(s => s.n !== currentShop.n);
                    closeRoadview();
                    render();
                } else showToast("Ïã§Ìå®: " + d.message);
            });
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        function search(k) {
            setFilter('ALL');
            const found = groupedShops.find(s => s.n.includes(k));
            if (found) {
                openShop(found);
                updateFilterBtnText();
            }
            else showToast("Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå");
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c;
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180)
        }
    </script>
</body>

</html>