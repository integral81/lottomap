<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>KINOV Lotto Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        // SDK Error Handler (Defined first)
        function handleScriptError() {
            const mapDiv = document.getElementById('map');
            const usedKey = 'a6b27b6dab16c7e3459bb9589bf1269d';
            if (mapDiv) {
                mapDiv.innerHTML = `
                    <div style="padding:40px; text-align:center; color:#d32f2f;">
                        <h2 style="margin-bottom:10px;">ğŸ”‘ ì¹´ì¹´ì˜¤ ì§€ë„ ì¸ì¦ ì‹¤íŒ¨ (Domain Mismatch)</h2>
                        <p style="color:#333; font-size:16px;">ì¸í„°ë„· ì—°ê²°ì€ í™•ì¸ë˜ì—ˆìœ¼ë‚˜, ì¹´ì¹´ì˜¤ ì„œë²„ì—ì„œ <strong>ë„ë©”ì¸ ê±°ë¶€</strong>ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        
                        <div style="background:#fff; border:1px solid #d32f2f; padding:20px; border-radius:10px; text-align:left; margin: 20px auto; color:#333; max-width:600px; font-size:14px; line-height:1.6;">
                            <strong>âœ… ì´ ìˆœì„œëŒ€ë¡œ í•´ê²°í•´ ë³´ì„¸ìš”:</strong><br><br>
                            1. <strong>ë„ë©”ì¸ ì¶”ê°€ ë“±ë¡</strong>: ì¹´ì¹´ì˜¤ ì½˜ì†” [í”Œë«í¼ > Web] ì‚¬ì´íŠ¸ ë„ë©”ì¸ì— ì•„ë˜ ì£¼ì†Œë“¤ì´ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”:
                               <ul style="margin:5px 0 15px 20px;">
                                 <li><code>http://localhost:8000</code></li>
                                 <li><code>http://127.0.0.1:8000</code></li>
                               </ul>
                            2. <strong>ì˜¬ë°”ë¥¸ í‚¤ ì‚¬ìš© í™•ì¸</strong>: ì¹´ì¹´ì˜¤ ì½˜ì†” [ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ > ìš”ì•½ ì •ë³´]ì—ì„œ ë°˜ë“œì‹œ <strong>'JavaScript í‚¤'</strong>ë¥¼ ë³µì‚¬í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.<br><br>
                            <div style="background:#eee; padding:10px; border-radius:5px; border:1px dashed #999;">
                                <strong>í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ í‚¤:</strong> <code>${usedKey}</code>
                            </div>
                        </div>
                        <p style="color:#666;">ì„¤ì •ì„ ë³€ê²½í•œ í›„ ë¸Œë¼ìš°ì €ë¥¼ <strong>ìƒˆë¡œê³ ì¹¨(F5)</strong> í•´ì£¼ì„¸ìš”.</p>
                    </div>`;
            }
        }
    </script>
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a6b27b6dab16c7e3459bb9589bf1269d&libraries=clusterer"
        onerror="handleScriptError()"></script>
    <style>
        :root {
            --primary: #d32f2f;
            --secondary: #1976d2;
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #333333;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Pretendard', system-ui, sans-serif;
            background-color: var(--bg);
            overflow: hidden;
        }

        #app {
            display: flex !important;
            width: 100vw;
            height: 100vh;
            flex-direction: row;
            overflow: hidden;
        }

        #sidebar {
            width: 320px;
            height: 100%;
            background: var(--card);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            order: 1;
            /* PC: First */
        }

        #map {
            flex: 1;
            height: 100%;
            background: #eee;
            order: 2;
            /* PC: Second */
        }

        h1 {
            font-size: 20px;
            color: var(--primary);
            margin: 0 0 20px 0;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .section-title {
            font-weight: 700;
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            display: block;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="number"] {
            width: 70px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-apply {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }

        .btn-apply:hover {
            background-color: #b71c1c;
        }

        .stats-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: auto;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .stat-value {
            color: var(--primary);
            font-weight: 700;
        }

        .infowindow {
            padding: 12px;
            min-width: 200px;
            min-height: 120px;
            box-sizing: border-box;
            background: #fff;
        }

        .iw-title {
            font-weight: 700;
            font-size: 15px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .iw-addr {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }

        .iw-tag {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            background: #eee;
            font-size: 10px;
            margin: 0 2px 2px 0;
        }

        .iw-actions {
            display: flex !important;
            gap: 10px;
            margin-top: 15px;
            border-top: 1px dashed #eee;
            padding-top: 12px;
            visibility: visible !important;
        }

        .btn-iw {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
            border: 1px solid #ddd;
            background: #fff;
        }

        .btn-iw:hover {
            background: #f5f5f5;
        }

        .btn-navi {
            background: var(--secondary) !important;
            color: white !important;
            border: none !important;
        }

        .btn-navi:hover {
            background: #1565c0 !important;
        }

        .iw-addr-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9f9f9;
            padding: 5px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .iw-addr-box:hover {
            background: #f0f0f0;
        }

        /* GPS Pulse Animation */
        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .pulse {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(25, 118, 210, 0.5);
            border-radius: 50%;
            animation: pulse 2s infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* GPS Button Style */
        .gps-button {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: #fff;
            border: 2px solid var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .gps-button:hover {
            transform: scale(1.1);
            background: #f0f0f0;
        }

        .gps-button svg {
            width: 24px;
            height: 24px;
            fill: var(--primary);
            transition: transform 0.2s;
            -webkit-transition: transform 0.2s;
        }

        .gps-button.loading svg {
            animation: rotate 1s linear infinite;
            -webkit-animation: rotate 1s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @-webkit-keyframes rotate {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(360deg);
            }
        }

        /* Responsive Design for Mobile (Phone only) */
        @media (max-width: 640px) {
            #app {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                overflow: auto;
            }

            #sidebar {
                width: 100%;
                height: auto;
                flex: none;
                order: 2;
                /* Mobile: Sidebar Bottom */
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }

            #map {
                width: 100%;
                height: 400px;
                flex: none;
                order: 1;
                /* Mobile: Map Top */
            }
        }

        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: #333;
            padding: 14px 28px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            white-space: pre-wrap;
            text-align: left;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            max-width: 90vw;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 500;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-info {
            border-left: 5px solid var(--secondary);
        }

        .toast-error {
            border-left: 5px solid var(--primary);
        }

        .toast-success {
            border-left: 5px solid #48bb78;
        }

        /* GPS Pulse Animation (Works on all devices) */
        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .pulse {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(25, 118, 210, 0.5);
            border-radius: 50%;
            animation: pulse 2s infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* Gold Button & Modal */
        .btn-gold {
            background: linear-gradient(135deg, #FFD700, #FFA000);
            color: #333;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            animation: shiver 2s infinite;
        }

        @keyframes shiver {
            0% {
                transform: rotate(0deg);
            }

            5% {
                transform: rotate(2deg);
            }

            10% {
                transform: rotate(-2deg);
            }

            15% {
                transform: rotate(2deg);
            }

            20% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }

        .lucky-balls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
        }

        .ball {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .ball.one {
            background: #fbc400;
        }

        .ball.two {
            background: #69c8f2;
        }

        .ball.three {
            background: #ff7272;
        }

        .ball.four {
            background: #aaaaaa;
        }

        .ball.five {
            background: #b0d840;
        }
    </style>
</head>

<body>
    <div id="toast-container"></div>
    <div id="app">
        <div id="sidebar">
            <h1>ğŸ° KINOV Lotto Map</h1>
            <div class="section">
                <span class="section-title">ğŸ“… íšŒì°¨ í•„í„° (Round)</span>
                <div class="input-row">
                    <input type="number" id="minRound" value="262">
                    <span>~</span>
                    <input type="number" id="maxRound" value="1210">
                </div>
            </div>
            <div class="section">
                <span class="section-title">ğŸ† ë‹¹ì²¨ íšŸìˆ˜ í•„í„° (Frequency)</span>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="freq5" checked> ğŸŒŸ 5íšŒ ì´ìƒ</label>
                    <label class="checkbox-item"><input type="checkbox" id="freq3" checked> ğŸ”´ 3~4íšŒ</label>
                    <label class="checkbox-item"><input type="checkbox" id="freq1" checked> ğŸ”µ 2íšŒ ì´í•˜</label>
                </div>
            </div>
            <div class="section">
                <span class="section-title">ğŸ² ë‹¹ì²¨ ë°©ì‹ (Method)</span>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="methodAuto" checked> ìë™</label>
                    <label class="checkbox-item"><input type="checkbox" id="methodManual" checked> ìˆ˜ë™</label>
                    <label class="checkbox-item"><input type="checkbox" id="methodSemi" checked> ë°˜ìë™</label>
                </div>
            </div>
            <button class="btn-apply" onclick="applyFilters()">ì ìš©í•˜ê¸°</button>
            <div class="stats-card">
                <div class="stat-item"><span>ì „ì²´ ë°ì´í„°</span> <span id="totalDataCount">0</span></div>
                <div class="stat-item"><span>í•„í„°ë§ ê²°ê³¼</span> <span id="filteredCount" class="stat-value">0</span></div>

                <!-- Fallback file loader -->
                <div id="manualLoader"
                    style="display:none; margin-top:10px; padding-top:10px; border-top:1px dashed #ccc;">
                    <p style="font-size:11px; color:#666; margin-bottom:5px;">âš ï¸ ìë™ ë¡œë“œ ì‹¤íŒ¨ ì‹œ íŒŒì¼ì„ ì§ì ‘ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
                    <input type="file" id="fileInput" accept=".json" style="display:none;"
                        onchange="handleFileSelect(event)">
                    <button class="btn-apply" style="background:#333; font-size:12px; padding:8px;"
                        onclick="document.getElementById('fileInput').click()">íŒŒì¼ ì§ì ‘ ì„ íƒí•˜ê¸° (lotto_data.json)</button>
                </div>
            </div>
        </div>
        <div id="map">
            <div class="gps-button" onclick="requestMyLocation()" title="ë‚´ ìœ„ì¹˜ ì°¾ê¸°">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z" />
                </svg>
            </div>
        </div>
        <div id="adModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal()">&times;</span>
                <div id="adContent">
                    <h2 style="color:#d32f2f;">âœ¨ ë‹¹ì²¨ ê¸°ìš´ ë¶„ì„ ì¤‘... âœ¨</h2>
                    <div style="margin:20px 0; font-size:50px;">â³</div>
                    <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.<br>ëª…ë‹¹ì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    <div style="margin-top:20px; color:#666; font-size:12px;">(ë‹¹ì²¨ ê¸°ìš´ì„ ëª¨ìœ¼ëŠ” ì¤‘ì…ë‹ˆë‹¤...)</div>
                </div>
                <div id="resultContent" style="display:none;">
                    <h2 style="color:#1976d2;">ğŸ‰ ì¶”ì²œ ë²ˆí˜¸ ìƒì„± ì™„ë£Œ! ğŸ‰</h2>
                    <p style="font-size:13px; color:#666; margin-bottom:10px;">
                        ì´ ëª…ë‹¹ì€ ê³¼ê±° <strong id="paramHCount" style="color:#d32f2f;">0</strong>ë²ˆì˜ 1ë“±ì„ ë°°ì¶œí–ˆìŠµë‹ˆë‹¤.<br>
                        (<span id="paramRounds"></span> ë“±)
                    </p>
                    <div class="lucky-balls" id="luckyBalls">
                        <!-- Balls go here -->
                    </div>
                    <p style="font-size:12px; color:#888;">* ì¬ë¯¸ë¡œë§Œ ë´ì£¼ì„¸ìš”. ê³¼ë„í•œ êµ¬ë§¤ëŠ” ê¸ˆë¬¼!</p>
                    <button class="btn-apply btn-navi" style="margin-top:10px;" onclick="goToShop()">
                        ğŸš— ì§€ê¸ˆ ë‹¹ì¥ ì‚¬ëŸ¬ ê°€ê¸° (ê¸¸ì°¾ê¸°)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map, clusterer, allData = [], markers = [];
        let currentInfoWindow = null; // Track the currently open InfoWindow


        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    processLoadedData(data);
                    document.getElementById('manualLoader').style.display = 'none';
                    alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! (' + data.length + 'ê±´)');
                } catch (err) {
                    alert('íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function processLoadedData(data) {
            allData = data;

            // Calculate win count per shop (Name + Address)
            const shopWins = {};
            data.forEach(item => {
                const key = (item.n || '').trim() + '|' + (item.a || '').trim();
                shopWins[key] = (shopWins[key] || 0) + 1;
            });
            // Attach individual shop win count to each record
            let highWinCount = 0;
            data.forEach(item => {
                const key = (item.n || '').trim() + '|' + (item.a || '').trim();
                item.totalWins = shopWins[key];
                if (item.totalWins >= 5) highWinCount++;
            });
            console.log('Grouped Shops:', Object.keys(shopWins).length);
            console.log('Records with 5+ wins:', highWinCount);

            document.getElementById('totalDataCount').innerText = data.length.toLocaleString();
            if (data.length > 0) {
                const rounds = data.map(d => d.r);
                const maxR = Math.max(...rounds);
                const minR = Math.min(...rounds);
                document.getElementById('maxRound').value = maxR;
                document.getElementById('minRound').value = minR;
            }
            applyFilters();
        }

        window.onload = function () {
            if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
                handleScriptError();
                return;
            }

            const mapContainer = document.getElementById('map');
            const mapOption = { center: new kakao.maps.LatLng(36.2683, 127.6358), level: 12 };
            map = new kakao.maps.Map(mapContainer, mapOption);

            clusterer = new kakao.maps.MarkerClusterer({
                map: map, averageCenter: true, minLevel: 10,
                styles: [{
                    width: '40px', height: '40px', background: 'rgba(211, 47, 47, 0.8)',
                    color: '#fff', textAlign: 'center', lineHeight: '40px',
                    borderRadius: '20px', fontWeight: 'bold'
                }]
            });

            loadData();
        };

        function loadData() {
            const countEl = document.getElementById('totalDataCount');
            console.log('Loading data...');

            Promise.all([
                fetch('lotto_data.json?v=' + Date.now()).then(res => res.json()),
                fetch('lotto_history.json?v=' + Date.now()).then(res => res.json())
            ])
                .then(([lottoData, historyData]) => {
                    window.lottoHistory = historyData; // Global variable
                    processLoadedData(lottoData);
                })
                .catch(err => {
                    console.error('Data load failed:', err);
                    countEl.innerHTML = `<span style="color:red; font-size:11px; cursor:help;" title="${err.message}">ë¡œë“œ ì‹¤íŒ¨ (${err.name})</span>`;
                    document.getElementById('manualLoader').style.display = 'block';
                    alert('ë°ì´í„° íŒŒì¼ ë¡œë“œ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + err.message);
                });
        }

        /**
         * ğŸ”® Lucky Number Generator Algorithm
         * 1. Store Luck (50%): Numbers that won in this store's history.
         * 2. Global Hot (30%): Most frequent numbers in recent 100 rounds (Simulated for now).
         * 3. Random (20%): Pure random luck.
         */
        function generateLuckyNumbers(storeWins) {
            // storeWins: Array of winning rounds for this store e.g., [{r: 1000, m: 'ìë™'}, ...]
            const history = window.lottoHistory || {};
            const numberWeights = {};

            // Initialize weights
            for (let i = 1; i <= 45; i++) numberWeights[i] = 1; // Base weight

            // 1. Analyze Store History
            let winningNumbers = [];
            storeWins.forEach(win => {
                const round = win.r;
                if (history[round]) {
                    const nums = history[round];
                    winningNumbers = [...winningNumbers, ...nums];
                    nums.forEach(n => {
                        numberWeights[n] += 5; // Boost weight for numbers that appeared in this store's winning rounds
                    });
                }
            });

            // 2. Select 6 numbers based on weights
            const selected = new Set();
            while (selected.size < 6) {
                const n = weightedRandom(numberWeights);
                selected.add(n);
            }

            return {
                numbers: Array.from(selected).sort((a, b) => a - b),
                historyCount: storeWins.length,
                relatedRounds: storeWins.map(w => w.r).slice(0, 5) // Top 5 recent rounds
            };
        }

        function weightedRandom(weights) {
            let sum = 0;
            for (let i in weights) sum += weights[i];
            let rand = Math.random() * sum;
            for (let i in weights) {
                rand -= weights[i];
                if (rand < 0) return parseInt(i);
            }
            return Math.floor(Math.random() * 45) + 1; // Fallback
        }

        function applyFilters() {
            const minR = parseInt(document.getElementById('minRound').value) || 0;
            const maxR = parseInt(document.getElementById('maxRound').value) || 9999;
            const auto = document.getElementById('methodAuto').checked;
            const manual = document.getElementById('methodManual').checked;
            const semi = document.getElementById('methodSemi').checked;

            // Frequency Filters
            const f5 = document.getElementById('freq5').checked;
            const f3 = document.getElementById('freq3').checked;
            const f1 = document.getElementById('freq1').checked;

            const filtered = allData.filter(d => {
                const rMatch = d.r >= minR && d.r <= maxR;
                let mMatch = false;
                if (auto && d.m.includes('ìë™')) mMatch = true;
                if (manual && d.m.includes('ìˆ˜ë™')) mMatch = true;
                if (semi && d.m.includes('ë°˜ìë™')) mMatch = true;

                let fMatch = false;
                if (f5 && d.totalWins >= 5) fMatch = true;
                if (f3 && d.totalWins >= 3 && d.totalWins <= 4) fMatch = true;
                if (f1 && d.totalWins <= 2) fMatch = true;

                return rMatch && mMatch && fMatch;
            });

            document.getElementById('filteredCount').innerText = filtered.length.toLocaleString();
            updateMarkers(filtered);
        }

        function updateMarkers(data) {
            clusterer.clear();
            markers.forEach(m => m.setMap(null));
            markers = [];

            // To avoid duplicate markers for the same shop at the same location,
            // we need to group the filtered data by shop (lat, lng, name, address)
            // and then create a single marker for each unique shop.
            const uniqueShops = {};
            data.forEach(d => {
                const key = `${d.lat}_${d.lng}_${d.n}_${d.a}`;
                if (!uniqueShops[key]) {
                    uniqueShops[key] = {
                        n: d.n,
                        a: d.a,
                        lat: d.lat,
                        lng: d.lng,
                        totalWins: d.totalWins, // This is the total wins for the shop
                        rounds: [] // To store individual round details for infowindow
                    };
                }
                uniqueShops[key].rounds.push({ r: d.r, m: d.m });
            });

            Object.values(uniqueShops).forEach(shop => {
                let markerImg = null;
                // Tiered Styles
                if (shop.totalWins >= 5) {
                    // Legendary Gold Star
                    markerImg = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
                        new kakao.maps.Size(24, 35)
                    );
                } else if (shop.totalWins >= 3) {
                    // Professional Red
                    markerImg = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/2018/pc/img/marker_spot.png',
                        new kakao.maps.Size(24, 35),
                        { offset: new kakao.maps.Point(12, 35) }
                    );
                }

                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(shop.lat, shop.lng),
                    image: markerImg
                });

                const sortedRounds = shop.rounds.sort((a, b) => b.r - a.r);
                const roundTagsHtml = sortedRounds.map(r => `<span class="iw-tag">${r.r}íšŒ(${r.m})</span>`).join('');

                const safeAddr = (shop.a || "").replace(/'/g, "\\'").replace(/\n/g, " ");
                const safeName = (shop.n || "").replace(/'/g, "\\'").replace(/\n/g, " ");

                const content = `
                    <div class="infowindow">
                        <div class="iw-title">${shop.n} ${shop.totalWins >= 5 ? 'ğŸŒŸ' : ''}</div>
                        <div class="iw-addr-box" onclick="copyToClipboard('${safeAddr}')" title="ì£¼ì†Œ ë³µì‚¬">
                            <span class="iw-addr">${shop.a}</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="#666"><path d="M16 1H4c-1.11 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        </div>
                        <div style="font-weight:bold; color:red; margin-bottom:5px;">ì´ ${shop.totalWins}íšŒ ë‹¹ì²¨</div>
                        <div class="iw-details">${roundTagsHtml}</div>
                        <button class="btn-gold" onclick="openAdModal('${safeName}', '${safeAddr}', ${shop.lat}, ${shop.lng}, ${shop.totalWins})">
                            âœ¨ ì´ë²ˆ ì£¼ 1ë“± ì¶”ì²œ ë²ˆí˜¸ ë°›ê¸°
                        </button>
                        <div class="iw-actions">
                            <button class="btn-iw btn-navi" onclick="openDirections(${shop.lat}, ${shop.lng}, '${safeName}')">
                                ğŸš— ê¸¸ì°¾ê¸°
                            </button>
                        </div>
                    </div>
                `;

                const infowindow = new kakao.maps.InfoWindow({
                    content: content,
                    removable: true
                });

                kakao.maps.event.addListener(marker, 'click', () => {
                    // Close previous InfoWindow if exists
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }

                    infowindow.open(map, marker);
                    currentInfoWindow = infowindow; // Update current
                });

                markers.push(marker);
            });
            clusterer.addMarkers(markers);
        }

        /**
         * GPS Location Service Module
         * Handles user positioning, nearest shop calculation, and UI feedback (Toasts).
         */
        let myLocationMarker = null;

        function requestMyLocation() {
            if (!navigator.onLine) {
                showToast("ğŸŒ ì¸í„°ë„· ì—°ê²°ì´ ëŠê²¨ ìˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.", "error");
                return;
            }

            if (!navigator.geolocation) {
                showToast("ğŸš« ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
                return;
            }

            const gpsBtn = document.querySelector('.gps-button');
            if (gpsBtn) gpsBtn.classList.add('loading');

            // GPS Permission & Fetch
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    if (gpsBtn) gpsBtn.classList.remove('loading');
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const center = new kakao.maps.LatLng(lat, lng);

                    map.setCenter(center);

                    // Close all infowindows to clear the view
                    if (typeof clusterer !== 'undefined') {
                        // There's no direct 'closeAll' on clusterer, but we can just let it be
                    }

                    // Add/Update Blue Dot Marker
                    if (!myLocationMarker) {
                        myLocationMarker = new kakao.maps.CustomOverlay({
                            position: center,
                            content: `
                                <div style="position:relative;">
                                    <div class="pulse"></div>
                                    <div style="width:16px; height:16px; background:#1976d2; border:2px solid #fff; border-radius:50%; box-shadow:0 0 10px rgba(0,0,0,0.5); position:relative; z-index:2; transform: translate(-50%, -50%);"></div>
                                </div>
                            `,
                            map: map,
                            zIndex: 1001
                        });
                    } else {
                        myLocationMarker.setPosition(center);
                        myLocationMarker.setMap(map);
                    }

                    findNearestShop(lat, lng);
                },
                (err) => {
                    console.error("GPS Error:", err);
                    if (gpsBtn) gpsBtn.classList.remove('loading');
                    let msg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    switch (err.code) {
                        case 1:
                            msg = "ìœ„ì¹˜ ì •ë³´ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.";
                            break;
                        case 2:
                            msg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPSê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.";
                            break;
                        case 3:
                            msg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”.";
                            break;
                    }
                    showToast(msg, "error");
                },
                { enableHighAccuracy: false, timeout: 15000, maximumAge: 0 }
            );
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // --- Monetization & Logic ---
        let currentShopData = null; // Store temp data for the modal

        function openAdModal(name, addr, lat, lng, totalWins) {
            // Re-filter allData for this specific shop to get rounds.
            const rounds = allData.filter(d => d.n === name && d.a === addr).map(d => ({ r: d.r, m: d.m }));

            currentShopData = { name, addr, lat, lng, totalWins, rounds };

            // Show Modal
            const modal = document.getElementById('adModal');
            const adContent = document.getElementById('adContent');
            const resultContent = document.getElementById('resultContent');

            modal.style.display = 'flex';
            adContent.style.display = 'block';
            resultContent.style.display = 'none';

            // Simulate Ad Delay (3 seconds)
            setTimeout(() => {
                showResult();
            }, 3000);
        }

        function closeModal() {
            document.getElementById('adModal').style.display = 'none';
        }

        function showResult() {
            document.getElementById('adContent').style.display = 'none';
            document.getElementById('resultContent').style.display = 'block';

            // Logic
            const result = generateLuckyNumbers(currentShopData.rounds);

            // Render
            document.getElementById('paramHCount').innerText = result.historyCount;
            document.getElementById('paramRounds').innerText = result.relatedRounds.join(', ') + (result.historyCount > 5 ? '...' : '');

            const ballContainer = document.getElementById('luckyBalls');
            ballContainer.innerHTML = '';

            result.numbers.forEach(n => {
                const ball = document.createElement('div');
                ball.className = 'ball ' + getBallColor(n);
                ball.innerText = n;
                ballContainer.appendChild(ball);
            });
        }

        function getBallColor(n) {
            if (n <= 10) return 'one';
            if (n <= 20) return 'two';
            if (n <= 30) return 'three';
            if (n <= 40) return 'four';
            return 'five';
        }

        function goToShop() {
            if (!currentShopData) return;
            openDirections(currentShopData.lat, currentShopData.lng, currentShopData.name);
            closeModal();
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('adModal');
            if (event.target == modal) {
                closeModal();
            }
        }



        function findNearestShop(lat, lng) {
            if (typeof allData === 'undefined' || allData.length === 0) return;

            // Sort all shops by distance
            const sortedShops = allData.map(shop => {
                return {
                    ...shop,
                    distance: getDistance(lat, lng, shop.lat, shop.lng)
                };
            }).sort((a, b) => a.distance - b.distance);

            // Take top 5
            const top5 = sortedShops.slice(0, 5);

            if (top5.length > 0) {
                let msg = "ğŸ“ ì£¼ë³€ 1ë“± ë°°ì¶œì  (ê°€ê¹Œìš´ ìˆœ)\n";
                top5.forEach((shop, index) => {
                    const distStr = shop.distance < 1 ? Math.round(shop.distance * 1000) + "m" : shop.distance.toFixed(1) + "km";
                    msg += `${index + 1}. ${shop.n} (${distStr})\n`;
                });
                showToast(msg, "success");

                // Adaptive Zoom: Fit my location and top nearest shops
                const bounds = new kakao.maps.LatLngBounds();
                bounds.extend(new kakao.maps.LatLng(lat, lng));

                // Only include shops within 20km for the initial view to avoid extreme zoom out
                top5.forEach(shop => {
                    if (shop.distance < 20) {
                        bounds.extend(new kakao.maps.LatLng(shop.lat, shop.lng));
                    }
                });

                map.setBounds(bounds, 80, 80, 80, 80); // generous padding
            }
        }

        function showToast(message, type = "info") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerText = message;

            container.appendChild(toast);

            // Force reflow
            toast.offsetHeight;

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode === container) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast("ğŸ“‹ ì£¼ì†Œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            } catch (err) {
                showToast("ë³µì‚¬ ì‹¤íŒ¨", "error");
            }
            document.body.removeChild(textarea);
        }

        function openDirections(lat, lng, name) {
            const url = `https://map.kakao.com/link/to/${encodeURIComponent(name)},${lat},${lng}`;
            window.open(url, '_blank');
        }
    </script>
</body>

</html>