<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>KINOV ë¡œë˜ ëª…ë‹¹ ì§€ë„</title>
    <!-- Library for QR Code Scanning -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="ì „êµ­ ë¡œë˜ 1ë“± ë‹¹ì²¨ íŒë§¤ì ì„ ì§€ë„ì—ì„œ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”. ë‚´ ì£¼ë³€ ëª…ë‹¹ ì°¾ê¸°, ë¡œë˜ ë²ˆí˜¸ ë¬´ë£Œ ì¶”ì²œ ì„œë¹„ìŠ¤ ì œê³µ.">
    <meta name="keywords" content="ë¡œë˜, ë¡œë˜ëª…ë‹¹, ë¡œë˜ì§€ë„, ë¡œë˜1ë“±, ë¡œë˜ë‹¹ì²¨ë²ˆí˜¸, ë¡œë˜íŒë§¤ì , KINOV">
    <meta name="author" content="KINOV">

    <!-- Open Graph (KakaoTalk, Facebook, etc.) -->
    <meta property="og:title" content="ğŸ° KINOV ë¡œë˜ ëª…ë‹¹ ì§€ë„">
    <meta property="og:description" content="ì—­ëŒ€ 1ë“± ë‹¹ì²¨ íŒë§¤ì ì„ í•œëˆˆì—! ë‹¹ì‹ ì˜ í–‰ìš´ì„ ì°¾ì•„ë³´ì„¸ìš”.">
    <meta property="og:image" content="https://www.k-inov.co.kr/assets/img/lotto_share_thumb.png">
    <!-- Update with actual image URL if available, or use a placeholder -->
    <meta property="og:url" content="https://integral81.github.io/lotto_kakaomap/">
    <meta property="og:type" content="website">

    <!-- Favicon (Using Emoji for now if no file exists) -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ°</text></svg>">
    <script>
        // SDK Error Handler (Defined first)
        function handleScriptError() {
            const mapDiv = document.getElementById('map');
            const usedKey = 'a6b27b6dab16c7e3459bb9589bf1269d';
            if (mapDiv) {
                mapDiv.innerHTML = `
                    <div style="padding:40px; text-align:center; color:#d32f2f;">
                        <h2 style="margin-bottom:10px;">ğŸ”‘ ì¹´ì¹´ì˜¤ ì§€ë„ ì¸ì¦ ì‹¤íŒ¨ (Domain Mismatch)</h2>
                        <p style="color:#333; font-size:16px;">ì¸í„°ë„· ì—°ê²°ì€ í™•ì¸ë˜ì—ˆìœ¼ë‚˜, ì¹´ì¹´ì˜¤ ì„œë²„ì—ì„œ <strong>ë„ë©”ì¸ ê±°ë¶€</strong>ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        
                        <div style="background:#fff; border:1px solid #d32f2f; padding:20px; border-radius:10px; text-align:left; margin: 20px auto; color:#333; max-width:600px; font-size:14px; line-height:1.6;">
                            <strong>âœ… ì´ ìˆœì„œëŒ€ë¡œ í•´ê²°í•´ ë³´ì„¸ìš”:</strong><br><br>
                            1. <strong>ë„ë©”ì¸ ì¶”ê°€ ë“±ë¡</strong>: ì¹´ì¹´ì˜¤ ì½˜ì†” [í”Œë«í¼ > Web] ì‚¬ì´íŠ¸ ë„ë©”ì¸ì— ì•„ë˜ ì£¼ì†Œë“¤ì´ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”:
                               <ul style="margin:5px 0 15px 20px;">
                                 <li><code>http://localhost:8000</code></li>
                                 <li><code>http://127.0.0.1:8000</code></li>
                               </ul>
                            2. <strong>ì˜¬ë°”ë¥¸ í‚¤ ì‚¬ìš© í™•ì¸</strong>: ì¹´ì¹´ì˜¤ ì½˜ì†” [ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ > ìš”ì•½ ì •ë³´]ì—ì„œ ë°˜ë“œì‹œ <strong>'JavaScript í‚¤'</strong>ë¥¼ ë³µì‚¬í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.<br><br>
                            <div style="background:#eee; padding:10px; border-radius:5px; border:1px dashed #999;">
                                <strong>í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ í‚¤:</strong> <code>${usedKey}</code>
                            </div>
                        </div>
                        <p style="color:#666;">ì„¤ì •ì„ ë³€ê²½í•œ í›„ ë¸Œë¼ìš°ì €ë¥¼ <strong>ìƒˆë¡œê³ ì¹¨(F5)</strong> í•´ì£¼ì„¸ìš”.</p>
                    </div>`;
            }
        }
    </script>
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a6b27b6dab16c7e3459bb9589bf1269d&libraries=clusterer"
        onerror="handleScriptError()"></script>
    <!-- Kakao SDK for Sharing -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"></script>
    <style>
        :root {
            --primary: #d32f2f;
            --secondary: #1976d2;
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #333333;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Pretendard', system-ui, sans-serif;
            background-color: var(--bg);
            overflow: hidden;
        }

        #app {
            display: flex !important;
            width: 100vw;
            height: 100vh;
            flex-direction: row;
            overflow: hidden;
        }

        #sidebar {
            width: 320px;
            height: 100%;
            background: var(--card);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            order: 1;
            /* PC: First */
        }

        #map {
            flex: 1;
            height: 100%;
            background: #eee;
            order: 2;
            /* PC: Second */
        }

        h1 {
            font-size: 20px;
            color: var(--primary);
            margin: 0 0 20px 0;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .section-title {
            font-weight: 700;
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            display: block;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="number"] {
            width: 70px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-apply {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }

        .btn-apply:hover {
            background-color: #b71c1c;
        }

        .stats-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: auto;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .stat-value {
            color: var(--primary);
            font-weight: 700;
        }

        .infowindow {
            padding: 12px;
            min-width: 200px;
            min-height: 120px;
            box-sizing: border-box;
            background: #fff;
        }

        .iw-title {
            font-weight: 700;
            font-size: 15px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .iw-addr {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }

        .iw-tag {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            background: #eee;
            font-size: 10px;
            margin: 0 2px 2px 0;
        }

        .iw-actions {
            display: flex !important;
            gap: 10px;
            margin-top: 15px;
            border-top: 1px dashed #eee;
            padding-top: 12px;
            visibility: visible !important;
        }

        .btn-iw {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
            border: 1px solid #ddd;
            background: #fff;
        }

        .btn-iw:hover {
            background: #f5f5f5;
        }

        .btn-navi {
            background: var(--secondary) !important;
            color: white !important;
            border: none !important;
        }

        .btn-navi:hover {
            background: #1565c0 !important;
        }

        .iw-addr-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9f9f9;
            padding: 5px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .iw-addr-box:hover {
            background: #f0f0f0;
        }

        /* GPS Pulse Animation */
        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .pulse {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(25, 118, 210, 0.5);
            border-radius: 50%;
            animation: pulse 2s infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* OMR Grid Styles */
        .omr-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            /* Above everything */
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .omr-modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .omr-modal-content {
            background: #fff;
            width: 90%;
            max-width: 350px;
            max-height: 70vh;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow-y: auto;
        }

        .omr-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin: 10px 0;
        }

        .omr-number {
            aspect-ratio: 0.6;
            /* Rectangular like OMR */
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border-radius: 2px;
            background: #f9f9f9;
            color: #ccc;
            font-weight: bold;
        }

        .omr-number.marked {
            background: #000;
            color: #fff;
            border-color: #000;
        }

        .omr-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }

        .omr-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .floating-btn {
            position: fixed;
            width: 50px;
            height: 50px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .floating-btn:hover {
            transform: scale(1.1);
            background: #f0f0f0;
        }

        /* GPS Button Position */
        .gps-button {
            bottom: 30px;
            right: 30px;
            background: var(--primary);
            color: white;
            border: none;
        }

        .gps-button svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        /* Loading state for GPS */
        .gps-button.loading svg {
            animation: rotate 1s linear infinite;
        }

        /* Menu Button Style */
        .menu-btn {
            top: 20px;
            right: 20px;
            border: 2px solid var(--secondary);
        }

        .hamburger-icon {
            width: 20px;
            height: 14px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hamburger-icon span {
            display: block;
            width: 100%;
            height: 2px;
            background: var(--secondary);
            border-radius: 2px;
            transition: all 0.3s;
        }

        .menu-btn.active .hamburger-icon span:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }

        .menu-btn.active .hamburger-icon span:nth-child(2) {
            opacity: 0;
        }

        .menu-btn.active .hamburger-icon span:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }

        /* Side Nav Drawer */
        .side-nav {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: white;
            z-index: 9000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
        }

        .side-nav.open {
            transform: translateX(0);
        }

        .side-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 8999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .side-nav-overlay.show {
            display: block;
            opacity: 1;
        }

        .side-nav-header {
            padding: 25px 20px;
            background: linear-gradient(135deg, var(--secondary), #1565c0);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .side-nav-header .logo {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .close-nav {
            font-size: 28px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .close-nav:hover {
            opacity: 1;
        }

        .side-nav-body {
            padding: 20px 0;
            flex: 1;
            overflow-y: auto;
        }

        .menu-category {
            padding: 10px 20px;
            font-size: 11px;
            font-weight: 700;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 4px solid transparent;
        }

        .menu-item:hover {
            background: #f8f9fa;
            border-left-color: var(--secondary);
        }

        .menu-item .m-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .menu-item .m-text {
            font-size: 15px;
            font-weight: 600;
            color: #444;
        }

        .side-nav-footer {
            padding: 20px;
            font-size: 12px;
            color: #999;
            text-align: center;
            border-top: 1px solid #eee;
        }

        /* Mobile specific adjustments */
        @media (max-width: 640px) {
            .side-nav {
                width: 80%;
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @-webkit-keyframes rotate {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(360deg);
            }
        }

        /* Responsive Design for Mobile (Phone only) */
        @media (max-width: 640px) {
            #app {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                overflow: auto;
            }

            #sidebar {
                width: 100%;
                height: auto;
                flex: none;
                order: 2;
                /* Mobile: Sidebar Bottom */
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }

            #map {
                width: 100%;
                height: 400px;
                flex: none;
                order: 1;
                /* Mobile: Map Top */
                position: relative;
                /* Anchor for absolute buttons */
            }

            /* Move floating buttons to bottom-right of map area on mobile */
            .gps-button {
                position: absolute !important;
                bottom: 20px !important;
                right: 20px !important;
                z-index: 1001;
            }

            .menu-btn {
                position: absolute !important;
                top: 20px !important;
                right: 20px !important;
                z-index: 1001;
            }
        }

        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: #333;
            padding: 14px 28px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            white-space: pre-wrap;
            text-align: left;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            max-width: 90vw;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 500;
            position: relative;
            padding-right: 45px;
            /* Space for close button */
        }

        .toast-close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #999;
            transition: color 0.2s;
            line-height: 1;
        }

        .toast-close:hover {
            color: #333;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-info {
            border-left: 5px solid var(--secondary);
        }

        .toast-error {
            border-left: 5px solid var(--primary);
        }

        .toast-success {
            border-left: 5px solid #48bb78;
        }

        /* GPS Pulse Animation (Works on all devices) */
        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .pulse {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(25, 118, 210, 0.5);
            border-radius: 50%;
            animation: pulse 2s infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* Gold Button & Modal */
        .btn-gold {
            background: linear-gradient(135deg, #FFD700, #FFA000);
            color: #333;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            animation: shiver 2s infinite;
        }

        @keyframes shiver {
            0% {
                transform: rotate(0deg);
            }

            5% {
                transform: rotate(2deg);
            }

            10% {
                transform: rotate(-2deg);
            }

            15% {
                transform: rotate(2deg);
            }

            20% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            cursor: pointer;
            /* Critical for iOS to recognize clicks on transparent/overlay elements */
        }

        .modal-content {
            background-color: transparent;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 70vh;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            overflow-y: auto;
            cursor: default;
            /* Reset cursor for content area */
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 32px;
            cursor: pointer;
            color: white;
            z-index: 10;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .modal-close:hover {
            transform: scale(1.1);
        }

        .lucky-balls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
        }

        .ball {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .ball.one {
            background: #fbc400;
        }

        .ball.two {
            background: #69c8f2;
        }

        .ball.three {
            background: #ff7272;
        }

        .ball.four {
            background: #aaaaaa;
        }

        .ball.five {
            background: #b0d840;
        }

        /* Mini Ball for Recent Rounds */
        .mini-ball {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 800;
            color: white;
            margin-right: 3px;
            box-shadow: inset -2px -2px 4px rgba(0, 0, 0, 0.2);
        }

        .mini-ball.one {
            background: #fbc400;
            color: #333;
            text-shadow: none;
        }

        .mini-ball.two {
            background: #69c8f2;
        }

        .mini-ball.three {
            background: #ff7272;
        }

        .mini-ball.four {
            background: #aaaaaa;
        }

        .mini-ball.five {
            background: #b0d840;
        }

        .recent-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 5px 8px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .recent-round-num {
            font-size: 11px;
            font-weight: bold;
            color: #555;
            width: 45px;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            #app {
                flex-direction: column !important;
            }

            #sidebar {
                width: 100% !important;
                height: auto !important;
                max-height: 50vh !important;
                order: 2 !important;
                padding: 15px !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }

            #map {
                order: 1 !important;
                height: 50vh !important;
                min-height: 300px !important;
            }

            h1 {
                font-size: 18px !important;
                margin: 0 0 15px 0 !important;
            }

            .section {
                margin-bottom: 15px !important;
                padding-bottom: 15px !important;
            }

            .section-title {
                font-size: 13px !important;
            }

            .btn-apply {
                font-size: 14px !important;
                padding: 12px !important;
            }

            .stats-card {
                font-size: 12px !important;
                padding: 12px !important;
            }

            .modal-content {
                width: 95% !important;
                max-width: 95% !important;
                margin: 0 auto !important;
            }

            #adContent,
            #resultContent {
                padding: 15px !important;
                width: 100% !important;
                box-sizing: border-box !important;
                /* Ensure padding doesn't add to width */
            }

            .modal-close {
                right: 10px !important;
                top: 10px !important;
            }
        }

        /* Selection Menu Styles (Global) */
        .selection-menu {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            margin-top: 10px;
        }

        .selection-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: left;
        }

        .selection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background: white;
        }

        .selection-icon {
            font-size: 24px;
            background: #f0f4f8;
            min-width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selection-info {
            flex: 1;
        }

        .selection-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
            display: block;
        }

        .selection-desc {
            font-size: 12px;
            color: #666;
            display: block;
        }

        /* Loading Animation */
        .loader-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fae100;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Dream Mode Styles */
        .dream-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .dream-tag {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dream-tag:hover {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .dream-input-box {
            display: flex;
            gap: 5px;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .dream-input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            text-align: center;
            outline: none;
        }

        .btn-dream-submit {
            background: #fae100;
            color: #333;
            border: none;
            padding: 0 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Input Container for Dream/Zodiac */
        .input-container {
            display: none;
            width: 100%;
            text-align: center;
        }

        .btn-sm {
            background-color: #555;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-sm:hover {
            background-color: #333;
        }

        /* Zodiac Mode Styles */
        .zodiac-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 320px;
            margin: 0 auto;
        }

        .zodiac-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            aspect-ratio: 1;
            /* Square shape */
        }

        .zodiac-item:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .zodiac-icon {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .zodiac-name {
            font-size: 12px;
            color: white;
            font-weight: bold;
        }

        .horoscope-text-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            color: white;
            font-size: 14px;
            line-height: 1.5;
            border-left: 4px solid #fae100;
        }

        /* QR Scanner Modal Styles */
        #qrModal {
            z-index: 10000;
        }

        .qr-modal-content {
            background: #fff;
            max-width: 600px;
            width: 95%;
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        #qr-reader {
            width: 100%;
            border: none !important;
        }

        #qr-reader__dashboard {
            padding: 20px !important;
        }

        #qr-reader__status_span {
            font-size: 14px !important;
            font-weight: bold !important;
        }

        .qr-result-container {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            overflow-y: auto;
        }

        .qr-game-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .qr-prize-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .prize-none {
            background: #999;
        }

        .prize-win {
            background: #ff5252;
        }

        /* Frequency Dashboard Styles */
        .freq-modal-content {
            background: #fff;
            max-width: 500px;
            width: 90%;
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 85vh;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        @media (max-width: 640px) {
            .freq-modal-content {
                width: 95%;
                max-height: 90vh;
                border-radius: 15px;
            }

            .freq-body {
                padding: 15px 10px;
            }

            .freq-row {
                gap: 8px;
            }

            .freq-ball {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }

            .freq-bar-container {
                height: 10px;
            }
        }

        .freq-header {
            background: #80cbc4;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .freq-header .back-btn {
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .freq-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .freq-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 15px;
        }

        .freq-ball {
            width: 32px;
            height: 32px;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .freq-bar-container {
            flex: 1;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .freq-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #444, #777);
            border-radius: 6px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .freq-disclaimer {
            font-size: 11px;
            color: #ff5252;
            margin-top: 5px;
            font-weight: 500;
        }

        .freq-count {
            width: 35px;
            text-align: right;
            font-size: 0.95rem;
            color: #333;
            font-weight: 500;
        }

        .freq-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .freq-filter-row {
            display: flex;
            gap: 15px;
            font-size: 0.95rem;
            color: #1976d2;
            font-weight: 500;
        }

        .freq-filter-item {
            cursor: pointer;
            padding: 2px 5px;
            transition: all 0.2s;
        }

        .freq-filter-item.active {
            font-weight: 800;
            border-bottom: 2px solid #1976d2;
        }

        .freq-range-display {
            text-align: center;
            font-size: 1.1rem;
            color: #1976d2;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div id="toast-container"></div>
    <div id="app">
        <div id="sidebar">
            <h1>ğŸ° KINOV Lotto Map</h1>
            <div class="section">
                <span class="section-title">ğŸ“… íšŒì°¨ í•„í„° (Round)</span>
                <div class="input-row">
                    <input type="number" id="minRound" value="1201">
                    <span>~</span>
                    <input type="number" id="maxRound" value="1210" max="1210"
                        oninput="if(parseInt(this.value) > 1210) this.value = 1210;">
                    <button class="btn-sm" onclick="refreshRecentRounds()">ì¡°íšŒ</button>
                </div>
                <!-- Data Availability Notice -->
                <div
                    style="font-size:14px; font-weight:bold; color:#d32f2f; margin-top:8px; line-height:1.4; background:rgba(255,0,0,0.05); padding:8px; border-radius:4px; border:1px solid rgba(255,0,0,0.1);">
                    1. 1ë“± ë‹¹ì²¨ë²ˆí˜¸ëŠ” 1íšŒì°¨ë¶€í„° ì œê³µ<br>
                    2. 1ë“± íŒë§¤ì í˜„í™©ì€ 262íšŒì°¨ë¶€í„° ì œê³µ
                </div>
            </div>

            <!-- Recent 3 Rounds Display -->
            <div class="section" id="recentRoundsContainer"
                style="background:#f0f4f8; padding:10px; border-radius:8px; margin-bottom:20px;">
                <span class="section-title" style="margin-bottom:8px;">ğŸ“Š ìµœê·¼ 3íšŒì°¨ ë‹¹ì²¨ë²ˆí˜¸ (ê¸°ì¤€: <span id="recentRefRound"
                        style="color:#d32f2f;">1210</span>íšŒ)</span>
                <div id="recentRoundsList" style="display:flex; flex-direction:column; gap:6px;">
                    <!-- Javascript will populate this -->
                    <div style="font-size:12px; color:#666; text-align:center;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
            </div>

            <div class="section">
                <span class="section-title">ğŸ† ë‹¹ì²¨ íšŸìˆ˜ í•„í„° (Frequency)</span>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="freq5" checked> ğŸŒŸ 5íšŒ ì´ìƒ</label>
                    <label class="checkbox-item"><input type="checkbox" id="freq3" checked> ğŸ”´ 3~4íšŒ</label>
                    <label class="checkbox-item"><input type="checkbox" id="freq1" checked> ğŸ”µ 2íšŒ ì´í•˜</label>
                </div>
            </div>
            <div class="section">
                <span class="section-title">ğŸ² ë‹¹ì²¨ ë°©ì‹ (Method)</span>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="methodAuto" checked> ìë™</label>
                    <label class="checkbox-item"><input type="checkbox" id="methodManual" checked> ìˆ˜ë™</label>
                    <label class="checkbox-item"><input type="checkbox" id="methodSemi" checked> ë°˜ìë™</label>
                </div>
            </div>
            <button class="btn-apply" onclick="applyFilters()">ì ìš©í•˜ê¸°</button>
            <div class="stats-card">
                <div class="stat-item"><span>ì „ì²´ ë°ì´í„°</span> <span id="totalDataCount">0</span></div>
                <div class="stat-item"><span>í•„í„°ë§ ê²°ê³¼</span> <span id="filteredCount" class="stat-value">0</span>
                </div>

                <!-- Fallback file loader -->
                <div id="manualLoader"
                    style="display:none; margin-top:10px; padding-top:10px; border-top:1px dashed #ccc;">
                    <p style="font-size:11px; color:#666; margin-bottom:5px;">âš ï¸ ìë™ ë¡œë“œ ì‹¤íŒ¨ ì‹œ íŒŒì¼ì„ ì§ì ‘ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
                    <input type="file" id="fileInput" accept=".json" style="display:none;"
                        onchange="handleFileSelect(event)">
                    <button class="btn-apply" style="background:#333; font-size:12px; padding:8px;"
                        onclick="document.getElementById('fileInput').click()">íŒŒì¼ ì§ì ‘ ì„ íƒí•˜ê¸° (lotto_data.json)</button>
                </div>
            </div>
        </div> <!-- end #sidebar -->
        <div id="map">
            <!-- Hamburger Menu Button (Moved inside #map for mobile anchoring) -->
            <div id="menuBtn" class="floating-btn menu-btn" onclick="toggleNav()" title="ë©”ë‰´ ì—´ê¸°">
                <div class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <!-- GPS Button (Moved inside #map for mobile anchoring) -->
            <div class="floating-btn gps-button" onclick="requestMyLocation()" title="ë‚´ ìœ„ì¹˜ ì°¾ê¸°">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z" />
                </svg>
            </div>
        </div>
    </div> <!-- end #app -->

    <!-- Side Navigation Drawer -->
    <div id="sideNavOverlay" class="side-nav-overlay" onclick="closeNav()"></div>
    <div id="sideNav" class="side-nav">
        <div class="side-nav-header">
            <div class="logo">ğŸ° KINOV</div>
            <span class="close-nav" onclick="closeNav()">&times;</span>
        </div>

        <div class="side-nav-body">
            <div class="menu-category">ë‹¹ì²¨ ì •ë³´</div>
            <div class="menu-item" onclick="showStats()">
                <span class="m-icon">ğŸ“Š</span>
                <span class="m-text">ë²ˆí˜¸ë³„ ì¶œí˜„íšŸìˆ˜</span>
            </div>
            <!-- Nationwide Rankings placeholder if needed later -->

            <div class="menu-category">í¸ì˜ ê¸°ëŠ¥</div>
            <div class="menu-item" onclick="showQRScanner()">
                <span class="m-icon">ğŸ“·</span>
                <span class="m-text">QRì½”ë“œ ë‹¹ì²¨í™•ì¸</span>
            </div>
            <div class="menu-item" onclick="requestMyLocation(); closeNav();">
                <span class="m-icon">ğŸ“</span>
                <span class="m-text">ë‚´ ì£¼ë³€ ëª…ë‹¹ ì°¾ê¸°</span>
            </div>

            <div class="menu-category">ê¸°íƒ€</div>
            <div class="menu-item" onclick="shareToKakao()">
                <span class="m-icon">ğŸ“¢</span>
                <span class="m-text">ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ê¸°</span>
            </div>
        </div>

        <div class="side-nav-footer">
            &copy; 2026 KINOV. All rights reserved.
        </div>
    </div>

    <div id="adModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="adContent"
                style="width:100%; height:450px; padding:20px; overflow-y:auto; display:flex; flex-direction:column; align-items:center; justify-content:center; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">

                <!-- Mode Selection Menu -->
                <div id="modeSelection" style="width:100%; max-width:400px;">
                    <div style="background:#fae100; color:#3c1e1e; padding:8px 15px; text-align:center; font-weight:bold; cursor:pointer; font-size:14px; border-radius:8px; margin-bottom:15px; box-shadow:0 2px 4px rgba(0,0,0,0.1);"
                        onclick="shareToKakao()">
                        ğŸ“¢ ì¹´í†¡ ê³µìœ í•˜ê³  ë‹¹ì²¨ í™•ë¥  ë†’ì´ê¸° (í´ë¦­)
                    </div>

                    <h2
                        style="color:white; text-align:center; margin-bottom:15px; font-size:20px; text-shadow:0 1px 2px rgba(0,0,0,0.2);">
                        ğŸ”® ë²ˆí˜¸ ìƒì„± ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”
                    </h2>

                    <div class="selection-menu">
                        <!-- 1. Data Analysis -->
                        <div class="selection-card" onclick="selectAnalysisMode()">
                            <div class="selection-icon">ğŸ“Š</div>
                            <div class="selection-info">
                                <span class="selection-title">ë°ì´í„° ì •ë°€ ë¶„ì„</span>
                                <span class="selection-desc">ëª…ë‹¹ì˜ ê³¼ê±° ë‹¹ì²¨ íŒ¨í„´ì„ ì •ë°€ ë¶„ì„</span>
                            </div>
                        </div>

                        <!-- 2. Dream -->
                        <div class="selection-card" onclick="selectDreamMode()">
                            <div class="selection-icon">ğŸŒ™</div>
                            <div class="selection-info">
                                <span class="selection-title">ê¿ˆ í•´ëª½ ë²ˆí˜¸</span>
                                <span class="selection-desc">ì–´ì ¯ë°¤ ê¿ˆ ë‚´ìš©ì„ ì…ë ¥í•´ë³´ì„¸ìš”</span>
                            </div>
                        </div>

                        <!-- 3. Horoscope -->
                        <div class="selection-card" onclick="selectHoroscopeMode()">
                            <div class="selection-icon">ğŸ…</div>
                            <div class="selection-info">
                                <span class="selection-title">ì˜¤ëŠ˜ì˜ ë ë³„ ìš´ì„¸</span>
                                <span class="selection-desc">ë‚˜ì˜ ë ì— ë§ëŠ” í–‰ìš´ì˜ ìˆ«ì</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Animation (Initially Hidden) -->
                <div id="analysisLoading" class="loader-container">
                    <div class="spinner"></div>
                    <h3 style="margin:10px 0; font-size:22px;">ë°ì´í„° ë¶„ì„ ì¤‘...</h3>
                    <p style="font-size:14px; opacity:0.9;">ëª…ë‹¹ì˜ ê¸°ìš´ì„ ëª¨ìœ¼ê³  ìˆìŠµë‹ˆë‹¤</p>
                </div>

                <!-- Placeholders for Step 2 & 3 -->
                <div id="modeDreamInput" class="input-container">
                    <h2 style="color:white; font-size:20px; margin-bottom:15px; text-shadow:0 1px 2px rgba(0,0,0,0.2);">
                        ğŸŒ™ ì–´ì ¯ë°¤ ë¬´ìŠ¨ ê¿ˆì„ ê¾¸ì…¨ë‚˜ìš”?
                    </h2>

                    <div class="dream-tags">
                        <button class="dream-tag" onclick="handleDreamTag('ë¼ì§€')">ğŸ· ë¼ì§€</button>
                        <button class="dream-tag" onclick="handleDreamTag('ë˜¥')">ğŸ’© ë˜¥</button>
                        <button class="dream-tag" onclick="handleDreamTag('ì¡°ìƒ')">ğŸ‘´ ì¡°ìƒ</button>
                        <button class="dream-tag" onclick="handleDreamTag('ë¶ˆ')">ğŸ”¥ ë¶ˆ</button>
                        <button class="dream-tag" onclick="handleDreamTag('ë¬¼')">ğŸ’§ ë¬¼</button>
                        <button class="dream-tag" onclick="handleDreamTag('ë±€')">ğŸ ë±€</button>
                    </div>

                    <div class="dream-input-box">
                        <input type="text" id="dreamInput" class="dream-input" placeholder="ê¸°íƒ€ ê¿ˆ ì…ë ¥ (10ì ì´ë‚´)"
                            maxlength="10">
                        <button class="btn-dream-submit" onclick="handleDreamSubmit()">ê²°ê³¼ë³´ê¸°</button>
                    </div>

                    <div style="margin-top:20px;">
                        <button class="btn-sm" style="background:rgba(0,0,0,0.3);" onclick="resetToModeSelection()">ğŸ”™
                            ë’¤ë¡œê°€ê¸°</button>
                    </div>
                </div>
                <div id="modeHoroscopeSelect" class="input-container">
                    <h2 style="color:white; font-size:20px; margin-bottom:15px; text-shadow:0 1px 2px rgba(0,0,0,0.2);">
                        ğŸ… ë‹¹ì‹ ì˜ ë ë¥¼ ì„ íƒí•˜ì„¸ìš”
                    </h2>
                    <div class="zodiac-grid">
                        <div class="zodiac-item" onclick="handleZodiacClick('ì¥', 'ğŸ¹')"><span
                                class="zodiac-icon">ğŸ¹</span><span class="zodiac-name">ì¥ë </span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('ì†Œ', 'ğŸ®')"><span
                                class="zodiac-icon">ğŸ®</span><span class="zodiac-name">ì†Œë </span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('í˜¸ë‘ì´', 'ğŸ¯')"><span
                                class="zodiac-icon">ğŸ¯</span><span class="zodiac-name">ë²”ë </span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('í† ë¼', 'ğŸ°')"><span
                                class="zodiac-icon">ğŸ°</span><span class="zodiac-name">í† ë¼ë </span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('ìš©', 'ğŸ²')"><span
                                class="zodiac-icon">ğŸ²</span><span class="zodiac-name">ìš©ë </span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('ë±€', 'ğŸ')"><span
                                class="zodiac-icon">ğŸ</span><span class="zodiac-name">ë±€ë </span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('ë§', 'ğŸ´')"><span
                                class="zodiac-icon">ğŸ´</span><span class="zodiac-name">ë§ë </span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('ì–‘', 'ğŸ‘')"><span
                                class="zodiac-icon">ğŸ‘</span><span class="zodiac-name">ì–‘ë </span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('ì›ìˆ­ì´', 'ğŸµ')"><span
                                class="zodiac-icon">ğŸµ</span><span class="zodiac-name">ì›ìˆ­ì´ë </span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('ë‹­', 'ğŸ”')"><span
                                class="zodiac-icon">ğŸ”</span><span class="zodiac-name">ë‹­ë </span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('ê°œ', 'ğŸ¶')"><span
                                class="zodiac-icon">ğŸ¶</span><span class="zodiac-name">ê°œë </span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('ë¼ì§€', 'ğŸ·')"><span
                                class="zodiac-icon">ğŸ·</span><span class="zodiac-name">ë¼ì§€ë </span></div>
                    </div>

                    <div style="margin-top:20px;">
                        <button class="btn-sm" style="background:rgba(0,0,0,0.3);" onclick="resetToModeSelection()">ğŸ”™
                            ë’¤ë¡œê°€ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="resultContent"
            style="display:none; position:relative; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:40px 20px; min-height:420px;">
            <span
                style="position:absolute; top:15px; right:20px; color:white; font-size:28px; font-weight:bold; cursor:pointer; z-index:10;"
                onclick="closeModal()">&times;</span>
            <h2 style="color:white; text-shadow:0 2px 4px rgba(0,0,0,0.2);">ğŸ‰ ì¶”ì²œ ë²ˆí˜¸ ìƒì„± ì™„ë£Œ! ğŸ‰</h2>
            <p id="resultInfoText" style="font-size:13px; color:rgba(255,255,255,0.95); margin-bottom:10px;">
                ì´ ëª…ë‹¹ì€ ê³¼ê±° <strong id="paramHCount" style="color:#fae100;">0</strong>ë²ˆì˜ 1ë“±ì„ ë°°ì¶œí–ˆìŠµë‹ˆë‹¤.<br>
                (<span id="paramRounds"></span> ë“±)
            </p>
            <div class="lucky-balls" id="luckyBalls">
                <!-- Balls go here -->
            </div>
            <p style="font-size:12px; color:rgba(255,255,255,0.8);">* ì¬ë¯¸ë¡œë§Œ ë´ì£¼ì„¸ìš”. ê³¼ë„í•œ êµ¬ë§¤ëŠ” ê¸ˆë¬¼!</p>
            <button class="btn-apply btn-navi"
                style="margin-top:10px; background:#fae100; color:#3c1e1e; border:none; padding:12px 30px; border-radius:25px; font-weight:bold; box-shadow:0 4px 12px rgba(0,0,0,0.2);"
                onclick="goToShop()">
                ğŸš— ì§€ê¸ˆ ë‹¹ì¥ ì‚¬ëŸ¬ ê°€ê¸° (ê¸¸ì°¾ê¸°)
            </button>
            <button class="btn-sm"
                style="display:block; margin:15px auto 0; background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); padding:8px 20px; border-radius:20px; color:white;"
                onclick="closeModal()">
                ë‹«ê¸°
            </button>
        </div> <!-- end info-modal -->
    </div> <!-- end ad-content -->
    <!-- Frequency Statistics Modal -->
    <div id="statModal" class="modal">
        <div class="freq-modal-content">
            <div class="freq-header">
                <div class="back-btn" onclick="closeStatModal()">
                    <span>â®</span> ë‹«ê¸°
                </div>
                <div>ë²ˆí˜¸ë³„ ì¶œí˜„íšŸìˆ˜ <span style="font-size: 10px; opacity: 0.8; vertical-align: middle;">(ë³´ë„ˆìŠ¤ ì œì™¸)</span>
                </div>
                <div style="width: 45px;"></div>
            </div>

            <div class="freq-body">
                <div class="freq-controls">
                    <div class="freq-filter-row">
                        <span class="freq-filter-item active" onclick="setFreqPeriod(0)">ì „ì²´</span>
                        <span class="freq-filter-item" onclick="setFreqPeriod(10)">ìµœê·¼ 10ì£¼</span>
                        <span class="freq-filter-item" onclick="setFreqPeriod(5)">ìµœê·¼ 5ì£¼</span>
                    </div>
                    <div class="freq-range-display" id="freqRangeText">
                        ë°ì´í„° ë¡œë”© ì¤‘...
                    </div>
                </div>
                <div id="freqListContainer">
                    <!-- Data will be injected here -->
                    <div style="padding: 10px; text-align: center; font-size: 12px; color: #666; background: #fffde7;">
                        ë³µê¶Œì˜ QR ì½”ë“œë¥¼ í™”ë©´ì— ë¹„ì¶°ì£¼ì„¸ìš”.
                    </div>
                </div>
                <div class="freq-disclaimer">
                    * ë³´ë„ˆìŠ¤ ë²ˆí˜¸ëŠ” í†µê³„ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Scanner Modal -->
    <div id="qrModal" class="modal">
        <div class="qr-modal-content">
            <span class="modal-close" style="color:#333; z-index:100; padding:10px; right:10px; top:5px;"
                onclick="closeQRScanner()">&times;</span>

            <div id="qr-reader" style="width:100%;"></div>

            <div id="qrResult" class="qr-result-container" style="display:none;">
                <h3 style="margin:0 0 10px 0; color:#333; text-align:center;">
                    ì œ <span id="qrRound" style="color:#d32f2f;">0</span>íšŒ ë‹¹ì²¨ ê²°ê³¼
                </h3>
                <div id="qrGameList">
                    <!-- Javascript will populate this -->
                </div>
                <div style="text-align:center; margin-top:15px;">
                    <button class="btn-sm" onclick="restartQRScanner()">ë‹¤ì‹œ ìŠ¤ìº”í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map, clusterer, allData = [], markers = [];
        let currentInfoWindow = null; // Track the currently open InfoWindow


        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    processLoadedData(data);
                    document.getElementById('manualLoader').style.display = 'none';
                    alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! (' + data.length + 'ê±´)');
                } catch (err) {
                    alert('íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function processLoadedData(data) {
            allData = data;

            // Calculate win count per shop (Name + Address)
            const shopWins = {};
            data.forEach(item => {
                const key = (item.n || '').trim() + '|' + (item.a || '').trim();
                shopWins[key] = (shopWins[key] || 0) + 1;
            });
            // Attach individual shop win count to each record
            let highWinCount = 0;
            data.forEach(item => {
                const key = (item.n || '').trim() + '|' + (item.a || '').trim();
                item.totalWins = shopWins[key];
                if (item.totalWins >= 5) highWinCount++;
            });
            console.log('Grouped Shops:', Object.keys(shopWins).length);
            console.log('Records with 5+ wins:', highWinCount);

            document.getElementById('totalDataCount').innerText = data.length.toLocaleString();
            if (data.length > 0) {
                const rounds = data.map(d => d.r);
                const maxR = Math.max(...rounds);
                const minR = Math.min(...rounds);
                document.getElementById('maxRound').value = maxR;
                document.getElementById('minRound').value = Math.max(1, maxR - 9);
            }

            applyFilters();

            // Initial load of recent rounds
            const initialMax = parseInt(document.getElementById('maxRound').value) || 1210;
            updateRecentRounds(initialMax);
        }

        window.onload = function () {
            if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
                handleScriptError();
                return;
            }

            const mapContainer = document.getElementById('map');
            const mapOption = { center: new kakao.maps.LatLng(36.2683, 127.6358), level: 12 };
            map = new kakao.maps.Map(mapContainer, mapOption);

            clusterer = new kakao.maps.MarkerClusterer({
                map: map, averageCenter: true, minLevel: 10,
                styles: [{
                    width: '40px', height: '40px', background: 'rgba(211, 47, 47, 0.8)',
                    color: '#fff', textAlign: 'center', lineHeight: '40px',
                    borderRadius: '20px', fontWeight: 'bold'
                }]
            });

            loadData();
        };

        function loadData() {
            const countEl = document.getElementById('totalDataCount');
            console.log('Loading data...');

            Promise.all([
                fetch('lotto_data.json?v=' + Date.now()).then(res => res.json()),
                fetch('lotto_history.json?v=' + Date.now()).then(res => res.json())
            ])
                .then(([lottoData, historyData]) => {
                    window.lottoHistory = historyData; // Global variable
                    processLoadedData(lottoData);
                })
                .catch(err => {
                    console.error('Data load failed:', err);
                    countEl.innerHTML = `<span style="color:red; font-size:11px; cursor:help;" title="${err.message}">ë¡œë“œ ì‹¤íŒ¨ (${err.name})</span>`;
                    document.getElementById('manualLoader').style.display = 'block';
                    alert('ë°ì´í„° íŒŒì¼ ë¡œë“œ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + err.message);
                });
        }

        // --- Advanced Prediction Algorithm ---
        let globalWeights = null; // Calculated once on load

        function analyzeGlobalHistory() {
            if (globalWeights) return;
            globalWeights = {};
            for (let i = 1; i <= 45; i++) globalWeights[i] = 10; // Base weight

            const history = window.lottoHistory || {};
            const rounds = Object.keys(history).map(Number).sort((a, b) => b - a); // Newest first

            // Recency Weighting: Newer rounds have more influence
            rounds.forEach((r, idx) => {
                const nums = history[String(r)];
                if (!nums) return;

                // Weight decay: Recent 10 rounds get +5, others get +1
                const weightBoost = idx < 10 ? 5 : 1;

                // Only consider main numbers (first 6)
                for (let i = 0; i < 6; i++) {
                    if (nums[i]) globalWeights[nums[i]] += weightBoost;
                }
            });
            console.log("Global Analysis Complete:", globalWeights);
        }

        /**
         * ğŸ”® Advanced Lucky Number Generator
         * Uses Global Weights + Shop Pattern + Statistical Filters
         */
        function generateLuckyNumbers(storeWins, mode = 'mix') {
            // Ensure global analysis is done
            if (!globalWeights) analyzeGlobalHistory();

            // 1. Clone Global Weights for this session
            const currentWeights = { ...globalWeights };

            // 2. Apply Shop-Specific Weights based on Mode
            // storeWins: [{r: 1000, m: 'ìë™'}, ...]
            const history = window.lottoHistory || {};
            let matchCount = 0;

            storeWins.forEach(win => {
                const isAuto = win.m.includes('ìë™');
                const isManual = win.m.includes('ìˆ˜ë™');

                // Logic: 
                // If mode is 'auto', heavily boost numbers from 'auto' wins.
                // If mode is 'manual', heavily boost numbers from 'manual' wins.
                // If mode is 'mix', boost all.
                let process = false;
                if (mode === 'auto' && isAuto) process = true;
                else if (mode === 'manual' && isManual) process = true;
                else if (mode === 'mix') process = true;

                if (process) {
                    const nums = history[String(win.r)];
                    if (nums) {
                        nums.slice(0, 6).forEach(n => {
                            currentWeights[n] += 50; // Massive boost for shop's winning pattern
                        });
                        matchCount++;
                    }
                }
            });

            // Fallback: If no matches for mode (e.g., asking for Manual but shop only has Auto wins),
            // then analyze ALL wins of this shop to find at least some "Shop Energy".
            if (matchCount === 0 && storeWins.length > 0) {
                storeWins.forEach(win => {
                    const nums = history[String(win.r)];
                    if (nums) {
                        nums.slice(0, 6).forEach(n => {
                            currentWeights[n] += 20; // Moderate boost
                        });
                    }
                });
            }

            // 3. Statistical Filter Loop
            // Try to generate a valid set that meets strict statistical criteria
            let bestSet = null;
            let maxAttempts = 200; // Hard limit

            for (let i = 0; i < maxAttempts; i++) {
                const candidate = drawSet(currentWeights);
                if (validateSet(candidate)) {
                    bestSet = candidate;
                    break;
                }
            }

            // If we failed to find a "perfect" set, just take the last raw one
            if (!bestSet) bestSet = drawSet(currentWeights);

            return {
                numbers: bestSet.sort((a, b) => a - b),
                historyCount: storeWins.length,
                relatedRounds: storeWins.map(w => w.r).slice(0, 5)
            };
        }

        function drawSet(weights) {
            const selected = new Set();
            // Safety copy to modify weights during draft (avoid picking same num)
            // But for simple Weighted Random without replacement, we just check 'has'

            while (selected.size < 6) {
                const n = weightedRandom(weights);
                selected.add(n);
            }
            return Array.from(selected);
        }

        function weightedRandom(weights) {
            let sum = 0;
            for (let i in weights) sum += weights[i];
            let rand = Math.random() * sum;
            for (let i in weights) {
                rand -= weights[i];
                if (rand < 0) return parseInt(i);
            }
            return Math.floor(Math.random() * 45) + 1;
        }

        // --- Probability Booster Filters ---
        function validateSet(numbers) {
            // Sort first
            numbers.sort((a, b) => a - b);

            // 1. Sum Filter: Winning sums usually fall between 100 ~ 175
            const sum = numbers.reduce((a, b) => a + b, 0);
            if (sum < 100 || sum > 175) return false;

            // 2. Odd/Even Ratio: Avoid 6:0 or 0:6. Accept 4:2, 3:3, 2:4
            const odds = numbers.filter(n => n % 2 !== 0).length;
            if (odds < 2 || odds > 4) return false;

            // 3. High/Low Ratio: (1-22) vs (23-45). Avoid 6:0 or 0:6
            const low = numbers.filter(n => n <= 22).length;
            if (low < 2 || low > 4) return false;

            // 4. Consecutive Check: Max 2 consecutive numbers allowed (e.g. 1,2,3 is bad)
            let consecutiveCnt = 0;
            for (let i = 0; i < numbers.length - 1; i++) {
                if (numbers[i] + 1 === numbers[i + 1]) {
                    consecutiveCnt++;
                    // If we have 2 pairs (1-2, 5-6) it's ok, but 1-2-3 (2 consecutives in a row) is rare
                    // Let's strictly disallow 3 consecutive numbers (1,2,3)
                    if (i > 0 && numbers[i - 1] + 1 === numbers[i]) return false;
                }
            }

            // 5. Last Digit Sum (Optimization): Usually ends in 0-9 spread 
            // (Optional, skip for performance)

            return true;
        }

        function applyFilters() {
            const minR = parseInt(document.getElementById('minRound').value) || 0;
            const maxR = parseInt(document.getElementById('maxRound').value) || 9999;
            const auto = document.getElementById('methodAuto').checked;
            const manual = document.getElementById('methodManual').checked;
            const semi = document.getElementById('methodSemi').checked;

            // Frequency Filters
            const f5 = document.getElementById('freq5').checked;
            const f3 = document.getElementById('freq3').checked;
            const f1 = document.getElementById('freq1').checked;

            const filtered = allData.filter(d => {
                const rMatch = d.r >= minR && d.r <= maxR;
                let mMatch = false;
                if (auto && d.m.includes('ìë™')) mMatch = true;
                if (manual && d.m.includes('ìˆ˜ë™')) mMatch = true;
                if (semi && d.m.includes('ë°˜ìë™')) mMatch = true;

                let fMatch = false;
                if (f5 && d.totalWins >= 5) fMatch = true;
                if (f3 && d.totalWins >= 3 && d.totalWins <= 4) fMatch = true;
                if (f1 && d.totalWins <= 2) fMatch = true;

                return rMatch && mMatch && fMatch;
            });

            document.getElementById('filteredCount').innerText = filtered.length.toLocaleString();
            updateMarkers(filtered);
            // updateRecentRounds(maxR); // Removed as per user request
        }

        function refreshRecentRounds() {
            const maxR = parseInt(document.getElementById('maxRound').value) || 9999;
            updateRecentRounds(maxR);
        }

        function updateRecentRounds(maxRound) {
            const container = document.getElementById('recentRoundsList');
            const refSpan = document.getElementById('recentRefRound');
            if (refSpan) refSpan.innerText = maxRound;

            if (!container) return;

            container.innerHTML = '';

            // Check if history data is loaded
            if (!window.lottoHistory) {
                container.innerHTML = '<div style="font-size:12px; color:#666; text-align:center;">ë°ì´í„° ë¡œë”© ì¤‘...</div>';
                return;
            }

            // Loop 3 rounds: maxRound, maxRound-1, maxRound-2 (Reduced to save space)
            for (let i = 0; i < 3; i++) {
                const targetRound = maxRound - i;
                if (targetRound < 1) continue; // No rounds below 1

                const row = document.createElement('div');
                row.className = 'recent-row';

                // Round Number
                const roundNum = document.createElement('span');
                roundNum.className = 'recent-round-num';
                roundNum.innerText = targetRound + 'íšŒ';
                row.appendChild(roundNum);

                // Balls Container
                const ballsDiv = document.createElement('div');
                ballsDiv.style.display = 'flex';
                ballsDiv.style.alignItems = 'center'; // Vertically center items
                ballsDiv.style.gap = '2px';

                // Get Winning Numbers
                // lottoHistory key is string "1210"
                const nums = window.lottoHistory[String(targetRound)];

                if (nums && nums.length > 0) {
                    // Separate Main (6) and Bonus (1)
                    // The 7th number is the bonus number in our JSON structure
                    const mainNums = nums.slice(0, 6).sort((a, b) => a - b);
                    const bonusNum = nums[6];

                    // Render Main Numbers
                    mainNums.forEach(n => {
                        const ball = document.createElement('span');
                        ball.className = 'mini-ball ' + getBallColor(n);
                        ball.innerText = n;
                        ballsDiv.appendChild(ball);
                    });

                    // Render Plus Sign
                    const plusSpan = document.createElement('span');
                    plusSpan.innerText = '+';
                    plusSpan.style.color = '#999';
                    plusSpan.style.fontSize = '12px';
                    plusSpan.style.fontWeight = 'bold';
                    plusSpan.style.margin = '0 2px';
                    ballsDiv.appendChild(plusSpan);

                    // Render Bonus Number
                    const bonusBall = document.createElement('span');
                    bonusBall.className = 'mini-ball ' + getBallColor(bonusNum);
                    bonusBall.innerText = bonusNum;
                    ballsDiv.appendChild(bonusBall);

                } else {
                    const noData = document.createElement('span');
                    noData.style.fontSize = '11px';
                    noData.style.color = '#999';
                    noData.innerText = 'ë°ì´í„° ì—†ìŒ';
                    ballsDiv.appendChild(noData);
                }

                row.appendChild(ballsDiv);
                container.appendChild(row);
            }
        }

        function updateMarkers(data) {
            clusterer.clear();
            markers.forEach(m => m.setMap(null));
            markers = [];

            // To avoid duplicate markers for the same shop at the same location,
            // we need to group the filtered data by shop (lat, lng, name, address)
            // and then create a single marker for each unique shop.
            const uniqueShops = {};
            data.forEach(d => {
                const key = `${d.lat}_${d.lng}_${d.n}_${d.a}`;
                if (!uniqueShops[key]) {
                    uniqueShops[key] = {
                        n: d.n,
                        a: d.a,
                        lat: d.lat,
                        lng: d.lng,
                        totalWins: d.totalWins, // This is the total wins for the shop
                        rounds: [] // To store individual round details for infowindow
                    };
                }
                uniqueShops[key].rounds.push({ r: d.r, m: d.m });
            });

            Object.values(uniqueShops).forEach(shop => {
                let markerImg = null;
                // Tiered Styles
                if (shop.totalWins >= 5) {
                    // Legendary Gold Star
                    markerImg = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
                        new kakao.maps.Size(24, 35)
                    );
                } else if (shop.totalWins >= 3) {
                    // Professional Red
                    markerImg = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/2018/pc/img/marker_spot.png',
                        new kakao.maps.Size(24, 35),
                        { offset: new kakao.maps.Point(12, 35) }
                    );
                }

                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(shop.lat, shop.lng),
                    image: markerImg
                });
                marker.shopData = shop; // Store shop data for retrieval

                const sortedRounds = shop.rounds.sort((a, b) => b.r - a.r);
                const roundTagsHtml = sortedRounds.map(r => `<span class="iw-tag">${r.r}íšŒ(${r.m})</span>`).join('');

                const safeAddr = (shop.a || "").replace(/'/g, "\\'").replace(/\n/g, " ");
                const safeName = (shop.n || "").replace(/'/g, "\\'").replace(/\n/g, " ");

                const content = `
                    <div class="infowindow">
                        <div class="iw-title">${shop.n} ${shop.totalWins >= 5 ? 'ğŸŒŸ' : ''}</div>
                        <div class="iw-addr-box" onclick="copyToClipboard('${safeAddr}')" title="ì£¼ì†Œ ë³µì‚¬">
                            <span class="iw-addr">${shop.a}</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="#666"><path d="M16 1H4c-1.11 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        </div>
                        <div style="font-weight:bold; color:red; margin-bottom:5px;">ì´ ${shop.totalWins}íšŒ ë‹¹ì²¨</div>
                        <div class="iw-details">${roundTagsHtml}</div>
                        <button class="btn-gold" onclick="openAdModal('${safeName}', '${safeAddr}', ${shop.lat}, ${shop.lng}, ${shop.totalWins})">
                            âœ¨ ì´ë²ˆ ì£¼ 1ë“± ì¶”ì²œ ë²ˆí˜¸ ë°›ê¸°
                        </button>
                        <div class="iw-actions">
                            <button class="btn-iw btn-navi" onclick="openDirections(${shop.lat}, ${shop.lng}, '${safeName}')">
                                ğŸš— ê¸¸ì°¾ê¸°
                            </button>
                        </div>
                    </div>
                `;

                const infowindow = new kakao.maps.InfoWindow({
                    content: content,
                    removable: true,
                    zIndex: 1500 // Ensure popup is on top of markers
                });

                kakao.maps.event.addListener(marker, 'click', () => {
                    // Close previous InfoWindow if exists
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }

                    infowindow.open(map, marker);
                    currentInfoWindow = infowindow; // Update current
                });

                markers.push(marker);
            });
            clusterer.addMarkers(markers);
        }

        /**
         * GPS Location Service Module
         * Handles user positioning, nearest shop calculation, and UI feedback (Toasts).
         */
        let myLocationMarker = null;

        function requestMyLocation() {
            if (!navigator.onLine) {
                showToast("ğŸŒ ì¸í„°ë„· ì—°ê²°ì´ ëŠê²¨ ìˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.", "error");
                return;
            }

            if (!navigator.geolocation) {
                showToast("ğŸš« ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
                return;
            }

            const gpsBtn = document.querySelector('.gps-button');
            if (gpsBtn) gpsBtn.classList.add('loading');

            // GPS Permission & Fetch
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    if (gpsBtn) gpsBtn.classList.remove('loading');
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const center = new kakao.maps.LatLng(lat, lng);

                    map.setCenter(center);

                    // Close all infowindows to clear the view
                    if (typeof clusterer !== 'undefined') {
                        // There's no direct 'closeAll' on clusterer, but we can just let it be
                    }

                    // Add/Update Blue Dot Marker
                    if (!myLocationMarker) {
                        myLocationMarker = new kakao.maps.CustomOverlay({
                            position: center,
                            content: `
                                <div style="position:relative;">
                                    <div class="pulse"></div>
                                    <div style="width:16px; height:16px; background:#1976d2; border:2px solid #fff; border-radius:50%; box-shadow:0 0 10px rgba(0,0,0,0.5); position:relative; z-index:2; transform: translate(-50%, -50%);"></div>
                                </div>
                            `,
                            map: map,
                            zIndex: 1001
                        });
                    } else {
                        myLocationMarker.setPosition(center);
                        myLocationMarker.setMap(map);
                    }

                    findNearestShop(lat, lng);
                },
                (err) => {
                    console.error("GPS Error:", err);
                    if (gpsBtn) gpsBtn.classList.remove('loading');
                    let msg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    switch (err.code) {
                        case 1:
                            msg = "ìœ„ì¹˜ ì •ë³´ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.";
                            break;
                        case 2:
                            msg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPSê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.";
                            break;
                        case 3:
                            msg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”.";
                            break;
                    }
                    showToast(msg, "error");
                },
                { enableHighAccuracy: false, timeout: 15000, maximumAge: 0 }
            );
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // --- Monetization & Logic ---
        let currentShopData = null; // Store temp data for the modal

        function openAdModal(name, addr, lat, lng, totalWins) {
            // Re-filter allData for this specific shop to get rounds.
            const rounds = allData.filter(d => d.n === name && d.a === addr).map(d => ({ r: d.r, m: d.m }));

            currentShopData = { name, addr, lat, lng, totalWins, rounds };

            // Show Modal
            const modal = document.getElementById('adModal');
            const adContent = document.getElementById('adContent');
            const resultContent = document.getElementById('resultContent');

            // Mode Containers
            const modeSelection = document.getElementById('modeSelection');
            const analysisLoading = document.getElementById('analysisLoading');
            const modeDreamInput = document.getElementById('modeDreamInput');
            const modeHoroscopeSelect = document.getElementById('modeHoroscopeSelect');

            modal.style.display = 'flex';
            adContent.style.display = 'flex'; // Changed to flex for centering
            resultContent.style.display = 'none';

            // Reset UI State (CRITICAL: Reset result text structure)
            const resultInfo = document.getElementById('resultInfoText');
            if (resultInfo) {
                resultInfo.innerHTML = `ì´ ëª…ë‹¹ì€ ê³¼ê±° <strong id="paramHCount" style="color:#fae100;">0</strong>ë²ˆì˜ 1ë“±ì„ ë°°ì¶œí–ˆìŠµë‹ˆë‹¤.<br>
                    (<span id="paramRounds"></span> ë“±)`;
            }

            modeSelection.style.display = 'block';
            if (analysisLoading) analysisLoading.style.display = 'none';
            if (modeDreamInput) modeDreamInput.style.display = 'none';
            if (modeHoroscopeSelect) modeHoroscopeSelect.style.display = 'none';

            // Push history state to support Back Button closing
            history.pushState({ modalOpen: true }, null, "");
        }

        // --- Phase 10: Selection Handlers ---

        function selectAnalysisMode() {
            // Hide selection, show loading
            document.getElementById('modeSelection').style.display = 'none';
            const loader = document.getElementById('analysisLoading');
            if (loader) {
                loader.style.display = 'flex';
                // Reset text if needed
                loader.querySelector('h3').innerText = 'ë°ì´í„° ë¶„ì„ ì¤‘...';
                loader.querySelector('p').innerText = 'ëª…ë‹¹ì˜ ê¸°ìš´ì„ ëª¨ìœ¼ê³  ìˆìŠµë‹ˆë‹¤';
            }

            // Simulate Analysis Delay (3 seconds)
            setTimeout(() => {
                showResult();
            }, 3000);
        }

        function selectDreamMode() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('modeDreamInput').style.display = 'block';
        }

        function resetToModeSelection() {
            document.getElementById('modeDreamInput').style.display = 'none';
            document.getElementById('modeHoroscopeSelect').style.display = 'none';
            document.getElementById('modeSelection').style.display = 'block';
        }

        function handleDreamTag(keyword) {
            document.getElementById('dreamInput').value = keyword;
            handleDreamSubmit();
        }

        function handleDreamSubmit() {
            const input = document.getElementById('dreamInput');
            const keyword = input.value.trim();

            if (!keyword) {
                alert('ê¿ˆ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            // Show loading state
            document.getElementById('modeDreamInput').style.display = 'none';
            const loader = document.getElementById('analysisLoading');
            if (loader) {
                loader.style.display = 'flex';
                loader.querySelector('h3').innerText = 'ê¿ˆ í•´ëª½ ì¤‘...';
                loader.querySelector('p').innerText = 'ê¿ˆ ì†ì— ìˆ¨ê²¨ì§„ í–‰ìš´ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤';
            }

            setTimeout(() => {
                const luckyNumbers = generateDreamNumbers(keyword);
                showResult(luckyNumbers);
            }, 2000);
        }

        function generateDreamNumbers(keyword) {
            // 1. Traditional Dream Mappings (Simple Version)
            const dreamMap = {
                'ë¼ì§€': [8, 12, 23, 33, 38, 41],
                'ë˜¥': [6, 17, 24, 35, 36, 42],
                'ì¡°ìƒ': [1, 3, 15, 27, 39, 41],
                'ë¶ˆ': [2, 11, 22, 33, 40, 44],
                'ë¬¼': [4, 9, 21, 26, 31, 37],
                'ë±€': [5, 10, 16, 28, 34, 45],
                'ìš©': [7, 18, 20, 30, 42, 45]
            };

            // If keyword exists in map, return it (with small variation if needed, but fixed for now)
            if (dreamMap[keyword]) {
                return {
                    numbers: dreamMap[keyword],
                    historyCount: 0, // Not based on history
                    type: 'dream',
                    keyword: keyword
                };
            }

            // 2. Hash-based Generation for unknown keywords
            // This ensures the same keyword always yields the same numbers
            let hash = 0;
            for (let i = 0; i < keyword.length; i++) {
                hash = ((hash << 5) - hash) + keyword.charCodeAt(i);
                hash |= 0; // Convert to 32bit integer
            }

            // Seeding logic using text hash
            const seededRandom = (seed) => {
                var x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            };

            const selected = new Set();
            let seed = Math.abs(hash);

            while (selected.size < 6) {
                const n = Math.floor(seededRandom(seed) * 45) + 1;
                selected.add(n);
                seed++;
            }

            return {
                numbers: Array.from(selected).sort((a, b) => a - b),
                historyCount: 0,
                type: 'dream',
                keyword: keyword
            };
        }

        function selectHoroscopeMode() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('modeHoroscopeSelect').style.display = 'block';
        }

        function handleZodiacClick(zodiacName, icon) {
            // Show loading
            document.getElementById('modeHoroscopeSelect').style.display = 'none';
            const loader = document.getElementById('analysisLoading');
            if (loader) {
                loader.style.display = 'flex';
                loader.querySelector('h3').innerText = 'ì˜¤ëŠ˜ì˜ ìš´ì„¸ ë¶„ì„ ì¤‘...';
                loader.querySelector('p').innerText = 'ë³„ë“¤ì˜ ê¸°ìš´ì„ ì½ê³  ìˆìŠµë‹ˆë‹¤';
            }

            // Simulate and Generate
            setTimeout(() => {
                const horoscopeData = generateHoroscope(zodiacName);
                showResult({
                    type: 'horoscope',
                    zodiac: zodiacName,
                    icon: icon,
                    ...horoscopeData
                });
            }, 2000);
        }

        function generateHoroscope(zodiacName) {
            // Get today's date string YYYY-MM-DD
            const today = new Date().toISOString().split('T')[0];
            const key = today + zodiacName;

            // Generate seeded random based on date + zodiac
            let hash = 0;
            for (let i = 0; i < key.length; i++) {
                hash = ((hash << 5) - hash) + key.charCodeAt(i);
                hash |= 0;
            }
            const seededRandom = (seed) => {
                var x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            };
            let seed = Math.abs(hash);

            // 1. Horoscope Text Pools
            const genFortunes = [
                "ê¸ˆê¸°(é‡‘æ°£)ì˜ ì˜í–¥ìœ¼ë¡œ ì‹ ì¤‘í•¨ì´ ìš”êµ¬ë˜ëŠ” í•˜ë£¨ì…ë‹ˆë‹¤.",
                "ì˜¤ëŠ˜ì€ ë‹¹ì‹ ì˜ ë‚ ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ í•´ë„ ìˆ ìˆ  í’€ë¦´ ê²ƒì…ë‹ˆë‹¤.",
                "ì§ê°ì´ ë§¤ìš° ë›°ì–´ë‚œ ë‚ ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ëŠë‚Œì„ ë¯¿ì–´ë³´ì„¸ìš”.",
                "ê·€ì¸ì˜ ë„ì›€ì„ ë°›ì•„ ì–´ë ¤ì›€ì´ í•´ê²°ë  ê²ƒì…ë‹ˆë‹¤. ê¸ì •ì ì¸ ë§ˆìŒì„ ê°€ì§€ì„¸ìš”.",
                "í–‰ìš´ì˜ ì—¬ì‹ ì´ ë‹¹ì‹ ì„ ë³´ê³  ë¯¸ì†Œ ì§“ê³  ìˆìŠµë‹ˆë‹¤.",
                "ëœ»ë°–ì˜ í–‰ìš´ì´ ì°¾ì•„ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì£¼ë³€ì„ ì˜ ì‚´í´ë³´ì„¸ìš”.",
                "ì°¨ë¶„í•˜ê²Œ ë‚´ì‹¤ì„ ë‹¤ì§€ë©´ ë” í° ê¸°íšŒê°€ ì°¾ì•„ì˜¬ ê²ƒì…ë‹ˆë‹¤.",
                "ìƒˆë¡œìš´ ë³€í™”ë¥¼ ì‹œë„í•˜ê¸°ì— ì•„ì£¼ ì ì ˆí•œ ì‹œê¸°ì…ë‹ˆë‹¤."
            ];

            const loveFortunes = [
                "ë§ì˜ í‘œí˜„ì„ ì¡°ì ˆí•˜ì„¸ìš”. ë°°ë ¤ê°€ í•„ìš”í•œ ì‹œê¸°ì…ë‹ˆë‹¤.",
                "ì†Œì¤‘í•œ ì‚¬ëŒê³¼ ì¦ê±°ìš´ ì‹œê°„ì„ ë³´ë‚´ê¸°ì— ì¢‹ì€ ë‚ ì…ë‹ˆë‹¤.",
                "ì†”ì§í•œ ê°ì • í‘œí˜„ì´ ìƒëŒ€ë°©ì˜ ë§ˆìŒì„ ì›€ì§ì¼ ê²ƒì…ë‹ˆë‹¤.",
                "ì‘ì€ ì˜¤í•´ê°€ ìƒê¸¸ ìˆ˜ ìˆìœ¼ë‹ˆ ì¶©ë¶„í•œ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ì„¸ìš”.",
                "ìƒˆë¡œìš´ ì¸ì—°ì´ ë‚˜íƒ€ë‚  ìˆ˜ ìˆëŠ” ê¸°ìš´ì´ ê°•í•©ë‹ˆë‹¤.",
                "ì„œë¡œì— ëŒ€í•œ ì‹ ë¢°ê°€ ê¹Šì–´ì§€ëŠ” ë”°ëœ»í•œ í•˜ë£¨ê°€ ë  ê²ƒì…ë‹ˆë‹¤.",
                "ë‹¹ì‹ ì˜ ë§¤ë ¥ì´ ë‹ë³´ì´ëŠ” ë‚ ì…ë‹ˆë‹¤. ìì‹ ê°ì„ ê°€ì§€ì„¸ìš”.",
                "ê°€ê¹Œìš´ ì‚¬ëŒê³¼ì˜ ê°ˆë“±ì€ ë¨¼ì € ì†ì„ ë‚´ë¯¸ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤."
            ];

            const moneyFortunes = [
                "ì˜ˆìƒì¹˜ ëª»í•œ ì§€ì¶œì— ëŒ€ë¹„í•˜ì„¸ìš”. ì‹ ì¤‘í•œ ì†Œë¹„ê°€ í•„ìš”í•©ë‹ˆë‹¤.",
                "ê¸ˆì „ìš´ì´ ë§¤ìš° ì¢‹ìŠµë‹ˆë‹¤. ì‘ì€ íˆ¬ìë„ ê²°ì‹¤ì„ ë§ºì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                "ì¬ë¬¼ìš´ì´ ìƒìŠ¹í•˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. ë¡œë˜ êµ¬ë§¤í•˜ê¸° ë”± ì¢‹ì€ ë‚ !",
                "ì§€ê°‘ ê´€ë¦¬ì— ì‹ ê²½ ì¨ì•¼ í•˜ëŠ” í•˜ë£¨ì…ë‹ˆë‹¤. ì¶©ë™êµ¬ë§¤ë¥¼ ì£¼ì˜í•˜ì„¸ìš”.",
                "ìƒê°ì§€ ëª»í•œ ê³³ì—ì„œ ì‘ì€ ìˆ˜ìµì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                "ê³„íšì ì¸ ì†Œë¹„ê°€ ë‹¹ì‹ ì—ê²Œ ë” í° í–‰ìš´ì„ ë¶ˆëŸ¬ì˜¬ ê²ƒì…ë‹ˆë‹¤.",
                "ê¸ˆì „ì ì¸ ì´ë“ë³´ë‹¤ëŠ” ì¸ë§¥ì„ ìŒ“ëŠ” ê²ƒì´ ì¥ê¸°ì ìœ¼ë¡œ ìœ ë¦¬í•©ë‹ˆë‹¤.",
                "ë¿Œë¦° ëŒ€ë¡œ ê±°ë‘ëŠ” ë‚ ì…ë‹ˆë‹¤. ì„±ì‹¤í•¨ì´ ë³´ìƒìœ¼ë¡œ ëŒì•„ì˜µë‹ˆë‹¤."
            ];

            const luckyColors = ["ë¹¨ê°•", "íŒŒë‘", "ë…¸ë‘", "ì´ˆë¡", "ë³´ë¼", "ê¸ˆìƒ‰", "ì€ìƒ‰", "í°ìƒ‰", "ê²€ì •", "ì£¼í™©"];

            const genIdx = Math.floor(seededRandom(seed) * genFortunes.length);
            const loveIdx = Math.floor(seededRandom(seed + 1) * loveFortunes.length);
            const moneyIdx = Math.floor(seededRandom(seed + 2) * moneyFortunes.length);
            const colorIdx = Math.floor(seededRandom(seed + 3) * luckyColors.length);

            const text = `
                <div style="text-align:left; margin: 0 auto; max-width:280px; line-height:1.8; font-size:14px;">
                    â€¢ <b>ì¢…í•©ìš´</b> : ${genFortunes[genIdx]}<br>
                    â€¢ <b>ì• ì •ìš´</b> : ${loveFortunes[loveIdx]}<br>
                    â€¢ <b>ê¸ˆì „ìš´</b> : ${moneyFortunes[moneyIdx]}<br>
                    â€¢ <b>í–‰ìš´ì˜ ìƒ‰ìƒ</b> : ${luckyColors[colorIdx]}
                </div>
            `;

            // 2. Number Generation
            const selected = new Set();
            let numSeed = seed + 100;
            while (selected.size < 6) {
                const n = Math.floor(seededRandom(numSeed) * 45) + 1;
                selected.add(n);
                numSeed++;
            }

            return {
                text: text,
                numbers: Array.from(selected).sort((a, b) => a - b),
                historyCount: 0
            };
        }

        function closeModal() {
            // If the modal is open, going back will trigger popstate which closes it effectively
            // But we need to check if we are actually in the modal state
            if (document.getElementById('adModal').style.display === 'flex') {
                history.back();
            }
        }

        function _internalCloseModal() {
            document.getElementById('adModal').style.display = 'none';
        }

        function showResult(customResult = null) {
            document.getElementById('adContent').style.display = 'none';
            document.getElementById('resultContent').style.display = 'block';

            // Legal Disclaimer
            const legalDiv = document.getElementById('legalDisclaimer');
            if (!legalDiv) {
                const legal = document.createElement('div');
                legal.id = 'legalDisclaimer';
                legal.style.cssText = "font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 15px; text-align: center; line-height: 1.4;";
                legal.innerHTML = "â€» ë³¸ ì„œë¹„ìŠ¤ëŠ” ë™í–‰ë³µê¶Œì˜ ë‹¹ì²¨ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í†µê³„ì /ì„ì˜ì  ë¶„ì„ì„ ì œê³µí•˜ë©°, ë‹¹ì²¨ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ê³¼ë„í•œ ë³µê¶Œ êµ¬ë§¤ëŠ” ë„ë°• ì¤‘ë…ì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
                document.getElementById('resultContent').appendChild(legal);
            }

            const ballContainer = document.getElementById('luckyBalls');
            ballContainer.innerHTML = '';

            // Reset container styles
            ballContainer.style.flexDirection = 'column';
            ballContainer.style.gap = '15px';

            if (customResult) {
                // --- Dream / Horoscope Mode (Single Row) ---
                if (customResult.type === 'dream') {
                    const container = document.getElementById('resultInfoText');
                    if (container) {
                        container.innerHTML =
                            `ê¿ˆ í‚¤ì›Œë“œ <strong style="color:#fae100;">'${customResult.keyword}'</strong>(ìœ¼)ë¡œ<br>ë¶„ì„ëœ í–‰ìš´ì˜ ë²ˆí˜¸ì…ë‹ˆë‹¤.`;
                    }
                } else if (customResult.type === 'horoscope') {
                    const container = document.getElementById('resultInfoText');
                    if (container) {
                        container.innerHTML =
                            `<div class="horoscope-text-box">
                                <div style="font-size:24px; margin-bottom:5px;">${customResult.icon}</div>
                                <div style="font-weight:bold; font-size:16px; margin-bottom:10px; color:#fae100;">${customResult.zodiac}ë  ì˜¤ëŠ˜ì˜ ìš´ì„¸</div>
                                ${customResult.text}
                            </div>
                            <div style="font-size:13px; color:rgba(255,255,255,0.8);">ìœ„ ìš´ì„¸ì— ê¸°ë°˜í•œ í–‰ìš´ì˜ ë²ˆí˜¸ì…ë‹ˆë‹¤.</div>`;
                    }
                }


                // Render with Copy/OMR buttons using createRow helper
                const createRowForCustom = (numbers) => {
                    const mainContainer = document.createElement('div');
                    mainContainer.style.display = 'flex';
                    mainContainer.style.flexDirection = 'column';
                    mainContainer.style.alignItems = 'center';
                    mainContainer.style.width = '100%';

                    const rowWrapper = document.createElement('div');
                    rowWrapper.style.display = 'flex';
                    rowWrapper.style.alignItems = 'center';
                    rowWrapper.style.justifyContent = 'center';
                    rowWrapper.style.gap = '15px';
                    rowWrapper.style.width = '100%';

                    // Balls
                    const ballsRow = document.createElement('div');
                    ballsRow.style.display = 'flex';
                    ballsRow.style.justifyContent = 'center';
                    ballsRow.style.gap = '5px';
                    ballsRow.style.flex = '1';

                    numbers.forEach(n => {
                        const ball = document.createElement('div');
                        ball.className = 'ball ' + getBallColor(n);
                        ball.innerText = n;
                        ballsRow.appendChild(ball);
                    });
                    rowWrapper.appendChild(ballsRow);

                    // Buttons Column
                    const buttonsCol = document.createElement('div');
                    buttonsCol.style.display = 'flex';
                    buttonsCol.style.flexDirection = 'column';
                    buttonsCol.style.gap = '5px';
                    buttonsCol.style.minWidth = '90px';

                    // Copy Button
                    const copyBtn = document.createElement('div');
                    copyBtn.className = 'omr-action-btn';
                    copyBtn.innerHTML = 'ğŸ“‹ ë³µì‚¬';
                    copyBtn.style.justifyContent = 'center';
                    copyBtn.onclick = (e) => {
                        e.stopPropagation();
                        copyToClipboard(numbers);
                    };
                    buttonsCol.appendChild(copyBtn);

                    // OMR Button
                    const omrBtn = document.createElement('div');
                    omrBtn.className = 'omr-action-btn';
                    omrBtn.innerHTML = 'ğŸ“ OMR ë³´ê¸°';
                    omrBtn.style.justifyContent = 'center';
                    omrBtn.onclick = (e) => {
                        e.stopPropagation();
                        openOMR(numbers);
                    };
                    buttonsCol.appendChild(omrBtn);

                    rowWrapper.appendChild(buttonsCol);
                    mainContainer.appendChild(rowWrapper);
                    return mainContainer;
                };

                ballContainer.appendChild(createRowForCustom(customResult.numbers));


            } else {
                // --- Standard Analysis Mode (Auto + Manual) ---
                // Generate two sets with specific modes
                const resultAuto = generateLuckyNumbers(currentShopData.rounds, 'auto');
                const resultManual = generateLuckyNumbers(currentShopData.rounds, 'manual');

                // Update Info Text (Shared stats)
                const container = document.getElementById('resultInfoText');
                if (container) {
                    container.innerHTML =
                        `ì´ ëª…ë‹¹ì€ ê³¼ê±° <strong id="paramHCount" style="color:#fae100;">${resultAuto.historyCount}</strong>ë²ˆì˜ 1ë“±ì„ ë°°ì¶œí–ˆìŠµë‹ˆë‹¤.<br>` +
                        `(<span id="paramRounds">${resultAuto.relatedRounds.join(', ') + (resultAuto.historyCount > 5 ? '...' : '')}</span> ë“±)`;
                }

                // Helper to create a unified row component
                const createRow = (label, numbers, isManual = false) => {
                    // Main Container (Vertical stack for Row + Optional Link)
                    const mainContainer = document.createElement('div');
                    mainContainer.style.display = 'flex';
                    mainContainer.style.flexDirection = 'column';
                    mainContainer.style.alignItems = 'center';
                    mainContainer.style.width = '100%';
                    mainContainer.style.marginBottom = '15px';

                    // Row (Label + Balls + Buttons)
                    const rowWrapper = document.createElement('div');
                    rowWrapper.style.display = 'flex';
                    rowWrapper.style.alignItems = 'center';
                    rowWrapper.style.justifyContent = 'center';
                    rowWrapper.style.gap = '15px';
                    rowWrapper.style.width = '100%';

                    // Label
                    const labelDiv = document.createElement('div');
                    labelDiv.innerHTML = `<span style="color:#fae100; font-weight:bold; font-size:16px;">[${label}]</span>`;
                    labelDiv.style.minWidth = '50px';
                    rowWrapper.appendChild(labelDiv);

                    // Balls
                    const ballsRow = document.createElement('div');
                    ballsRow.style.display = 'flex';
                    ballsRow.style.justifyContent = 'center';
                    ballsRow.style.gap = '5px';
                    ballsRow.style.flex = '1';

                    numbers.forEach(n => {
                        const ball = document.createElement('div');
                        ball.className = 'ball ' + getBallColor(n);
                        ball.innerText = n;
                        ballsRow.appendChild(ball);
                    });
                    rowWrapper.appendChild(ballsRow);

                    // Buttons Column (Copy / OMR stacked vertically)
                    const buttonsCol = document.createElement('div');
                    buttonsCol.style.display = 'flex';
                    buttonsCol.style.flexDirection = 'column';
                    buttonsCol.style.gap = '5px';
                    buttonsCol.style.minWidth = '90px';

                    // Copy Button
                    const copyBtn = document.createElement('div');
                    copyBtn.className = 'omr-action-btn';
                    copyBtn.innerHTML = 'ğŸ“‹ ë³µì‚¬';
                    copyBtn.style.justifyContent = 'center';
                    copyBtn.onclick = (e) => {
                        e.stopPropagation();
                        copyToClipboard(numbers);
                    };
                    buttonsCol.appendChild(copyBtn);

                    // OMR Button
                    const omrBtn = document.createElement('div');
                    omrBtn.className = 'omr-action-btn';
                    omrBtn.innerHTML = 'ğŸ“ OMR ë³´ê¸°';
                    omrBtn.style.justifyContent = 'center';
                    omrBtn.onclick = (e) => {
                        e.stopPropagation();
                        openOMR(numbers);
                    };
                    buttonsCol.appendChild(omrBtn);

                    rowWrapper.appendChild(buttonsCol);
                    mainContainer.appendChild(rowWrapper);

                    // Link for Manual
                    if (isManual) {
                        const linkBtn = document.createElement('div');
                        linkBtn.innerHTML = 'ğŸ“Š ë²ˆí˜¸ë³„ ì¶œí˜„ íšŸìˆ˜ ì°¸ê³ í•˜ê¸° >';
                        linkBtn.style.color = '#fae100';
                        linkBtn.style.fontSize = '12px';
                        linkBtn.style.marginTop = '5px';
                        linkBtn.style.cursor = 'pointer';
                        linkBtn.style.textDecoration = 'underline';
                        linkBtn.style.opacity = '1';
                        linkBtn.onclick = (e) => {
                            e.stopPropagation();
                            showStats();
                        };
                        mainContainer.appendChild(linkBtn);
                    }

                    return mainContainer;
                };

                ballContainer.appendChild(createRow('ìë™', resultAuto.numbers));
                ballContainer.appendChild(createRow('ìˆ˜ë™', resultManual.numbers, true));
            }
        }

        function getBallColor(n) {
            if (n <= 10) return 'one';
            if (n <= 20) return 'two';
            if (n <= 30) return 'three';
            if (n <= 40) return 'four';
            return 'five';
        }

        function goToShop() {
            if (!currentShopData) return;
            openDirections(currentShopData.lat, currentShopData.lng, currentShopData.name);
            closeModal();
        }

        // --- Side Nav Controls ---
        function toggleNav() {
            const nav = document.getElementById('sideNav');
            const overlay = document.getElementById('sideNavOverlay');
            const btn = document.getElementById('menuBtn');
            const isOpen = nav.classList.contains('open');

            if (isOpen) {
                closeNav();
            } else {
                nav.classList.add('open');
                overlay.style.display = 'block';
                setTimeout(() => overlay.classList.add('show'), 10);
                btn.classList.add('active');
            }
        }

        function closeNav() {
            const nav = document.getElementById('sideNav');
            const overlay = document.getElementById('sideNavOverlay');
            const btn = document.getElementById('menuBtn');

            nav.classList.remove('open');
            overlay.classList.remove('show');
            setTimeout(() => {
                if (!nav.classList.contains('open')) {
                    overlay.style.display = 'none';
                }
            }, 300);
            btn.classList.remove('active');
        }

        let currentFreqPeriod = 0; // 0 for All, N for last N weeks

        function showStats() {
            closeNav();
            const modal = document.getElementById('statModal');
            modal.style.display = 'flex';
            currentFreqPeriod = 0; // Reset to All
            updateFreqFilterUI();
            renderFrequencyStats();
        }

        function closeStatModal() {
            document.getElementById('statModal').style.display = 'none';
        }

        function setFreqPeriod(period) {
            currentFreqPeriod = period;
            updateFreqFilterUI();
            renderFrequencyStats();
        }

        function updateFreqFilterUI() {
            const items = document.querySelectorAll('.freq-filter-item');
            items.forEach(item => {
                const onclickStr = item.getAttribute('onclick');
                const p = parseInt(onclickStr.match(/\d+/)[0]);
                if (p === currentFreqPeriod) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function renderFrequencyStats() {
            const container = document.getElementById('freqListContainer');
            const rangeText = document.getElementById('freqRangeText');
            if (!window.lottoHistory) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:red;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // Get sorted rounds
            const rounds = Object.keys(window.lottoHistory).map(Number).sort((a, b) => b - a);
            const totalRoundsAvailable = rounds.length;
            const maxR = rounds[0];

            let targetRounds = rounds;
            let minR = rounds[rounds.length - 1];

            if (currentFreqPeriod > 0) {
                targetRounds = rounds.slice(0, currentFreqPeriod);
                minR = targetRounds[targetRounds.length - 1];
            }

            rangeText.innerText = `${minR}íšŒ ~ ${maxR}íšŒ`;

            // 1. Calculate frequencies for the selected range (1-45)
            const counts = {};
            for (let i = 1; i <= 45; i++) counts[i] = 0;

            targetRounds.forEach(r => {
                const nums = window.lottoHistory[r.toString()];
                nums.forEach(n => {
                    if (counts[n] !== undefined) counts[n]++;
                });
            });

            // 2. Convert to array and sort by frequency (descending)
            const sorted = Object.keys(counts).map(num => ({
                num: parseInt(num),
                count: counts[num]
            })).sort((a, b) => b.count - a.count || a.num - b.num);

            const maxCount = sorted.length > 0 ? sorted[0].count : 0;

            // 3. Render
            let html = '';
            sorted.forEach((item, index) => {
                const percentage = maxCount > 0 ? (item.count / maxCount) * 100 : 0;
                const paddedNum = item.num < 10 ? '0' + item.num : item.num;
                html += `
                    <div class="freq-row">
                        <div class="freq-ball">${paddedNum}</div>
                        <div class="freq-bar-container">
                            <div class="freq-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="freq-count">${item.count}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        let html5QrCode = null;

        function showQRScanner() {
            closeNav();
            const modal = document.getElementById('qrModal');
            modal.style.display = 'flex';

            // Reset Result
            document.getElementById('qrResult').style.display = 'none';
            document.getElementById('qr-reader').style.display = 'block';

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            // Start Camera (Prefer Environment)
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    console.error("Error starting QR scanner", err);
                    alert("ì¹´ë©”ë¼ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n" + err);
                });
        }

        function closeQRScanner() {
            const modal = document.getElementById('qrModal');
            modal.style.display = 'none';

            if (html5QrCode) {
                if (html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        html5QrCode.clear();
                        html5QrCode = null;
                    }).catch(err => console.log("Failed to stop qr code scanner", err));
                } else {
                    html5QrCode.clear();
                    html5QrCode = null;
                }
            }
        }

        function restartQRScanner() {
            // Simply call showQRScanner to reuse the initialization logic
            // But we need to ensure previous instance is cleaned up if it exists in weird state?
            // Usually onScanSuccess cleans it up.
            showQRScanner();
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`);
            if (decodedText.includes('dhlottery.co.kr') && decodedText.includes('v=')) {
                // Stop scanning
                if (html5QrCode) {
                    html5QrCode.stop().then(() => {
                        html5QrCode.clear();
                        html5QrCode = null; // Destroy instance to force fresh start next time
                        document.getElementById('qr-reader').style.display = 'none';
                        verifyLotteryQR(decodedText);
                    }).catch(err => console.error(err));
                }
            } else {
                // Continuous scanning...
            }
        }

        function verifyLotteryQR(url) {
            try {
                const urlObj = new URL(url);
                const v = urlObj.searchParams.get('v');
                if (!v) throw new Error("QR ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨ (v param missing)");

                // Format: ROUND + 'm' + NUMBERS...
                const parts = v.split('m');
                const round = parseInt(parts[0]);
                const rawNumbers = parts[1];

                document.getElementById('qrRound').innerText = round;

                // Get winning numbers
                const winNums = window.lottoHistory ? window.lottoHistory[String(round)] : null;
                const resultArea = document.getElementById('qrResult');
                resultArea.style.display = 'block';

                const listContainer = document.getElementById('qrGameList');
                listContainer.innerHTML = '';

                if (!winNums) {
                    listContainer.innerHTML = `<div style="padding:20px; text-align:center;">
                        ${round}íšŒì°¨ ì¶”ì²¨ ê²°ê³¼ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.<br>
                        (í† ìš”ì¼ ì˜¤í›„ 8ì‹œ 35ë¶„ ì´í›„ í™•ì¸ ê°€ëŠ¥)
                    </div>`;
                    return;
                }

                // winNums: [n1, n2, n3, n4, n5, n6, bonus]
                const mainNums = winNums.slice(0, 6);
                const bonusNum = winNums[6];

                // Parse games
                const games = [];
                // rawNumbers string contains concatenated games.
                // It 'usually' splits by 'n' or other delimiters in older formats?
                // But the snippet saw `v.split('m')` logic.
                // Let's rely on fixed width 12 chars per game logic if possible, 
                // but safeguard against delimiters.
                // Removing non-digit characters is safer.
                const cleanNums = rawNumbers.replace(/[^0-9]/g, '');

                for (let i = 0; i < cleanNums.length; i += 12) {
                    const gameStr = cleanNums.substring(i, i + 12);
                    if (gameStr.length < 12) break;

                    const nums = [];
                    for (let j = 0; j < 12; j += 2) {
                        nums.push(parseInt(gameStr.substring(j, j + 2)));
                    }
                    games.push(nums);
                }

                const gameLabels = ['A', 'B', 'C', 'D', 'E'];

                games.forEach((myNums, idx) => {
                    let matchCount = 0;
                    let bonusMatch = false;

                    myNums.forEach(n => {
                        if (mainNums.includes(n)) matchCount++;
                        if (n === bonusNum) bonusMatch = true;
                    });

                    let rank = "ë‚™ì²¨";
                    let rankClass = "prize-none";

                    if (matchCount === 6) { rank = "1ë“± ğŸ¥‡"; rankClass = "prize-win"; }
                    else if (matchCount === 5 && bonusMatch) { rank = "2ë“± ğŸ¥ˆ"; rankClass = "prize-win"; }
                    else if (matchCount === 5) { rank = "3ë“± ğŸ¥‰"; rankClass = "prize-win"; }
                    else if (matchCount === 4) { rank = "4ë“± ğŸ’µ"; rankClass = "prize-win"; }
                    else if (matchCount === 3) { rank = "5ë“± ğŸ’°"; rankClass = "prize-win"; }

                    // Render
                    const row = document.createElement('div');
                    row.className = 'qr-game-row';

                    const ballsHtml = myNums.map(n => {
                        let style = "display:inline-block; width:20px; text-align:center;";
                        let color = "#333";
                        let weight = "normal";

                        if (mainNums.includes(n)) {
                            color = "#d32f2f"; weight = "bold";
                        } else if (n === bonusNum && matchCount === 5) {
                            color = "#1976d2"; weight = "bold"; // Bonus highlight
                        }

                        return `<span style="${style} color:${color}; font-weight:${weight};">${n}</span>`;
                    }).join('');

                    row.innerHTML = `
                        <div style="font-weight:bold; color:#666; width:20px;">${gameLabels[idx] || '?'}</div>
                        <div style="flex:1; display:flex; justify-content:center; gap:2px; font-size:13px;">
                            ${ballsHtml}
                        </div>
                        <div class="qr-prize-badge ${rankClass}">${rank}</div>
                    `;
                    listContainer.appendChild(row);
                });

            } catch (e) {
                console.error(e);
                alert("QR ì½”ë“œë¥¼ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. " + e.message);
                restartQRScanner();
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', function (event) {
            const adModal = document.getElementById('adModal');
            const statModal = document.getElementById('statModal');
            const qrModal = document.getElementById('qrModal');
            if (event.target === adModal) {
                closeModal();
            }
            if (event.target === statModal) {
                closeStatModal();
            }
            if (event.target === qrModal) {
                closeQRScanner();
            }
        });

        // Handle Back Button
        window.addEventListener('popstate', function (event) {
            // When history changes (Back pressed), we close the modal UI
            // Check if modal is currently visible
            const modal = document.getElementById('adModal');
            if (modal && modal.style.display === 'flex') {
                _internalCloseModal();
            }
        });



        function focusShop(lat, lng) {
            console.log('Focusing shop:', lat, lng);
            // Find marker by coordinates (approximate match to handle float precision)
            const target = markers.find(m => {
                const p = m.getPosition();
                return Math.abs(p.getLat() - lat) < 0.0001 && Math.abs(p.getLng() - lng) < 0.0001;
            });

            if (target) {
                // Zoom in to resolve clusters and ensure marker is visible
                if (map.getLevel() > 5) {
                    map.setLevel(3);
                }
                const mapCenter = new kakao.maps.LatLng(lat, lng);
                map.panTo(mapCenter);

                // Trigger click to open InfoWindow (Wait a bit for pan to finish for better UI)
                setTimeout(() => {
                    kakao.maps.event.trigger(target, 'click');
                }, 300);
            } else {
                console.warn('Marker not found for:', lat, lng);
                showToast("í˜„ì¬ ì¡°ê±´(íšŒì°¨ í•„í„° ë“±)ì— ë§ëŠ” íŒë§¤ì  ë§ˆì»¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "info");
            }
        }

        function findNearestShop(lat, lng) {
            // Find nearest among ACTIVE markers (filtered ones on the map)
            if (!markers || markers.length === 0) {
                showToast("í˜„ì¬ í•„í„° ì¡°ê±´ì— ë¶€í•©í•˜ëŠ” íŒë§¤ì ì´ ì§€ë„ì— ì—†ìŠµë‹ˆë‹¤.", "info");
                return;
            }

            // Sort all markers by distance
            const sortedByDist = markers.map(m => {
                const p = m.getPosition();
                return {
                    marker: m,
                    distance: getDistance(lat, lng, p.getLat(), p.getLng())
                };
            }).sort((a, b) => a.distance - b.distance);

            // Take top 3
            const top3 = sortedByDist.slice(0, 3);

            if (top3.length > 0) {
                let msg = "ğŸ“ <strong>ì£¼ë³€ 1ë“± ë°°ì¶œì  (ê°€ê¹Œìš´ ìˆœ)</strong><br>";
                top3.forEach((item, index) => {
                    const shop = item.marker.shopData;
                    const distStr = item.distance < 1 ? Math.round(item.distance * 1000) + "m" : item.distance.toFixed(1) + "km";
                    // Add clickable span
                    msg += `<div onclick="focusShop(${shop.lat}, ${shop.lng})" style="cursor:pointer; padding:2px 0; text-decoration:underline;">${index + 1}. ${shop.n} (${distStr})</div>`;
                });
                showToast(msg, "success", true); // Pass true to make it persistent

                // Adaptive Zoom: Fit my location and top nearest shops
                const bounds = new kakao.maps.LatLngBounds();
                bounds.extend(new kakao.maps.LatLng(lat, lng));

                top3.forEach(item => {
                    if (item.distance < 10) { // Only include within 10km for bounds
                        bounds.extend(item.marker.getPosition());
                    }
                });

                map.setBounds(bounds, 80, 80, 80, 80);
            }
        }

        function showToast(message, type = "info", persistent = false) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            // Contents
            const content = document.createElement('div');
            content.innerHTML = message;
            toast.appendChild(content);

            // Close Button
            const closeBtn = document.createElement('span');
            closeBtn.className = 'toast-close';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode === container) container.removeChild(toast);
                }, 300);
            };
            toast.appendChild(closeBtn);

            container.appendChild(toast);

            // Force reflow
            toast.offsetHeight;

            toast.classList.add('show');

            // Auto-hide only if NOT persistent
            if (!persistent) {
                setTimeout(() => {
                    if (toast.classList.contains('show')) {
                        toast.classList.remove('show');
                        setTimeout(() => {
                            if (toast.parentNode === container) container.removeChild(toast);
                        }, 300);
                    }
                }, 5000);
            }
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast("ğŸ“‹ ì£¼ì†Œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            } catch (err) {
                showToast("ë³µì‚¬ ì‹¤íŒ¨", "error");
            }
            document.body.removeChild(textarea);
        }

        function openDirections(lat, lng, name) {
            const url = `https://map.kakao.com/link/to/${encodeURIComponent(name)},${lat},${lng}`;
            window.open(url, '_blank');
        }

        function shareToKakao() {
            try {
                console.log('[Kakao Share] Function called');

                // Check if Kakao SDK is loaded
                if (typeof window.Kakao === 'undefined') {
                    console.error('[Kakao Share] Kakao SDK not loaded');
                    return;
                }

                console.log('[Kakao Share] Kakao SDK loaded successfully');

                // Initialize Kakao SDK if not already initialized
                if (!window.Kakao.isInitialized()) {
                    console.log('[Kakao Share] Initializing Kakao SDK...');
                    window.Kakao.init('a6b27b6dab16c7e3459bb9589bf1269d');
                    console.log('[Kakao Share] Kakao SDK initialized');
                } else {
                    console.log('[Kakao Share] Kakao SDK already initialized');
                }

                // Prepare share data - NO IMAGE to ensure k-inov.co.kr link works
                const shareData = {
                    objectType: 'feed',
                    content: {
                        title: 'ğŸ° KINOV ë¡œë˜ ëª…ë‹¹ ì§€ë„',
                        description: 'ì—­ëŒ€ 1ë“± ë‹¹ì²¨ íŒë§¤ì ì„ í•œëˆˆì—! ë‹¹ì‹ ì˜ í–‰ìš´ì„ ì°¾ì•„ë³´ì„¸ìš”.\n\nì§€ê¸ˆ ë°”ë¡œ KINOV Mallì„ ë°©ë¬¸í•˜ì„¸ìš”!',
                        link: {
                            mobileWebUrl: 'https://www.k-inov.co.kr',
                            webUrl: 'https://www.k-inov.co.kr'
                        }
                    },
                    buttons: [
                        {
                            title: 'KINOV Mall ë°©ë¬¸í•˜ê¸°',
                            link: {
                                mobileWebUrl: 'https://www.k-inov.co.kr',
                                webUrl: 'https://www.k-inov.co.kr'
                            }
                        }
                    ]
                };

                console.log('[Kakao Share] Sending share data:', shareData);

                // Send KakaoTalk share message
                window.Kakao.Share.sendDefault(shareData);

                console.log('[Kakao Share] Share dialog opened successfully');

            } catch (error) {
                console.error('[Kakao Share] Error:', error);
            }
        }
    </script>
    <!-- OMR Modal (Re-inserted) -->
    <div id="omrModal" class="omr-modal-overlay" onclick="closeOMR()">
        <div class="omr-modal-content" onclick="event.stopPropagation()">
            <!-- Close X Button (Top Right) -->
            <span onclick="closeOMR()"
                style="position:absolute; top:10px; right:15px; font-size:28px; color:#999; cursor:pointer; line-height:1; transition: color 0.2s;"
                onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">&times;</span>

            <h3 style="margin:0; color:#333;">OMR ë§ˆí‚¹ ë„ìš°ë¯¸</h3>
            <p style="font-size:12px; color:#666; margin:5px 0;">í™”ë©´ì„ ë³´ê³  OMR ì¹´ë“œì— ìƒ‰ì¹ í•˜ì„¸ìš”.</p>
            <div id="omrGrid" class="omr-grid">
                <!-- 1-45 generated here -->
            </div>
            <button onclick="closeOMR()"
                style="width:100%; padding:10px; background:#333; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        function openOMR(numbers) {
            const grid = document.getElementById('omrGrid');
            grid.innerHTML = '';

            // Generate 1-45 grid
            for (let i = 1; i <= 45; i++) {
                const cell = document.createElement('div');
                cell.className = 'omr-number';
                cell.innerText = i;
                if (numbers.includes(i)) {
                    cell.className += ' marked';
                }
                grid.appendChild(cell);
            }

            const modal = document.getElementById('omrModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.className += ' show', 10);
        }

        function closeOMR() {
            const modal = document.getElementById('omrModal');
            modal.className = 'omr-modal-overlay';
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // Updated Clipboard function (Global)
        // Note: Replaces/Overwrites the old one if names collide, or just exists as a better version
        window.copyToClipboard = function (numbers) {
            let text = "";
            if (Array.isArray(numbers)) {
                text = numbers.join(', ');
            } else {
                text = numbers;
            }

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast(`ğŸ“‹ ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ${text}`);
                }).catch(err => {
                    showToast('ë³µì‚¬ ì‹¤íŒ¨: ' + err);
                });
            } else {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast("ğŸ“‹ ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ (êµ¬í˜• ë¸Œë¼ìš°ì €)", "success");
                } catch (err) {
                    showToast("ë³µì‚¬ ì‹¤íŒ¨", "error");
                }
                document.body.removeChild(textarea);
            }
        };
    </script>
</body>

</html>