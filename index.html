<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>KINOV Lotto Map - 전국 로또 명당 지도</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="전국 로또 1등 당첨 판매점을 지도에서 한눈에 확인하세요. 내 주변 명당 찾기, 로또 번호 무료 추천 서비스 제공.">
    <meta name="keywords" content="로또, 로또명당, 로또지도, 로또1등, 로또당첨번호, 로또판매점, KINOV">
    <meta name="author" content="KINOV">

    <!-- Open Graph (KakaoTalk, Facebook, etc.) -->
    <meta property="og:title" content="🎰 KINOV 로또 명당 지도">
    <meta property="og:description" content="역대 1등 당첨 판매점을 한눈에! 당신의 행운을 찾아보세요.">
    <meta property="og:image" content="https://www.k-inov.co.kr/assets/img/lotto_share_thumb.png">
    <!-- Update with actual image URL if available, or use a placeholder -->
    <meta property="og:url" content="https://integral81.github.io/lotto_kakaomap/">
    <meta property="og:type" content="website">

    <!-- Favicon (Using Emoji for now if no file exists) -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎰</text></svg>">
    <script>
        // SDK Error Handler (Defined first)
        function handleScriptError() {
            const mapDiv = document.getElementById('map');
            const usedKey = 'a6b27b6dab16c7e3459bb9589bf1269d';
            if (mapDiv) {
                mapDiv.innerHTML = `
                    <div style="padding:40px; text-align:center; color:#d32f2f;">
                        <h2 style="margin-bottom:10px;">🔑 카카오 지도 인증 실패 (Domain Mismatch)</h2>
                        <p style="color:#333; font-size:16px;">인터넷 연결은 확인되었으나, 카카오 서버에서 <strong>도메인 거부</strong>가 발생했습니다.</p>
                        
                        <div style="background:#fff; border:1px solid #d32f2f; padding:20px; border-radius:10px; text-align:left; margin: 20px auto; color:#333; max-width:600px; font-size:14px; line-height:1.6;">
                            <strong>✅ 이 순서대로 해결해 보세요:</strong><br><br>
                            1. <strong>도메인 추가 등록</strong>: 카카오 콘솔 [플랫폼 > Web] 사이트 도메인에 아래 주소들이 등록되어 있는지 확인해 주세요:
                               <ul style="margin:5px 0 15px 20px;">
                                 <li><code>http://localhost:8000</code></li>
                                 <li><code>http://127.0.0.1:8000</code></li>
                               </ul>
                            2. <strong>올바른 키 사용 확인</strong>: 카카오 콘솔 [내 애플리케이션 > 요약 정보]에서 반드시 <strong>'JavaScript 키'</strong>를 복사했는지 확인해 주세요.<br><br>
                            <div style="background:#eee; padding:10px; border-radius:5px; border:1px dashed #999;">
                                <strong>현재 사용 중인 키:</strong> <code>${usedKey}</code>
                            </div>
                        </div>
                        <p style="color:#666;">설정을 변경한 후 브라우저를 <strong>새로고침(F5)</strong> 해주세요.</p>
                    </div>`;
            }
        }
    </script>
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a6b27b6dab16c7e3459bb9589bf1269d&libraries=clusterer"
        onerror="handleScriptError()"></script>
    <!-- Kakao SDK for Sharing -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"></script>
    <style>
        :root {
            --primary: #d32f2f;
            --secondary: #1976d2;
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #333333;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Pretendard', system-ui, sans-serif;
            background-color: var(--bg);
            overflow: hidden;
        }

        #app {
            display: flex !important;
            width: 100vw;
            height: 100vh;
            flex-direction: row;
            overflow: hidden;
        }

        #sidebar {
            width: 320px;
            height: 100%;
            background: var(--card);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            order: 1;
            /* PC: First */
        }

        #map {
            flex: 1;
            height: 100%;
            background: #eee;
            order: 2;
            /* PC: Second */
        }

        h1 {
            font-size: 20px;
            color: var(--primary);
            margin: 0 0 20px 0;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .section-title {
            font-weight: 700;
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            display: block;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="number"] {
            width: 70px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-apply {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }

        .btn-apply:hover {
            background-color: #b71c1c;
        }

        .stats-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: auto;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .stat-value {
            color: var(--primary);
            font-weight: 700;
        }

        .infowindow {
            padding: 12px;
            min-width: 200px;
            min-height: 120px;
            box-sizing: border-box;
            background: #fff;
        }

        .iw-title {
            font-weight: 700;
            font-size: 15px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .iw-addr {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }

        .iw-tag {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            background: #eee;
            font-size: 10px;
            margin: 0 2px 2px 0;
        }

        .iw-actions {
            display: flex !important;
            gap: 10px;
            margin-top: 15px;
            border-top: 1px dashed #eee;
            padding-top: 12px;
            visibility: visible !important;
        }

        .btn-iw {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
            border: 1px solid #ddd;
            background: #fff;
        }

        .btn-iw:hover {
            background: #f5f5f5;
        }

        .btn-navi {
            background: var(--secondary) !important;
            color: white !important;
            border: none !important;
        }

        .btn-navi:hover {
            background: #1565c0 !important;
        }

        .iw-addr-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9f9f9;
            padding: 5px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .iw-addr-box:hover {
            background: #f0f0f0;
        }

        /* GPS Pulse Animation */
        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .pulse {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(25, 118, 210, 0.5);
            border-radius: 50%;
            animation: pulse 2s infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* Floating Button Common */
        .floating-btn {
            position: fixed;
            width: 50px;
            height: 50px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .floating-btn:hover {
            transform: scale(1.1);
            background: #f0f0f0;
        }

        /* GPS Button Position */
        .gps-button {
            bottom: 30px;
            right: 30px;
            background: var(--primary);
            color: white;
            border: none;
        }

        .gps-button svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        /* Loading state for GPS */
        .gps-button.loading svg {
            animation: rotate 1s linear infinite;
        }

        /* Menu Button Style */
        .menu-btn {
            top: 20px;
            right: 20px;
            border: 2px solid var(--secondary);
        }

        .hamburger-icon {
            width: 20px;
            height: 14px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hamburger-icon span {
            display: block;
            width: 100%;
            height: 2px;
            background: var(--secondary);
            border-radius: 2px;
            transition: all 0.3s;
        }

        .menu-btn.active .hamburger-icon span:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }

        .menu-btn.active .hamburger-icon span:nth-child(2) {
            opacity: 0;
        }

        .menu-btn.active .hamburger-icon span:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }

        /* Side Nav Drawer */
        .side-nav {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: white;
            z-index: 9000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
        }

        .side-nav.open {
            transform: translateX(0);
        }

        .side-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 8999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .side-nav-overlay.show {
            display: block;
            opacity: 1;
        }

        .side-nav-header {
            padding: 25px 20px;
            background: linear-gradient(135deg, var(--secondary), #1565c0);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .side-nav-header .logo {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .close-nav {
            font-size: 28px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .close-nav:hover {
            opacity: 1;
        }

        .side-nav-body {
            padding: 20px 0;
            flex: 1;
            overflow-y: auto;
        }

        .menu-category {
            padding: 10px 20px;
            font-size: 11px;
            font-weight: 700;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 4px solid transparent;
        }

        .menu-item:hover {
            background: #f8f9fa;
            border-left-color: var(--secondary);
        }

        .menu-item .m-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .menu-item .m-text {
            font-size: 15px;
            font-weight: 600;
            color: #444;
        }

        .side-nav-footer {
            padding: 20px;
            font-size: 12px;
            color: #999;
            text-align: center;
            border-top: 1px solid #eee;
        }

        /* Mobile specific adjustments */
        @media (max-width: 640px) {
            .side-nav {
                width: 80%;
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @-webkit-keyframes rotate {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(360deg);
            }
        }

        /* Responsive Design for Mobile (Phone only) */
        @media (max-width: 640px) {
            #app {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                overflow: auto;
            }

            #sidebar {
                width: 100%;
                height: auto;
                flex: none;
                order: 2;
                /* Mobile: Sidebar Bottom */
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }

            #map {
                width: 100%;
                height: 400px;
                flex: none;
                order: 1;
                /* Mobile: Map Top */
            }
        }

        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: #333;
            padding: 14px 28px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            white-space: pre-wrap;
            text-align: left;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            max-width: 90vw;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 500;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-info {
            border-left: 5px solid var(--secondary);
        }

        .toast-error {
            border-left: 5px solid var(--primary);
        }

        .toast-success {
            border-left: 5px solid #48bb78;
        }

        /* GPS Pulse Animation (Works on all devices) */
        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .pulse {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(25, 118, 210, 0.5);
            border-radius: 50%;
            animation: pulse 2s infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* Gold Button & Modal */
        .btn-gold {
            background: linear-gradient(135deg, #FFD700, #FFA000);
            color: #333;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            animation: shiver 2s infinite;
        }

        @keyframes shiver {
            0% {
                transform: rotate(0deg);
            }

            5% {
                transform: rotate(2deg);
            }

            10% {
                transform: rotate(-2deg);
            }

            15% {
                transform: rotate(2deg);
            }

            20% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            cursor: pointer;
            /* Critical for iOS to recognize clicks on transparent/overlay elements */
        }

        .modal-content {
            background-color: transparent;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            cursor: default;
            /* Reset cursor for content area */
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 32px;
            cursor: pointer;
            color: white;
            z-index: 10;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .modal-close:hover {
            transform: scale(1.1);
        }

        .lucky-balls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
        }

        .ball {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .ball.one {
            background: #fbc400;
        }

        .ball.two {
            background: #69c8f2;
        }

        .ball.three {
            background: #ff7272;
        }

        .ball.four {
            background: #aaaaaa;
        }

        .ball.five {
            background: #b0d840;
        }

        /* Mini Ball for Recent Rounds */
        .mini-ball {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 800;
            color: white;
            margin-right: 3px;
            box-shadow: inset -2px -2px 4px rgba(0, 0, 0, 0.2);
        }

        .mini-ball.one {
            background: #fbc400;
            color: #333;
            text-shadow: none;
        }

        .mini-ball.two {
            background: #69c8f2;
        }

        .mini-ball.three {
            background: #ff7272;
        }

        .mini-ball.four {
            background: #aaaaaa;
        }

        .mini-ball.five {
            background: #b0d840;
        }

        .recent-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 5px 8px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .recent-round-num {
            font-size: 11px;
            font-weight: bold;
            color: #555;
            width: 45px;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            #app {
                flex-direction: column !important;
            }

            #sidebar {
                width: 100% !important;
                height: auto !important;
                max-height: 50vh !important;
                order: 2 !important;
                padding: 15px !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }

            #map {
                order: 1 !important;
                height: 50vh !important;
                min-height: 300px !important;
            }

            h1 {
                font-size: 18px !important;
                margin: 0 0 15px 0 !important;
            }

            .section {
                margin-bottom: 15px !important;
                padding-bottom: 15px !important;
            }

            .section-title {
                font-size: 13px !important;
            }

            .btn-apply {
                font-size: 14px !important;
                padding: 12px !important;
            }

            .stats-card {
                font-size: 12px !important;
                padding: 12px !important;
            }

            .modal-content {
                width: 95% !important;
                max-width: 95% !important;
                margin: 0 auto !important;
            }

            #adContent,
            #resultContent {
                padding: 15px !important;
                width: 100% !important;
                box-sizing: border-box !important;
                /* Ensure padding doesn't add to width */
            }

            .modal-close {
                right: 10px !important;
                top: 10px !important;
            }
        }

        /* Selection Menu Styles (Global) */
        .selection-menu {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            margin-top: 10px;
        }

        .selection-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: left;
        }

        .selection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background: white;
        }

        .selection-icon {
            font-size: 24px;
            background: #f0f4f8;
            min-width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selection-info {
            flex: 1;
        }

        .selection-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
            display: block;
        }

        .selection-desc {
            font-size: 12px;
            color: #666;
            display: block;
        }

        /* Loading Animation */
        .loader-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fae100;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Dream Mode Styles */
        .dream-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .dream-tag {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dream-tag:hover {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .dream-input-box {
            display: flex;
            gap: 5px;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .dream-input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            text-align: center;
            outline: none;
        }

        .btn-dream-submit {
            background: #fae100;
            color: #333;
            border: none;
            padding: 0 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Input Container for Dream/Zodiac */
        .input-container {
            display: none;
            width: 100%;
            text-align: center;
        }

        .btn-sm {
            background-color: #555;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-sm:hover {
            background-color: #333;
        }

        /* Zodiac Mode Styles */
        .zodiac-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 320px;
            margin: 0 auto;
        }

        .zodiac-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            aspect-ratio: 1;
            /* Square shape */
        }

        .zodiac-item:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .zodiac-icon {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .zodiac-name {
            font-size: 12px;
            color: white;
            font-weight: bold;
        }

        .horoscope-text-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            color: white;
            font-size: 14px;
            line-height: 1.5;
            border-left: 4px solid #fae100;
        }
    </style>
</head>

<body>
    <div id="toast-container"></div>
    <div id="app">
        <div id="sidebar">
            <h1>🎰 KINOV Lotto Map</h1>
            <div class="section">
                <span class="section-title">📅 회차 필터 (Round)</span>
                <div class="input-row">
                    <input type="number" id="minRound" value="1201">
                    <span>~</span>
                    <input type="number" id="maxRound" value="1210" max="1210"
                        oninput="if(parseInt(this.value) > 1210) this.value = 1210;">
                    <button class="btn-sm" onclick="refreshRecentRounds()">조회</button>
                </div>
                <!-- Data Availability Notice -->
                <div
                    style="font-size:14px; font-weight:bold; color:#d32f2f; margin-top:8px; line-height:1.4; background:rgba(255,0,0,0.05); padding:8px; border-radius:4px; border:1px solid rgba(255,0,0,0.1);">
                    1. 1등 당첨번호는 1회차부터 제공<br>
                    2. 1등 판매점현황은 262회차부터 제공
                </div>
            </div>

            <!-- Recent 3 Rounds Display -->
            <div class="section" id="recentRoundsContainer"
                style="background:#f0f4f8; padding:10px; border-radius:8px; margin-bottom:20px;">
                <span class="section-title" style="margin-bottom:8px;">📊 최근 3회차 당첨번호 (기준: <span id="recentRefRound"
                        style="color:#d32f2f;">1210</span>회)</span>
                <div id="recentRoundsList" style="display:flex; flex-direction:column; gap:6px;">
                    <!-- Javascript will populate this -->
                    <div style="font-size:12px; color:#666; text-align:center;">데이터 로딩 중...</div>
                </div>
            </div>

            <div class="section">
                <span class="section-title">🏆 당첨 횟수 필터 (Frequency)</span>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="freq5" checked> 🌟 5회 이상</label>
                    <label class="checkbox-item"><input type="checkbox" id="freq3" checked> 🔴 3~4회</label>
                    <label class="checkbox-item"><input type="checkbox" id="freq1" checked> 🔵 2회 이하</label>
                </div>
            </div>
            <div class="section">
                <span class="section-title">🎲 당첨 방식 (Method)</span>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="methodAuto" checked> 자동</label>
                    <label class="checkbox-item"><input type="checkbox" id="methodManual" checked> 수동</label>
                    <label class="checkbox-item"><input type="checkbox" id="methodSemi" checked> 반자동</label>
                </div>
            </div>
            <button class="btn-apply" onclick="applyFilters()">적용하기</button>
            <div class="stats-card">
                <div class="stat-item"><span>전체 데이터</span> <span id="totalDataCount">0</span></div>
                <div class="stat-item"><span>필터링 결과</span> <span id="filteredCount" class="stat-value">0</span></div>

                <!-- Fallback file loader -->
                <div id="manualLoader"
                    style="display:none; margin-top:10px; padding-top:10px; border-top:1px dashed #ccc;">
                    <p style="font-size:11px; color:#666; margin-bottom:5px;">⚠️ 자동 로드 실패 시 파일을 직접 선택해 주세요.</p>
                    <input type="file" id="fileInput" accept=".json" style="display:none;"
                        onchange="handleFileSelect(event)">
                    <button class="btn-apply" style="background:#333; font-size:12px; padding:8px;"
                        onclick="document.getElementById('fileInput').click()">파일 직접 선택하기 (lotto_data.json)</button>
                </div>
            </div>
        </div> <!-- end #sidebar -->
        <div id="map"></div>
    </div> <!-- end #app -->

    <!-- Hamburger Menu Button -->
    <div id="menuBtn" class="floating-btn menu-btn" onclick="toggleNav()" title="메뉴 열기">
        <div class="hamburger-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <!-- GPS Button -->
    <div class="floating-btn gps-button" onclick="requestMyLocation()" title="내 위치 찾기">
        <svg viewBox="0 0 24 24">
            <path
                d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z" />
        </svg>
    </div>

    <!-- Side Navigation Drawer -->
    <div id="sideNavOverlay" class="side-nav-overlay" onclick="closeNav()"></div>
    <div id="sideNav" class="side-nav">
        <div class="side-nav-header">
            <div class="logo">🎰 KINOV</div>
            <span class="close-nav" onclick="closeNav()">&times;</span>
        </div>

        <div class="side-nav-body">
            <div class="menu-category">당첨 정보</div>
            <div class="menu-item" onclick="showStats()">
                <span class="m-icon">📊</span>
                <span class="m-text">번호별 출현횟수 (준비중)</span>
            </div>
            <!-- Nationwide Rankings placeholder if needed later -->

            <div class="menu-category">편의 기능</div>
            <div class="menu-item" onclick="showQRScanner()">
                <span class="m-icon">📷</span>
                <span class="m-text">QR코드 당첨확인 (준비중)</span>
            </div>
            <div class="menu-item" onclick="requestMyLocation(); closeNav();">
                <span class="m-icon">📍</span>
                <span class="m-text">내 주변 명당 찾기</span>
            </div>

            <div class="menu-category">기타</div>
            <div class="menu-item" onclick="shareToKakao()">
                <span class="m-icon">📢</span>
                <span class="m-text">친구에게 공유하기</span>
            </div>
        </div>

        <div class="side-nav-footer">
            &copy; 2026 KINOV. All rights reserved.
        </div>
    </div>

    <div id="adModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="adContent"
                style="width:100%; height:450px; padding:20px; overflow-y:auto; display:flex; flex-direction:column; align-items:center; justify-content:center; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">

                <!-- Mode Selection Menu -->
                <div id="modeSelection" style="width:100%; max-width:400px;">
                    <div style="background:#fae100; color:#3c1e1e; padding:8px 15px; text-align:center; font-weight:bold; cursor:pointer; font-size:14px; border-radius:8px; margin-bottom:15px; box-shadow:0 2px 4px rgba(0,0,0,0.1);"
                        onclick="shareToKakao()">
                        📢 카톡 공유하고 당첨 확률 높이기 (클릭)
                    </div>

                    <h2
                        style="color:white; text-align:center; margin-bottom:15px; font-size:20px; text-shadow:0 1px 2px rgba(0,0,0,0.2);">
                        🔮 번호 생성 방식을 선택하세요
                    </h2>

                    <div class="selection-menu">
                        <!-- 1. Data Analysis -->
                        <div class="selection-card" onclick="selectAnalysisMode()">
                            <div class="selection-icon">📊</div>
                            <div class="selection-info">
                                <span class="selection-title">데이터 정밀 분석</span>
                                <span class="selection-desc">명당의 과거 당첨 패턴을 정밀 분석</span>
                            </div>
                        </div>

                        <!-- 2. Dream -->
                        <div class="selection-card" onclick="selectDreamMode()">
                            <div class="selection-icon">🌙</div>
                            <div class="selection-info">
                                <span class="selection-title">꿈 해몽 번호</span>
                                <span class="selection-desc">어젯밤 꿈 내용을 입력해보세요</span>
                            </div>
                        </div>

                        <!-- 3. Horoscope -->
                        <div class="selection-card" onclick="selectHoroscopeMode()">
                            <div class="selection-icon">🐅</div>
                            <div class="selection-info">
                                <span class="selection-title">오늘의 띠별 운세</span>
                                <span class="selection-desc">나의 띠에 맞는 행운의 숫자</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Animation (Initially Hidden) -->
                <div id="analysisLoading" class="loader-container">
                    <div class="spinner"></div>
                    <h3 style="margin:10px 0; font-size:22px;">데이터 분석 중...</h3>
                    <p style="font-size:14px; opacity:0.9;">명당의 기운을 모으고 있습니다</p>
                </div>

                <!-- Placeholders for Step 2 & 3 -->
                <div id="modeDreamInput" class="input-container">
                    <h2 style="color:white; font-size:20px; margin-bottom:15px; text-shadow:0 1px 2px rgba(0,0,0,0.2);">
                        🌙 어젯밤 무슨 꿈을 꾸셨나요?
                    </h2>

                    <div class="dream-tags">
                        <button class="dream-tag" onclick="handleDreamTag('돼지')">🐷 돼지</button>
                        <button class="dream-tag" onclick="handleDreamTag('똥')">💩 똥</button>
                        <button class="dream-tag" onclick="handleDreamTag('조상')">👴 조상</button>
                        <button class="dream-tag" onclick="handleDreamTag('불')">🔥 불</button>
                        <button class="dream-tag" onclick="handleDreamTag('물')">💧 물</button>
                        <button class="dream-tag" onclick="handleDreamTag('뱀')">🐍 뱀</button>
                    </div>

                    <div class="dream-input-box">
                        <input type="text" id="dreamInput" class="dream-input" placeholder="기타 꿈 입력 (10자 이내)"
                            maxlength="10">
                        <button class="btn-dream-submit" onclick="handleDreamSubmit()">결과보기</button>
                    </div>

                    <div style="margin-top:20px;">
                        <button class="btn-sm" style="background:rgba(0,0,0,0.3);" onclick="resetToModeSelection()">🔙
                            뒤로가기</button>
                    </div>
                </div>
                <div id="modeHoroscopeSelect" class="input-container">
                    <h2 style="color:white; font-size:20px; margin-bottom:15px; text-shadow:0 1px 2px rgba(0,0,0,0.2);">
                        🐅 당신의 띠를 선택하세요
                    </h2>
                    <div class="zodiac-grid">
                        <div class="zodiac-item" onclick="handleZodiacClick('쥐', '🐹')"><span
                                class="zodiac-icon">🐹</span><span class="zodiac-name">쥐띠</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('소', '🐮')"><span
                                class="zodiac-icon">🐮</span><span class="zodiac-name">소띠</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('호랑이', '🐯')"><span
                                class="zodiac-icon">🐯</span><span class="zodiac-name">범띠</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('토끼', '🐰')"><span
                                class="zodiac-icon">🐰</span><span class="zodiac-name">토끼띠</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('용', '🐲')"><span
                                class="zodiac-icon">🐲</span><span class="zodiac-name">용띠</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('뱀', '🐍')"><span
                                class="zodiac-icon">🐍</span><span class="zodiac-name">뱀띠</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('말', '🐴')"><span
                                class="zodiac-icon">🐴</span><span class="zodiac-name">말띠</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('양', '🐑')"><span
                                class="zodiac-icon">🐑</span><span class="zodiac-name">양띠</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('원숭이', '🐵')"><span
                                class="zodiac-icon">🐵</span><span class="zodiac-name">원숭이띠</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('닭', '🐔')"><span
                                class="zodiac-icon">🐔</span><span class="zodiac-name">닭띠</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('개', '🐶')"><span
                                class="zodiac-icon">🐶</span><span class="zodiac-name">개띠</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('돼지', '🐷')"><span
                                class="zodiac-icon">🐷</span><span class="zodiac-name">돼지띠</span></div>
                    </div>

                    <div style="margin-top:20px;">
                        <button class="btn-sm" style="background:rgba(0,0,0,0.3);" onclick="resetToModeSelection()">🔙
                            뒤로가기</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="resultContent"
            style="display:none; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:40px 20px; min-height:420px;">
            <h2 style="color:white; text-shadow:0 2px 4px rgba(0,0,0,0.2);">🎉 추천 번호 생성 완료! 🎉</h2>
            <p id="resultInfoText" style="font-size:13px; color:rgba(255,255,255,0.95); margin-bottom:10px;">
                이 명당은 과거 <strong id="paramHCount" style="color:#fae100;">0</strong>번의 1등을 배출했습니다.<br>
                (<span id="paramRounds"></span> 등)
            </p>
            <div class="lucky-balls" id="luckyBalls">
                <!-- Balls go here -->
            </div>
            <p style="font-size:12px; color:rgba(255,255,255,0.8);">* 재미로만 봐주세요. 과도한 구매는 금물!</p>
            <button class="btn-apply btn-navi"
                style="margin-top:10px; background:#fae100; color:#3c1e1e; border:none; padding:12px 30px; border-radius:25px; font-weight:bold; box-shadow:0 4px 12px rgba(0,0,0,0.2);"
                onclick="goToShop()">
                🚗 지금 당장 사러 가기 (길찾기)
        </div> <!-- end info-modal -->
    </div> <!-- end ad-content -->

    <script>
        let map, clusterer, allData = [], markers = [];
        let currentInfoWindow = null; // Track the currently open InfoWindow


        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    processLoadedData(data);
                    document.getElementById('manualLoader').style.display = 'none';
                    alert('데이터를 성공적으로 불러왔습니다! (' + data.length + '건)');
                } catch (err) {
                    alert('파일 형식이 잘못되었습니다: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function processLoadedData(data) {
            allData = data;

            // Calculate win count per shop (Name + Address)
            const shopWins = {};
            data.forEach(item => {
                const key = (item.n || '').trim() + '|' + (item.a || '').trim();
                shopWins[key] = (shopWins[key] || 0) + 1;
            });
            // Attach individual shop win count to each record
            let highWinCount = 0;
            data.forEach(item => {
                const key = (item.n || '').trim() + '|' + (item.a || '').trim();
                item.totalWins = shopWins[key];
                if (item.totalWins >= 5) highWinCount++;
            });
            console.log('Grouped Shops:', Object.keys(shopWins).length);
            console.log('Records with 5+ wins:', highWinCount);

            document.getElementById('totalDataCount').innerText = data.length.toLocaleString();
            if (data.length > 0) {
                const rounds = data.map(d => d.r);
                const maxR = Math.max(...rounds);
                const minR = Math.min(...rounds);
                document.getElementById('maxRound').value = maxR;
                document.getElementById('minRound').value = Math.max(1, maxR - 9);
            }

            applyFilters();

            // Initial load of recent rounds
            const initialMax = parseInt(document.getElementById('maxRound').value) || 1210;
            updateRecentRounds(initialMax);
        }

        window.onload = function () {
            if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
                handleScriptError();
                return;
            }

            const mapContainer = document.getElementById('map');
            const mapOption = { center: new kakao.maps.LatLng(36.2683, 127.6358), level: 12 };
            map = new kakao.maps.Map(mapContainer, mapOption);

            clusterer = new kakao.maps.MarkerClusterer({
                map: map, averageCenter: true, minLevel: 10,
                styles: [{
                    width: '40px', height: '40px', background: 'rgba(211, 47, 47, 0.8)',
                    color: '#fff', textAlign: 'center', lineHeight: '40px',
                    borderRadius: '20px', fontWeight: 'bold'
                }]
            });

            loadData();
        };

        function loadData() {
            const countEl = document.getElementById('totalDataCount');
            console.log('Loading data...');

            Promise.all([
                fetch('lotto_data.json?v=' + Date.now()).then(res => res.json()),
                fetch('lotto_history.json?v=' + Date.now()).then(res => res.json())
            ])
                .then(([lottoData, historyData]) => {
                    window.lottoHistory = historyData; // Global variable
                    processLoadedData(lottoData);
                })
                .catch(err => {
                    console.error('Data load failed:', err);
                    countEl.innerHTML = `<span style="color:red; font-size:11px; cursor:help;" title="${err.message}">로드 실패 (${err.name})</span>`;
                    document.getElementById('manualLoader').style.display = 'block';
                    alert('데이터 파일 로드 중 에러가 발생했습니다.\n\n' + err.message);
                });
        }

        /**
         * 🔮 Lucky Number Generator Algorithm
         * 1. Store Luck (50%): Numbers that won in this store's history.
         * 2. Global Hot (30%): Most frequent numbers in recent 100 rounds (Simulated for now).
         * 3. Random (20%): Pure random luck.
         */
        function generateLuckyNumbers(storeWins) {
            // storeWins: Array of winning rounds for this store e.g., [{r: 1000, m: '자동'}, ...]
            const history = window.lottoHistory || {};
            const numberWeights = {};

            // Initialize weights
            for (let i = 1; i <= 45; i++) numberWeights[i] = 1; // Base weight

            // 1. Analyze Store History
            let winningNumbers = [];
            storeWins.forEach(win => {
                const round = win.r;
                if (history[round]) {
                    const nums = history[round];
                    winningNumbers = [...winningNumbers, ...nums];
                    nums.forEach(n => {
                        numberWeights[n] += 5; // Boost weight for numbers that appeared in this store's winning rounds
                    });
                }
            });

            // 2. Select 6 numbers based on weights
            const selected = new Set();
            while (selected.size < 6) {
                const n = weightedRandom(numberWeights);
                selected.add(n);
            }

            return {
                numbers: Array.from(selected).sort((a, b) => a - b),
                historyCount: storeWins.length,
                relatedRounds: storeWins.map(w => w.r).slice(0, 5) // Top 5 recent rounds
            };
        }

        function weightedRandom(weights) {
            let sum = 0;
            for (let i in weights) sum += weights[i];
            let rand = Math.random() * sum;
            for (let i in weights) {
                rand -= weights[i];
                if (rand < 0) return parseInt(i);
            }
            return Math.floor(Math.random() * 45) + 1; // Fallback
        }

        function applyFilters() {
            const minR = parseInt(document.getElementById('minRound').value) || 0;
            const maxR = parseInt(document.getElementById('maxRound').value) || 9999;
            const auto = document.getElementById('methodAuto').checked;
            const manual = document.getElementById('methodManual').checked;
            const semi = document.getElementById('methodSemi').checked;

            // Frequency Filters
            const f5 = document.getElementById('freq5').checked;
            const f3 = document.getElementById('freq3').checked;
            const f1 = document.getElementById('freq1').checked;

            const filtered = allData.filter(d => {
                const rMatch = d.r >= minR && d.r <= maxR;
                let mMatch = false;
                if (auto && d.m.includes('자동')) mMatch = true;
                if (manual && d.m.includes('수동')) mMatch = true;
                if (semi && d.m.includes('반자동')) mMatch = true;

                let fMatch = false;
                if (f5 && d.totalWins >= 5) fMatch = true;
                if (f3 && d.totalWins >= 3 && d.totalWins <= 4) fMatch = true;
                if (f1 && d.totalWins <= 2) fMatch = true;

                return rMatch && mMatch && fMatch;
            });

            document.getElementById('filteredCount').innerText = filtered.length.toLocaleString();
            updateMarkers(filtered);
            // updateRecentRounds(maxR); // Removed as per user request
        }

        function refreshRecentRounds() {
            const maxR = parseInt(document.getElementById('maxRound').value) || 9999;
            updateRecentRounds(maxR);
        }

        function updateRecentRounds(maxRound) {
            const container = document.getElementById('recentRoundsList');
            const refSpan = document.getElementById('recentRefRound');
            if (refSpan) refSpan.innerText = maxRound;

            if (!container) return;

            container.innerHTML = '';

            // Check if history data is loaded
            if (!window.lottoHistory) {
                container.innerHTML = '<div style="font-size:12px; color:#666; text-align:center;">데이터 로딩 중...</div>';
                return;
            }

            // Loop 3 rounds: maxRound, maxRound-1, maxRound-2 (Reduced to save space)
            for (let i = 0; i < 3; i++) {
                const targetRound = maxRound - i;
                if (targetRound < 1) continue; // No rounds below 1

                const row = document.createElement('div');
                row.className = 'recent-row';

                // Round Number
                const roundNum = document.createElement('span');
                roundNum.className = 'recent-round-num';
                roundNum.innerText = targetRound + '회';
                row.appendChild(roundNum);

                // Balls Container
                const ballsDiv = document.createElement('div');
                ballsDiv.style.display = 'flex';
                ballsDiv.style.gap = '2px';

                // Get Winning Numbers
                // lottoHistory key is string "1210"
                const nums = window.lottoHistory[String(targetRound)];

                if (nums && nums.length > 0) {
                    nums.sort((a, b) => a - b).forEach(n => {
                        const ball = document.createElement('span');
                        ball.className = 'mini-ball ' + getBallColor(n);
                        ball.innerText = n;
                        ballsDiv.appendChild(ball);
                    });
                } else {
                    const noData = document.createElement('span');
                    noData.style.fontSize = '11px';
                    noData.style.color = '#999';
                    noData.innerText = '데이터 없음';
                    ballsDiv.appendChild(noData);
                }

                row.appendChild(ballsDiv);
                container.appendChild(row);
            }
        }

        function updateMarkers(data) {
            clusterer.clear();
            markers.forEach(m => m.setMap(null));
            markers = [];

            // To avoid duplicate markers for the same shop at the same location,
            // we need to group the filtered data by shop (lat, lng, name, address)
            // and then create a single marker for each unique shop.
            const uniqueShops = {};
            data.forEach(d => {
                const key = `${d.lat}_${d.lng}_${d.n}_${d.a}`;
                if (!uniqueShops[key]) {
                    uniqueShops[key] = {
                        n: d.n,
                        a: d.a,
                        lat: d.lat,
                        lng: d.lng,
                        totalWins: d.totalWins, // This is the total wins for the shop
                        rounds: [] // To store individual round details for infowindow
                    };
                }
                uniqueShops[key].rounds.push({ r: d.r, m: d.m });
            });

            Object.values(uniqueShops).forEach(shop => {
                let markerImg = null;
                // Tiered Styles
                if (shop.totalWins >= 5) {
                    // Legendary Gold Star
                    markerImg = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
                        new kakao.maps.Size(24, 35)
                    );
                } else if (shop.totalWins >= 3) {
                    // Professional Red
                    markerImg = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/2018/pc/img/marker_spot.png',
                        new kakao.maps.Size(24, 35),
                        { offset: new kakao.maps.Point(12, 35) }
                    );
                }

                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(shop.lat, shop.lng),
                    image: markerImg
                });

                const sortedRounds = shop.rounds.sort((a, b) => b.r - a.r);
                const roundTagsHtml = sortedRounds.map(r => `<span class="iw-tag">${r.r}회(${r.m})</span>`).join('');

                const safeAddr = (shop.a || "").replace(/'/g, "\\'").replace(/\n/g, " ");
                const safeName = (shop.n || "").replace(/'/g, "\\'").replace(/\n/g, " ");

                const content = `
                    <div class="infowindow">
                        <div class="iw-title">${shop.n} ${shop.totalWins >= 5 ? '🌟' : ''}</div>
                        <div class="iw-addr-box" onclick="copyToClipboard('${safeAddr}')" title="주소 복사">
                            <span class="iw-addr">${shop.a}</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="#666"><path d="M16 1H4c-1.11 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        </div>
                        <div style="font-weight:bold; color:red; margin-bottom:5px;">총 ${shop.totalWins}회 당첨</div>
                        <div class="iw-details">${roundTagsHtml}</div>
                        <button class="btn-gold" onclick="openAdModal('${safeName}', '${safeAddr}', ${shop.lat}, ${shop.lng}, ${shop.totalWins})">
                            ✨ 이번 주 1등 추천 번호 받기
                        </button>
                        <div class="iw-actions">
                            <button class="btn-iw btn-navi" onclick="openDirections(${shop.lat}, ${shop.lng}, '${safeName}')">
                                🚗 길찾기
                            </button>
                        </div>
                    </div>
                `;

                const infowindow = new kakao.maps.InfoWindow({
                    content: content,
                    removable: true,
                    zIndex: 1500 // Ensure popup is on top of markers
                });

                kakao.maps.event.addListener(marker, 'click', () => {
                    // Close previous InfoWindow if exists
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }

                    infowindow.open(map, marker);
                    currentInfoWindow = infowindow; // Update current
                });

                markers.push(marker);
            });
            clusterer.addMarkers(markers);
        }

        /**
         * GPS Location Service Module
         * Handles user positioning, nearest shop calculation, and UI feedback (Toasts).
         */
        let myLocationMarker = null;

        function requestMyLocation() {
            if (!navigator.onLine) {
                showToast("🌐 인터넷 연결이 끊겨 있습니다. 네트워크를 확인해 주세요.", "error");
                return;
            }

            if (!navigator.geolocation) {
                showToast("🚫 이 브라우저에서는 위치 정보를 사용할 수 없습니다.", "error");
                return;
            }

            const gpsBtn = document.querySelector('.gps-button');
            if (gpsBtn) gpsBtn.classList.add('loading');

            // GPS Permission & Fetch
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    if (gpsBtn) gpsBtn.classList.remove('loading');
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const center = new kakao.maps.LatLng(lat, lng);

                    map.setCenter(center);

                    // Close all infowindows to clear the view
                    if (typeof clusterer !== 'undefined') {
                        // There's no direct 'closeAll' on clusterer, but we can just let it be
                    }

                    // Add/Update Blue Dot Marker
                    if (!myLocationMarker) {
                        myLocationMarker = new kakao.maps.CustomOverlay({
                            position: center,
                            content: `
                                <div style="position:relative;">
                                    <div class="pulse"></div>
                                    <div style="width:16px; height:16px; background:#1976d2; border:2px solid #fff; border-radius:50%; box-shadow:0 0 10px rgba(0,0,0,0.5); position:relative; z-index:2; transform: translate(-50%, -50%);"></div>
                                </div>
                            `,
                            map: map,
                            zIndex: 1001
                        });
                    } else {
                        myLocationMarker.setPosition(center);
                        myLocationMarker.setMap(map);
                    }

                    findNearestShop(lat, lng);
                },
                (err) => {
                    console.error("GPS Error:", err);
                    if (gpsBtn) gpsBtn.classList.remove('loading');
                    let msg = "위치 정보를 가져오는 데 실패했습니다.";
                    switch (err.code) {
                        case 1:
                            msg = "위치 정보 권한이 거부되었습니다. 브라우저 설정에서 위치 권한을 허용해 주세요.";
                            break;
                        case 2:
                            msg = "위치 정보를 사용할 수 없습니다. GPS가 켜져 있는지 확인해 주세요.";
                            break;
                        case 3:
                            msg = "위치 정보를 가져오는 데 시간이 초과되었습니다. 다시 시도해 보세요.";
                            break;
                    }
                    showToast(msg, "error");
                },
                { enableHighAccuracy: false, timeout: 15000, maximumAge: 0 }
            );
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // --- Monetization & Logic ---
        let currentShopData = null; // Store temp data for the modal

        function openAdModal(name, addr, lat, lng, totalWins) {
            // Re-filter allData for this specific shop to get rounds.
            const rounds = allData.filter(d => d.n === name && d.a === addr).map(d => ({ r: d.r, m: d.m }));

            currentShopData = { name, addr, lat, lng, totalWins, rounds };

            // Show Modal
            const modal = document.getElementById('adModal');
            const adContent = document.getElementById('adContent');
            const resultContent = document.getElementById('resultContent');

            // Mode Containers
            const modeSelection = document.getElementById('modeSelection');
            const analysisLoading = document.getElementById('analysisLoading');
            const modeDreamInput = document.getElementById('modeDreamInput');
            const modeHoroscopeSelect = document.getElementById('modeHoroscopeSelect');

            modal.style.display = 'flex';
            adContent.style.display = 'flex'; // Changed to flex for centering
            resultContent.style.display = 'none';

            // Reset UI State (CRITICAL: Reset result text structure)
            const resultInfo = document.getElementById('resultInfoText');
            if (resultInfo) {
                resultInfo.innerHTML = `이 명당은 과거 <strong id="paramHCount" style="color:#fae100;">0</strong>번의 1등을 배출했습니다.<br>
                    (<span id="paramRounds"></span> 등)`;
            }

            modeSelection.style.display = 'block';
            if (analysisLoading) analysisLoading.style.display = 'none';
            if (modeDreamInput) modeDreamInput.style.display = 'none';
            if (modeHoroscopeSelect) modeHoroscopeSelect.style.display = 'none';

            // Push history state to support Back Button closing
            history.pushState({ modalOpen: true }, null, "");
        }

        // --- Phase 10: Selection Handlers ---

        function selectAnalysisMode() {
            // Hide selection, show loading
            document.getElementById('modeSelection').style.display = 'none';
            const loader = document.getElementById('analysisLoading');
            if (loader) {
                loader.style.display = 'flex';
                // Reset text if needed
                loader.querySelector('h3').innerText = '데이터 분석 중...';
                loader.querySelector('p').innerText = '명당의 기운을 모으고 있습니다';
            }

            // Simulate Analysis Delay (3 seconds)
            setTimeout(() => {
                showResult();
            }, 3000);
        }

        function selectDreamMode() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('modeDreamInput').style.display = 'block';
        }

        function resetToModeSelection() {
            document.getElementById('modeDreamInput').style.display = 'none';
            document.getElementById('modeHoroscopeSelect').style.display = 'none';
            document.getElementById('modeSelection').style.display = 'block';
        }

        function handleDreamTag(keyword) {
            document.getElementById('dreamInput').value = keyword;
            handleDreamSubmit();
        }

        function handleDreamSubmit() {
            const input = document.getElementById('dreamInput');
            const keyword = input.value.trim();

            if (!keyword) {
                alert('꿈 내용을 입력해주세요!');
                return;
            }

            // Show loading state
            document.getElementById('modeDreamInput').style.display = 'none';
            const loader = document.getElementById('analysisLoading');
            if (loader) {
                loader.style.display = 'flex';
                loader.querySelector('h3').innerText = '꿈 해몽 중...';
                loader.querySelector('p').innerText = '꿈 속에 숨겨진 행운을 찾고 있습니다';
            }

            setTimeout(() => {
                const luckyNumbers = generateDreamNumbers(keyword);
                showResult(luckyNumbers);
            }, 2000);
        }

        function generateDreamNumbers(keyword) {
            // 1. Traditional Dream Mappings (Simple Version)
            const dreamMap = {
                '돼지': [8, 12, 23, 33, 38, 41],
                '똥': [6, 17, 24, 35, 36, 42],
                '조상': [1, 3, 15, 27, 39, 41],
                '불': [2, 11, 22, 33, 40, 44],
                '물': [4, 9, 21, 26, 31, 37],
                '뱀': [5, 10, 16, 28, 34, 45],
                '용': [7, 18, 20, 30, 42, 45]
            };

            // If keyword exists in map, return it (with small variation if needed, but fixed for now)
            if (dreamMap[keyword]) {
                return {
                    numbers: dreamMap[keyword],
                    historyCount: 0, // Not based on history
                    type: 'dream',
                    keyword: keyword
                };
            }

            // 2. Hash-based Generation for unknown keywords
            // This ensures the same keyword always yields the same numbers
            let hash = 0;
            for (let i = 0; i < keyword.length; i++) {
                hash = ((hash << 5) - hash) + keyword.charCodeAt(i);
                hash |= 0; // Convert to 32bit integer
            }

            // Seeding logic using text hash
            const seededRandom = (seed) => {
                var x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            };

            const selected = new Set();
            let seed = Math.abs(hash);

            while (selected.size < 6) {
                const n = Math.floor(seededRandom(seed) * 45) + 1;
                selected.add(n);
                seed++;
            }

            return {
                numbers: Array.from(selected).sort((a, b) => a - b),
                historyCount: 0,
                type: 'dream',
                keyword: keyword
            };
        }

        function selectHoroscopeMode() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('modeHoroscopeSelect').style.display = 'block';
        }

        function handleZodiacClick(zodiacName, icon) {
            // Show loading
            document.getElementById('modeHoroscopeSelect').style.display = 'none';
            const loader = document.getElementById('analysisLoading');
            if (loader) {
                loader.style.display = 'flex';
                loader.querySelector('h3').innerText = '오늘의 운세 분석 중...';
                loader.querySelector('p').innerText = '별들의 기운을 읽고 있습니다';
            }

            // Simulate and Generate
            setTimeout(() => {
                const horoscopeData = generateHoroscope(zodiacName);
                showResult({
                    type: 'horoscope',
                    zodiac: zodiacName,
                    icon: icon,
                    ...horoscopeData
                });
            }, 2000);
        }

        function generateHoroscope(zodiacName) {
            // Get today's date string YYYY-MM-DD
            const today = new Date().toISOString().split('T')[0];
            const key = today + zodiacName;

            // Generate seeded random based on date + zodiac
            let hash = 0;
            for (let i = 0; i < key.length; i++) {
                hash = ((hash << 5) - hash) + key.charCodeAt(i);
                hash |= 0;
            }
            const seededRandom = (seed) => {
                var x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            };
            let seed = Math.abs(hash);

            // 1. Horoscope Text Pools
            const genFortunes = [
                "금기(金氣)의 영향으로 신중함이 요구되는 하루입니다.",
                "오늘은 당신의 날입니다. 무엇을 해도 술술 풀릴 것입니다.",
                "직감이 매우 뛰어난 날입니다. 당신의 느낌을 믿어보세요.",
                "귀인의 도움을 받아 어려움이 해결될 것입니다. 긍정적인 마음을 가지세요.",
                "행운의 여신이 당신을 보고 미소 짓고 있습니다.",
                "뜻밖의 행운이 찾아올 수 있습니다. 주변을 잘 살펴보세요.",
                "차분하게 내실을 다지면 더 큰 기회가 찾아올 것입니다.",
                "새로운 변화를 시도하기에 아주 적절한 시기입니다."
            ];

            const loveFortunes = [
                "말의 표현을 조절하세요. 배려가 필요한 시기입니다.",
                "소중한 사람과 즐거운 시간을 보내기에 좋은 날입니다.",
                "솔직한 감정 표현이 상대방의 마음을 움직일 것입니다.",
                "작은 오해가 생길 수 있으니 충분한 대화를 나누세요.",
                "새로운 인연이 나타날 수 있는 기운이 강합니다.",
                "서로에 대한 신뢰가 깊어지는 따뜻한 하루가 될 것입니다.",
                "당신의 매력이 돋보이는 날입니다. 자신감을 가지세요.",
                "가까운 사람과의 갈등은 먼저 손을 내미는 것이 좋습니다."
            ];

            const moneyFortunes = [
                "예상치 못한 지출에 대비하세요. 신중한 소비가 필요합니다.",
                "금전운이 매우 좋습니다. 작은 투자도 결실을 맺을 수 있습니다.",
                "재물운이 상승하는 시기입니다. 로또 구매하기 딱 좋은 날!",
                "지갑 관리에 신경 써야 하는 하루입니다. 충동구매를 주의하세요.",
                "생각지 못한 곳에서 작은 수익이 발생할 수 있습니다.",
                "계획적인 소비가 당신에게 더 큰 행운을 불러올 것입니다.",
                "금전적인 이득보다는 인맥을 쌓는 것이 장기적으로 유리합니다.",
                "뿌린 대로 거두는 날입니다. 성실함이 보상으로 돌아옵니다."
            ];

            const luckyColors = ["빨강", "파랑", "노랑", "초록", "보라", "금색", "은색", "흰색", "검정", "주황"];

            const genIdx = Math.floor(seededRandom(seed) * genFortunes.length);
            const loveIdx = Math.floor(seededRandom(seed + 1) * loveFortunes.length);
            const moneyIdx = Math.floor(seededRandom(seed + 2) * moneyFortunes.length);
            const colorIdx = Math.floor(seededRandom(seed + 3) * luckyColors.length);

            const text = `
                <div style="text-align:left; margin: 0 auto; max-width:280px; line-height:1.8; font-size:14px;">
                    • <b>종합운</b> : ${genFortunes[genIdx]}<br>
                    • <b>애정운</b> : ${loveFortunes[loveIdx]}<br>
                    • <b>금전운</b> : ${moneyFortunes[moneyIdx]}<br>
                    • <b>행운의 색상</b> : ${luckyColors[colorIdx]}
                </div>
            `;

            // 2. Number Generation
            const selected = new Set();
            let numSeed = seed + 100;
            while (selected.size < 6) {
                const n = Math.floor(seededRandom(numSeed) * 45) + 1;
                selected.add(n);
                numSeed++;
            }

            return {
                text: text,
                numbers: Array.from(selected).sort((a, b) => a - b),
                historyCount: 0
            };
        }

        function closeModal() {
            // If the modal is open, going back will trigger popstate which closes it effectively
            // But we need to check if we are actually in the modal state
            if (document.getElementById('adModal').style.display === 'flex') {
                history.back();
            }
        }

        function _internalCloseModal() {
            document.getElementById('adModal').style.display = 'none';
        }

        function showResult(customResult = null) {
            document.getElementById('adContent').style.display = 'none';
            document.getElementById('resultContent').style.display = 'block';

            // Logic
            let result;
            if (customResult) {
                result = customResult;
                // Update text based on result type
                // Update text based on result type
                // const container... removed, using ID inside blocks

                if (result.type === 'dream') {
                    // Use safer selector
                    const container = document.getElementById('resultInfoText');
                    if (container) {
                        container.innerHTML =
                            `꿈 키워드 <strong style="color:#fae100;">'${result.keyword}'</strong>(으)로<br>분석된 행운의 번호입니다.`;
                    }
                } else if (result.type === 'horoscope') {
                    const container = document.getElementById('resultInfoText');
                    if (container) {
                        container.innerHTML =
                            `<div class="horoscope-text-box">
                                <div style="font-size:24px; margin-bottom:5px;">${result.icon}</div>
                                <div style="font-weight:bold; font-size:16px; margin-bottom:10px; color:#fae100;">${result.zodiac}띠 오늘의 운세</div>
                                ${result.text}
                            </div>
                            <div style="font-size:13px; color:rgba(255,255,255,0.8);">위 운세에 기반한 행운의 번호입니다.</div>`;
                    }
                }
            } else {
                result = generateLuckyNumbers(currentShopData.rounds);
                // Restore default text (Safely using ID)
                const container = document.getElementById('resultInfoText');
                if (container) {
                    container.innerHTML =
                        `이 명당은 과거 <strong id="paramHCount" style="color:#fae100;">${result.historyCount}</strong>번의 1등을 배출했습니다.<br>` +
                        `(<span id="paramRounds">${result.relatedRounds.join(', ') + (result.historyCount > 5 ? '...' : '')}</span> 등)`;
                }
            }

            // Legal Disclaimer
            const legalDiv = document.getElementById('legalDisclaimer');
            if (!legalDiv) {
                const legal = document.createElement('div');
                legal.id = 'legalDisclaimer';
                legal.style.cssText = "font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 15px; text-align: center; line-height: 1.4;";
                legal.innerHTML = "※ 본 서비스는 동행복권의 당첨 데이터를 기반으로 통계적/임의적 분석을 제공하며, 당첨을 보장하지 않습니다.<br>과도한 복권 구매는 도박 중독을 유발할 수 있습니다.";
                document.getElementById('resultContent').appendChild(legal);
            }

            // Render
            const ballContainer = document.getElementById('luckyBalls');
            ballContainer.innerHTML = '';

            result.numbers.forEach(n => {
                const ball = document.createElement('div');
                ball.className = 'ball ' + getBallColor(n);
                ball.innerText = n;
                ballContainer.appendChild(ball);
            });
        }

        function getBallColor(n) {
            if (n <= 10) return 'one';
            if (n <= 20) return 'two';
            if (n <= 30) return 'three';
            if (n <= 40) return 'four';
            return 'five';
        }

        function goToShop() {
            if (!currentShopData) return;
            openDirections(currentShopData.lat, currentShopData.lng, currentShopData.name);
            closeModal();
        }

        // --- Side Nav Controls ---
        function toggleNav() {
            const nav = document.getElementById('sideNav');
            const overlay = document.getElementById('sideNavOverlay');
            const btn = document.getElementById('menuBtn');
            const isOpen = nav.classList.contains('open');

            if (isOpen) {
                closeNav();
            } else {
                nav.classList.add('open');
                overlay.style.display = 'block';
                setTimeout(() => overlay.classList.add('show'), 10);
                btn.classList.add('active');
            }
        }

        function closeNav() {
            const nav = document.getElementById('sideNav');
            const overlay = document.getElementById('sideNavOverlay');
            const btn = document.getElementById('menuBtn');

            nav.classList.remove('open');
            overlay.classList.remove('show');
            setTimeout(() => {
                if (!nav.classList.contains('open')) {
                    overlay.style.display = 'none';
                }
            }, 300);
            btn.classList.remove('active');
        }

        function showStats() {
            showToast("📊 번호별 출현횟수 기능 개발 중입니다!", "info");
            closeNav();
        }

        function showQRScanner() {
            showToast("📷 QR코드 당첨확인 기능 개발 중입니다!", "info");
            closeNav();
        }

        // Close modal when clicking outside - Direct listener for better mobile support
        const modalEl = document.getElementById('adModal');
        if (modalEl) {
            modalEl.addEventListener('click', function (event) {
                if (event.target === modalEl) {
                    closeModal();
                }
            });
        }

        // Handle Back Button
        window.addEventListener('popstate', function (event) {
            // When history changes (Back pressed), we close the modal UI
            // Check if modal is currently visible
            const modal = document.getElementById('adModal');
            if (modal && modal.style.display === 'flex') {
                _internalCloseModal();
            }
        });



        function focusShop(lat, lng) {
            // Find maker by coordinates (approximate match to handle float precision)
            const target = markers.find(m => {
                const p = m.getPosition();
                return Math.abs(p.getLat() - lat) < 0.000001 && Math.abs(p.getLng() - lng) < 0.000001;
            });

            if (target) {
                const mapCenter = new kakao.maps.LatLng(lat, lng);
                map.panTo(mapCenter);
                // Trigger click to open InfoWindow
                kakao.maps.event.trigger(target, 'click');
            }
        }

        function findNearestShop(lat, lng) {
            if (typeof allData === 'undefined' || allData.length === 0) return;

            // Sort all shops by distance
            const sortedShops = allData.map(shop => {
                return {
                    ...shop,
                    distance: getDistance(lat, lng, shop.lat, shop.lng)
                };
            }).sort((a, b) => a.distance - b.distance);

            // Take top 3
            const top3 = sortedShops.slice(0, 3);

            if (top3.length > 0) {
                let msg = "📍 <strong>주변 1등 배출점 (가까운 순)</strong><br>";
                top3.forEach((shop, index) => {
                    const distStr = shop.distance < 1 ? Math.round(shop.distance * 1000) + "m" : shop.distance.toFixed(1) + "km";
                    // Add clickable span
                    msg += `<div onclick="focusShop(${shop.lat}, ${shop.lng})" style="cursor:pointer; padding:2px 0; text-decoration:underline;">${index + 1}. ${shop.n} (${distStr})</div>`;
                });
                showToast(msg, "success");

                // Adaptive Zoom: Fit my location and top nearest shops
                const bounds = new kakao.maps.LatLngBounds();
                bounds.extend(new kakao.maps.LatLng(lat, lng));

                // Only include shops within 20km for the initial view
                top3.forEach(shop => {
                    if (shop.distance < 20) {
                        bounds.extend(new kakao.maps.LatLng(shop.lat, shop.lng));
                    }
                });

                map.setBounds(bounds, 80, 80, 80, 80);
            }
        }

        function showToast(message, type = "info") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            // Use innerHTML to support links/clicks
            toast.innerHTML = message;

            container.appendChild(toast);

            // Force reflow
            toast.offsetHeight;

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode === container) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast("📋 주소가 클립보드에 복사되었습니다.", "success");
            } catch (err) {
                showToast("복사 실패", "error");
            }
            document.body.removeChild(textarea);
        }

        function openDirections(lat, lng, name) {
            const url = `https://map.kakao.com/link/to/${encodeURIComponent(name)},${lat},${lng}`;
            window.open(url, '_blank');
        }

        function shareToKakao() {
            try {
                console.log('[Kakao Share] Function called');

                // Check if Kakao SDK is loaded
                if (typeof window.Kakao === 'undefined') {
                    console.error('[Kakao Share] Kakao SDK not loaded');
                    return;
                }

                console.log('[Kakao Share] Kakao SDK loaded successfully');

                // Initialize Kakao SDK if not already initialized
                if (!window.Kakao.isInitialized()) {
                    console.log('[Kakao Share] Initializing Kakao SDK...');
                    window.Kakao.init('a6b27b6dab16c7e3459bb9589bf1269d');
                    console.log('[Kakao Share] Kakao SDK initialized');
                } else {
                    console.log('[Kakao Share] Kakao SDK already initialized');
                }

                // Prepare share data - NO IMAGE to ensure k-inov.co.kr link works
                const shareData = {
                    objectType: 'feed',
                    content: {
                        title: '🎰 KINOV 로또 명당 지도',
                        description: '역대 1등 당첨 판매점을 한눈에! 당신의 행운을 찾아보세요.\n\n지금 바로 KINOV Mall을 방문하세요!',
                        link: {
                            mobileWebUrl: 'https://www.k-inov.co.kr',
                            webUrl: 'https://www.k-inov.co.kr'
                        }
                    },
                    buttons: [
                        {
                            title: 'KINOV Mall 방문하기',
                            link: {
                                mobileWebUrl: 'https://www.k-inov.co.kr',
                                webUrl: 'https://www.k-inov.co.kr'
                            }
                        }
                    ]
                };

                console.log('[Kakao Share] Sending share data:', shareData);

                // Send KakaoTalk share message
                window.Kakao.Share.sendDefault(shareData);

                console.log('[Kakao Share] Share dialog opened successfully');

            } catch (error) {
                console.error('[Kakao Share] Error:', error);
            }
        }
    </script>
</body>

</html>