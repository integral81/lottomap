<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>KINOV Lotto Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        // SDK Error Handler (Defined first)
        function handleScriptError() {
            const mapDiv = document.getElementById('map');
            const usedKey = 'a6b27b6dab16c7e3459bb9589bf1269d';
            if (mapDiv) {
                mapDiv.innerHTML = `
                    <div style="padding:40px; text-align:center; color:#d32f2f;">
                        <h2 style="margin-bottom:10px;">ğŸ”‘ ì¹´ì¹´ì˜¤ ì§€ë„ ì¸ì¦ ì‹¤íŒ¨ (Domain Mismatch)</h2>
                        <p style="color:#333; font-size:16px;">ì¸í„°ë„· ì—°ê²°ì€ í™•ì¸ë˜ì—ˆìœ¼ë‚˜, ì¹´ì¹´ì˜¤ ì„œë²„ì—ì„œ <strong>ë„ë©”ì¸ ê±°ë¶€</strong>ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        
                        <div style="background:#fff; border:1px solid #d32f2f; padding:20px; border-radius:10px; text-align:left; margin: 20px auto; color:#333; max-width:600px; font-size:14px; line-height:1.6;">
                            <strong>âœ… ì´ ìˆœì„œëŒ€ë¡œ í•´ê²°í•´ ë³´ì„¸ìš”:</strong><br><br>
                            1. <strong>ë„ë©”ì¸ ì¶”ê°€ ë“±ë¡</strong>: ì¹´ì¹´ì˜¤ ì½˜ì†” [í”Œë«í¼ > Web] ì‚¬ì´íŠ¸ ë„ë©”ì¸ì— ì•„ë˜ ì£¼ì†Œë“¤ì´ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”:
                               <ul style="margin:5px 0 15px 20px;">
                                 <li><code>http://localhost:8000</code></li>
                                 <li><code>http://127.0.0.1:8000</code></li>
                               </ul>
                            2. <strong>ì˜¬ë°”ë¥¸ í‚¤ ì‚¬ìš© í™•ì¸</strong>: ì¹´ì¹´ì˜¤ ì½˜ì†” [ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ > ìš”ì•½ ì •ë³´]ì—ì„œ ë°˜ë“œì‹œ <strong>'JavaScript í‚¤'</strong>ë¥¼ ë³µì‚¬í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.<br><br>
                            <div style="background:#eee; padding:10px; border-radius:5px; border:1px dashed #999;">
                                <strong>í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ í‚¤:</strong> <code>${usedKey}</code>
                            </div>
                        </div>
                        <p style="color:#666;">ì„¤ì •ì„ ë³€ê²½í•œ í›„ ë¸Œë¼ìš°ì €ë¥¼ <strong>ìƒˆë¡œê³ ì¹¨(F5)</strong> í•´ì£¼ì„¸ìš”.</p>
                    </div>`;
            }
        }
    </script>
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a6b27b6dab16c7e3459bb9589bf1269d&libraries=clusterer"
        onerror="handleScriptError()"></script>
    <!-- Kakao SDK for Sharing -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"></script>
    <style>
        :root {
            --primary: #d32f2f;
            --secondary: #1976d2;
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #333333;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Pretendard', system-ui, sans-serif;
            background-color: var(--bg);
            overflow: hidden;
        }

        #app {
            display: flex !important;
            width: 100vw;
            height: 100vh;
            flex-direction: row;
            overflow: hidden;
        }

        #sidebar {
            width: 320px;
            height: 100%;
            background: var(--card);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            order: 1;
            /* PC: First */
        }

        #map {
            flex: 1;
            height: 100%;
            background: #eee;
            order: 2;
            /* PC: Second */
        }

        h1 {
            font-size: 20px;
            color: var(--primary);
            margin: 0 0 20px 0;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .section-title {
            font-weight: 700;
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            display: block;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="number"] {
            width: 70px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-apply {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }

        .btn-apply:hover {
            background-color: #b71c1c;
        }

        .stats-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: auto;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .stat-value {
            color: var(--primary);
            font-weight: 700;
        }

        .infowindow {
            padding: 12px;
            min-width: 200px;
            min-height: 120px;
            box-sizing: border-box;
            background: #fff;
        }

        .iw-title {
            font-weight: 700;
            font-size: 15px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .iw-addr {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }

        .iw-tag {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            background: #eee;
            font-size: 10px;
            margin: 0 2px 2px 0;
        }

        .iw-actions {
            display: flex !important;
            gap: 10px;
            margin-top: 15px;
            border-top: 1px dashed #eee;
            padding-top: 12px;
            visibility: visible !important;
        }

        .btn-iw {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
            border: 1px solid #ddd;
            background: #fff;
        }

        .btn-iw:hover {
            background: #f5f5f5;
        }

        .btn-navi {
            background: var(--secondary) !important;
            color: white !important;
            border: none !important;
        }

        .btn-navi:hover {
            background: #1565c0 !important;
        }

        .iw-addr-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9f9f9;
            padding: 5px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .iw-addr-box:hover {
            background: #f0f0f0;
        }

        /* GPS Pulse Animation */
        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .pulse {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(25, 118, 210, 0.5);
            border-radius: 50%;
            animation: pulse 2s infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* GPS Button Style */
        .gps-button {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: #fff;
            border: 2px solid var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .gps-button:hover {
            transform: scale(1.1);
            background: #f0f0f0;
        }

        .gps-button svg {
            width: 24px;
            height: 24px;
            fill: var(--primary);
            transition: transform 0.2s;
            -webkit-transition: transform 0.2s;
        }

        .gps-button.loading svg {
            animation: rotate 1s linear infinite;
            -webkit-animation: rotate 1s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @-webkit-keyframes rotate {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(360deg);
            }
        }

        /* Responsive Design for Mobile (Phone only) */
        @media (max-width: 640px) {
            #app {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                overflow: auto;
            }

            #sidebar {
                width: 100%;
                height: auto;
                flex: none;
                order: 2;
                /* Mobile: Sidebar Bottom */
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }

            #map {
                width: 100%;
                height: 400px;
                flex: none;
                order: 1;
                /* Mobile: Map Top */
            }
        }

        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: #333;
            padding: 14px 28px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            white-space: pre-wrap;
            text-align: left;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            max-width: 90vw;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 500;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-info {
            border-left: 5px solid var(--secondary);
        }

        .toast-error {
            border-left: 5px solid var(--primary);
        }

        .toast-success {
            border-left: 5px solid #48bb78;
        }

        /* GPS Pulse Animation (Works on all devices) */
        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .pulse {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(25, 118, 210, 0.5);
            border-radius: 50%;
            animation: pulse 2s infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* Gold Button & Modal */
        .btn-gold {
            background: linear-gradient(135deg, #FFD700, #FFA000);
            color: #333;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            animation: shiver 2s infinite;
        }

        @keyframes shiver {
            0% {
                transform: rotate(0deg);
            }

            5% {
                transform: rotate(2deg);
            }

            10% {
                transform: rotate(-2deg);
            }

            15% {
                transform: rotate(2deg);
            }

            20% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            cursor: pointer;
            /* Critical for iOS to recognize clicks on transparent/overlay elements */
        }

        .modal-content {
            background-color: transparent;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            cursor: default;
            /* Reset cursor for content area */
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 32px;
            cursor: pointer;
            color: white;
            z-index: 10;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .modal-close:hover {
            transform: scale(1.1);
        }

        .lucky-balls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
        }

        .ball {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .ball.one {
            background: #fbc400;
        }

        .ball.two {
            background: #69c8f2;
        }

        .ball.three {
            background: #ff7272;
        }

        .ball.four {
            background: #aaaaaa;
        }

        .ball.five {
            background: #b0d840;
        }

        /* Mini Ball for Recent Rounds */
        .mini-ball {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 800;
            color: white;
            margin-right: 3px;
            box-shadow: inset -2px -2px 4px rgba(0, 0, 0, 0.2);
        }

        .mini-ball.one {
            background: #fbc400;
            color: #333;
            text-shadow: none;
        }

        .mini-ball.two {
            background: #69c8f2;
        }

        .mini-ball.three {
            background: #ff7272;
        }

        .mini-ball.four {
            background: #aaaaaa;
        }

        .mini-ball.five {
            background: #b0d840;
        }

        .recent-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 5px 8px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .recent-round-num {
            font-size: 11px;
            font-weight: bold;
            color: #555;
            width: 45px;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            #app {
                flex-direction: column !important;
            }

            #sidebar {
                width: 100% !important;
                height: auto !important;
                max-height: 50vh !important;
                order: 2 !important;
                padding: 15px !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }

            #map {
                order: 1 !important;
                height: 50vh !important;
                min-height: 300px !important;
            }

            h1 {
                font-size: 18px !important;
                margin: 0 0 15px 0 !important;
            }

            .section {
                margin-bottom: 15px !important;
                padding-bottom: 15px !important;
            }

            .section-title {
                font-size: 13px !important;
            }

            .btn-apply {
                font-size: 14px !important;
                padding: 12px !important;
            }

            .stats-card {
                font-size: 12px !important;
                padding: 12px !important;
            }

            .modal-content {
                width: 95% !important;
                max-width: 95% !important;
                margin: 0 auto !important;
            }

            #adContent,
            #resultContent {
                padding: 15px !important;
                width: 100% !important;
                box-sizing: border-box !important;
                /* Ensure padding doesn't add to width */
            }

            .modal-close {
                right: 10px !important;
                top: 10px !important;
            }
        }

        /* Selection Menu Styles (Global) */
        .selection-menu {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            margin-top: 10px;
        }

        .selection-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: left;
        }

        .selection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background: white;
        }

        .selection-icon {
            font-size: 24px;
            background: #f0f4f8;
            min-width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selection-info {
            flex: 1;
        }

        .selection-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
            display: block;
        }

        .selection-desc {
            font-size: 12px;
            color: #666;
            display: block;
        }

        /* Loading Animation */
        .loader-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fae100;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Dream Mode Styles */
        .dream-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .dream-tag {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dream-tag:hover {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .dream-input-box {
            display: flex;
            gap: 5px;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .dream-input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            text-align: center;
            outline: none;
        }

        .btn-dream-submit {
            background: #fae100;
            color: #333;
            border: none;
            padding: 0 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Input Container for Dream/Zodiac */
        .input-container {
            display: none;
            width: 100%;
            text-align: center;
        }

        .btn-sm {
            background-color: #555;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-sm:hover {
            background-color: #333;
        }

        /* Zodiac Mode Styles */
        .zodiac-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 320px;
            margin: 0 auto;
        }

        .zodiac-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            aspect-ratio: 1;
            /* Square shape */
        }

        .zodiac-item:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .zodiac-icon {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .zodiac-name {
            font-size: 12px;
            color: white;
            font-weight: bold;
        }

        .horoscope-text-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            color: white;
            font-size: 14px;
            line-height: 1.5;
            border-left: 4px solid #fae100;
        }
    </style>
</head>

<body>
    <div id="toast-container"></div>
    <div id="app">
        <div id="sidebar">
            <h1>ğŸ° KINOV Lotto Map</h1>
            <div class="section">
                <span class="section-title">ğŸ“… íšŒì°¨ í•„í„° (Round)</span>
                <div class="input-row">
                    <input type="number" id="minRound" value="1">
                    <span>~</span>
                    <input type="number" id="maxRound" value="1210">
                    <button class="btn-sm" onclick="refreshRecentRounds()">ì¡°íšŒ</button>
                </div>
                <!-- Data Availability Notice -->
                <div
                    style="font-size:14px; font-weight:bold; color:#d32f2f; margin-top:8px; line-height:1.4; background:rgba(255,0,0,0.05); padding:8px; border-radius:4px; border:1px solid rgba(255,0,0,0.1);">
                    1. 1ë“± ë‹¹ì²¨ë²ˆí˜¸ëŠ” 1íšŒì°¨ë¶€í„° ì œê³µ<br>
                    2. 1ë“± íŒë§¤ì í˜„í™©ì€ 262íšŒì°¨ë¶€í„° ì œê³µ
                </div>
            </div>

            <!-- Recent 3 Rounds Display -->
            <div class="section" id="recentRoundsContainer"
                style="background:#f0f4f8; padding:10px; border-radius:8px; margin-bottom:20px;">
                <span class="section-title" style="margin-bottom:8px;">ğŸ“Š ìµœê·¼ 3íšŒì°¨ ë‹¹ì²¨ë²ˆí˜¸ (ê¸°ì¤€: <span id="recentRefRound"
                        style="color:#d32f2f;">1210</span>íšŒ)</span>
                <div id="recentRoundsList" style="display:flex; flex-direction:column; gap:6px;">
                    <!-- Javascript will populate this -->
                    <div style="font-size:12px; color:#666; text-align:center;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
            </div>

            <div class="section">
                <span class="section-title">ğŸ† ë‹¹ì²¨ íšŸìˆ˜ í•„í„° (Frequency)</span>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="freq5" checked> ğŸŒŸ 5íšŒ ì´ìƒ</label>
                    <label class="checkbox-item"><input type="checkbox" id="freq3" checked> ğŸ”´ 3~4íšŒ</label>
                    <label class="checkbox-item"><input type="checkbox" id="freq1" checked> ğŸ”µ 2íšŒ ì´í•˜</label>
                </div>
            </div>
            <div class="section">
                <span class="section-title">ğŸ² ë‹¹ì²¨ ë°©ì‹ (Method)</span>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="methodAuto" checked> ìë™</label>
                    <label class="checkbox-item"><input type="checkbox" id="methodManual" checked> ìˆ˜ë™</label>
                    <label class="checkbox-item"><input type="checkbox" id="methodSemi" checked> ë°˜ìë™</label>
                </div>
            </div>
            <button class="btn-apply" onclick="applyFilters()">ì ìš©í•˜ê¸°</button>
            <div class="stats-card">
                <div class="stat-item"><span>ì „ì²´ ë°ì´í„°</span> <span id="totalDataCount">0</span></div>
                <div class="stat-item"><span>í•„í„°ë§ ê²°ê³¼</span> <span id="filteredCount" class="stat-value">0</span></div>

                <!-- Fallback file loader -->
                <div id="manualLoader"
                    style="display:none; margin-top:10px; padding-top:10px; border-top:1px dashed #ccc;">
                    <p style="font-size:11px; color:#666; margin-bottom:5px;">âš ï¸ ìë™ ë¡œë“œ ì‹¤íŒ¨ ì‹œ íŒŒì¼ì„ ì§ì ‘ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
                    <input type="file" id="fileInput" accept=".json" style="display:none;"
                        onchange="handleFileSelect(event)">
                    <button class="btn-apply" style="background:#333; font-size:12px; padding:8px;"
                        onclick="document.getElementById('fileInput').click()">íŒŒì¼ ì§ì ‘ ì„ íƒí•˜ê¸° (lotto_data.json)</button>
                </div>
            </div>
        </div>
        <div id="map">
            <div class="gps-button" onclick="requestMyLocation()" title="ë‚´ ìœ„ì¹˜ ì°¾ê¸°">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z" />
                </svg>
            </div>
        </div>
        <div id="adModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal()">&times;</span>
                <div id="adContent"
                    style="width:100%; height:450px; padding:20px; overflow-y:auto; display:flex; flex-direction:column; align-items:center; justify-content:center; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">

                    <!-- Mode Selection Menu -->
                    <div id="modeSelection" style="width:100%; max-width:400px;">
                        <div style="background:#fae100; color:#3c1e1e; padding:8px 15px; text-align:center; font-weight:bold; cursor:pointer; font-size:14px; border-radius:8px; margin-bottom:15px; box-shadow:0 2px 4px rgba(0,0,0,0.1);"
                            onclick="shareToKakao()">
                            ğŸ“¢ ì¹´í†¡ ê³µìœ í•˜ê³  ë‹¹ì²¨ í™•ë¥  ë†’ì´ê¸° (í´ë¦­)
                        </div>

                        <h2
                            style="color:white; text-align:center; margin-bottom:15px; font-size:20px; text-shadow:0 1px 2px rgba(0,0,0,0.2);">
                            ğŸ”® ë²ˆí˜¸ ìƒì„± ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”
                        </h2>

                        <div class="selection-menu">
                            <!-- 1. Data Analysis -->
                            <div class="selection-card" onclick="selectAnalysisMode()">
                                <div class="selection-icon">ğŸ“Š</div>
                                <div class="selection-info">
                                    <span class="selection-title">ë°ì´í„° ì •ë°€ ë¶„ì„</span>
                                    <span class="selection-desc">ëª…ë‹¹ì˜ ê³¼ê±° ë‹¹ì²¨ íŒ¨í„´ì„ ì •ë°€ ë¶„ì„</span>
                                </div>
                            </div>

                            <!-- 2. Dream -->
                            <div class="selection-card" onclick="selectDreamMode()">
                                <div class="selection-icon">ğŸŒ™</div>
                                <div class="selection-info">
                                    <span class="selection-title">ê¿ˆ í•´ëª½ ë²ˆí˜¸</span>
                                    <span class="selection-desc">ì–´ì ¯ë°¤ ê¿ˆ ë‚´ìš©ì„ ì…ë ¥í•´ë³´ì„¸ìš”</span>
                                </div>
                            </div>

                            <!-- 3. Horoscope -->
                            <div class="selection-card" onclick="selectHoroscopeMode()">
                                <div class="selection-icon">ğŸ…</div>
                                <div class="selection-info">
                                    <span class="selection-title">ì˜¤ëŠ˜ì˜ ë ë³„ ìš´ì„¸</span>
                                    <span class="selection-desc">ë‚˜ì˜ ë ì— ë§ëŠ” í–‰ìš´ì˜ ìˆ«ì</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading Animation (Initially Hidden) -->
                    <div id="analysisLoading" class="loader-container">
                        <div class="spinner"></div>
                        <h3 style="margin:10px 0; font-size:22px;">ë°ì´í„° ë¶„ì„ ì¤‘...</h3>
                        <p style="font-size:14px; opacity:0.9;">ëª…ë‹¹ì˜ ê¸°ìš´ì„ ëª¨ìœ¼ê³  ìˆìŠµë‹ˆë‹¤</p>
                    </div>

                    <!-- Placeholders for Step 2 & 3 -->
                    <div id="modeDreamInput" class="input-container">
                        <h2
                            style="color:white; font-size:20px; margin-bottom:15px; text-shadow:0 1px 2px rgba(0,0,0,0.2);">
                            ğŸŒ™ ì–´ì ¯ë°¤ ë¬´ìŠ¨ ê¿ˆì„ ê¾¸ì…¨ë‚˜ìš”?
                        </h2>

                        <div class="dream-tags">
                            <button class="dream-tag" onclick="handleDreamTag('ë¼ì§€')">ğŸ· ë¼ì§€</button>
                            <button class="dream-tag" onclick="handleDreamTag('ë˜¥')">ğŸ’© ë˜¥</button>
                            <button class="dream-tag" onclick="handleDreamTag('ì¡°ìƒ')">ğŸ‘´ ì¡°ìƒ</button>
                            <button class="dream-tag" onclick="handleDreamTag('ë¶ˆ')">ğŸ”¥ ë¶ˆ</button>
                            <button class="dream-tag" onclick="handleDreamTag('ë¬¼')">ğŸ’§ ë¬¼</button>
                            <button class="dream-tag" onclick="handleDreamTag('ë±€')">ğŸ ë±€</button>
                        </div>

                        <div class="dream-input-box">
                            <input type="text" id="dreamInput" class="dream-input" placeholder="ê¸°íƒ€ ê¿ˆ ì…ë ¥ (10ì ì´ë‚´)"
                                maxlength="10">
                            <button class="btn-dream-submit" onclick="handleDreamSubmit()">ê²°ê³¼ë³´ê¸°</button>
                        </div>

                        <div style="margin-top:20px;">
                            <button class="btn-sm" style="background:rgba(0,0,0,0.3);"
                                onclick="resetToModeSelection()">ğŸ”™ ë’¤ë¡œê°€ê¸°</button>
                        </div>
                    </div>
                    <div id="modeHoroscopeSelect" class="input-container">
                        <h2
                            style="color:white; font-size:20px; margin-bottom:15px; text-shadow:0 1px 2px rgba(0,0,0,0.2);">
                            ğŸ… ë‹¹ì‹ ì˜ ë ë¥¼ ì„ íƒí•˜ì„¸ìš”
                        </h2>
                        <div class="zodiac-grid">
                            <div class="zodiac-item" onclick="handleZodiacClick('ì¥', 'ğŸ¹')"><span
                                    class="zodiac-icon">ğŸ¹</span><span class="zodiac-name">ì¥ë </span></div>
                            <div class="zodiac-item" onclick="handleZodiacClick('ì†Œ', 'ğŸ®')"><span
                                    class="zodiac-icon">ğŸ®</span><span class="zodiac-name">ì†Œë </span></div>
                            <div class="zodiac-item" onclick="handleZodiacClick('í˜¸ë‘ì´', 'ğŸ¯')"><span
                                    class="zodiac-icon">ğŸ¯</span><span class="zodiac-name">ë²”ë </span></div>
                            <div class="zodiac-item" onclick="handleZodiacClick('í† ë¼', 'ğŸ°')"><span
                                    class="zodiac-icon">ğŸ°</span><span class="zodiac-name">í† ë¼ë </span></div>
                            <div class="zodiac-item" onclick="handleZodiacClick('ìš©', 'ğŸ²')"><span
                                    class="zodiac-icon">ğŸ²</span><span class="zodiac-name">ìš©ë </span></div>
                            <div class="zodiac-item" onclick="handleZodiacClick('ë±€', 'ğŸ')"><span
                                    class="zodiac-icon">ğŸ</span><span class="zodiac-name">ë±€ë </span></div>
                            <div class="zodiac-item" onclick="handleZodiacClick('ë§', 'ğŸ´')"><span
                                    class="zodiac-icon">ğŸ´</span><span class="zodiac-name">ë§ë </span></div>
                            <div class="zodiac-item" onclick="handleZodiacClick('ì–‘', 'ğŸ‘')"><span
                                    class="zodiac-icon">ğŸ‘</span><span class="zodiac-name">ì–‘ë </span></div>
                            <div class="zodiac-item" onclick="handleZodiacClick('ì›ìˆ­ì´', 'ğŸµ')"><span
                                    class="zodiac-icon">ğŸµ</span><span class="zodiac-name">ì›ìˆ­ì´ë </span></div>
                            <div class="zodiac-item" onclick="handleZodiacClick('ë‹­', 'ğŸ”')"><span
                                    class="zodiac-icon">ğŸ”</span><span class="zodiac-name">ë‹­ë </span></div>
                            <div class="zodiac-item" onclick="handleZodiacClick('ê°œ', 'ğŸ¶')"><span
                                    class="zodiac-icon">ğŸ¶</span><span class="zodiac-name">ê°œë </span></div>
                            <div class="zodiac-item" onclick="handleZodiacClick('ë¼ì§€', 'ğŸ·')"><span
                                    class="zodiac-icon">ğŸ·</span><span class="zodiac-name">ë¼ì§€ë </span></div>
                        </div>

                        <div style="margin-top:20px;">
                            <button class="btn-sm" style="background:rgba(0,0,0,0.3);"
                                onclick="resetToModeSelection()">ğŸ”™ ë’¤ë¡œê°€ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="resultContent"
                style="display:none; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:40px 20px; min-height:420px;">
                <h2 style="color:white; text-shadow:0 2px 4px rgba(0,0,0,0.2);">ğŸ‰ ì¶”ì²œ ë²ˆí˜¸ ìƒì„± ì™„ë£Œ! ğŸ‰</h2>
                <p style="font-size:13px; color:rgba(255,255,255,0.95); margin-bottom:10px;">
                    ì´ ëª…ë‹¹ì€ ê³¼ê±° <strong id="paramHCount" style="color:#fae100;">0</strong>ë²ˆì˜ 1ë“±ì„ ë°°ì¶œí–ˆìŠµë‹ˆë‹¤.<br>
                    (<span id="paramRounds"></span> ë“±)
                </p>
                <div class="lucky-balls" id="luckyBalls">
                    <!-- Balls go here -->
                </div>
                <p style="font-size:12px; color:rgba(255,255,255,0.8);">* ì¬ë¯¸ë¡œë§Œ ë´ì£¼ì„¸ìš”. ê³¼ë„í•œ êµ¬ë§¤ëŠ” ê¸ˆë¬¼!</p>
                <button class="btn-apply btn-navi"
                    style="margin-top:10px; background:#fae100; color:#3c1e1e; border:none; padding:12px 30px; border-radius:25px; font-weight:bold; box-shadow:0 4px 12px rgba(0,0,0,0.2);"
                    onclick="goToShop()">
                    ğŸš— ì§€ê¸ˆ ë‹¹ì¥ ì‚¬ëŸ¬ ê°€ê¸° (ê¸¸ì°¾ê¸°)
                </button>
            </div>
        </div>
    </div>
    </div>

    <script>
        let map, clusterer, allData = [], markers = [];
        let currentInfoWindow = null; // Track the currently open InfoWindow


        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    processLoadedData(data);
                    document.getElementById('manualLoader').style.display = 'none';
                    alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! (' + data.length + 'ê±´)');
                } catch (err) {
                    alert('íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function processLoadedData(data) {
            allData = data;

            // Calculate win count per shop (Name + Address)
            const shopWins = {};
            data.forEach(item => {
                const key = (item.n || '').trim() + '|' + (item.a || '').trim();
                shopWins[key] = (shopWins[key] || 0) + 1;
            });
            // Attach individual shop win count to each record
            let highWinCount = 0;
            data.forEach(item => {
                const key = (item.n || '').trim() + '|' + (item.a || '').trim();
                item.totalWins = shopWins[key];
                if (item.totalWins >= 5) highWinCount++;
            });
            console.log('Grouped Shops:', Object.keys(shopWins).length);
            console.log('Records with 5+ wins:', highWinCount);

            document.getElementById('totalDataCount').innerText = data.length.toLocaleString();
            if (data.length > 0) {
                const rounds = data.map(d => d.r);
                const maxR = Math.max(...rounds);
                const minR = Math.min(...rounds);
                document.getElementById('maxRound').value = maxR;
                document.getElementById('minRound').value = minR;
            }

            applyFilters();

            // Initial load of recent rounds
            const initialMax = parseInt(document.getElementById('maxRound').value) || 1210;
            updateRecentRounds(initialMax);
        }

        window.onload = function () {
            if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
                handleScriptError();
                return;
            }

            const mapContainer = document.getElementById('map');
            const mapOption = { center: new kakao.maps.LatLng(36.2683, 127.6358), level: 12 };
            map = new kakao.maps.Map(mapContainer, mapOption);

            clusterer = new kakao.maps.MarkerClusterer({
                map: map, averageCenter: true, minLevel: 10,
                styles: [{
                    width: '40px', height: '40px', background: 'rgba(211, 47, 47, 0.8)',
                    color: '#fff', textAlign: 'center', lineHeight: '40px',
                    borderRadius: '20px', fontWeight: 'bold'
                }]
            });

            loadData();
        };

        function loadData() {
            const countEl = document.getElementById('totalDataCount');
            console.log('Loading data...');

            Promise.all([
                fetch('lotto_data.json?v=' + Date.now()).then(res => res.json()),
                fetch('lotto_history.json?v=' + Date.now()).then(res => res.json())
            ])
                .then(([lottoData, historyData]) => {
                    window.lottoHistory = historyData; // Global variable
                    processLoadedData(lottoData);
                })
                .catch(err => {
                    console.error('Data load failed:', err);
                    countEl.innerHTML = `<span style="color:red; font-size:11px; cursor:help;" title="${err.message}">ë¡œë“œ ì‹¤íŒ¨ (${err.name})</span>`;
                    document.getElementById('manualLoader').style.display = 'block';
                    alert('ë°ì´í„° íŒŒì¼ ë¡œë“œ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + err.message);
                });
        }

        /**
         * ğŸ”® Lucky Number Generator Algorithm
         * 1. Store Luck (50%): Numbers that won in this store's history.
         * 2. Global Hot (30%): Most frequent numbers in recent 100 rounds (Simulated for now).
         * 3. Random (20%): Pure random luck.
         */
        function generateLuckyNumbers(storeWins) {
            // storeWins: Array of winning rounds for this store e.g., [{r: 1000, m: 'ìë™'}, ...]
            const history = window.lottoHistory || {};
            const numberWeights = {};

            // Initialize weights
            for (let i = 1; i <= 45; i++) numberWeights[i] = 1; // Base weight

            // 1. Analyze Store History
            let winningNumbers = [];
            storeWins.forEach(win => {
                const round = win.r;
                if (history[round]) {
                    const nums = history[round];
                    winningNumbers = [...winningNumbers, ...nums];
                    nums.forEach(n => {
                        numberWeights[n] += 5; // Boost weight for numbers that appeared in this store's winning rounds
                    });
                }
            });

            // 2. Select 6 numbers based on weights
            const selected = new Set();
            while (selected.size < 6) {
                const n = weightedRandom(numberWeights);
                selected.add(n);
            }

            return {
                numbers: Array.from(selected).sort((a, b) => a - b),
                historyCount: storeWins.length,
                relatedRounds: storeWins.map(w => w.r).slice(0, 5) // Top 5 recent rounds
            };
        }

        function weightedRandom(weights) {
            let sum = 0;
            for (let i in weights) sum += weights[i];
            let rand = Math.random() * sum;
            for (let i in weights) {
                rand -= weights[i];
                if (rand < 0) return parseInt(i);
            }
            return Math.floor(Math.random() * 45) + 1; // Fallback
        }

        function applyFilters() {
            const minR = parseInt(document.getElementById('minRound').value) || 0;
            const maxR = parseInt(document.getElementById('maxRound').value) || 9999;
            const auto = document.getElementById('methodAuto').checked;
            const manual = document.getElementById('methodManual').checked;
            const semi = document.getElementById('methodSemi').checked;

            // Frequency Filters
            const f5 = document.getElementById('freq5').checked;
            const f3 = document.getElementById('freq3').checked;
            const f1 = document.getElementById('freq1').checked;

            const filtered = allData.filter(d => {
                const rMatch = d.r >= minR && d.r <= maxR;
                let mMatch = false;
                if (auto && d.m.includes('ìë™')) mMatch = true;
                if (manual && d.m.includes('ìˆ˜ë™')) mMatch = true;
                if (semi && d.m.includes('ë°˜ìë™')) mMatch = true;

                let fMatch = false;
                if (f5 && d.totalWins >= 5) fMatch = true;
                if (f3 && d.totalWins >= 3 && d.totalWins <= 4) fMatch = true;
                if (f1 && d.totalWins <= 2) fMatch = true;

                return rMatch && mMatch && fMatch;
            });

            document.getElementById('filteredCount').innerText = filtered.length.toLocaleString();
            updateMarkers(filtered);
            // updateRecentRounds(maxR); // Removed as per user request
        }

        function refreshRecentRounds() {
            const maxR = parseInt(document.getElementById('maxRound').value) || 9999;
            updateRecentRounds(maxR);
        }

        function updateRecentRounds(maxRound) {
            const container = document.getElementById('recentRoundsList');
            const refSpan = document.getElementById('recentRefRound');
            if (refSpan) refSpan.innerText = maxRound;

            if (!container) return;

            container.innerHTML = '';

            // Check if history data is loaded
            if (!window.lottoHistory) {
                container.innerHTML = '<div style="font-size:12px; color:#666; text-align:center;">ë°ì´í„° ë¡œë”© ì¤‘...</div>';
                return;
            }

            // Loop 3 rounds: maxRound, maxRound-1, maxRound-2 (Reduced to save space)
            for (let i = 0; i < 3; i++) {
                const targetRound = maxRound - i;
                if (targetRound < 1) continue; // No rounds below 1

                const row = document.createElement('div');
                row.className = 'recent-row';

                // Round Number
                const roundNum = document.createElement('span');
                roundNum.className = 'recent-round-num';
                roundNum.innerText = targetRound + 'íšŒ';
                row.appendChild(roundNum);

                // Balls Container
                const ballsDiv = document.createElement('div');
                ballsDiv.style.display = 'flex';
                ballsDiv.style.gap = '2px';

                // Get Winning Numbers
                // lottoHistory key is string "1210"
                const nums = window.lottoHistory[String(targetRound)];

                if (nums && nums.length > 0) {
                    nums.sort((a, b) => a - b).forEach(n => {
                        const ball = document.createElement('span');
                        ball.className = 'mini-ball ' + getBallColor(n);
                        ball.innerText = n;
                        ballsDiv.appendChild(ball);
                    });
                } else {
                    const noData = document.createElement('span');
                    noData.style.fontSize = '11px';
                    noData.style.color = '#999';
                    noData.innerText = 'ë°ì´í„° ì—†ìŒ';
                    ballsDiv.appendChild(noData);
                }

                row.appendChild(ballsDiv);
                container.appendChild(row);
            }
        }

        function updateMarkers(data) {
            clusterer.clear();
            markers.forEach(m => m.setMap(null));
            markers = [];

            // To avoid duplicate markers for the same shop at the same location,
            // we need to group the filtered data by shop (lat, lng, name, address)
            // and then create a single marker for each unique shop.
            const uniqueShops = {};
            data.forEach(d => {
                const key = `${d.lat}_${d.lng}_${d.n}_${d.a}`;
                if (!uniqueShops[key]) {
                    uniqueShops[key] = {
                        n: d.n,
                        a: d.a,
                        lat: d.lat,
                        lng: d.lng,
                        totalWins: d.totalWins, // This is the total wins for the shop
                        rounds: [] // To store individual round details for infowindow
                    };
                }
                uniqueShops[key].rounds.push({ r: d.r, m: d.m });
            });

            Object.values(uniqueShops).forEach(shop => {
                let markerImg = null;
                // Tiered Styles
                if (shop.totalWins >= 5) {
                    // Legendary Gold Star
                    markerImg = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
                        new kakao.maps.Size(24, 35)
                    );
                } else if (shop.totalWins >= 3) {
                    // Professional Red
                    markerImg = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/2018/pc/img/marker_spot.png',
                        new kakao.maps.Size(24, 35),
                        { offset: new kakao.maps.Point(12, 35) }
                    );
                }

                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(shop.lat, shop.lng),
                    image: markerImg
                });

                const sortedRounds = shop.rounds.sort((a, b) => b.r - a.r);
                const roundTagsHtml = sortedRounds.map(r => `<span class="iw-tag">${r.r}íšŒ(${r.m})</span>`).join('');

                const safeAddr = (shop.a || "").replace(/'/g, "\\'").replace(/\n/g, " ");
                const safeName = (shop.n || "").replace(/'/g, "\\'").replace(/\n/g, " ");

                const content = `
                    <div class="infowindow">
                        <div class="iw-title">${shop.n} ${shop.totalWins >= 5 ? 'ğŸŒŸ' : ''}</div>
                        <div class="iw-addr-box" onclick="copyToClipboard('${safeAddr}')" title="ì£¼ì†Œ ë³µì‚¬">
                            <span class="iw-addr">${shop.a}</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="#666"><path d="M16 1H4c-1.11 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        </div>
                        <div style="font-weight:bold; color:red; margin-bottom:5px;">ì´ ${shop.totalWins}íšŒ ë‹¹ì²¨</div>
                        <div class="iw-details">${roundTagsHtml}</div>
                        <button class="btn-gold" onclick="openAdModal('${safeName}', '${safeAddr}', ${shop.lat}, ${shop.lng}, ${shop.totalWins})">
                            âœ¨ ì´ë²ˆ ì£¼ 1ë“± ì¶”ì²œ ë²ˆí˜¸ ë°›ê¸°
                        </button>
                        <div class="iw-actions">
                            <button class="btn-iw btn-navi" onclick="openDirections(${shop.lat}, ${shop.lng}, '${safeName}')">
                                ğŸš— ê¸¸ì°¾ê¸°
                            </button>
                        </div>
                    </div>
                `;

                const infowindow = new kakao.maps.InfoWindow({
                    content: content,
                    removable: true,
                    zIndex: 1500 // Ensure popup is on top of markers
                });

                kakao.maps.event.addListener(marker, 'click', () => {
                    // Close previous InfoWindow if exists
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }

                    infowindow.open(map, marker);
                    currentInfoWindow = infowindow; // Update current
                });

                markers.push(marker);
            });
            clusterer.addMarkers(markers);
        }

        /**
         * GPS Location Service Module
         * Handles user positioning, nearest shop calculation, and UI feedback (Toasts).
         */
        let myLocationMarker = null;

        function requestMyLocation() {
            if (!navigator.onLine) {
                showToast("ğŸŒ ì¸í„°ë„· ì—°ê²°ì´ ëŠê²¨ ìˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.", "error");
                return;
            }

            if (!navigator.geolocation) {
                showToast("ğŸš« ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
                return;
            }

            const gpsBtn = document.querySelector('.gps-button');
            if (gpsBtn) gpsBtn.classList.add('loading');

            // GPS Permission & Fetch
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    if (gpsBtn) gpsBtn.classList.remove('loading');
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const center = new kakao.maps.LatLng(lat, lng);

                    map.setCenter(center);

                    // Close all infowindows to clear the view
                    if (typeof clusterer !== 'undefined') {
                        // There's no direct 'closeAll' on clusterer, but we can just let it be
                    }

                    // Add/Update Blue Dot Marker
                    if (!myLocationMarker) {
                        myLocationMarker = new kakao.maps.CustomOverlay({
                            position: center,
                            content: `
                                <div style="position:relative;">
                                    <div class="pulse"></div>
                                    <div style="width:16px; height:16px; background:#1976d2; border:2px solid #fff; border-radius:50%; box-shadow:0 0 10px rgba(0,0,0,0.5); position:relative; z-index:2; transform: translate(-50%, -50%);"></div>
                                </div>
                            `,
                            map: map,
                            zIndex: 1001
                        });
                    } else {
                        myLocationMarker.setPosition(center);
                        myLocationMarker.setMap(map);
                    }

                    findNearestShop(lat, lng);
                },
                (err) => {
                    console.error("GPS Error:", err);
                    if (gpsBtn) gpsBtn.classList.remove('loading');
                    let msg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    switch (err.code) {
                        case 1:
                            msg = "ìœ„ì¹˜ ì •ë³´ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.";
                            break;
                        case 2:
                            msg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPSê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.";
                            break;
                        case 3:
                            msg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”.";
                            break;
                    }
                    showToast(msg, "error");
                },
                { enableHighAccuracy: false, timeout: 15000, maximumAge: 0 }
            );
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // --- Monetization & Logic ---
        let currentShopData = null; // Store temp data for the modal

        function openAdModal(name, addr, lat, lng, totalWins) {
            // Re-filter allData for this specific shop to get rounds.
            const rounds = allData.filter(d => d.n === name && d.a === addr).map(d => ({ r: d.r, m: d.m }));

            currentShopData = { name, addr, lat, lng, totalWins, rounds };

            // Show Modal
            const modal = document.getElementById('adModal');
            const adContent = document.getElementById('adContent');
            const resultContent = document.getElementById('resultContent');

            // Mode Containers
            const modeSelection = document.getElementById('modeSelection');
            const analysisLoading = document.getElementById('analysisLoading');
            const modeDreamInput = document.getElementById('modeDreamInput');
            const modeHoroscopeSelect = document.getElementById('modeHoroscopeSelect');

            modal.style.display = 'flex';
            adContent.style.display = 'flex'; // Changed to flex for centering
            resultContent.style.display = 'none';

            // Reset UI State
            modeSelection.style.display = 'block';
            if (analysisLoading) analysisLoading.style.display = 'none';
            if (modeDreamInput) modeDreamInput.style.display = 'none';
            if (modeHoroscopeSelect) modeHoroscopeSelect.style.display = 'none';

            // Push history state to support Back Button closing
            history.pushState({ modalOpen: true }, null, "");
        }

        // --- Phase 10: Selection Handlers ---

        function selectAnalysisMode() {
            // Hide selection, show loading
            document.getElementById('modeSelection').style.display = 'none';
            const loader = document.getElementById('analysisLoading');
            if (loader) {
                loader.style.display = 'flex';
                // Reset text if needed
                loader.querySelector('h3').innerText = 'ë°ì´í„° ë¶„ì„ ì¤‘...';
                loader.querySelector('p').innerText = 'ëª…ë‹¹ì˜ ê¸°ìš´ì„ ëª¨ìœ¼ê³  ìˆìŠµë‹ˆë‹¤';
            }

            // Simulate Analysis Delay (3 seconds)
            setTimeout(() => {
                showResult();
            }, 3000);
        }

        function selectDreamMode() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('modeDreamInput').style.display = 'block';
        }

        function resetToModeSelection() {
            document.getElementById('modeDreamInput').style.display = 'none';
            document.getElementById('modeHoroscopeSelect').style.display = 'none';
            document.getElementById('modeSelection').style.display = 'block';
        }

        function handleDreamTag(keyword) {
            document.getElementById('dreamInput').value = keyword;
            handleDreamSubmit();
        }

        function handleDreamSubmit() {
            const input = document.getElementById('dreamInput');
            const keyword = input.value.trim();

            if (!keyword) {
                alert('ê¿ˆ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            // Show loading state
            document.getElementById('modeDreamInput').style.display = 'none';
            const loader = document.getElementById('analysisLoading');
            if (loader) {
                loader.style.display = 'flex';
                loader.querySelector('h3').innerText = 'ê¿ˆ í•´ëª½ ì¤‘...';
                loader.querySelector('p').innerText = 'ê¿ˆ ì†ì— ìˆ¨ê²¨ì§„ í–‰ìš´ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤';
            }

            setTimeout(() => {
                const luckyNumbers = generateDreamNumbers(keyword);
                showResult(luckyNumbers);
            }, 2000);
        }

        function generateDreamNumbers(keyword) {
            // 1. Traditional Dream Mappings (Simple Version)
            const dreamMap = {
                'ë¼ì§€': [8, 12, 23, 33, 38, 41],
                'ë˜¥': [6, 17, 24, 35, 36, 42],
                'ì¡°ìƒ': [1, 3, 15, 27, 39, 41],
                'ë¶ˆ': [2, 11, 22, 33, 40, 44],
                'ë¬¼': [4, 9, 21, 26, 31, 37],
                'ë±€': [5, 10, 16, 28, 34, 45],
                'ìš©': [7, 18, 20, 30, 42, 45]
            };

            // If keyword exists in map, return it (with small variation if needed, but fixed for now)
            if (dreamMap[keyword]) {
                return {
                    numbers: dreamMap[keyword],
                    historyCount: 0, // Not based on history
                    type: 'dream',
                    keyword: keyword
                };
            }

            // 2. Hash-based Generation for unknown keywords
            // This ensures the same keyword always yields the same numbers
            let hash = 0;
            for (let i = 0; i < keyword.length; i++) {
                hash = ((hash << 5) - hash) + keyword.charCodeAt(i);
                hash |= 0; // Convert to 32bit integer
            }

            // Seeding logic using text hash
            const seededRandom = (seed) => {
                var x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            };

            const selected = new Set();
            let seed = Math.abs(hash);

            while (selected.size < 6) {
                const n = Math.floor(seededRandom(seed) * 45) + 1;
                selected.add(n);
                seed++;
            }

            return {
                numbers: Array.from(selected).sort((a, b) => a - b),
                historyCount: 0,
                type: 'dream',
                keyword: keyword
            };
        }

        function selectHoroscopeMode() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('modeHoroscopeSelect').style.display = 'block';
        }

        function handleZodiacClick(zodiacName, icon) {
            // Show loading
            document.getElementById('modeHoroscopeSelect').style.display = 'none';
            const loader = document.getElementById('analysisLoading');
            if (loader) {
                loader.style.display = 'flex';
                loader.querySelector('h3').innerText = 'ì˜¤ëŠ˜ì˜ ìš´ì„¸ ë¶„ì„ ì¤‘...';
                loader.querySelector('p').innerText = 'ë³„ë“¤ì˜ ê¸°ìš´ì„ ì½ê³  ìˆìŠµë‹ˆë‹¤';
            }

            // Simulate and Generate
            setTimeout(() => {
                const horoscopeData = generateHoroscope(zodiacName);
                showResult({
                    type: 'horoscope',
                    zodiac: zodiacName,
                    icon: icon,
                    ...horoscopeData
                });
            }, 2000);
        }

        function generateHoroscope(zodiacName) {
            // Get today's date string YYYY-MM-DD
            const today = new Date().toISOString().split('T')[0];
            const key = today + zodiacName;

            // Generate seeded random based on date + zodiac
            let hash = 0;
            for (let i = 0; i < key.length; i++) {
                hash = ((hash << 5) - hash) + key.charCodeAt(i);
                hash |= 0;
            }
            const seededRandom = (seed) => {
                var x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            };
            let seed = Math.abs(hash);

            // 1. Horoscope Text Generation
            const fortunes = [
                "ê¸ˆì „ìš´ì´ ë§¤ìš° ì¢‹ì€ ë‚ ì…ë‹ˆë‹¤. ì‘ì€ íˆ¬ìë„ í° ê²°ì‹¤ì„ ë§ºì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                "ëœ»ë°–ì˜ í–‰ìš´ì´ ì°¾ì•„ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì£¼ë³€ì„ ì˜ ì‚´í´ë³´ì„¸ìš”.",
                "ì˜¤ëŠ˜ì€ ì§ê°ì´ ë§¤ìš° ë›°ì–´ë‚œ ë‚ ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ëŠë‚Œì„ ë¯¿ì–´ë³´ì„¸ìš”.",
                "ê·€ì¸ì˜ ë„ì›€ì„ ë°›ì•„ ì–´ë ¤ì›€ì´ í•´ê²°ë  ê²ƒì…ë‹ˆë‹¤. ê¸ì •ì ì¸ ë§ˆìŒì„ ê°€ì§€ì„¸ìš”.",
                "ì¬ë¬¼ìš´ì´ ìƒìŠ¹í•˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. ë¡œë˜ êµ¬ë§¤í•˜ê¸° ë”± ì¢‹ì€ ë‚ !",
                "ì‘ì€ ë…¸ë ¥ìœ¼ë¡œ í° ê¸°ì¨ì„ ì–»ì„ ìˆ˜ ìˆëŠ” ë‚ ì…ë‹ˆë‹¤.",
                "í–‰ìš´ì˜ ì—¬ì‹ ì´ ë‹¹ì‹ ì„ ë³´ê³  ë¯¸ì†Œ ì§“ê³  ìˆìŠµë‹ˆë‹¤.",
                "ì˜¤ë«ë™ì•ˆ ê¸°ë‹¤ë ¤ì˜¨ ì†Œì‹ì´ ë“¤ë ¤ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                "ì˜¤ëŠ˜ì€ ë‹¹ì‹ ì˜ ë‚ ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ í•´ë„ ìˆ ìˆ  í’€ë¦´ ê²ƒì…ë‹ˆë‹¤.",
                "ì£¼ë³€ ì‚¬ëŒë“¤ê³¼ì˜ ê´€ê³„ì—ì„œ í–‰ìš´ì´ ë¹„ë¡¯ë  ê²ƒì…ë‹ˆë‹¤."
            ];

            const luckyColors = ["ë¹¨ê°•", "íŒŒë‘", "ë…¸ë‘", "ì´ˆë¡", "ë³´ë¼", "ê¸ˆìƒ‰", "ì€ìƒ‰", "í°ìƒ‰"];
            const directions = ["ë™", "ì„œ", "ë‚¨", "ë¶", "ë™ë‚¨", "ë™ë¶", "ì„œë‚¨", "ì„œë¶"];

            const fortuneIndex = Math.floor(seededRandom(seed) * fortunes.length);
            const colorIndex = Math.floor(seededRandom(seed + 1) * luckyColors.length);
            const dirIndex = Math.floor(seededRandom(seed + 2) * directions.length);

            const text = `${fortunes[fortuneIndex]}<br>í–‰ìš´ì˜ ìƒ‰: <b>${luckyColors[colorIndex]}</b>, ë°©í–¥: <b>${directions[dirIndex]}ìª½</b>`;

            // 2. Number Generation
            const selected = new Set();
            let numSeed = seed + 100;
            while (selected.size < 6) {
                const n = Math.floor(seededRandom(numSeed) * 45) + 1;
                selected.add(n);
                numSeed++;
            }

            return {
                text: text,
                numbers: Array.from(selected).sort((a, b) => a - b),
                historyCount: 0
            };
        }

        function closeModal() {
            // If the modal is open, going back will trigger popstate which closes it effectively
            // But we need to check if we are actually in the modal state
            if (document.getElementById('adModal').style.display === 'flex') {
                history.back();
            }
        }

        function _internalCloseModal() {
            document.getElementById('adModal').style.display = 'none';
        }

        function showResult(customResult = null) {
            document.getElementById('adContent').style.display = 'none';
            document.getElementById('resultContent').style.display = 'block';

            // Logic
            let result;
            if (customResult) {
                result = customResult;
                // Update text based on result type
                const container = document.getElementById('paramHCount').parentElement;

                if (result.type === 'dream') {
                    container.innerHTML =
                        `ê¿ˆ í‚¤ì›Œë“œ <strong style="color:#fae100;">'${result.keyword}'</strong>(ìœ¼)ë¡œ<br>ë¶„ì„ëœ í–‰ìš´ì˜ ë²ˆí˜¸ì…ë‹ˆë‹¤.`;
                } else if (result.type === 'horoscope') {
                    container.innerHTML =
                        `<div class="horoscope-text-box">
                            <div style="font-size:24px; margin-bottom:5px;">${result.icon}</div>
                            <div style="font-weight:bold; font-size:16px; margin-bottom:10px; color:#fae100;">${result.zodiac}ë  ì˜¤ëŠ˜ì˜ ìš´ì„¸</div>
                            ${result.text}
                        </div>
                        <div style="font-size:13px; color:rgba(255,255,255,0.8);">ìœ„ ìš´ì„¸ì— ê¸°ë°˜í•œ í–‰ìš´ì˜ ë²ˆí˜¸ì…ë‹ˆë‹¤.</div>`;
                }
            } else {
                result = generateLuckyNumbers(currentShopData.rounds);
                // Restore default text
                document.getElementById('paramHCount').parentElement.innerHTML =
                    `ì´ ëª…ë‹¹ì€ ê³¼ê±° <strong id="paramHCount" style="color:#fae100;">${result.historyCount}</strong>ë²ˆì˜ 1ë“±ì„ ë°°ì¶œí–ˆìŠµë‹ˆë‹¤.<br>` +
                    `(<span id="paramRounds">${result.relatedRounds.join(', ') + (result.historyCount > 5 ? '...' : '')}</span> ë“±)`;
            }

            // Render
            const ballContainer = document.getElementById('luckyBalls');
            ballContainer.innerHTML = '';

            result.numbers.forEach(n => {
                const ball = document.createElement('div');
                ball.className = 'ball ' + getBallColor(n);
                ball.innerText = n;
                ballContainer.appendChild(ball);
            });
        }

        function getBallColor(n) {
            if (n <= 10) return 'one';
            if (n <= 20) return 'two';
            if (n <= 30) return 'three';
            if (n <= 40) return 'four';
            return 'five';
        }

        function goToShop() {
            if (!currentShopData) return;
            openDirections(currentShopData.lat, currentShopData.lng, currentShopData.name);
            // closeModal(); // Do not close automatically or it might conflict with navigation? 
            // Actually, usually you want to close modal if leaving. 
            // But if opening _blank, modal stays. Let's force close logic.
            // Calling closeModal() triggers history.back(), cleaning up state.
            closeModal();
        }

        // Close modal when clicking outside - Direct listener for better mobile support
        const modalEl = document.getElementById('adModal');
        if (modalEl) {
            modalEl.addEventListener('click', function (event) {
                if (event.target === modalEl) {
                    closeModal();
                }
            });
        }

        // Handle Back Button
        window.addEventListener('popstate', function (event) {
            // When history changes (Back pressed), we close the modal UI
            // Check if modal is currently visible
            const modal = document.getElementById('adModal');
            if (modal && modal.style.display === 'flex') {
                _internalCloseModal();
            }
        });



        function findNearestShop(lat, lng) {
            if (typeof allData === 'undefined' || allData.length === 0) return;

            // Sort all shops by distance
            const sortedShops = allData.map(shop => {
                return {
                    ...shop,
                    distance: getDistance(lat, lng, shop.lat, shop.lng)
                };
            }).sort((a, b) => a.distance - b.distance);

            // Take top 5
            const top5 = sortedShops.slice(0, 5);

            if (top5.length > 0) {
                let msg = "ğŸ“ ì£¼ë³€ 1ë“± ë°°ì¶œì  (ê°€ê¹Œìš´ ìˆœ)\n";
                top5.forEach((shop, index) => {
                    const distStr = shop.distance < 1 ? Math.round(shop.distance * 1000) + "m" : shop.distance.toFixed(1) + "km";
                    msg += `${index + 1}. ${shop.n} (${distStr})\n`;
                });
                showToast(msg, "success");

                // Adaptive Zoom: Fit my location and top nearest shops
                const bounds = new kakao.maps.LatLngBounds();
                bounds.extend(new kakao.maps.LatLng(lat, lng));

                // Only include shops within 20km for the initial view to avoid extreme zoom out
                top5.forEach(shop => {
                    if (shop.distance < 20) {
                        bounds.extend(new kakao.maps.LatLng(shop.lat, shop.lng));
                    }
                });

                map.setBounds(bounds, 80, 80, 80, 80); // generous padding
            }
        }

        function showToast(message, type = "info") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerText = message;

            container.appendChild(toast);

            // Force reflow
            toast.offsetHeight;

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode === container) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast("ğŸ“‹ ì£¼ì†Œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            } catch (err) {
                showToast("ë³µì‚¬ ì‹¤íŒ¨", "error");
            }
            document.body.removeChild(textarea);
        }

        function openDirections(lat, lng, name) {
            const url = `https://map.kakao.com/link/to/${encodeURIComponent(name)},${lat},${lng}`;
            window.open(url, '_blank');
        }

        function shareToKakao() {
            try {
                console.log('[Kakao Share] Function called');

                // Check if Kakao SDK is loaded
                if (typeof window.Kakao === 'undefined') {
                    console.error('[Kakao Share] Kakao SDK not loaded');
                    return;
                }

                console.log('[Kakao Share] Kakao SDK loaded successfully');

                // Initialize Kakao SDK if not already initialized
                if (!window.Kakao.isInitialized()) {
                    console.log('[Kakao Share] Initializing Kakao SDK...');
                    window.Kakao.init('a6b27b6dab16c7e3459bb9589bf1269d');
                    console.log('[Kakao Share] Kakao SDK initialized');
                } else {
                    console.log('[Kakao Share] Kakao SDK already initialized');
                }

                // Prepare share data - NO IMAGE to ensure k-inov.co.kr link works
                const shareData = {
                    objectType: 'feed',
                    content: {
                        title: 'ğŸ° KINOV ë¡œë˜ ëª…ë‹¹ ì§€ë„',
                        description: 'ì—­ëŒ€ 1ë“± ë‹¹ì²¨ íŒë§¤ì ì„ í•œëˆˆì—! ë‹¹ì‹ ì˜ í–‰ìš´ì„ ì°¾ì•„ë³´ì„¸ìš”.\n\nì§€ê¸ˆ ë°”ë¡œ KINOV Mallì„ ë°©ë¬¸í•˜ì„¸ìš”!',
                        link: {
                            mobileWebUrl: 'https://www.k-inov.co.kr',
                            webUrl: 'https://www.k-inov.co.kr'
                        }
                    },
                    buttons: [
                        {
                            title: 'KINOV Mall ë°©ë¬¸í•˜ê¸°',
                            link: {
                                mobileWebUrl: 'https://www.k-inov.co.kr',
                                webUrl: 'https://www.k-inov.co.kr'
                            }
                        }
                    ]
                };

                console.log('[Kakao Share] Sending share data:', shareData);

                // Send KakaoTalk share message
                window.Kakao.Share.sendDefault(shareData);

                console.log('[Kakao Share] Share dialog opened successfully');

            } catch (error) {
                console.error('[Kakao Share] Error:', error);
            }
        }
    </script>
</body>

</html>