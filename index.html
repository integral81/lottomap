<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINOV 로또 명당 정밀 지도</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=b29ba13a6dceba9dda144cda55359e59&libraries=services,clusterer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Malgun Gothic', sans-serif; overflow: hidden; }
        #container { display: flex; flex-direction: column; height: 100vh; }
        #header { padding: 15px; background: #1a1a1a; color: #fff; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 100; }
        #controls { display: flex; gap: 15px; align-items: center; font-size: 13px; }
        #map { flex: 1; }
        .filter-group { background: #333; padding: 6px 12px; border-radius: 4px; border: 1px solid #444; }
        button { cursor: pointer; padding: 7px 18px; background: #ffcc00; border: none; color: #000; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        button:hover { background: #e6b800; }
        .info-card { padding: 10px; min-width: 180px; font-size: 12px; line-height: 1.6; }
        .win-tag { display: inline-block; padding: 2px 5px; margin: 2px; font-size: 10px; border-radius: 3px; color: white; }
        .tag-자동 { background: #27ae60; } .tag-수동 { background: #2980b9; } .tag-반자동 { background: #f39c12; }
        #status { font-size: 11px; color: #aaa; margin-left: 10px; }
    </style>
</head>
<body>

<div id="container">
    <div id="header">
        <div><strong>KINOV LOTTO MAP</strong><span id="status">파일 로딩 대기 중...</span></div>
        <div id="controls">
            <div class="filter-group">
                방식: 
                <label><input type="checkbox" class="type-chk" value="자동" checked> 자동</label>
                <label><input type="checkbox" class="type-chk" value="수동" checked> 수동</label>
                <label><input type="checkbox" class="type-chk" value="반자동" checked> 반자동</label>
            </div>
            <div class="filter-group">
                회차: <input type="number" id="startRev" value="1000" style="width:55px;"> ~ 
                <input type="number" id="endRev" value="1209" style="width:55px;">
            </div>
            <button onclick="applyFilter()">필터 적용</button>
        </div>
    </div>
    <div id="map"></div>
</div>

<script>
    let map, clusterer, geocoder;
    let allData = [];
    let coordCache = new Map(); // 좌표 캐싱

    // 1. 지도 초기화
    map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(36.2683, 127.6358),
        level: 12
    });
    geocoder = new kakao.maps.services.Geocoder();
    clusterer = new kakao.maps.MarkerClusterer({
        map: map,
        averageCenter: true,
        minLevel: 8
    });

    // 2. CSV 파일 읽기 (동일 폴더 내 lotto.csv)
    function loadCSV() {
        document.getElementById('status').innerText = "데이터 읽는 중...";
        Papa.parse("lotto.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                allData = results.data;
                document.getElementById('status').innerText = `총 ${allData.length}건 로드 완료`;
                applyFilter();
            },
            error: function() {
                document.getElementById('status').innerText = "lotto.csv 파일을 찾을 수 없습니다.";
            }
        });
    }

    // 3. 필터 적용 및 마커 표시
    async function applyFilter() {
        clusterer.clear();
        const start = parseInt(document.getElementById('startRev').value);
        const end = parseInt(document.getElementById('endRev').value);
        const types = Array.from(document.querySelectorAll('.type-chk:checked')).map(el => el.value);

        // 필터링 및 그룹화
        const groups = {};
        allData.forEach(d => {
            const rev = parseInt(d['회차']);
            const type = d['당첨방식'];
            if (rev >= start && rev <= end && types.includes(type)) {
                const addr = d['소재지'];
                if(!groups[addr]) groups[addr] = { name: d['상호명'], addr: addr, wins: [] };
                groups[addr].wins.push(d);
            }
        });

        document.getElementById('status').innerText = `필터링 결과: ${Object.keys(groups).length}개 지점 표시 중...`;

        const markers = [];
        for (const addr in groups) {
            const coords = await getCoords(addr);
            if (coords) {
                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(coords.lat, coords.lng)
                });

                const winHtml = groups[addr].wins.map(w => 
                    `<span class="win-tag tag-${w['당첨방식']}">${w['회차']}회</span>`
                ).join('');

                const infowindow = new kakao.maps.InfoWindow({
                    content: `<div class="info-card"><strong>${groups[addr].name}</strong><br><small>${addr}</small><hr>${winHtml}</div>`,
                    removable: true
                });

                kakao.maps.event.addListener(marker, 'click', () => infowindow.open(map, marker));
                markers.push(marker);
            }
        }
        clusterer.addMarkers(markers);
    }

    // 4. 지오코딩 (Promise + Cache)
    function getCoords(address) {
        if (coordCache.has(address)) return Promise.resolve(coordCache.get(address));
        
        return new Promise((resolve) => {
            geocoder.addressSearch(address, (result, status) => {
                if (status === kakao.maps.services.Status.OK) {
                    const res = { lat: result[0].y, lng: result[0].x };
                    coordCache.set(address, res);
                    resolve(res);
                } else {
                    resolve(null);
                }
            });
        });
    }

    // 시작
    window.onload = loadCSV;
</script>

</body>
</html>