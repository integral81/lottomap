<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>KINOV Î°úÎòê Î™ÖÎãπ ÏßÄÎèÑ</title>
    <!-- Library for QR Code Scanning -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Ï†ÑÍµ≠ Î°úÎòê 1Îì± ÎãπÏ≤® ÌåêÎß§Ï†êÏùÑ ÏßÄÎèÑÏóêÏÑú ÌïúÎààÏóê ÌôïÏù∏ÌïòÏÑ∏Ïöî. ÎÇ¥ Ï£ºÎ≥Ä Î™ÖÎãπ Ï∞æÍ∏∞, Î°úÎòê Î≤àÌò∏ Î¨¥Î£å Ï∂îÏ≤ú ÏÑúÎπÑÏä§ Ï†úÍ≥µ.">
    <meta name="keywords" content="Î°úÎòê, Î°úÎòêÎ™ÖÎãπ, Î°úÎòêÏßÄÎèÑ, Î°úÎòê1Îì±, Î°úÎòêÎãπÏ≤®Î≤àÌò∏, Î°úÎòêÌåêÎß§Ï†ê, KINOV">
    <meta name="author" content="KINOV">

    <!-- Open Graph (KakaoTalk, Facebook, etc.) -->
    <meta property="og:title" content="üé∞ KINOV Î°úÎòê Î™ÖÎãπ ÏßÄÎèÑ">
    <meta property="og:description" content="Ïó≠ÎåÄ 1Îì± ÎãπÏ≤® ÌåêÎß§Ï†êÏùÑ ÌïúÎààÏóê! ÎãπÏã†Ïùò ÌñâÏö¥ÏùÑ Ï∞æÏïÑÎ≥¥ÏÑ∏Ïöî.">
    <meta property="og:image" content="https://www.k-inov.co.kr/assets/img/lotto_share_thumb.png">
    <!-- Update with actual image URL if available, or use a placeholder -->
    <meta property="og:url" content="https://integral81.github.io/lotto_kakaomap/">
    <meta property="og:type" content="website">

    <!-- Favicon (Using Emoji for now if no file exists) -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé∞</text></svg>">
    <script>
        // SDK Error Handler (Defined first)
        function handleScriptError() {
            const mapDiv = document.getElementById('map');
            const usedKey = 'a6b27b6dab16c7e3459bb9589bf1269d';
            if (mapDiv) {
                mapDiv.innerHTML = `
                    <div style="padding:40px; text-align:center; color:#d32f2f;">
                        <h2 style="margin-bottom:10px;">üîë Ïπ¥Ïπ¥Ïò§ ÏßÄÎèÑ Ïù∏Ï¶ù Ïã§Ìå® (Domain Mismatch)</h2>
                        <p style="color:#333; font-size:16px;">Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÄ ÌôïÏù∏ÎêòÏóàÏúºÎÇò, Ïπ¥Ïπ¥Ïò§ ÏÑúÎ≤ÑÏóêÏÑú <strong>ÎèÑÎ©îÏù∏ Í±∞Î∂Ä</strong>Í∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>
                        
                        <div style="background:#fff; border:1px solid #d32f2f; padding:20px; border-radius:10px; text-align:left; margin: 20px auto; color:#333; max-width:600px; font-size:14px; line-height:1.6;">
                            <strong>‚úÖ Ïù¥ ÏàúÏÑúÎåÄÎ°ú Ìï¥Í≤∞Ìï¥ Î≥¥ÏÑ∏Ïöî:</strong><br><br>
                            1. <strong>ÎèÑÎ©îÏù∏ Ï∂îÍ∞Ä Îì±Î°ù</strong>: Ïπ¥Ïπ¥Ïò§ ÏΩòÏÜî [ÌîåÎû´Ìèº > Web] ÏÇ¨Ïù¥Ìä∏ ÎèÑÎ©îÏù∏Ïóê ÏïÑÎûò Ï£ºÏÜåÎì§Ïù¥ Îì±Î°ùÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî:
                               <ul style="margin:5px 0 15px 20px;">
                                 <li><code>http://localhost:8000</code></li>
                                 <li><code>http://127.0.0.1:8000</code></li>
                               </ul>
                            2. <strong>Ïò¨Î∞îÎ•∏ ÌÇ§ ÏÇ¨Ïö© ÌôïÏù∏</strong>: Ïπ¥Ïπ¥Ïò§ ÏΩòÏÜî [ÎÇ¥ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò > ÏöîÏïΩ Ï†ïÎ≥¥]ÏóêÏÑú Î∞òÎìúÏãú <strong>'JavaScript ÌÇ§'</strong>Î•º Î≥µÏÇ¨ÌñàÎäîÏßÄ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.<br><br>
                            <div style="background:#eee; padding:10px; border-radius:5px; border:1px dashed #999;">
                                <strong>ÌòÑÏû¨ ÏÇ¨Ïö© Ï§ëÏù∏ ÌÇ§:</strong> <code>${usedKey}</code>
                            </div>
                        </div>
                        <p style="color:#666;">ÏÑ§Ï†ïÏùÑ Î≥ÄÍ≤ΩÌïú ÌõÑ Î∏åÎùºÏö∞Ï†ÄÎ•º <strong>ÏÉàÎ°úÍ≥†Ïπ®(F5)</strong> Ìï¥Ï£ºÏÑ∏Ïöî.</p>
                    </div>`;
            }
        }
    </script>
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a6b27b6dab16c7e3459bb9589bf1269d&libraries=clusterer"
        onerror="handleScriptError()"></script>
    <!-- Kakao SDK for Sharing -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"></script>
    <style>
        :root {
            --primary: #d32f2f;
            --secondary: #1976d2;
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #333333;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Pretendard', system-ui, sans-serif;
            background-color: var(--bg);
            overflow: hidden;
        }

        #app {
            display: flex !important;
            width: 100vw;
            height: 100vh;
            flex-direction: row;
            overflow: hidden;
        }

        #sidebar {
            width: 320px;
            height: 100%;
            background: var(--card);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            order: 1;
            /* PC: First */
        }

        #map {
            flex: 1;
            height: 100%;
            background: #eee;
            order: 2;
            /* PC: Second */
        }

        h1 {
            font-size: 20px;
            color: var(--primary);
            margin: 0 0 20px 0;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .section-title {
            font-weight: 700;
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            display: block;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="number"] {
            width: 70px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-apply {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }

        .btn-apply:hover {
            background-color: #b71c1c;
        }

        .stats-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: auto;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .stat-value {
            color: var(--primary);
            font-weight: 700;
        }

        .infowindow {
            padding: 12px;
            min-width: 200px;
            min-height: 120px;
            box-sizing: border-box;
            background: #fff;
        }

        .iw-title {
            font-weight: 700;
            font-size: 15px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .iw-addr {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
            word-break: keep-all;
        }

        .iw-tag {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            background: #eee;
            font-size: 10px;
            margin: 0 2px 2px 0;
        }

        .iw-actions {
            display: flex !important;
            gap: 10px;
            margin-top: 15px;
            border-top: 1px dashed #eee;
            padding-top: 12px;
            visibility: visible !important;
        }

        .btn-iw {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
            border: 1px solid #ddd;
            background: #fff;
        }

        .btn-iw:hover {
            background: #f5f5f5;
        }

        .btn-navi {
            background: var(--secondary) !important;
            color: white !important;
            border: none !important;
        }

        .btn-navi:hover {
            background: #1565c0 !important;
        }

        .iw-addr-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9f9f9;
            padding: 5px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .iw-addr-box:hover {
            background: #f0f0f0;
        }

        /* GPS Pulse Animation */
        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .pulse {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(25, 118, 210, 0.5);
            border-radius: 50%;
            animation: pulse 2s infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* OMR Grid Styles */
        .omr-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            /* Above everything */
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .omr-modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .omr-modal-content {
            background: #fff;
            width: 90%;
            max-width: 350px;
            max-height: 70vh;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow-y: auto;
        }

        /* Mobile-specific: Reduce OMR modal height by 5% */
        @media (max-width: 768px) {
            .omr-modal-content {
                max-height: 65vh;
            }
        }

        /* Zodiac Grid Styles */
        .zodiac-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 10px;
        }

        .zodiac-item {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .zodiac-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .zodiac-icon {
            font-size: 40px;
        }

        .zodiac-name {
            font-size: 14px;
            font-weight: 600;
            color: white;
        }

        /* Mobile-specific: Change zodiac grid to 3 columns */
        @media (max-width: 768px) {
            .zodiac-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 6px !important;
                padding: 5px !important;
            }

            .zodiac-item {
                padding: 8px !important;
                gap: 4px !important;
            }

            .zodiac-icon {
                font-size: 28px !important;
            }

            .zodiac-name {
                font-size: 11px !important;
            }
        }

        .omr-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin: 10px 0;
        }

        .omr-number {
            aspect-ratio: 0.6;
            /* Rectangular like OMR */
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border-radius: 2px;
            background: #f9f9f9;
            color: #ccc;
            font-weight: bold;
        }

        .omr-number.marked {
            background: #000;
            color: #fff;
            border-color: #000;
        }

        .omr-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }

        .omr-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .floating-btn {
            position: fixed;
            width: 50px;
            height: 50px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .floating-btn:hover {
            transform: scale(1.1);
            background: #f0f0f0;
        }

        /* Action Button Positions & Standard Branding */
        .gps-button {
            top: 140px;
            right: 20px;
            background: #fff;
            border: 2px solid #48bb78;
            /* Green for location */
        }

        .gps-button svg {
            width: 24px;
            height: 24px;
            fill: #48bb78;
        }

        /* Loading state for GPS */
        .gps-button.loading svg {
            animation: rotate 1s linear infinite;
        }

        /* Menu Button Style */
        .menu-btn {
            top: 20px;
            right: 20px;
            border: 2px solid var(--secondary);
        }

        /* QR Quick Button Style */
        .qr-quick-btn {
            top: 80px;
            right: 20px;
            border: 2px solid var(--primary);
        }

        .qr-quick-btn svg {
            width: 24px;
            height: 24px;
            stroke: var(--primary);
        }

        .hamburger-icon {
            width: 20px;
            height: 14px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hamburger-icon span {
            display: block;
            width: 100%;
            height: 2px;
            background: var(--secondary);
            border-radius: 2px;
            transition: all 0.3s;
        }

        .menu-btn.active .hamburger-icon span:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }

        .menu-btn.active .hamburger-icon span:nth-child(2) {
            opacity: 0;
        }

        .menu-btn.active .hamburger-icon span:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }

        /* Side Nav Drawer */
        .side-nav {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: white;
            z-index: 9000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
        }

        .side-nav.open {
            transform: translateX(0);
        }

        .side-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 8999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .side-nav-overlay.show {
            display: block;
            opacity: 1;
        }

        .side-nav-header {
            padding: 25px 20px;
            background: linear-gradient(135deg, var(--secondary), #1565c0);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .side-nav-header .logo {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .close-nav {
            font-size: 28px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .close-nav:hover {
            opacity: 1;
        }

        .side-nav-body {
            padding: 20px 0;
            flex: 1;
            overflow-y: auto;
        }

        .menu-category {
            padding: 10px 20px;
            font-size: 11px;
            font-weight: 700;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 4px solid transparent;
        }

        .menu-item:hover {
            background: #f8f9fa;
            border-left-color: var(--secondary);
        }

        .menu-item .m-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .menu-item .m-text {
            font-size: 15px;
            font-weight: 600;
            color: #444;
        }

        .side-nav-footer {
            padding: 20px;
            font-size: 12px;
            color: #999;
            text-align: center;
            border-top: 1px solid #eee;
        }

        /* Hide mobile line breaks on desktop */
        .mobile-br {
            display: none;
        }

        /* Mobile specific adjustments */
        @media (max-width: 640px) {
            .side-nav {
                width: 80%;
            }

            .mobile-br {
                display: inline;
            }

            /* InfoWindow Badge Grid Optimization */
            .iw-details {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 5px !important;
                margin: 8px 0 12px 0 !important;
            }

            .iw-tag {
                margin: 0 !important;
                padding: 5px 2px !important;
                font-size: 10px !important;
                text-align: center !important;
                background: #f8f9fa !important;
                border: 1px solid #e0e0e0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                white-space: nowrap !important;
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @-webkit-keyframes rotate {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(360deg);
            }
        }

        /* Responsive Design for Mobile (Phone only) */
        @media (max-width: 640px) {
            #app {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                overflow: auto;
            }

            #sidebar {
                width: 100%;
                height: auto;
                flex: none;
                order: 2;
                /* Mobile: Sidebar Bottom */
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }

            #map {
                width: 100%;
                height: 400px;
                flex: none;
                order: 1;
                /* Mobile: Map Top */
                position: relative;
                /* Anchor for absolute buttons */
            }

            /* Move floating buttons to bottom-right of map area on mobile */
            .gps-button {
                position: absolute !important;
                top: 140px !important;
                right: 20px !important;
                z-index: 1001;
                bottom: auto !important;
                /* Reset desktop bottom */
            }

            .toast {
                padding: 12px 18px !important;
                padding-right: 40px !important;
                font-size: 13px !important;
            }

            .menu-btn {
                position: absolute !important;
                top: 20px !important;
                right: 20px !important;
                z-index: 1001;
            }

            .qr-quick-btn {
                position: absolute !important;
                top: 80px !important;
                right: 20px !important;
                z-index: 1001;
            }

            .ai-system-card {
                padding: 16px 20px !important;
            }
        }

        /* Toast Notification Styles */
        #toast-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            width: fit-content;
        }

        .toast {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: #333;
            padding: 14px 28px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            white-space: pre-wrap;
            text-align: left;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            max-width: 90vw;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 500;
            position: relative;
            padding-right: 45px;
            /* Space for close button */
        }

        .toast-close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #999;
            transition: color 0.2s;
            line-height: 1;
        }

        .toast-close:hover {
            color: #333;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-info {
            border-left: 5px solid var(--secondary);
        }

        .toast-error {
            border-left: 5px solid var(--primary);
        }

        .toast-success {
            border-left: 5px solid #48bb78;
        }

        /* GPS Pulse Animation (Works on all devices) */
        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .pulse {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(25, 118, 210, 0.5);
            border-radius: 50%;
            animation: pulse 2s infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* Gold Button & Modal */
        .btn-gold {
            background: linear-gradient(135deg, #FFD700, #FFA000);
            color: #333;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            animation: shiver 2s infinite;
        }

        @keyframes shiver {
            0% {
                transform: rotate(0deg);
            }

            5% {
                transform: rotate(2deg);
            }

            10% {
                transform: rotate(-2deg);
            }

            15% {
                transform: rotate(2deg);
            }

            20% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        @keyframes pulse-alert {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }

            50% {
                transform: scale(1.02);
                box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            cursor: pointer;
            /* Critical for iOS to recognize clicks on transparent/overlay elements */
        }

        .modal-content {
            background-color: transparent;
            padding: 0;
            border-radius: 16px;
            width: 75%;
            max-width: 600px;
            max-height: 70vh;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            overflow-y: auto;
            cursor: default;
            /* Reset cursor for content area */
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 32px;
            cursor: pointer;
            color: white;
            z-index: 10;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .modal-close:hover {
            transform: scale(1.1);
        }

        .lucky-balls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
        }

        .ball {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .ball.one {
            background: #fbc400;
        }

        .ball.two {
            background: #69c8f2;
        }

        .ball.three {
            background: #ff7272;
        }

        .ball.four {
            background: #aaaaaa;
        }

        .ball.five {
            background: #b0d840;
        }

        /* Mini Ball for Recent Rounds */
        .mini-ball {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 800;
            color: white;
            margin-right: 3px;
            box-shadow: inset -2px -2px 4px rgba(0, 0, 0, 0.2);
        }

        .mini-ball.one {
            background: #fbc400;
            color: #333;
            text-shadow: none;
        }

        .mini-ball.two {
            background: #69c8f2;
        }

        .mini-ball.three {
            background: #ff7272;
        }

        .mini-ball.four {
            background: #aaaaaa;
        }

        .mini-ball.five {
            background: #b0d840;
        }

        .recent-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 5px 8px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .recent-round-num {
            font-size: 11px;
            font-weight: bold;
            color: #555;
            width: 45px;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            #app {
                flex-direction: column !important;
            }

            #sidebar {
                width: 100% !important;
                height: auto !important;
                max-height: 50vh !important;
                order: 2 !important;
                padding: 15px !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }

            #map {
                order: 1 !important;
                height: 50vh !important;
                min-height: 300px !important;
            }

            h1 {
                font-size: 18px !important;
                margin: 0 0 15px 0 !important;
            }

            .section {
                margin-bottom: 15px !important;
                padding-bottom: 15px !important;
            }

            .section-title {
                font-size: 13px !important;
            }

            .btn-apply {
                font-size: 14px !important;
                padding: 12px !important;
            }

            .stats-card {
                font-size: 12px !important;
                padding: 12px !important;
            }

            .modal-content {
                width: 95% !important;
                max-width: 95% !important;
                margin: 0 auto !important;
            }

            #adContent,
            #resultContent {
                padding: 15px !important;
                width: 100% !important;
                box-sizing: border-box !important;
                /* Ensure padding doesn't add to width */
            }

            .modal-close {
                right: 10px !important;
                top: 10px !important;
            }
        }

        /* Selection Menu Styles (Global) */
        .selection-menu {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            margin-top: 10px;
        }

        /* AI System Card Style */
        .ai-system-card {
            background: linear-gradient(135deg, #6366f1 0%, #d946ef 100%);
            border-radius: 20px;
            padding: 18px 20px;
            margin-bottom: 20px;
            color: white;
            text-align: left;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .ai-system-card .ai-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 12px;
        }

        .ai-system-card .ai-desc {
            font-size: 13px;
            line-height: 1.5;
            opacity: 0.9;
            margin-bottom: 15px;
            word-break: keep-all;
        }

        .ai-system-card .ai-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .ai-system-card .ai-tag {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
        }

        .selection-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: left;
        }

        .selection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background: white;
        }

        .selection-icon {
            font-size: 24px;
            background: #f0f4f8;
            min-width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selection-info {
            flex: 1;
        }

        .selection-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
            display: block;
        }

        .selection-desc {
            font-size: 12px;
            color: #666;
            display: block;
        }

        /* Loading Animation */
        .loader-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fae100;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Dream Mode Styles */
        .dream-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .dream-tag {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dream-tag:hover {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .dream-input-box {
            display: flex;
            gap: 5px;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .dream-input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            text-align: center;
            outline: none;
            min-width: 0;
            /* Allow input to shrink if needed */
        }

        .btn-dream-submit {
            background: #fae100;
            color: #333;
            border: none;
            padding: 0 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
            /* Prevent text wrapping */
            flex-shrink: 0;
            /* Don't let the button shrink below its text content */
        }

        /* Input Container for Dream/Zodiac */
        .input-container {
            display: none;
            width: 100%;
            text-align: center;
        }

        .btn-sm {
            background-color: #555;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-sm:hover {
            background-color: #333;
        }

        /* Zodiac Mode Styles */
        .zodiac-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 320px;
            margin: 0 auto;
        }

        .zodiac-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            aspect-ratio: 1;
            /* Square shape */
        }

        .zodiac-item:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .zodiac-icon {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .zodiac-name {
            font-size: 12px;
            color: white;
            font-weight: bold;
        }

        .horoscope-text-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            color: white;
            font-size: 14px;
            line-height: 1.5;
            border-left: 4px solid #fae100;
        }

        /* QR Scanner Modal Styles */
        #qrModal {
            z-index: 10000;
        }

        .qr-modal-content {
            background: #fff;
            max-width: 600px;
            width: 95%;
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        #qr-reader {
            width: 100%;
            border: none !important;
        }

        #qr-reader__dashboard {
            padding: 20px !important;
        }

        #qr-reader__status_span {
            font-size: 14px !important;
            font-weight: bold !important;
        }

        .qr-result-container {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            overflow-y: auto;
        }

        .qr-game-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .qr-prize-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .prize-none {
            background: #999;
        }

        .prize-win {
            background: #ff5252;
        }

        /* Frequency Dashboard Styles */
        .freq-modal-content {
            background: #fff;
            max-width: 500px;
            width: 90%;
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 85vh;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        @media (max-width: 640px) {
            .freq-modal-content {
                width: 95%;
                max-height: 90vh;
                border-radius: 15px;
            }

            .freq-body {
                padding: 15px 10px;
            }

            .freq-row {
                gap: 8px;
            }

            .freq-ball {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }

            .freq-bar-container {
                height: 10px;
            }
        }

        .freq-header {
            background: #80cbc4;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .freq-header .back-btn {
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .freq-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .freq-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 15px;
        }

        .freq-ball {
            width: 32px;
            height: 32px;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .freq-bar-container {
            flex: 1;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .freq-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #444, #777);
            border-radius: 6px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .freq-disclaimer {
            font-size: 11px;
            color: #ff5252;
            margin-top: 5px;
            font-weight: 500;
        }

        .freq-count {
            width: 35px;
            text-align: right;
            font-size: 0.95rem;
            color: #333;
            font-weight: 500;
        }

        .freq-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .freq-filter-row {
            display: flex;
            gap: 15px;
            font-size: 0.95rem;
            color: #1976d2;
            font-weight: 500;
            justify-content: center;
        }

        .freq-filter-item {
            cursor: pointer;
            padding: 2px 5px;
            transition: all 0.2s;
            text-align: center;
        }

        .freq-filter-item.active {
            font-weight: 800;
            border-bottom: 2px solid #1976d2;
        }

        .freq-range-display {
            text-align: center;
            font-size: 1.1rem;
            color: #1976d2;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="sidebar">
            <h1>üé∞ KINOV Lotto Map</h1>
            <div class="section">
                <span class="section-title">üìÖ ÌöåÏ∞® ÌïÑÌÑ∞ (Round)</span>
                <div class="input-row">
                    <input type="number" id="minRound" value="1201">
                    <span>~</span>
                    <input type="number" id="maxRound" value="1210" max="1210"
                        oninput="if(parseInt(this.value) > 1210) this.value = 1210;">
                    <button class="btn-sm" onclick="refreshRecentRounds()">Ï°∞Ìöå</button>
                </div>
                <!-- Data Availability Notice -->
                <div
                    style="font-size:14px; font-weight:bold; color:#d32f2f; margin-top:8px; line-height:1.4; background:rgba(255,0,0,0.05); padding:8px; border-radius:4px; border:1px solid rgba(255,0,0,0.1);">
                    1. 1Îì± ÎãπÏ≤®Î≤àÌò∏Îäî 1ÌöåÏ∞®Î∂ÄÌÑ∞ Ï†úÍ≥µ<br>
                    2. 1Îì± ÌåêÎß§Ï†êÌòÑÌô©ÏùÄ 262ÌöåÏ∞®Î∂ÄÌÑ∞ Ï†úÍ≥µ
                </div>
            </div>

            <!-- Recent 3 Rounds Display -->
            <div class="section" id="recentRoundsContainer"
                style="background:#f0f4f8; padding:10px; border-radius:8px; margin-bottom:20px;">
                <span class="section-title" style="margin-bottom:8px;">üìä ÏµúÍ∑º 3ÌöåÏ∞® ÎãπÏ≤®Î≤àÌò∏ (Í∏∞Ï§Ä: <span id="recentRefRound"
                        style="color:#d32f2f;">1210</span>Ìöå)</span>
                <div id="recentRoundsList" style="display:flex; flex-direction:column; gap:6px;">
                    <!-- Javascript will populate this -->
                    <div style="font-size:12px; color:#666; text-align:center;">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</div>
                </div>
            </div>

            <div class="section">
                <span class="section-title">üèÜ ÎãπÏ≤® ÌöüÏàò ÌïÑÌÑ∞ (Frequency)</span>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="freq5" checked> üåü 5Ìöå Ïù¥ÏÉÅ</label>
                    <label class="checkbox-item"><input type="checkbox" id="freq3" checked> üî¥ 3~4Ìöå</label>
                    <label class="checkbox-item"><input type="checkbox" id="freq1" checked> üîµ 2Ìöå Ïù¥Ìïò</label>
                </div>
            </div>
            <div class="section">
                <span class="section-title">üé≤ ÎãπÏ≤® Î∞©Ïãù (Method)</span>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="methodAuto" checked> ÏûêÎèô</label>
                    <label class="checkbox-item"><input type="checkbox" id="methodManual" checked> ÏàòÎèô</label>
                    <label class="checkbox-item"><input type="checkbox" id="methodSemi" checked> Î∞òÏûêÎèô</label>
                </div>
            </div>
            <button class="btn-apply" onclick="applyFilters()">Ï†ÅÏö©ÌïòÍ∏∞</button>
            <div class="stats-card">
                <div class="stat-item"><span>Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞</span> <span id="totalDataCount">0</span></div>
                <div class="stat-item"><span>ÌïÑÌÑ∞ÎßÅ Í≤∞Í≥º</span> <span id="filteredCount" class="stat-value">0</span>
                </div>

                <!-- Fallback file loader -->
                <div id="manualLoader"
                    style="display:none; margin-top:10px; padding-top:10px; border-top:1px dashed #ccc;">
                    <p style="font-size:11px; color:#666; margin-bottom:5px;">‚ö†Ô∏è ÏûêÎèô Î°úÎìú Ïã§Ìå® Ïãú ÌååÏùºÏùÑ ÏßÅÏ†ë ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.</p>
                    <input type="file" id="fileInput" accept=".json" style="display:none;"
                        onchange="handleFileSelect(event)">
                    <button class="btn-apply" style="background:#333; font-size:12px; padding:8px;"
                        onclick="document.getElementById('fileInput').click()">ÌååÏùº ÏßÅÏ†ë ÏÑ†ÌÉùÌïòÍ∏∞ (lotto_data.json)</button>
                </div>
            </div>
        </div> <!-- end #sidebar -->
        <div id="map">
            <!-- Hamburger Menu Button (Moved inside #map for mobile anchoring) -->
            <div id="menuBtn" class="floating-btn menu-btn" onclick="toggleNav()" title="Î©îÎâ¥ Ïó¥Í∏∞">
                <div class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <!-- QR Quick Button (Focus Frame Icon) -->
            <div id="qrQuickBtn" class="floating-btn qr-quick-btn" onclick="showQRScanner()" title="QRÏΩîÎìú ÎãπÏ≤®ÌôïÏù∏">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                    <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
                    <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
                    <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
                    <line x1="8" y1="12" x2="16" y2="12" stroke-opacity="0.5"></line>
                </svg>
            </div>

            <!-- GPS Button (Moved inside #map for mobile anchoring) -->
            <div class="floating-btn gps-button" onclick="requestMyLocation()" title="ÎÇ¥ ÏúÑÏπò Ï∞æÍ∏∞">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z" />
                </svg>
            </div>

            <!-- Toast Notification Container (Moved inside map for relative alignment) -->
            <div id="toast-container"></div>
        </div>
    </div> <!-- end #app -->

    <!-- Side Navigation Drawer -->
    <div id="sideNavOverlay" class="side-nav-overlay" onclick="closeNav()"></div>
    <div id="sideNav" class="side-nav">
        <div class="side-nav-header">
            <div class="logo">üé∞ KINOV</div>
            <span class="close-nav" onclick="closeNav()">&times;</span>
        </div>

        <div class="side-nav-body">
            <div class="menu-category">ÎãπÏ≤® Ï†ïÎ≥¥</div>
            <div class="menu-item" onclick="showStats()">
                <span class="m-icon">üìä</span>
                <span class="m-text">Î≤àÌò∏Î≥Ñ Ï∂úÌòÑÌöüÏàò</span>
            </div>
            <!-- Nationwide Rankings placeholder if needed later -->

            <div class="menu-category">Ìé∏Ïùò Í∏∞Îä•</div>
            <div class="menu-item" onclick="showQRScanner()">
                <span class="m-icon">üì∑</span>
                <span class="m-text">QRÏΩîÎìú ÎãπÏ≤®ÌôïÏù∏</span>
            </div>
            <div class="menu-item" onclick="requestMyLocation(); closeNav();">
                <span class="m-icon">üìç</span>
                <span class="m-text">ÎÇ¥ Ï£ºÎ≥Ä Î™ÖÎãπ Ï∞æÍ∏∞</span>
            </div>
            <div class="menu-item" onclick="openLastOMR();">
                <span class="m-icon">üìù</span>
                <span class="m-text">Ïù¥Î≤à Ï£º 1Îì±Î≤àÌò∏ OMRÎ°ú<br class="mobile-br"> Î≥¥Í∏∞</span>
            </div>

            <!-- Alert Box for OMR (Hidden by default) -->
            <div id="omrAlertBox"
                style="display:none; margin: 15px 15px 20px 15px; padding: 20px; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); border-radius: 12px; border: 3px solid #ff6b6b; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); animation: pulse-alert 1.5s infinite;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 24px;">‚ö†Ô∏è</span>
                    <div style="flex: 1;">
                        <div
                            style="font-size: 21px; font-weight: bold; color: #d32f2f; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">
                            ÏïåÎ¶º</div>
                        <div style="font-size: 16px; color: #333; font-weight: 600; line-height: 1.4;">ÏßÄÎèÑÏóêÏÑú Ï∂îÏ≤úÎ≤àÌò∏Î•º<br>Î®ºÏ†Ä
                            Î∞õÍ≥† Ïò§ÏÑ∏Ïöî~!!</div>
                    </div>
                </div>
            </div>

            <div class="menu-category">Í∏∞ÌÉÄ</div>
            <div class="menu-item" onclick="shareToKakao()">
                <span class="m-icon">üì¢</span>
                <span class="m-text">ÏπúÍµ¨ÏóêÍ≤å Í≥µÏú†ÌïòÍ∏∞</span>
            </div>
        </div>

        <div class="side-nav-footer">
            &copy; 2026 KINOV. All rights reserved.
        </div>
    </div>

    <div id="adModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="adContent"
                style="width:100%; height:450px; padding:20px; overflow-y:auto; display:flex; flex-direction:column; align-items:center; justify-content:center; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">

                <!-- Mode Selection Menu -->
                <div id="modeSelection" style="width:100%; max-width:400px;">
                    <div style="background:#fae100; color:#3c1e1e; padding:8px 15px; text-align:center; font-weight:bold; cursor:pointer; font-size:14px; border-radius:8px; margin-bottom:15px; box-shadow:0 2px 4px rgba(0,0,0,0.1);"
                        onclick="shareToKakao()">
                        üì¢ Ïπ¥ÌÜ° Í≥µÏú†ÌïòÍ≥† ÎãπÏ≤® ÌôïÎ•† ÎÜíÏù¥Í∏∞ (ÌÅ¥Î¶≠)
                    </div>

                    <!-- AI Analysis System Card -->
                    <div class="ai-system-card">
                        <div class="ai-title">‚ú® AI Î°úÎòê Î∂ÑÏÑù ÏãúÏä§ÌÖú</div>
                        <div class="ai-desc">
                            1,200ÌöåÏ∞® Ïù¥ÏÉÅÏùò Ïó≠ÎåÄ ÎãπÏ≤® Îç∞Ïù¥ÌÑ∞Î•º AIÍ∞Ä Ïã¨Ï∏µ Î∂ÑÏÑùÌïòÏó¨ ÌÜµÍ≥Ñ Í∏∞Î∞ò Ïù∏ÏÇ¨Ïù¥Ìä∏Î•º Ï†úÍ≥µÌï©ÎãàÎã§.
                        </div>
                        <div class="ai-tags">
                            <div class="ai-tag">üìà Ïã§ÏãúÍ∞Ñ Î∂ÑÏÑù</div>
                            <div class="ai-tag">ü™Ñ AI ÏòàÏ∏°</div>
                            <div class="ai-tag">üìä 27Í∞ú Î∂ÑÏÑùÎèÑÍµ¨</div>
                        </div>
                    </div>

                    <h2
                        style="color:white; text-align:center; margin-bottom:15px; font-size:20px; text-shadow:0 1px 2px rgba(0,0,0,0.2);">
                        üîÆ Î≤àÌò∏ ÏÉùÏÑ± Î∞©ÏãùÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî
                    </h2>

                    <div class="selection-menu">
                        <!-- 1. Data Analysis -->
                        <div class="selection-card" onclick="selectAnalysisMode()">
                            <div class="selection-icon">üìä</div>
                            <div class="selection-info">
                                <span class="selection-title">Îç∞Ïù¥ÌÑ∞ Ï†ïÎ∞Ä Î∂ÑÏÑù</span>
                                <span class="selection-desc">Î™ÖÎãπÏùò Í≥ºÍ±∞ ÎãπÏ≤® Ìå®ÌÑ¥ÏùÑ Ï†ïÎ∞Ä Î∂ÑÏÑù</span>
                            </div>
                        </div>

                        <!-- 2. Dream -->
                        <div class="selection-card" onclick="selectDreamMode()">
                            <div class="selection-icon">üåô</div>
                            <div class="selection-info">
                                <span class="selection-title">Íøà Ìï¥Î™Ω Î≤àÌò∏</span>
                                <span class="selection-desc">Ïñ¥Ï†ØÎ∞§ Íøà ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Î≥¥ÏÑ∏Ïöî</span>
                            </div>
                        </div>

                        <!-- 3. Horoscope -->
                        <div class="selection-card" onclick="selectHoroscopeMode()">
                            <div class="selection-icon">üêÖ</div>
                            <div class="selection-info">
                                <span class="selection-title">Ïò§ÎäòÏùò Îù†Î≥Ñ Ïö¥ÏÑ∏</span>
                                <span class="selection-desc">ÎÇòÏùò Îù†Ïóê ÎßûÎäî ÌñâÏö¥Ïùò Ïà´Ïûê</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Animation (Initially Hidden) -->
                <div id="analysisLoading" class="loader-container">
                    <div class="spinner"></div>
                    <h3 style="margin:10px 0; font-size:22px;">Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë...</h3>
                    <p style="font-size:14px; opacity:0.9;">Î™ÖÎãπÏùò Í∏∞Ïö¥ÏùÑ Î™®ÏúºÍ≥† ÏûàÏäµÎãàÎã§</p>
                </div>

                <!-- Placeholders for Step 2 & 3 -->
                <div id="modeDreamInput" class="input-container">
                    <h2 style="color:white; font-size:20px; margin-bottom:15px; text-shadow:0 1px 2px rgba(0,0,0,0.2);">
                        üåô Ïñ¥Ï†ØÎ∞§ Î¨¥Ïä® ÍøàÏùÑ Íæ∏ÏÖ®ÎÇòÏöî?
                    </h2>

                    <div class="dream-tags">
                        <button class="dream-tag" onclick="handleDreamTag('ÎèºÏßÄ')">üê∑ ÎèºÏßÄ</button>
                        <button class="dream-tag" onclick="handleDreamTag('Îò•')">üí© Îò•</button>
                        <button class="dream-tag" onclick="handleDreamTag('Ï°∞ÏÉÅ')">üë¥ Ï°∞ÏÉÅ</button>
                        <button class="dream-tag" onclick="handleDreamTag('Î∂à')">üî• Î∂à</button>
                        <button class="dream-tag" onclick="handleDreamTag('Î¨º')">üíß Î¨º</button>
                        <button class="dream-tag" onclick="handleDreamTag('Î±Ä')">üêç Î±Ä</button>
                    </div>

                    <div class="dream-input-box">
                        <input type="text" id="dreamInput" class="dream-input" placeholder="Í∏∞ÌÉÄ Íøà ÏûÖÎ†• (10Ïûê Ïù¥ÎÇ¥)"
                            maxlength="10">
                        <button class="btn-dream-submit" onclick="handleDreamSubmit()">Í≤∞Í≥ºÎ≥¥Í∏∞</button>
                    </div>

                    <div style="margin-top:20px;">
                        <button class="btn-sm" style="background:rgba(0,0,0,0.3);" onclick="resetToModeSelection()">üîô
                            Îí§Î°úÍ∞ÄÍ∏∞</button>
                    </div>
                </div>
                <div id="modeHoroscopeSelect" class="input-container">
                    <h2 style="color:white; font-size:20px; margin-bottom:15px; text-shadow:0 1px 2px rgba(0,0,0,0.2);">
                        üêÖ ÎãπÏã†Ïùò Îù†Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî
                    </h2>
                    <div class="zodiac-grid">
                        <div class="zodiac-item" onclick="handleZodiacClick('Ï•ê', 'üêπ')"><span
                                class="zodiac-icon">üêπ</span><span class="zodiac-name">Ï•êÎù†</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('ÏÜå', 'üêÆ')"><span
                                class="zodiac-icon">üêÆ</span><span class="zodiac-name">ÏÜåÎù†</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('Ìò∏ÎûëÏù¥', 'üêØ')"><span
                                class="zodiac-icon">üêØ</span><span class="zodiac-name">Î≤îÎù†</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('ÌÜ†ÎÅº', 'üê∞')"><span
                                class="zodiac-icon">üê∞</span><span class="zodiac-name">ÌÜ†ÎÅºÎù†</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('Ïö©', 'üê≤')"><span
                                class="zodiac-icon">üê≤</span><span class="zodiac-name">Ïö©Îù†</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('Î±Ä', 'üêç')"><span
                                class="zodiac-icon">üêç</span><span class="zodiac-name">Î±ÄÎù†</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('Îßê', 'üê¥')"><span
                                class="zodiac-icon">üê¥</span><span class="zodiac-name">ÎßêÎù†</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('Ïñë', 'üêë')"><span
                                class="zodiac-icon">üêë</span><span class="zodiac-name">ÏñëÎù†</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('ÏõêÏà≠Ïù¥', 'üêµ')"><span
                                class="zodiac-icon">üêµ</span><span class="zodiac-name">ÏõêÏà≠Ïù¥Îù†</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('Îã≠', 'üêî')"><span
                                class="zodiac-icon">üêî</span><span class="zodiac-name">Îã≠Îù†</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('Í∞ú', 'üê∂')"><span
                                class="zodiac-icon">üê∂</span><span class="zodiac-name">Í∞úÎù†</span></div>
                        <div class="zodiac-item" onclick="handleZodiacClick('ÎèºÏßÄ', 'üê∑')"><span
                                class="zodiac-icon">üê∑</span><span class="zodiac-name">ÎèºÏßÄÎù†</span></div>
                    </div>

                    <div style="margin-top:20px;">
                        <button class="btn-sm" style="background:rgba(0,0,0,0.3);" onclick="resetToModeSelection()">üîô
                            Îí§Î°úÍ∞ÄÍ∏∞</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="resultContent"
            style="display:none; position:relative; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:40px 20px; max-height:70vh; overflow-y:auto;">
            <span
                style="position:absolute; top:15px; right:20px; color:white; font-size:28px; font-weight:bold; cursor:pointer; z-index:10;"
                onclick="closeModal()">&times;</span>
            <h2 style="color:white; text-shadow:0 2px 4px rgba(0,0,0,0.2);">üéâ Ï∂îÏ≤ú Î≤àÌò∏ ÏÉùÏÑ± ÏôÑÎ£å! üéâ</h2>
            <p id="resultInfoText" style="font-size:13px; color:rgba(255,255,255,0.95); margin-bottom:10px;">
                Ïù¥ Î™ÖÎãπÏùÄ Í≥ºÍ±∞ <strong id="paramHCount" style="color:#fae100;">0</strong>Î≤àÏùò 1Îì±ÏùÑ Î∞∞Ï∂úÌñàÏäµÎãàÎã§.<br>
                (<span id="paramRounds"></span> Îì±)
            </p>
            <div class="lucky-balls" id="luckyBalls">
                <!-- Balls go here -->
            </div>
            <p style="font-size:12px; color:rgba(255,255,255,0.8);">* Ïû¨ÎØ∏Î°úÎßå Î¥êÏ£ºÏÑ∏Ïöî. Í≥ºÎèÑÌïú Íµ¨Îß§Îäî Í∏àÎ¨º!</p>
            <button class="btn-apply btn-navi"
                style="margin-top:10px; background:#fae100; color:#3c1e1e; border:none; padding:12px 30px; border-radius:25px; font-weight:bold; box-shadow:0 4px 12px rgba(0,0,0,0.2);"
                onclick="goToShop()">
                üöó ÏßÄÍ∏à ÎãπÏû• ÏÇ¨Îü¨ Í∞ÄÍ∏∞ (Í∏∏Ï∞æÍ∏∞)
            </button>
            <button class="btn-sm"
                style="display:block; margin:15px auto 0; background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); padding:8px 20px; border-radius:20px; color:white;"
                onclick="closeModal()">
                Îã´Í∏∞
            </button>
        </div> <!-- end info-modal -->
    </div> <!-- end ad-content -->
    <!-- Frequency Statistics Modal -->
    <div id="statModal" class="modal">
        <div class="freq-modal-content">
            <div class="freq-header">
                <div class="back-btn" onclick="closeStatModal()">
                    <span>‚ùÆ</span> Îã´Í∏∞
                </div>
                <div>Î≤àÌò∏Î≥Ñ Ï∂úÌòÑÌöüÏàò <span style="font-size: 10px; opacity: 0.8; vertical-align: middle;">(Î≥¥ÎÑàÏä§ Ï†úÏô∏)</span>
                </div>
                <div style="width: 45px;"></div>
            </div>

            <div class="freq-body">
                <div class="freq-controls">
                    <div class="freq-filter-row">
                        <span class="freq-filter-item active" onclick="setFreqPeriod(0)">Ï†ÑÏ≤¥</span>
                        <span class="freq-filter-item" onclick="setFreqPeriod(10)">ÏµúÍ∑º<br class="mobile-br"> 10Ï£º</span>
                        <span class="freq-filter-item" onclick="setFreqPeriod(5)">ÏµúÍ∑º<br class="mobile-br"> 5Ï£º</span>
                        <span class="freq-filter-item" onclick="setFreqPeriod(3)">ÏµúÍ∑º<br class="mobile-br"> 3Ï£º</span>
                    </div>
                    <div class="freq-range-display" id="freqRangeText">
                        Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...
                    </div>
                </div>
                <div id="freqListContainer">
                    <!-- Data will be injected here -->
                    <div style="padding: 10px; text-align: center; font-size: 12px; color: #666; background: #fffde7;">
                        Î≥µÍ∂åÏùò QR ÏΩîÎìúÎ•º ÌôîÎ©¥Ïóê ÎπÑÏ∂∞Ï£ºÏÑ∏Ïöî.
                    </div>
                </div>
                <div class="freq-disclaimer">
                    * Î≥¥ÎÑàÏä§ Î≤àÌò∏Îäî ÌÜµÍ≥ÑÏóêÏÑú Ï†úÏô∏Îê©ÎãàÎã§.
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Scanner Modal -->
    <div id="qrModal" class="modal">
        <div class="qr-modal-content">
            <span class="modal-close" style="color:#333; z-index:100; padding:10px; right:10px; top:5px;"
                onclick="closeQRScanner()">&times;</span>

            <div id="qr-reader" style="width:100%;"></div>

            <div id="qrResult" class="qr-result-container" style="display:none;">
                <h3 style="margin:0 0 10px 0; color:#333; text-align:center;">
                    Ï†ú <span id="qrRound" style="color:#d32f2f;">0</span>Ìöå ÎãπÏ≤® Í≤∞Í≥º
                </h3>
                <div id="qrGameList">
                    <!-- Javascript will populate this -->
                </div>
                <div style="text-align:center; margin-top:15px;">
                    <button class="btn-sm" onclick="restartQRScanner()">Îã§Ïãú Ïä§Ï∫îÌïòÍ∏∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map, clusterer, allData = [], markers = [];
        let currentInfoWindow = null; // Track the currently open InfoWindow


        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    processLoadedData(data);
                    document.getElementById('manualLoader').style.display = 'none';
                    alert('Îç∞Ïù¥ÌÑ∞Î•º ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∂àÎü¨ÏôîÏäµÎãàÎã§! (' + data.length + 'Í±¥)');
                } catch (err) {
                    alert('ÌååÏùº ÌòïÏãùÏù¥ ÏûòÎ™ªÎêòÏóàÏäµÎãàÎã§: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function processLoadedData(data) {
            allData = data;

            // Calculate win count per shop (Name + Address)
            const shopWins = {};
            data.forEach(item => {
                const key = (item.n || '').trim() + '|' + (item.a || '').trim();
                shopWins[key] = (shopWins[key] || 0) + 1;
            });
            // Attach individual shop win count to each record
            let highWinCount = 0;
            data.forEach(item => {
                const key = (item.n || '').trim() + '|' + (item.a || '').trim();
                item.totalWins = shopWins[key];
                if (item.totalWins >= 5) highWinCount++;
            });
            console.log('Grouped Shops:', Object.keys(shopWins).length);
            console.log('Records with 5+ wins:', highWinCount);

            document.getElementById('totalDataCount').innerText = data.length.toLocaleString();
            if (data.length > 0) {
                const rounds = data.map(d => d.r);
                const maxR = Math.max(...rounds);
                const minR = Math.min(...rounds);
                document.getElementById('maxRound').value = maxR;
                document.getElementById('minRound').value = Math.max(1, maxR - 9);
            }

            applyFilters();

            // Initial load of recent rounds
            const initialMax = parseInt(document.getElementById('maxRound').value) || 1210;
            updateRecentRounds(initialMax);
        }

        window.onload = function () {
            if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
                handleScriptError();
                return;
            }

            const mapContainer = document.getElementById('map');
            const mapOption = { center: new kakao.maps.LatLng(36.2683, 127.6358), level: 12 };
            map = new kakao.maps.Map(mapContainer, mapOption);

            clusterer = new kakao.maps.MarkerClusterer({
                map: map, averageCenter: true, minLevel: 10,
                styles: [{
                    width: '40px', height: '40px', background: 'rgba(211, 47, 47, 0.8)',
                    color: '#fff', textAlign: 'center', lineHeight: '40px',
                    borderRadius: '20px', fontWeight: 'bold'
                }]
            });

            loadData();
        };

        function loadData() {
            const countEl = document.getElementById('totalDataCount');
            console.log('Loading data...');

            Promise.all([
                fetch('lotto_data.json?v=' + Date.now()).then(res => res.json()),
                fetch('lotto_history.json?v=' + Date.now()).then(res => res.json())
            ])
                .then(([lottoData, historyData]) => {
                    window.lottoHistory = historyData; // Global variable
                    processLoadedData(lottoData);
                })
                .catch(err => {
                    console.error('Data load failed:', err);
                    countEl.innerHTML = `<span style="color:red; font-size:11px; cursor:help;" title="${err.message}">Î°úÎìú Ïã§Ìå® (${err.name})</span>`;
                    document.getElementById('manualLoader').style.display = 'block';
                    alert('Îç∞Ïù¥ÌÑ∞ ÌååÏùº Î°úÎìú Ï§ë ÏóêÎü¨Í∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\n' + err.message);
                });
        }

        // --- Advanced Prediction Algorithm ---
        let globalWeights = null; // Calculated once on load
        let lastRecommendedNumbers = null; // Store last recommended numbers for quick OMR access

        function analyzeGlobalHistory() {
            if (globalWeights) return;
            globalWeights = {};
            for (let i = 1; i <= 45; i++) globalWeights[i] = 10; // Base weight

            const history = window.lottoHistory || {};
            const rounds = Object.keys(history).map(Number).sort((a, b) => b - a); // Newest first

            // Recency Weighting: Newer rounds have more influence
            rounds.forEach((r, idx) => {
                const nums = history[String(r)];
                if (!nums) return;

                // Weight decay: Recent 10 rounds get +5, others get +1
                const weightBoost = idx < 10 ? 5 : 1;

                // Only consider main numbers (first 6)
                for (let i = 0; i < 6; i++) {
                    if (nums[i]) globalWeights[nums[i]] += weightBoost;
                }
            });
            console.log("Global Analysis Complete:", globalWeights);
        }

        /**
         * üîÆ Advanced Lucky Number Generator
         * Uses Global Weights + Shop Pattern + Statistical Filters
         */
        function generateLuckyNumbers(storeWins, mode = 'mix') {
            // Ensure global analysis is done
            if (!globalWeights) analyzeGlobalHistory();

            // 1. Clone Global Weights for this session
            const currentWeights = { ...globalWeights };

            // 2. Apply Shop-Specific Weights based on Mode
            // storeWins: [{r: 1000, m: 'ÏûêÎèô'}, ...]
            const history = window.lottoHistory || {};
            let matchCount = 0;

            storeWins.forEach(win => {
                const isAuto = win.m.includes('ÏûêÎèô');
                const isManual = win.m.includes('ÏàòÎèô');

                // Logic: 
                // If mode is 'auto', heavily boost numbers from 'auto' wins.
                // If mode is 'manual', heavily boost numbers from 'manual' wins.
                // If mode is 'mix', boost all.
                let process = false;
                if (mode === 'auto' && isAuto) process = true;
                else if (mode === 'manual' && isManual) process = true;
                else if (mode === 'mix') process = true;

                if (process) {
                    const nums = history[String(win.r)];
                    if (nums) {
                        nums.slice(0, 6).forEach(n => {
                            currentWeights[n] += 50; // Massive boost for shop's winning pattern
                        });
                        matchCount++;
                    }
                }
            });

            // Fallback: If no matches for mode (e.g., asking for Manual but shop only has Auto wins),
            // then analyze ALL wins of this shop to find at least some "Shop Energy".
            if (matchCount === 0 && storeWins.length > 0) {
                storeWins.forEach(win => {
                    const nums = history[String(win.r)];
                    if (nums) {
                        nums.slice(0, 6).forEach(n => {
                            currentWeights[n] += 20; // Moderate boost
                        });
                    }
                });
            }

            // 3. Statistical Filter Loop
            // Try to generate a valid set that meets strict statistical criteria
            let bestSet = null;
            let maxAttempts = 200; // Hard limit

            for (let i = 0; i < maxAttempts; i++) {
                const candidate = drawSet(currentWeights);
                if (validateSet(candidate)) {
                    bestSet = candidate;
                    break;
                }
            }

            // If we failed to find a "perfect" set, just take the last raw one
            if (!bestSet) bestSet = drawSet(currentWeights);

            return {
                numbers: bestSet.sort((a, b) => a - b),
                historyCount: storeWins.length,
                relatedRounds: storeWins.map(w => w.r).slice(0, 5)
            };
        }

        function drawSet(weights) {
            const selected = new Set();
            // Safety copy to modify weights during draft (avoid picking same num)
            // But for simple Weighted Random without replacement, we just check 'has'

            while (selected.size < 6) {
                const n = weightedRandom(weights);
                selected.add(n);
            }
            return Array.from(selected);
        }

        function weightedRandom(weights) {
            let sum = 0;
            for (let i in weights) sum += weights[i];
            let rand = Math.random() * sum;
            for (let i in weights) {
                rand -= weights[i];
                if (rand < 0) return parseInt(i);
            }
            return Math.floor(Math.random() * 45) + 1;
        }

        // --- Probability Booster Filters ---
        function validateSet(numbers) {
            // Sort first
            numbers.sort((a, b) => a - b);

            // 1. Sum Filter: Winning sums usually fall between 100 ~ 175
            const sum = numbers.reduce((a, b) => a + b, 0);
            if (sum < 100 || sum > 175) return false;

            // 2. Odd/Even Ratio: Avoid 6:0 or 0:6. Accept 4:2, 3:3, 2:4
            const odds = numbers.filter(n => n % 2 !== 0).length;
            if (odds < 2 || odds > 4) return false;

            // 3. High/Low Ratio: (1-22) vs (23-45). Avoid 6:0 or 0:6
            const low = numbers.filter(n => n <= 22).length;
            if (low < 2 || low > 4) return false;

            // 4. Consecutive Check: Max 2 consecutive numbers allowed (e.g. 1,2,3 is bad)
            let consecutiveCnt = 0;
            for (let i = 0; i < numbers.length - 1; i++) {
                if (numbers[i] + 1 === numbers[i + 1]) {
                    consecutiveCnt++;
                    // If we have 2 pairs (1-2, 5-6) it's ok, but 1-2-3 (2 consecutives in a row) is rare
                    // Let's strictly disallow 3 consecutive numbers (1,2,3)
                    if (i > 0 && numbers[i - 1] + 1 === numbers[i]) return false;
                }
            }

            // 5. Last Digit Sum (Optimization): Usually ends in 0-9 spread 
            // (Optional, skip for performance)

            return true;
        }

        function applyFilters() {
            const minR = parseInt(document.getElementById('minRound').value) || 0;
            const maxR = parseInt(document.getElementById('maxRound').value) || 9999;
            const auto = document.getElementById('methodAuto').checked;
            const manual = document.getElementById('methodManual').checked;
            const semi = document.getElementById('methodSemi').checked;

            // Frequency Filters
            const f5 = document.getElementById('freq5').checked;
            const f3 = document.getElementById('freq3').checked;
            const f1 = document.getElementById('freq1').checked;

            const filtered = allData.filter(d => {
                const rMatch = d.r >= minR && d.r <= maxR;
                let mMatch = false;
                if (auto && d.m.includes('ÏûêÎèô')) mMatch = true;
                if (manual && d.m.includes('ÏàòÎèô')) mMatch = true;
                if (semi && d.m.includes('Î∞òÏûêÎèô')) mMatch = true;

                let fMatch = false;
                if (f5 && d.totalWins >= 5) fMatch = true;
                if (f3 && d.totalWins >= 3 && d.totalWins <= 4) fMatch = true;
                if (f1 && d.totalWins <= 2) fMatch = true;

                return rMatch && mMatch && fMatch;
            });

            document.getElementById('filteredCount').innerText = filtered.length.toLocaleString();
            updateMarkers(filtered);
            // updateRecentRounds(maxR); // Removed as per user request
        }

        function refreshRecentRounds() {
            const maxR = parseInt(document.getElementById('maxRound').value) || 9999;
            updateRecentRounds(maxR);
        }

        function updateRecentRounds(maxRound) {
            const container = document.getElementById('recentRoundsList');
            const refSpan = document.getElementById('recentRefRound');
            if (refSpan) refSpan.innerText = maxRound;

            if (!container) return;

            container.innerHTML = '';

            // Check if history data is loaded
            if (!window.lottoHistory) {
                container.innerHTML = '<div style="font-size:12px; color:#666; text-align:center;">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</div>';
                return;
            }

            // Loop 3 rounds: maxRound, maxRound-1, maxRound-2 (Reduced to save space)
            for (let i = 0; i < 3; i++) {
                const targetRound = maxRound - i;
                if (targetRound < 1) continue; // No rounds below 1

                const row = document.createElement('div');
                row.className = 'recent-row';

                // Round Number
                const roundNum = document.createElement('span');
                roundNum.className = 'recent-round-num';
                roundNum.innerText = targetRound + 'Ìöå';
                row.appendChild(roundNum);

                // Balls Container
                const ballsDiv = document.createElement('div');
                ballsDiv.style.display = 'flex';
                ballsDiv.style.alignItems = 'center'; // Vertically center items
                ballsDiv.style.gap = '2px';

                // Get Winning Numbers
                // lottoHistory key is string "1210"
                const nums = window.lottoHistory[String(targetRound)];

                if (nums && nums.length > 0) {
                    // Separate Main (6) and Bonus (1)
                    // The 7th number is the bonus number in our JSON structure
                    const mainNums = nums.slice(0, 6).sort((a, b) => a - b);
                    const bonusNum = nums[6];

                    // Render Main Numbers
                    mainNums.forEach(n => {
                        const ball = document.createElement('span');
                        ball.className = 'mini-ball ' + getBallColor(n);
                        ball.innerText = n;
                        ballsDiv.appendChild(ball);
                    });

                    // Render Plus Sign
                    const plusSpan = document.createElement('span');
                    plusSpan.innerText = '+';
                    plusSpan.style.color = '#999';
                    plusSpan.style.fontSize = '12px';
                    plusSpan.style.fontWeight = 'bold';
                    plusSpan.style.margin = '0 2px';
                    ballsDiv.appendChild(plusSpan);

                    // Render Bonus Number
                    const bonusBall = document.createElement('span');
                    bonusBall.className = 'mini-ball ' + getBallColor(bonusNum);
                    bonusBall.innerText = bonusNum;
                    ballsDiv.appendChild(bonusBall);

                } else {
                    const noData = document.createElement('span');
                    noData.style.fontSize = '11px';
                    noData.style.color = '#999';
                    noData.innerText = 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå';
                    ballsDiv.appendChild(noData);
                }

                row.appendChild(ballsDiv);
                container.appendChild(row);
            }
        }

        function updateMarkers(data) {
            clusterer.clear();
            markers.forEach(m => m.setMap(null));
            markers = [];

            // To avoid duplicate markers for the same shop at the same location,
            // we need to group the filtered data by shop (lat, lng, name, address)
            // and then create a single marker for each unique shop.
            const uniqueShops = {};
            data.forEach(d => {
                const key = `${d.lat}_${d.lng}_${d.n}_${d.a}`;
                if (!uniqueShops[key]) {
                    uniqueShops[key] = {
                        n: d.n,
                        a: d.a,
                        lat: d.lat,
                        lng: d.lng,
                        totalWins: d.totalWins, // This is the total wins for the shop
                        rounds: [] // To store individual round details for infowindow
                    };
                }
                uniqueShops[key].rounds.push({ r: d.r, m: d.m });
            });

            Object.values(uniqueShops).forEach(shop => {
                let markerImg = null;
                // Tiered Styles
                if (shop.totalWins >= 5) {
                    // Legendary Gold Star
                    markerImg = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
                        new kakao.maps.Size(24, 35)
                    );
                } else if (shop.totalWins >= 3) {
                    // Professional Red
                    markerImg = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/2018/pc/img/marker_spot.png',
                        new kakao.maps.Size(24, 35),
                        { offset: new kakao.maps.Point(12, 35) }
                    );
                }

                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(shop.lat, shop.lng),
                    image: markerImg
                });
                marker.shopData = shop; // Store shop data for retrieval

                const sortedRounds = shop.rounds.sort((a, b) => b.r - a.r);
                const roundTagsHtml = sortedRounds.map(r => `<span class="iw-tag">${r.r}Ìöå(${r.m})</span>`).join('');

                // Helper to format address for mobile: break after the street number
                const formatAddrForMobile = (addr) => {
                    if (!addr) return "";
                    // Regex: Find the first sequence of digits followed by a space and insert mobile-only BR
                    return addr.replace(/(\d+)\s/, '$1<br class="mobile-br"> ');
                };
                const displayAddr = formatAddrForMobile(shop.a);

                const safeAddr = (shop.a || "").replace(/'/g, "\\'").replace(/\n/g, " ");
                const safeName = (shop.n || "").replace(/'/g, "\\'").replace(/\n/g, " ");

                const content = `
                    <div class="infowindow">
                        <div class="iw-title">${shop.n} ${shop.totalWins >= 5 ? 'üåü' : ''}</div>
                        <div class="iw-addr-box" onclick="copyToClipboard('${safeAddr}')" title="Ï£ºÏÜå Î≥µÏÇ¨">
                            <span class="iw-addr">${displayAddr}</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="#666"><path d="M16 1H4c-1.11 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        </div>
                        <div style="font-weight:bold; color:red; margin-bottom:5px;">Ï¥ù ${shop.totalWins}Ìöå ÎãπÏ≤®</div>
                        <div class="iw-details">${roundTagsHtml}</div>
                        <button class="btn-gold" onclick="openAdModal('${safeName}', '${safeAddr}', ${shop.lat}, ${shop.lng}, ${shop.totalWins})">
                            ‚ú® Ïù¥Î≤à Ï£º 1Îì± Ï∂îÏ≤ú Î≤àÌò∏ Î∞õÍ∏∞
                        </button>
                        <div class="iw-actions">
                            <button class="btn-iw btn-navi" onclick="openDirections(${shop.lat}, ${shop.lng}, '${safeName}')">
                                üöó Í∏∏Ï∞æÍ∏∞
                            </button>
                        </div>
                    </div>
                `;

                const infowindow = new kakao.maps.InfoWindow({
                    content: content,
                    removable: true,
                    zIndex: 1500 // Ensure popup is on top of markers
                });

                kakao.maps.event.addListener(marker, 'click', () => {
                    // Close previous InfoWindow if exists
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }

                    infowindow.open(map, marker);
                    currentInfoWindow = infowindow; // Update current
                });

                markers.push(marker);
            });
            clusterer.addMarkers(markers);
        }

        /**
         * GPS Location Service Module
         * Handles user positioning, nearest shop calculation, and UI feedback (Toasts).
         */
        let myLocationMarker = null;

        function requestMyLocation() {
            if (!navigator.onLine) {
                showToast("üåê Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞Ïù¥ ÎÅäÍ≤® ÏûàÏäµÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨Î•º ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.", "error");
                return;
            }

            if (!navigator.geolocation) {
                showToast("üö´ Ïù¥ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎäî ÏúÑÏπò Ï†ïÎ≥¥Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.", "error");
                return;
            }

            const gpsBtn = document.querySelector('.gps-button');
            if (gpsBtn) gpsBtn.classList.add('loading');

            // GPS Permission & Fetch
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    if (gpsBtn) gpsBtn.classList.remove('loading');
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const center = new kakao.maps.LatLng(lat, lng);

                    map.setCenter(center);

                    // Close all infowindows to clear the view
                    if (typeof clusterer !== 'undefined') {
                        // There's no direct 'closeAll' on clusterer, but we can just let it be
                    }

                    // Add/Update Blue Dot Marker
                    if (!myLocationMarker) {
                        myLocationMarker = new kakao.maps.CustomOverlay({
                            position: center,
                            content: `
                                <div style="position:relative;">
                                    <div class="pulse"></div>
                                    <div style="width:16px; height:16px; background:#1976d2; border:2px solid #fff; border-radius:50%; box-shadow:0 0 10px rgba(0,0,0,0.5); position:relative; z-index:2; transform: translate(-50%, -50%);"></div>
                                </div>
                            `,
                            map: map,
                            zIndex: 1001
                        });
                    } else {
                        myLocationMarker.setPosition(center);
                        myLocationMarker.setMap(map);
                    }

                    findNearestShop(lat, lng);
                },
                (err) => {
                    console.error("GPS Error:", err);
                    if (gpsBtn) gpsBtn.classList.remove('loading');
                    let msg = "ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.";
                    switch (err.code) {
                        case 1:
                            msg = "ÏúÑÏπò Ï†ïÎ≥¥ Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÏúÑÏπò Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥ Ï£ºÏÑ∏Ïöî.";
                            break;
                        case 2:
                            msg = "ÏúÑÏπò Ï†ïÎ≥¥Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§. GPSÍ∞Ä ÏºúÏ†∏ ÏûàÎäîÏßÄ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.";
                            break;
                        case 3:
                            msg = "ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Îäî Îç∞ ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥ Î≥¥ÏÑ∏Ïöî.";
                            break;
                    }
                    showToast(msg, "error");
                },
                { enableHighAccuracy: false, timeout: 15000, maximumAge: 0 }
            );
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // --- Monetization & Logic ---
        let currentShopData = null; // Store temp data for the modal

        function openAdModal(name, addr, lat, lng, totalWins) {
            // Re-filter allData for this specific shop to get rounds.
            const rounds = allData.filter(d => d.n === name && d.a === addr).map(d => ({ r: d.r, m: d.m }));

            currentShopData = { name, addr, lat, lng, totalWins, rounds };

            // Show Modal
            const modal = document.getElementById('adModal');
            const adContent = document.getElementById('adContent');
            const resultContent = document.getElementById('resultContent');

            // Mode Containers
            const modeSelection = document.getElementById('modeSelection');
            const analysisLoading = document.getElementById('analysisLoading');
            const modeDreamInput = document.getElementById('modeDreamInput');
            const modeHoroscopeSelect = document.getElementById('modeHoroscopeSelect');

            modal.style.display = 'flex';
            adContent.style.display = 'flex'; // Changed to flex for centering
            resultContent.style.display = 'none';

            // Reset UI State (CRITICAL: Reset result text structure)
            const resultInfo = document.getElementById('resultInfoText');
            if (resultInfo) {
                resultInfo.innerHTML = `Ïù¥ Î™ÖÎãπÏùÄ Í≥ºÍ±∞ <strong id="paramHCount" style="color:#fae100;">0</strong>Î≤àÏùò 1Îì±ÏùÑ Î∞∞Ï∂úÌñàÏäµÎãàÎã§.<br>
                    (<span id="paramRounds"></span> Îì±)`;
            }

            modeSelection.style.display = 'block';
            if (analysisLoading) analysisLoading.style.display = 'none';
            if (modeDreamInput) modeDreamInput.style.display = 'none';
            if (modeHoroscopeSelect) modeHoroscopeSelect.style.display = 'none';

            // Push history state to support Back Button closing
            history.pushState({ modalOpen: true }, null, "");
        }

        // --- Phase 10: Selection Handlers ---

        function selectAnalysisMode() {
            // Hide selection, show loading
            document.getElementById('modeSelection').style.display = 'none';
            const loader = document.getElementById('analysisLoading');
            if (loader) {
                loader.style.display = 'flex';
                // Reset text if needed
                loader.querySelector('h3').innerText = 'Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë...';
                loader.querySelector('p').innerText = 'Î™ÖÎãπÏùò Í∏∞Ïö¥ÏùÑ Î™®ÏúºÍ≥† ÏûàÏäµÎãàÎã§';
            }

            // Simulate Analysis Delay (3 seconds)
            setTimeout(() => {
                showResult();
            }, 3000);
        }

        function selectDreamMode() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('modeDreamInput').style.display = 'block';
        }

        function resetToModeSelection() {
            document.getElementById('modeDreamInput').style.display = 'none';
            document.getElementById('modeHoroscopeSelect').style.display = 'none';
            document.getElementById('modeSelection').style.display = 'block';
        }

        function handleDreamTag(keyword) {
            document.getElementById('dreamInput').value = keyword;
            handleDreamSubmit();
        }

        function handleDreamSubmit() {
            const input = document.getElementById('dreamInput');
            const keyword = input.value.trim();

            if (!keyword) {
                alert('Íøà ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            // Show loading state
            document.getElementById('modeDreamInput').style.display = 'none';
            const loader = document.getElementById('analysisLoading');
            if (loader) {
                loader.style.display = 'flex';
                loader.querySelector('h3').innerText = 'Íøà Ìï¥Î™Ω Ï§ë...';
                loader.querySelector('p').innerText = 'Íøà ÏÜçÏóê Ïà®Í≤®ÏßÑ ÌñâÏö¥ÏùÑ Ï∞æÍ≥† ÏûàÏäµÎãàÎã§';
            }

            setTimeout(() => {
                const luckyNumbers = generateDreamNumbers(keyword);
                showResult(luckyNumbers);
            }, 2000);
        }

        function generateDreamNumbers(keyword) {
            // 1. Traditional Dream Mappings (Simple Version)
            const dreamMap = {
                'ÎèºÏßÄ': [8, 12, 23, 33, 38, 41],
                'Îò•': [6, 17, 24, 35, 36, 42],
                'Ï°∞ÏÉÅ': [1, 3, 15, 27, 39, 41],
                'Î∂à': [2, 11, 22, 33, 40, 44],
                'Î¨º': [4, 9, 21, 26, 31, 37],
                'Î±Ä': [5, 10, 16, 28, 34, 45],
                'Ïö©': [7, 18, 20, 30, 42, 45]
            };

            // If keyword exists in map, return it (with small variation if needed, but fixed for now)
            if (dreamMap[keyword]) {
                return {
                    numbers: dreamMap[keyword],
                    historyCount: 0, // Not based on history
                    type: 'dream',
                    keyword: keyword
                };
            }

            // 2. Hash-based Generation for unknown keywords
            // This ensures the same keyword always yields the same numbers
            let hash = 0;
            for (let i = 0; i < keyword.length; i++) {
                hash = ((hash << 5) - hash) + keyword.charCodeAt(i);
                hash |= 0; // Convert to 32bit integer
            }

            // Seeding logic using text hash
            const seededRandom = (seed) => {
                var x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            };

            const selected = new Set();
            let seed = Math.abs(hash);

            while (selected.size < 6) {
                const n = Math.floor(seededRandom(seed) * 45) + 1;
                selected.add(n);
                seed++;
            }

            return {
                numbers: Array.from(selected).sort((a, b) => a - b),
                historyCount: 0,
                type: 'dream',
                keyword: keyword
            };
        }

        function selectHoroscopeMode() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('modeHoroscopeSelect').style.display = 'block';
        }

        function handleZodiacClick(zodiacName, icon) {
            // Show loading
            document.getElementById('modeHoroscopeSelect').style.display = 'none';
            const loader = document.getElementById('analysisLoading');
            if (loader) {
                loader.style.display = 'flex';
                loader.querySelector('h3').innerText = 'Ïò§ÎäòÏùò Ïö¥ÏÑ∏ Î∂ÑÏÑù Ï§ë...';
                loader.querySelector('p').innerText = 'Î≥ÑÎì§Ïùò Í∏∞Ïö¥ÏùÑ ÏùΩÍ≥† ÏûàÏäµÎãàÎã§';
            }

            // Simulate and Generate
            setTimeout(() => {
                const horoscopeData = generateHoroscope(zodiacName);
                showResult({
                    type: 'horoscope',
                    zodiac: zodiacName,
                    icon: icon,
                    ...horoscopeData
                });
            }, 2000);
        }

        function generateHoroscope(zodiacName) {
            // Get today's date string YYYY-MM-DD
            const today = new Date().toISOString().split('T')[0];
            const key = today + zodiacName;

            // Generate seeded random based on date + zodiac
            let hash = 0;
            for (let i = 0; i < key.length; i++) {
                hash = ((hash << 5) - hash) + key.charCodeAt(i);
                hash |= 0;
            }
            const seededRandom = (seed) => {
                var x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            };
            let seed = Math.abs(hash);

            // 1. Horoscope Text Pools
            const genFortunes = [
                "Í∏àÍ∏∞(ÈáëÊ∞£)Ïùò ÏòÅÌñ•ÏúºÎ°ú Ïã†Ï§ëÌï®Ïù¥ ÏöîÍµ¨ÎêòÎäî ÌïòÎ£®ÏûÖÎãàÎã§.",
                "Ïò§ÎäòÏùÄ ÎãπÏã†Ïùò ÎÇ†ÏûÖÎãàÎã§. Î¨¥ÏóáÏùÑ Ìï¥ÎèÑ Ïà†Ïà† ÌíÄÎ¶¥ Í≤ÉÏûÖÎãàÎã§.",
                "ÏßÅÍ∞êÏù¥ Îß§Ïö∞ Îõ∞Ïñ¥ÎÇú ÎÇ†ÏûÖÎãàÎã§. ÎãπÏã†Ïùò ÎäêÎÇåÏùÑ ÎØøÏñ¥Î≥¥ÏÑ∏Ïöî.",
                "Í∑ÄÏù∏Ïùò ÎèÑÏõÄÏùÑ Î∞õÏïÑ Ïñ¥Î†§ÏõÄÏù¥ Ìï¥Í≤∞Îê† Í≤ÉÏûÖÎãàÎã§. Í∏çÏ†ïÏ†ÅÏù∏ ÎßàÏùåÏùÑ Í∞ÄÏßÄÏÑ∏Ïöî.",
                "ÌñâÏö¥Ïùò Ïó¨Ïã†Ïù¥ ÎãπÏã†ÏùÑ Î≥¥Í≥† ÎØ∏ÏÜå ÏßìÍ≥† ÏûàÏäµÎãàÎã§.",
                "ÎúªÎ∞ñÏùò ÌñâÏö¥Ïù¥ Ï∞æÏïÑÏò¨ Ïàò ÏûàÏäµÎãàÎã§. Ï£ºÎ≥ÄÏùÑ Ïûò ÏÇ¥Ìé¥Î≥¥ÏÑ∏Ïöî.",
                "Ï∞®Î∂ÑÌïòÍ≤å ÎÇ¥Ïã§ÏùÑ Îã§ÏßÄÎ©¥ Îçî ÌÅ∞ Í∏∞ÌöåÍ∞Ä Ï∞æÏïÑÏò¨ Í≤ÉÏûÖÎãàÎã§.",
                "ÏÉàÎ°úÏö¥ Î≥ÄÌôîÎ•º ÏãúÎèÑÌïòÍ∏∞Ïóê ÏïÑÏ£º Ï†ÅÏ†àÌïú ÏãúÍ∏∞ÏûÖÎãàÎã§."
            ];

            const loveFortunes = [
                "ÎßêÏùò ÌëúÌòÑÏùÑ Ï°∞Ï†àÌïòÏÑ∏Ïöî. Î∞∞Î†§Í∞Ä ÌïÑÏöîÌïú ÏãúÍ∏∞ÏûÖÎãàÎã§.",
                "ÏÜåÏ§ëÌïú ÏÇ¨ÎûåÍ≥º Ï¶êÍ±∞Ïö¥ ÏãúÍ∞ÑÏùÑ Î≥¥ÎÇ¥Í∏∞Ïóê Ï¢ãÏùÄ ÎÇ†ÏûÖÎãàÎã§.",
                "ÏÜîÏßÅÌïú Í∞êÏ†ï ÌëúÌòÑÏù¥ ÏÉÅÎåÄÎ∞©Ïùò ÎßàÏùåÏùÑ ÏõÄÏßÅÏùº Í≤ÉÏûÖÎãàÎã§.",
                "ÏûëÏùÄ Ïò§Ìï¥Í∞Ä ÏÉùÍ∏∏ Ïàò ÏûàÏúºÎãà Ï∂©Î∂ÑÌïú ÎåÄÌôîÎ•º ÎÇòÎàÑÏÑ∏Ïöî.",
                "ÏÉàÎ°úÏö¥ Ïù∏Ïó∞Ïù¥ ÎÇòÌÉÄÎÇ† Ïàò ÏûàÎäî Í∏∞Ïö¥Ïù¥ Í∞ïÌï©ÎãàÎã§.",
                "ÏÑúÎ°úÏóê ÎåÄÌïú Ïã†Î¢∞Í∞Ä ÍπäÏñ¥ÏßÄÎäî Îî∞ÎúªÌïú ÌïòÎ£®Í∞Ä Îê† Í≤ÉÏûÖÎãàÎã§.",
                "ÎãπÏã†Ïùò Îß§Î†•Ïù¥ ÎèãÎ≥¥Ïù¥Îäî ÎÇ†ÏûÖÎãàÎã§. ÏûêÏã†Í∞êÏùÑ Í∞ÄÏßÄÏÑ∏Ïöî.",
                "Í∞ÄÍπåÏö¥ ÏÇ¨ÎûåÍ≥ºÏùò Í∞àÎì±ÏùÄ Î®ºÏ†Ä ÏÜêÏùÑ ÎÇ¥ÎØ∏Îäî Í≤ÉÏù¥ Ï¢ãÏäµÎãàÎã§."
            ];

            const moneyFortunes = [
                "ÏòàÏÉÅÏπò Î™ªÌïú ÏßÄÏ∂úÏóê ÎåÄÎπÑÌïòÏÑ∏Ïöî. Ïã†Ï§ëÌïú ÏÜåÎπÑÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.",
                "Í∏àÏ†ÑÏö¥Ïù¥ Îß§Ïö∞ Ï¢ãÏäµÎãàÎã§. ÏûëÏùÄ Ìà¨ÏûêÎèÑ Í≤∞Ïã§ÏùÑ Îß∫ÏùÑ Ïàò ÏûàÏäµÎãàÎã§.",
                "Ïû¨Î¨ºÏö¥Ïù¥ ÏÉÅÏäπÌïòÎäî ÏãúÍ∏∞ÏûÖÎãàÎã§. Î°úÎòê Íµ¨Îß§ÌïòÍ∏∞ Îî± Ï¢ãÏùÄ ÎÇ†!",
                "ÏßÄÍ∞ë Í¥ÄÎ¶¨Ïóê Ïã†Í≤Ω Ïç®Ïïº ÌïòÎäî ÌïòÎ£®ÏûÖÎãàÎã§. Ï∂©ÎèôÍµ¨Îß§Î•º Ï£ºÏùòÌïòÏÑ∏Ïöî.",
                "ÏÉùÍ∞ÅÏßÄ Î™ªÌïú Í≥≥ÏóêÏÑú ÏûëÏùÄ ÏàòÏùµÏù¥ Î∞úÏÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.",
                "Í≥ÑÌöçÏ†ÅÏù∏ ÏÜåÎπÑÍ∞Ä ÎãπÏã†ÏóêÍ≤å Îçî ÌÅ∞ ÌñâÏö¥ÏùÑ Î∂àÎü¨Ïò¨ Í≤ÉÏûÖÎãàÎã§.",
                "Í∏àÏ†ÑÏ†ÅÏù∏ Ïù¥ÎìùÎ≥¥Îã§Îäî Ïù∏Îß•ÏùÑ ÏåìÎäî Í≤ÉÏù¥ Ïû•Í∏∞Ï†ÅÏúºÎ°ú Ïú†Î¶¨Ìï©ÎãàÎã§.",
                "ÎøåÎ¶∞ ÎåÄÎ°ú Í±∞ÎëêÎäî ÎÇ†ÏûÖÎãàÎã§. ÏÑ±Ïã§Ìï®Ïù¥ Î≥¥ÏÉÅÏúºÎ°ú ÎèåÏïÑÏòµÎãàÎã§."
            ];

            const luckyColors = ["Îπ®Í∞ï", "ÌååÎûë", "ÎÖ∏Îûë", "Ï¥àÎ°ù", "Î≥¥Îùº", "Í∏àÏÉâ", "ÏùÄÏÉâ", "Ìù∞ÏÉâ", "Í≤ÄÏ†ï", "Ï£ºÌô©"];

            const genIdx = Math.floor(seededRandom(seed) * genFortunes.length);
            const loveIdx = Math.floor(seededRandom(seed + 1) * loveFortunes.length);
            const moneyIdx = Math.floor(seededRandom(seed + 2) * moneyFortunes.length);
            const colorIdx = Math.floor(seededRandom(seed + 3) * luckyColors.length);

            const text = `
                <div style="text-align:left; margin: 0 auto; max-width:280px; line-height:1.8; font-size:14px;">
                    ‚Ä¢ <b>Ï¢ÖÌï©Ïö¥</b> : ${genFortunes[genIdx]}<br>
                    ‚Ä¢ <b>Ïï†Ï†ïÏö¥</b> : ${loveFortunes[loveIdx]}<br>
                    ‚Ä¢ <b>Í∏àÏ†ÑÏö¥</b> : ${moneyFortunes[moneyIdx]}<br>
                    ‚Ä¢ <b>ÌñâÏö¥Ïùò ÏÉâÏÉÅ</b> : ${luckyColors[colorIdx]}
                </div>
            `;

            // 2. Number Generation
            const selected = new Set();
            let numSeed = seed + 100;
            while (selected.size < 6) {
                const n = Math.floor(seededRandom(numSeed) * 45) + 1;
                selected.add(n);
                numSeed++;
            }

            return {
                text: text,
                numbers: Array.from(selected).sort((a, b) => a - b),
                historyCount: 0
            };
        }

        function closeModal() {
            // If the modal is open, going back will trigger popstate which closes it effectively
            // But we need to check if we are actually in the modal state
            if (document.getElementById('adModal').style.display === 'flex') {
                history.back();
            }
        }

        function _internalCloseModal() {
            document.getElementById('adModal').style.display = 'none';
        }

        function showResult(customResult = null) {
            document.getElementById('adContent').style.display = 'none';
            document.getElementById('resultContent').style.display = 'block';

            // Legal Disclaimer
            const legalDiv = document.getElementById('legalDisclaimer');
            if (!legalDiv) {
                const legal = document.createElement('div');
                legal.id = 'legalDisclaimer';
                legal.style.cssText = "font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 15px; text-align: center; line-height: 1.4;";
                legal.innerHTML = "‚Äª Î≥∏ ÏÑúÎπÑÏä§Îäî ÎèôÌñâÎ≥µÍ∂åÏùò ÎãπÏ≤® Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Î∞òÏúºÎ°ú ÌÜµÍ≥ÑÏ†Å/ÏûÑÏùòÏ†Å Î∂ÑÏÑùÏùÑ Ï†úÍ≥µÌïòÎ©∞, ÎãπÏ≤®ÏùÑ Î≥¥Ïû•ÌïòÏßÄ ÏïäÏäµÎãàÎã§.<br>Í≥ºÎèÑÌïú Î≥µÍ∂å Íµ¨Îß§Îäî ÎèÑÎ∞ï Ï§ëÎèÖÏùÑ Ïú†Î∞úÌï† Ïàò ÏûàÏäµÎãàÎã§.";
                document.getElementById('resultContent').appendChild(legal);
            }

            const ballContainer = document.getElementById('luckyBalls');
            ballContainer.innerHTML = '';

            // Reset container styles
            ballContainer.style.flexDirection = 'column';
            ballContainer.style.gap = '15px';

            if (customResult) {
                // --- Dream / Horoscope Mode (Single Row) ---
                if (customResult.type === 'dream') {
                    const container = document.getElementById('resultInfoText');
                    if (container) {
                        container.innerHTML =
                            `Íøà ÌÇ§ÏõåÎìú <strong style="color:#fae100;">'${customResult.keyword}'</strong>(Ïúº)Î°ú<br>Î∂ÑÏÑùÎêú ÌñâÏö¥Ïùò Î≤àÌò∏ÏûÖÎãàÎã§.`;
                    }
                } else if (customResult.type === 'horoscope') {
                    const container = document.getElementById('resultInfoText');
                    if (container) {
                        container.innerHTML =
                            `<div class="horoscope-text-box">
                                <div style="font-size:24px; margin-bottom:5px;">${customResult.icon}</div>
                                <div style="font-weight:bold; font-size:16px; margin-bottom:10px; color:#fae100;">${customResult.zodiac}Îù† Ïò§ÎäòÏùò Ïö¥ÏÑ∏</div>
                                ${customResult.text}
                            </div>
                            <div style="font-size:13px; color:rgba(255,255,255,0.8);">ÏúÑ Ïö¥ÏÑ∏Ïóê Í∏∞Î∞òÌïú ÌñâÏö¥Ïùò Î≤àÌò∏ÏûÖÎãàÎã§.</div>`;
                    }
                }


                // Render with Copy/OMR buttons using createRow helper
                const createRowForCustom = (numbers) => {
                    const mainContainer = document.createElement('div');
                    mainContainer.style.display = 'flex';
                    mainContainer.style.flexDirection = 'column';
                    mainContainer.style.alignItems = 'center';
                    mainContainer.style.width = '100%';

                    const rowWrapper = document.createElement('div');
                    rowWrapper.style.display = 'flex';
                    rowWrapper.style.alignItems = 'center';
                    rowWrapper.style.justifyContent = 'center';
                    rowWrapper.style.gap = '15px';
                    rowWrapper.style.width = '100%';

                    // Balls
                    const ballsRow = document.createElement('div');
                    ballsRow.style.display = 'flex';
                    ballsRow.style.justifyContent = 'center';
                    ballsRow.style.gap = '5px';
                    ballsRow.style.flex = '1';

                    numbers.forEach(n => {
                        const ball = document.createElement('div');
                        ball.className = 'ball ' + getBallColor(n);
                        ball.innerText = n;
                        ballsRow.appendChild(ball);
                    });
                    rowWrapper.appendChild(ballsRow);

                    // Buttons Column
                    const buttonsCol = document.createElement('div');
                    buttonsCol.style.display = 'flex';
                    buttonsCol.style.flexDirection = 'column';
                    buttonsCol.style.gap = '5px';
                    buttonsCol.style.minWidth = '90px';

                    // Copy Button
                    const copyBtn = document.createElement('div');
                    copyBtn.className = 'omr-action-btn';
                    copyBtn.innerHTML = 'üìã Î≥µÏÇ¨';
                    copyBtn.style.justifyContent = 'center';
                    copyBtn.onclick = (e) => {
                        e.stopPropagation();
                        copyToClipboard(numbers);
                    };
                    buttonsCol.appendChild(copyBtn);

                    // OMR Button
                    const omrBtn = document.createElement('div');
                    omrBtn.className = 'omr-action-btn';
                    omrBtn.innerHTML = 'üìù OMR Î≥¥Í∏∞';
                    omrBtn.style.justifyContent = 'center';
                    omrBtn.onclick = (e) => {
                        e.stopPropagation();
                        openOMR(numbers);
                    };
                    buttonsCol.appendChild(omrBtn);

                    rowWrapper.appendChild(buttonsCol);
                    mainContainer.appendChild(rowWrapper);
                    return mainContainer;
                };

                ballContainer.appendChild(createRowForCustom(customResult.numbers));

                // Store last recommended numbers for quick OMR access
                lastRecommendedNumbers = customResult.numbers;

            } else {
                // --- Standard Analysis Mode (Auto + Manual) ---
                // Generate two sets with specific modes
                const resultAuto = generateLuckyNumbers(currentShopData.rounds, 'auto');
                const resultManual = generateLuckyNumbers(currentShopData.rounds, 'manual');

                // Update Info Text (Shared stats)
                const container = document.getElementById('resultInfoText');
                if (container) {
                    container.innerHTML =
                        `Ïù¥ Î™ÖÎãπÏùÄ Í≥ºÍ±∞ <strong id="paramHCount" style="color:#fae100;">${resultAuto.historyCount}</strong>Î≤àÏùò 1Îì±ÏùÑ Î∞∞Ï∂úÌñàÏäµÎãàÎã§.<br>` +
                        `(<span id="paramRounds">${resultAuto.relatedRounds.join(', ') + (resultAuto.historyCount > 5 ? '...' : '')}</span> Îì±)`;
                }

                // Helper to create a unified row component
                const createRow = (label, numbers, isManual = false) => {
                    // Main Container (Vertical stack for Row + Optional Link)
                    const mainContainer = document.createElement('div');
                    mainContainer.style.display = 'flex';
                    mainContainer.style.flexDirection = 'column';
                    mainContainer.style.alignItems = 'center';
                    mainContainer.style.width = '100%';
                    mainContainer.style.marginBottom = '15px';

                    // Row (Label + Balls + Buttons)
                    const rowWrapper = document.createElement('div');
                    rowWrapper.style.display = 'flex';
                    rowWrapper.style.alignItems = 'center';
                    rowWrapper.style.justifyContent = 'center';
                    rowWrapper.style.gap = '15px';
                    rowWrapper.style.width = '100%';

                    // Label
                    const labelDiv = document.createElement('div');
                    labelDiv.innerHTML = `<span style="color:#fae100; font-weight:bold; font-size:16px;">[${label}]</span>`;
                    labelDiv.style.minWidth = '50px';
                    rowWrapper.appendChild(labelDiv);

                    // Balls
                    const ballsRow = document.createElement('div');
                    ballsRow.style.display = 'flex';
                    ballsRow.style.justifyContent = 'center';
                    ballsRow.style.gap = '5px';
                    ballsRow.style.flex = '1';

                    numbers.forEach(n => {
                        const ball = document.createElement('div');
                        ball.className = 'ball ' + getBallColor(n);
                        ball.innerText = n;
                        ballsRow.appendChild(ball);
                    });
                    rowWrapper.appendChild(ballsRow);

                    // Buttons Column (Copy / OMR stacked vertically)
                    const buttonsCol = document.createElement('div');
                    buttonsCol.style.display = 'flex';
                    buttonsCol.style.flexDirection = 'column';
                    buttonsCol.style.gap = '5px';
                    buttonsCol.style.minWidth = '90px';

                    // Copy Button
                    const copyBtn = document.createElement('div');
                    copyBtn.className = 'omr-action-btn';
                    copyBtn.innerHTML = 'üìã Î≥µÏÇ¨';
                    copyBtn.style.justifyContent = 'center';
                    copyBtn.onclick = (e) => {
                        e.stopPropagation();
                        copyToClipboard(numbers);
                    };
                    buttonsCol.appendChild(copyBtn);

                    // OMR Button
                    const omrBtn = document.createElement('div');
                    omrBtn.className = 'omr-action-btn';
                    omrBtn.innerHTML = 'üìù OMR Î≥¥Í∏∞';
                    omrBtn.style.justifyContent = 'center';
                    omrBtn.onclick = (e) => {
                        e.stopPropagation();
                        openOMR(numbers);
                    };
                    buttonsCol.appendChild(omrBtn);

                    rowWrapper.appendChild(buttonsCol);
                    mainContainer.appendChild(rowWrapper);

                    // Link for Manual
                    if (isManual) {
                        const linkBtn = document.createElement('div');
                        linkBtn.innerHTML = 'üìä Î≤àÌò∏Î≥Ñ Ï∂úÌòÑ ÌöüÏàò Ï∞∏Í≥†ÌïòÍ∏∞ >';
                        linkBtn.style.color = '#fae100';
                        linkBtn.style.fontSize = '12px';
                        linkBtn.style.marginTop = '5px';
                        linkBtn.style.cursor = 'pointer';
                        linkBtn.style.textDecoration = 'underline';
                        linkBtn.style.opacity = '1';
                        linkBtn.onclick = (e) => {
                            e.stopPropagation();
                            showStats();
                        };
                        mainContainer.appendChild(linkBtn);
                    }

                    return mainContainer;
                };

                ballContainer.appendChild(createRow('ÏûêÎèô', resultAuto.numbers));
                ballContainer.appendChild(createRow('ÏàòÎèô', resultManual.numbers, true));

                // Store last recommended numbers (Auto mode) for quick OMR access
                lastRecommendedNumbers = resultAuto.numbers;
            }
        }

        function getBallColor(n) {
            if (n <= 10) return 'one';
            if (n <= 20) return 'two';
            if (n <= 30) return 'three';
            if (n <= 40) return 'four';
            return 'five';
        }

        function goToShop() {
            if (!currentShopData) return;
            openDirections(currentShopData.lat, currentShopData.lng, currentShopData.name);
            closeModal();
        }

        // --- Side Nav Controls ---
        function toggleNav() {
            const nav = document.getElementById('sideNav');
            const overlay = document.getElementById('sideNavOverlay');
            const btn = document.getElementById('menuBtn');
            const isOpen = nav.classList.contains('open');

            if (isOpen) {
                closeNav();
            } else {
                nav.classList.add('open');
                overlay.style.display = 'block';
                setTimeout(() => overlay.classList.add('show'), 10);
                btn.classList.add('active');
            }
        }

        function closeNav() {
            const nav = document.getElementById('sideNav');
            const overlay = document.getElementById('sideNavOverlay');
            const btn = document.getElementById('menuBtn');

            nav.classList.remove('open');
            overlay.classList.remove('show');
            setTimeout(() => {
                if (!nav.classList.contains('open')) {
                    overlay.style.display = 'none';
                }
            }, 300);
            btn.classList.remove('active');
        }

        let currentFreqPeriod = 0; // 0 for All, N for last N weeks

        function showStats() {
            closeNav();
            const modal = document.getElementById('statModal');
            modal.style.display = 'flex';
            currentFreqPeriod = 0; // Reset to All
            updateFreqFilterUI();
            renderFrequencyStats();
        }

        function closeStatModal() {
            document.getElementById('statModal').style.display = 'none';
        }

        function setFreqPeriod(period) {
            currentFreqPeriod = period;
            updateFreqFilterUI();
            renderFrequencyStats();
        }

        function updateFreqFilterUI() {
            const items = document.querySelectorAll('.freq-filter-item');
            items.forEach(item => {
                const onclickStr = item.getAttribute('onclick');
                const p = parseInt(onclickStr.match(/\d+/)[0]);
                if (p === currentFreqPeriod) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function renderFrequencyStats() {
            const container = document.getElementById('freqListContainer');
            const rangeText = document.getElementById('freqRangeText');
            if (!window.lottoHistory) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:red;">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }

            // Get sorted rounds
            const rounds = Object.keys(window.lottoHistory).map(Number).sort((a, b) => b - a);
            const totalRoundsAvailable = rounds.length;
            const maxR = rounds[0];

            let targetRounds = rounds;
            let minR = rounds[rounds.length - 1];

            if (currentFreqPeriod > 0) {
                targetRounds = rounds.slice(0, currentFreqPeriod);
                minR = targetRounds[targetRounds.length - 1];
            }

            rangeText.innerText = `${minR}Ìöå ~ ${maxR}Ìöå`;

            // 1. Calculate frequencies for the selected range (1-45)
            const counts = {};
            for (let i = 1; i <= 45; i++) counts[i] = 0;

            targetRounds.forEach(r => {
                const nums = window.lottoHistory[r.toString()];
                nums.forEach(n => {
                    if (counts[n] !== undefined) counts[n]++;
                });
            });

            // 2. Convert to array and sort by frequency (descending)
            const sorted = Object.keys(counts).map(num => ({
                num: parseInt(num),
                count: counts[num]
            })).sort((a, b) => b.count - a.count || a.num - b.num);

            const maxCount = sorted.length > 0 ? sorted[0].count : 0;

            // 3. Render
            let html = '';
            sorted.forEach((item, index) => {
                const percentage = maxCount > 0 ? (item.count / maxCount) * 100 : 0;
                const paddedNum = item.num < 10 ? '0' + item.num : item.num;
                html += `
                    <div class="freq-row">
                        <div class="freq-ball">${paddedNum}</div>
                        <div class="freq-bar-container">
                            <div class="freq-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="freq-count">${item.count}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        let html5QrCode = null;

        function showQRScanner() {
            closeNav();
            const modal = document.getElementById('qrModal');
            modal.style.display = 'flex';

            // Reset Result
            document.getElementById('qrResult').style.display = 'none';
            document.getElementById('qr-reader').style.display = 'block';

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            // Start Camera (Prefer Environment)
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    console.error("Error starting QR scanner", err);
                    alert("Ïπ¥Î©îÎùºÎ•º Ïã§ÌñâÌï† Ïàò ÏóÜÏäµÎãàÎã§. Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.\n" + err);
                    // Return to hamburger menu on permission denial or error
                    closeQRScanner();
                });
        }

        function closeQRScanner() {
            const modal = document.getElementById('qrModal');
            modal.style.display = 'none';

            if (html5QrCode) {
                if (html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        html5QrCode.clear();
                        html5QrCode = null;
                        // Return to hamburger menu
                        toggleNav();
                    }).catch(err => {
                        console.log("Failed to stop qr code scanner", err);
                        toggleNav();
                    });
                } else {
                    html5QrCode.clear();
                    html5QrCode = null;
                    toggleNav();
                }
            } else {
                toggleNav();
            }
        }

        function restartQRScanner() {
            // Simply call showQRScanner to reuse the initialization logic
            // But we need to ensure previous instance is cleaned up if it exists in weird state?
            // Usually onScanSuccess cleans it up.
            showQRScanner();
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`);
            if (decodedText.includes('dhlottery.co.kr') && decodedText.includes('v=')) {
                // Stop scanning
                if (html5QrCode) {
                    html5QrCode.stop().then(() => {
                        html5QrCode.clear();
                        html5QrCode = null; // Destroy instance to force fresh start next time
                        document.getElementById('qr-reader').style.display = 'none';
                        verifyLotteryQR(decodedText);
                    }).catch(err => console.error(err));
                }
            } else {
                // Continuous scanning...
            }
        }

        function verifyLotteryQR(url) {
            try {
                const urlObj = new URL(url);
                const v = urlObj.searchParams.get('v');
                if (!v) throw new Error("QR Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïã§Ìå® (v param missing)");

                // Format: ROUND + 'm' + NUMBERS...
                const parts = v.split('m');
                const round = parseInt(parts[0]);
                const rawNumbers = parts[1];

                document.getElementById('qrRound').innerText = round;

                // Get winning numbers
                const winNums = window.lottoHistory ? window.lottoHistory[String(round)] : null;
                const resultArea = document.getElementById('qrResult');
                resultArea.style.display = 'block';

                const listContainer = document.getElementById('qrGameList');
                listContainer.innerHTML = '';

                if (!winNums) {
                    listContainer.innerHTML = `<div style="padding:20px; text-align:center;">
                        ${round}ÌöåÏ∞® Ï∂îÏ≤® Í≤∞Í≥ºÍ∞Ä ÏïÑÏßÅ ÏóÜÏäµÎãàÎã§.<br>
                        (ÌÜ†ÏöîÏùº Ïò§ÌõÑ 8Ïãú 35Î∂Ñ Ïù¥ÌõÑ ÌôïÏù∏ Í∞ÄÎä•)
                    </div>`;
                    return;
                }

                // winNums: [n1, n2, n3, n4, n5, n6, bonus]
                const mainNums = winNums.slice(0, 6);
                const bonusNum = winNums[6];

                // Parse games
                const games = [];
                // rawNumbers string contains concatenated games.
                // It 'usually' splits by 'n' or other delimiters in older formats?
                // But the snippet saw `v.split('m')` logic.
                // Let's rely on fixed width 12 chars per game logic if possible, 
                // but safeguard against delimiters.
                // Removing non-digit characters is safer.
                const cleanNums = rawNumbers.replace(/[^0-9]/g, '');

                for (let i = 0; i < cleanNums.length; i += 12) {
                    const gameStr = cleanNums.substring(i, i + 12);
                    if (gameStr.length < 12) break;

                    const nums = [];
                    for (let j = 0; j < 12; j += 2) {
                        nums.push(parseInt(gameStr.substring(j, j + 2)));
                    }
                    games.push(nums);
                }

                const gameLabels = ['A', 'B', 'C', 'D', 'E'];

                games.forEach((myNums, idx) => {
                    let matchCount = 0;
                    let bonusMatch = false;

                    myNums.forEach(n => {
                        if (mainNums.includes(n)) matchCount++;
                        if (n === bonusNum) bonusMatch = true;
                    });

                    let rank = "ÎÇôÏ≤®";
                    let rankClass = "prize-none";

                    if (matchCount === 6) { rank = "1Îì± ü•á"; rankClass = "prize-win"; }
                    else if (matchCount === 5 && bonusMatch) { rank = "2Îì± ü•à"; rankClass = "prize-win"; }
                    else if (matchCount === 5) { rank = "3Îì± ü•â"; rankClass = "prize-win"; }
                    else if (matchCount === 4) { rank = "4Îì± üíµ"; rankClass = "prize-win"; }
                    else if (matchCount === 3) { rank = "5Îì± üí∞"; rankClass = "prize-win"; }

                    // Render
                    const row = document.createElement('div');
                    row.className = 'qr-game-row';

                    const ballsHtml = myNums.map(n => {
                        let style = "display:inline-block; width:20px; text-align:center;";
                        let color = "#333";
                        let weight = "normal";

                        if (mainNums.includes(n)) {
                            color = "#d32f2f"; weight = "bold";
                        } else if (n === bonusNum && matchCount === 5) {
                            color = "#1976d2"; weight = "bold"; // Bonus highlight
                        }

                        return `<span style="${style} color:${color}; font-weight:${weight};">${n}</span>`;
                    }).join('');

                    row.innerHTML = `
                        <div style="font-weight:bold; color:#666; width:20px;">${gameLabels[idx] || '?'}</div>
                        <div style="flex:1; display:flex; justify-content:center; gap:2px; font-size:13px;">
                            ${ballsHtml}
                        </div>
                        <div class="qr-prize-badge ${rankClass}">${rank}</div>
                    `;
                    listContainer.appendChild(row);
                });

            } catch (e) {
                console.error(e);
                alert("QR ÏΩîÎìúÎ•º Î∂ÑÏÑùÌï† Ïàò ÏóÜÏäµÎãàÎã§. " + e.message);
                restartQRScanner();
            }
        }

        // Close modal when clicking outside (click + touchstart for mobile)
        const handleBackdropClick = (event) => {
            const adModal = document.getElementById('adModal');
            const statModal = document.getElementById('statModal');
            const qrModal = document.getElementById('qrModal');
            if (event.target === adModal) {
                closeModal();
            }
            if (event.target === statModal) {
                closeStatModal();
            }
            if (event.target === qrModal) {
                closeQRScanner();
            }
        };

        window.addEventListener('click', handleBackdropClick);
        window.addEventListener('touchstart', handleBackdropClick, { passive: true });

        // Handle Back Button
        window.addEventListener('popstate', function (event) {
            // When history changes (Back pressed), we close the modal UI
            // Check if modal is currently visible
            const modal = document.getElementById('adModal');
            if (modal && modal.style.display === 'flex') {
                _internalCloseModal();
            }
        });



        function focusShop(lat, lng) {
            console.log('Focusing shop:', lat, lng);
            // Find marker by coordinates (approximate match to handle float precision)
            const target = markers.find(m => {
                const p = m.getPosition();
                return Math.abs(p.getLat() - lat) < 0.0001 && Math.abs(p.getLng() - lng) < 0.0001;
            });

            if (target) {
                // Zoom in to resolve clusters and ensure marker is visible
                if (map.getLevel() > 5) {
                    map.setLevel(3);
                }
                const mapCenter = new kakao.maps.LatLng(lat, lng);
                map.panTo(mapCenter);

                // Trigger click to open InfoWindow (Wait a bit for pan to finish for better UI)
                setTimeout(() => {
                    kakao.maps.event.trigger(target, 'click');
                }, 300);
            } else {
                console.warn('Marker not found for:', lat, lng);
                showToast("ÌòÑÏû¨ Ï°∞Í±¥(ÌöåÏ∞® ÌïÑÌÑ∞ Îì±)Ïóê ÎßûÎäî ÌåêÎß§Ï†ê ÎßàÏª§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.", "info");
            }
        }

        function findNearestShop(lat, lng) {
            // Find nearest among ACTIVE markers (filtered ones on the map)
            if (!markers || markers.length === 0) {
                showToast("ÌòÑÏû¨ ÌïÑÌÑ∞ Ï°∞Í±¥Ïóê Î∂ÄÌï©ÌïòÎäî ÌåêÎß§Ï†êÏù¥ ÏßÄÎèÑÏóê ÏóÜÏäµÎãàÎã§.", "info");
                return;
            }

            // Sort all markers by distance
            const sortedByDist = markers.map(m => {
                const p = m.getPosition();
                return {
                    marker: m,
                    distance: getDistance(lat, lng, p.getLat(), p.getLng())
                };
            }).sort((a, b) => a.distance - b.distance);

            // Take top 3 (top 2 on mobile to prevent overlap)
            const isMobile = window.innerWidth <= 768;
            const topCount = isMobile ? 2 : 3;
            const topShops = sortedByDist.slice(0, topCount);
            11: 58 PM
            if (topShops.length > 0) {
                let msg = "üìç <strong style=\"white-space: nowrap;\">Ï£ºÎ≥Ä 1Îì±Ï†ê</strong> <br class=\"mobile-br\"> <strong>(Í∞ÄÍπåÏö¥ Ïàú)</strong><br>";
                topShops.forEach((item, index) => {
                    const shop = item.marker.shopData;
                    const distStr = item.distance < 1 ? Math.round(item.distance * 1000) + "m" : item.distance.toFixed(1) + "km";
                    // Add clickable span
                    msg += `<div onclick="focusShop(${shop.lat}, ${shop.lng})" style="cursor:pointer; padding:2px 0; text-decoration:underline;">${index + 1}. ${shop.n} (${distStr})</div>`;
                });
                showToast(msg, "success", true); // Pass true to make it persistent

                // Adaptive Zoom: Fit my location and top nearest shops
                const bounds = new kakao.maps.LatLngBounds();
                bounds.extend(new kakao.maps.LatLng(lat, lng));

                topShops.forEach(item => {
                    if (item.distance < 10) { // Only include within 10km for bounds
                        bounds.extend(item.marker.getPosition());
                    }
                });

                const bottomPad = isMobile ? 180 : 40;
                map.setBounds(bounds, 40, 40, bottomPad, 40);
            }
        }

        function showToast(message, type = "info", persistent = false) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            // Contents
            const content = document.createElement('div');
            content.innerHTML = message;
            toast.appendChild(content);

            // Close Button
            const closeBtn = document.createElement('span');
            closeBtn.className = 'toast-close';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode === container) container.removeChild(toast);
                }, 300);
            };
            toast.appendChild(closeBtn);

            container.appendChild(toast);

            // Force reflow
            toast.offsetHeight;

            toast.classList.add('show');

            // Auto-hide only if NOT persistent
            if (!persistent) {
                setTimeout(() => {
                    if (toast.classList.contains('show')) {
                        toast.classList.remove('show');
                        setTimeout(() => {
                            if (toast.parentNode === container) container.removeChild(toast);
                        }, 300);
                    }
                }, 5000);
            }
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast("üìã Ï£ºÏÜåÍ∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.", "success");
            } catch (err) {
                showToast("Î≥µÏÇ¨ Ïã§Ìå®", "error");
            }
            document.body.removeChild(textarea);
        }

        function openDirections(lat, lng, name) {
            const url = `https://map.kakao.com/link/to/${encodeURIComponent(name)},${lat},${lng}`;
            window.open(url, '_blank');
        }

        function shareToKakao() {
            try {
                console.log('[Kakao Share] Function called');

                // Check if Kakao SDK is loaded
                if (typeof window.Kakao === 'undefined') {
                    console.error('[Kakao Share] Kakao SDK not loaded');
                    return;
                }

                console.log('[Kakao Share] Kakao SDK loaded successfully');

                // Initialize Kakao SDK if not already initialized
                if (!window.Kakao.isInitialized()) {
                    console.log('[Kakao Share] Initializing Kakao SDK...');
                    window.Kakao.init('a6b27b6dab16c7e3459bb9589bf1269d');
                    console.log('[Kakao Share] Kakao SDK initialized');
                } else {
                    console.log('[Kakao Share] Kakao SDK already initialized');
                }

                // Prepare share data - NO IMAGE to ensure k-inov.co.kr link works
                const shareData = {
                    objectType: 'feed',
                    content: {
                        title: 'üé∞ KINOV Î°úÎòê Î™ÖÎãπ ÏßÄÎèÑ',
                        description: 'Ïó≠ÎåÄ 1Îì± ÎãπÏ≤® ÌåêÎß§Ï†êÏùÑ ÌïúÎààÏóê! ÎãπÏã†Ïùò ÌñâÏö¥ÏùÑ Ï∞æÏïÑÎ≥¥ÏÑ∏Ïöî.\n\nÏßÄÍ∏à Î∞îÎ°ú KINOV MallÏùÑ Î∞©Î¨∏ÌïòÏÑ∏Ïöî!',
                        link: {
                            mobileWebUrl: 'https://www.k-inov.co.kr',
                            webUrl: 'https://www.k-inov.co.kr'
                        }
                    },
                    buttons: [
                        {
                            title: 'KINOV Mall Î∞©Î¨∏ÌïòÍ∏∞',
                            link: {
                                mobileWebUrl: 'https://www.k-inov.co.kr',
                                webUrl: 'https://www.k-inov.co.kr'
                            }
                        }
                    ]
                };

                console.log('[Kakao Share] Sending share data:', shareData);

                // Send KakaoTalk share message
                window.Kakao.Share.sendDefault(shareData);

                console.log('[Kakao Share] Share dialog opened successfully');

            } catch (error) {
                console.error('[Kakao Share] Error:', error);
            }
        }
    </script>
    <!-- OMR Modal (Re-inserted) -->
    <div id="omrModal" class="omr-modal-overlay" onclick="closeOMR()">
        <div class="omr-modal-content" onclick="event.stopPropagation()">
            <!-- Close X Button (Top Right) -->
            <span onclick="closeOMR()"
                style="position:absolute; top:10px; right:15px; font-size:28px; color:#999; cursor:pointer; line-height:1; transition: color 0.2s;"
                onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">&times;</span>

            <h3 style="margin:0; color:#333;">OMR ÎßàÌÇπ ÎèÑÏö∞ÎØ∏</h3>
            <p style="font-size:12px; color:#666; margin:5px 0;">ÌôîÎ©¥ÏùÑ Î≥¥Í≥† OMR Ïπ¥ÎìúÏóê ÏÉâÏπ†ÌïòÏÑ∏Ïöî.</p>
            <div id="omrGrid" class="omr-grid">
                <!-- 1-45 generated here -->
            </div>
            <button onclick="closeOMR()"
                style="width:100%; padding:10px; background:#333; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">Îã´Í∏∞</button>
        </div>
    </div>

    <script>
        function openOMR(numbers) {
            const grid = document.getElementById('omrGrid');
            grid.innerHTML = '';

            // Generate 1-45 grid
            for (let i = 1; i <= 45; i++) {
                const cell = document.createElement('div');
                cell.className = 'omr-number';
                cell.innerText = i;
                if (numbers.includes(i)) {
                    cell.className += ' marked';
                }
                grid.appendChild(cell);
            }

            const modal = document.getElementById('omrModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.className += ' show', 10);
        }

        function closeOMR() {
            const modal = document.getElementById('omrModal');
            modal.className = 'omr-modal-overlay';
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // Quick OMR View from Hamburger Menu
        function openLastOMR() {
            if (lastRecommendedNumbers && lastRecommendedNumbers.length === 6) {
                closeNav();
                openOMR(lastRecommendedNumbers);
            } else {
                // Show alert box in hamburger menu
                const alertBox = document.getElementById('omrAlertBox');
                alertBox.style.display = 'block';

                // Auto-hide after 4 seconds
                setTimeout(() => {
                    alertBox.style.display = 'none';
                }, 4000);
            }
        }

        // Updated Clipboard function (Global)
        // Note: Replaces/Overwrites the old one if names collide, or just exists as a better version
        window.copyToClipboard = function (numbers) {
            let text = "";
            if (Array.isArray(numbers)) {
                text = numbers.join(', ');
            } else {
                text = numbers;
            }

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast(`üìã Î≤àÌò∏Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§: ${text}`);
                }).catch(err => {
                    showToast('Î≥µÏÇ¨ Ïã§Ìå®: ' + err);
                });
            } else {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast("üìã Î≤àÌò∏Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§ (Íµ¨Ìòï Î∏åÎùºÏö∞Ï†Ä)", "success");
                } catch (err) {
                    showToast("Î≥µÏÇ¨ Ïã§Ìå®", "error");
                }
                document.body.removeChild(textarea);
            }
        };
    </script>
</body>

</html>