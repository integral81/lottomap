<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>KINOV Lotto Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        // SDK Error Handler (Defined first)
        function handleScriptError() {
            const mapDiv = document.getElementById('map');
            const usedKey = 'a6b27b6dab16c7e3459bb9589bf1269d';
            if (mapDiv) {
                mapDiv.innerHTML = `
                    <div style="padding:40px; text-align:center; color:#d32f2f;">
                        <h2 style="margin-bottom:10px;">ğŸ”‘ ì¹´ì¹´ì˜¤ ì§€ë„ ì¸ì¦ ì‹¤íŒ¨ (Domain Mismatch)</h2>
                        <p style="color:#333; font-size:16px;">ì¸í„°ë„· ì—°ê²°ì€ í™•ì¸ë˜ì—ˆìœ¼ë‚˜, ì¹´ì¹´ì˜¤ ì„œë²„ì—ì„œ <strong>ë„ë©”ì¸ ê±°ë¶€</strong>ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        
                        <div style="background:#fff; border:1px solid #d32f2f; padding:20px; border-radius:10px; text-align:left; margin: 20px auto; color:#333; max-width:600px; font-size:14px; line-height:1.6;">
                            <strong>âœ… ì´ ìˆœì„œëŒ€ë¡œ í•´ê²°í•´ ë³´ì„¸ìš”:</strong><br><br>
                            1. <strong>ë„ë©”ì¸ ì¶”ê°€ ë“±ë¡</strong>: ì¹´ì¹´ì˜¤ ì½˜ì†” [í”Œë«í¼ > Web] ì‚¬ì´íŠ¸ ë„ë©”ì¸ì— ì•„ë˜ ì£¼ì†Œë“¤ì´ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”:
                               <ul style="margin:5px 0 15px 20px;">
                                 <li><code>http://localhost:8000</code></li>
                                 <li><code>http://127.0.0.1:8000</code></li>
                               </ul>
                            2. <strong>ì˜¬ë°”ë¥¸ í‚¤ ì‚¬ìš© í™•ì¸</strong>: ì¹´ì¹´ì˜¤ ì½˜ì†” [ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ > ìš”ì•½ ì •ë³´]ì—ì„œ ë°˜ë“œì‹œ <strong>'JavaScript í‚¤'</strong>ë¥¼ ë³µì‚¬í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.<br><br>
                            <div style="background:#eee; padding:10px; border-radius:5px; border:1px dashed #999;">
                                <strong>í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ í‚¤:</strong> <code>${usedKey}</code>
                            </div>
                        </div>
                        <p style="color:#666;">ì„¤ì •ì„ ë³€ê²½í•œ í›„ ë¸Œë¼ìš°ì €ë¥¼ <strong>ìƒˆë¡œê³ ì¹¨(F5)</strong> í•´ì£¼ì„¸ìš”.</p>
                    </div>`;
            }
        }
    </script>
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a6b27b6dab16c7e3459bb9589bf1269d&libraries=clusterer"
        onerror="handleScriptError()"></script>
    <style>
        :root {
            --primary: #d32f2f;
            --secondary: #1976d2;
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #333333;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Pretendard', system-ui, sans-serif;
            background-color: var(--bg);
            overflow: hidden;
        }

        #app {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #map {
            flex: 1;
            height: 100%;
            background: #eee;
        }

        #sidebar {
            width: 320px;
            background: var(--card);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        h1 {
            font-size: 20px;
            color: var(--primary);
            margin: 0 0 20px 0;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .section-title {
            font-weight: 700;
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            display: block;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="number"] {
            width: 70px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-apply {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }

        .btn-apply:hover {
            background-color: #b71c1c;
        }

        .stats-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: auto;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .stat-value {
            color: var(--primary);
            font-weight: 700;
        }

        .infowindow {
            padding: 10px;
            min-width: 180px;
        }

        .iw-title {
            font-weight: 700;
            font-size: 15px;
            color: var(--primary);
            margin-bottom: 3px;
        }

        .iw-addr {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }

        .iw-tag {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            background: #eee;
            font-size: 10px;
            margin: 0 2px 2px 0;
        }

        /* Responsive Design for Mobile */
        @media (max-width: 768px) {

            body,
            html {
                overflow: auto;
                height: auto;
            }

            #app {
                display: flex;
                flex-direction: column-reverse;
                height: auto;
            }

            #sidebar {
                width: 100%;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }

            #map {
                width: 100%;
                height: 450px;
                flex: none;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="sidebar">
            <h1>ğŸ° KINOV Lotto Map</h1>
            <div class="section">
                <span class="section-title">ğŸ“… íšŒì°¨ í•„í„° (Round)</span>
                <div class="input-row">
                    <input type="number" id="minRound" value="262">
                    <span>~</span>
                    <input type="number" id="maxRound" value="1209">
                </div>
            </div>
            <div class="section">
                <span class="section-title">ğŸ† ë‹¹ì²¨ íšŸìˆ˜ í•„í„° (Frequency)</span>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="freq5" checked> ğŸŒŸ 5íšŒ ì´ìƒ</label>
                    <label class="checkbox-item"><input type="checkbox" id="freq3" checked> ğŸ”´ 3~4íšŒ</label>
                    <label class="checkbox-item"><input type="checkbox" id="freq1" checked> ğŸ”µ 2íšŒ ì´í•˜</label>
                </div>
            </div>
            <div class="section">
                <span class="section-title">ğŸ² ë‹¹ì²¨ ë°©ì‹ (Method)</span>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="methodAuto" checked> ìë™</label>
                    <label class="checkbox-item"><input type="checkbox" id="methodManual" checked> ìˆ˜ë™</label>
                    <label class="checkbox-item"><input type="checkbox" id="methodSemi" checked> ë°˜ìë™</label>
                </div>
            </div>
            <button class="btn-apply" onclick="applyFilters()">ì ìš©í•˜ê¸°</button>
            <div class="stats-card">
                <div class="stat-item"><span>ì „ì²´ ë°ì´í„°</span> <span id="totalDataCount">0</span></div>
                <div class="stat-item"><span>í•„í„°ë§ ê²°ê³¼</span> <span id="filteredCount" class="stat-value">0</span></div>

                <!-- Fallback file loader -->
                <div id="manualLoader"
                    style="display:none; margin-top:10px; padding-top:10px; border-top:1px dashed #ccc;">
                    <p style="font-size:11px; color:#666; margin-bottom:5px;">âš ï¸ ìë™ ë¡œë“œ ì‹¤íŒ¨ ì‹œ íŒŒì¼ì„ ì§ì ‘ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
                    <input type="file" id="fileInput" accept=".json" style="display:none;"
                        onchange="handleFileSelect(event)">
                    <button class="btn-apply" style="background:#333; font-size:12px; padding:8px;"
                        onclick="document.getElementById('fileInput').click()">íŒŒì¼ ì§ì ‘ ì„ íƒí•˜ê¸° (lotto_data.json)</button>
                </div>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <script>
        let map, clusterer, allData = [], markers = [];

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    processLoadedData(data);
                    document.getElementById('manualLoader').style.display = 'none';
                    alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! (' + data.length + 'ê±´)');
                } catch (err) {
                    alert('íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function processLoadedData(data) {
            allData = data;
            document.getElementById('totalDataCount').innerText = data.length.toLocaleString();
            if (data.length > 0) {
                const maxR = Math.max(...data.map(d => d.r));
                document.getElementById('maxRound').value = maxR;
            }
            applyFilters();
        }

        window.onload = function () {
            if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
                handleScriptError();
                return;
            }

            const mapContainer = document.getElementById('map');
            const mapOption = { center: new kakao.maps.LatLng(36.2683, 127.6358), level: 12 };
            map = new kakao.maps.Map(mapContainer, mapOption);

            clusterer = new kakao.maps.MarkerClusterer({
                map: map, averageCenter: true, minLevel: 10,
                styles: [{
                    width: '40px', height: '40px', background: 'rgba(211, 47, 47, 0.8)',
                    color: '#fff', textAlign: 'center', lineHeight: '40px',
                    borderRadius: '20px', fontWeight: 'bold'
                }]
            });

            loadData();
        };

        function loadData() {
            const countEl = document.getElementById('totalDataCount');
            console.log('Loading lotto_data.json...');
            fetch('lotto_data.json?v=' + Date.now())
                .then(res => {
                    if (!res.ok) throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (Status: ' + res.status + ')');
                    return res.json();
                })
                .then(data => {
                    processLoadedData(data); // Call the updated processLoadedData
                })
                .catch(err => {
                    console.error('Data load failed:', err);
                    countEl.innerHTML = `<span style="color:red; font-size:11px; cursor:help;" title="${err.message}">ë¡œë“œ ì‹¤íŒ¨ (${err.name})</span>`;
                    document.getElementById('manualLoader').style.display = 'block';
                    alert('ë°ì´í„° íŒŒì¼(lotto_data.json) ë¡œë“œ ì¤‘ì— ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nì—ëŸ¬ ë‚´ìš©: ' + err.message + '\n\ní•˜ë‹¨ì˜ [íŒŒì¼ ì§ì ‘ ì„ íƒí•˜ê¸°] ë²„íŠ¼ì„ í†µí•´ íŒŒì¼ì„ ì§ì ‘ ë¶ˆëŸ¬ì™€ ì£¼ì„¸ìš”.');
                });
        }

        function applyFilters() {
            const minR = parseInt(document.getElementById('minRound').value) || 0;
            const maxR = parseInt(document.getElementById('maxRound').value) || 9999;
            const auto = document.getElementById('methodAuto').checked;
            const manual = document.getElementById('methodManual').checked;
            const semi = document.getElementById('methodSemi').checked;

            // Frequency Filters
            const f5 = document.getElementById('freq5').checked;
            const f3 = document.getElementById('freq3').checked;
            const f1 = document.getElementById('freq1').checked;

            const filtered = allData.filter(d => {
                const rMatch = d.r >= minR && d.r <= maxR;
                let mMatch = false;
                if (auto && d.m.includes('ìë™')) mMatch = true;
                if (manual && d.m.includes('ìˆ˜ë™')) mMatch = true;
                if (semi && d.m.includes('ë°˜ìë™')) mMatch = true;

                let fMatch = false;
                if (f5 && d.totalWins >= 5) fMatch = true;
                if (f3 && d.totalWins >= 3 && d.totalWins <= 4) fMatch = true;
                if (f1 && d.totalWins <= 2) fMatch = true;

                return rMatch && mMatch && fMatch;
            });

            document.getElementById('filteredCount').innerText = filtered.length.toLocaleString();
            updateMarkers(filtered);
        }

        function updateMarkers(data) {
            clusterer.clear();
            markers.forEach(m => m.setMap(null));
            markers = [];

            // To avoid duplicate markers for the same shop at the same location,
            // we need to group the filtered data by shop (lat, lng, name, address)
            // and then create a single marker for each unique shop.
            const uniqueShops = {};
            data.forEach(d => {
                const key = `${d.lat}_${d.lng}_${d.n}_${d.a}`;
                if (!uniqueShops[key]) {
                    uniqueShops[key] = {
                        n: d.n,
                        a: d.a,
                        lat: d.lat,
                        lng: d.lng,
                        totalWins: d.totalWins, // This is the total wins for the shop
                        rounds: [] // To store individual round details for infowindow
                    };
                }
                uniqueShops[key].rounds.push({ r: d.r, m: d.m });
            });

            Object.values(uniqueShops).forEach(shop => {
                let markerImg = null;
                // Tiered Styles
                if (shop.totalWins >= 5) {
                    // Legendary Gold Star
                    markerImg = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
                        new kakao.maps.Size(24, 35)
                    );
                } else if (shop.totalWins >= 3) {
                    // Professional Red
                    markerImg = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/2018/pc/img/marker_spot.png',
                        new kakao.maps.Size(24, 35),
                        { offset: new kakao.maps.Point(12, 35) }
                    );
                }

                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(shop.lat, shop.lng),
                    image: markerImg
                });

                const sortedRounds = shop.rounds.sort((a, b) => b.r - a.r);
                const roundTagsHtml = sortedRounds.map(r => `<span class="iw-tag">${r.r}íšŒ(${r.m})</span>`).join('');

                const content = `
                    <div class="infowindow">
                        <div class="iw-title">${shop.n} ${shop.totalWins >= 5 ? 'ğŸŒŸ' : ''}</div>
                        <div class="iw-addr">${shop.a}</div>
                        <div style="font-weight:bold; color:red; margin-bottom:5px;">ì´ ${shop.totalWins}íšŒ ë‹¹ì²¨</div>
                        <div class="iw-details">${roundTagsHtml}</div>
                    </div>
                `;

                const infowindow = new kakao.maps.InfoWindow({
                    content: content,
                    removable: true
                });

                kakao.maps.event.addListener(marker, 'click', () => {
                    infowindow.open(map, marker);
                });

                markers.push(marker);
            });
            clusterer.addMarkers(markers);
        }
    </script>
</body>

</html>