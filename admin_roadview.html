<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINOV ì‹ ê·œ 5íšŒ ë‹¹ì²¨ì§€ POV ìˆ˜ì§‘ (9ê°œì†Œ)</title>
    <script
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a6b27b6dab16c7e3459bb9589bf1269d&libraries=services"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background: #f0f2f5;
        }

        #sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        #sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #2c3e50;
            color: white;
        }

        #search-box {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        #search-input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #shop-list {
            flex: 1;
            overflow-y: auto;
        }

        .shop-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .shop-item:hover {
            background: #f8f9fa;
        }

        .shop-item.active {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .shop-name {
            font-weight: bold;
            font-size: 15px;
            display: block;
            margin-bottom: 4px;
        }

        .shop-addr {
            font-size: 12px;
            color: #666;
            display: block;
            line-height: 1.4;
        }

        .shop-wins {
            display: inline-block;
            background: #ff9800;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 5px;
        }

        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #rv-container {
            flex: 1;
            position: relative;
        }

        #roadview {
            width: 100%;
            height: 100%;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 10px;
            border: 1px solid #ddd;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-move {
            background: #2196f3;
            color: white;
        }

        .btn-capture {
            background: #4caf50;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        #output-area {
            height: 250px;
            background: #2d3436;
            color: #dfe6e9;
            padding: 15px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            overflow-y: auto;
            border-top: 2px solid #636e72;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #636e72;
            padding-bottom: 5px;
        }

        .header-btns {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .btn-copy {
            background: #00b894;
            color: white;
        }

        .btn-paste {
            background: #0984e3;
            color: white;
        }

        /* Modal Style */
        #paste-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 600px;
        }

        #paste-area {
            width: 100%;
            height: 300px;
            margin: 10px 0;
            font-family: monospace;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
        }
    </style>
</head>

<body>
    <div id="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>

    <!-- Paste Modal -->
    <div id="paste-modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">ğŸ“‹ í”„ë¦¬ì…‹ ë°ì´í„° ì¼ê´„ ë¶™ì—¬ë„£ê¸°</h3>
            <p style="font-size:12px; color:#666;">ìº¡ì²˜ëœ ë¡œê·¸ í˜•ì‹({ name: "..." })ì„ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
            <textarea id="paste-area"
                placeholder='{ name: "ë¶€ì¼ì¹´ì„œë¹„ìŠ¤", addr: "...", panoId: ..., pov: { ... } },'></textarea>
            <div style="display:flex; justify-content: flex-end; gap:10px;">
                <button class="btn" style="background:#eee;" onclick="closePasteModal()">ì·¨ì†Œ</button>
                <button class="btn" style="background:#0984e3; color:white;" onclick="importData()">ê°€ì ¸ì˜¤ê¸°</button>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <div id="sidebar-header">
            <h2 style="margin:0; font-size: 18px;">ğŸ… ëª…ë‹¹ ë¡œë“œë·° ê´€ë¦¬ (4íšŒ)</h2>
            <p style="margin:5px 0 0 0; font-size: 12px; opacity: 0.8;">ì´ 115ê°œì†Œ (10ê°œì”© ì‘ì—…)</p>
        </div>
        <div id="batch-control"
            style="padding: 10px; display: flex; justify-content: space-between; align-items: center; background: #f0f0f0; border-bottom: 1px solid #ddd;">
            <button onclick="changeBatch(-1)" style="padding: 5px 10px; cursor: pointer;">â—€ ì´ì „</button>
            <span id="batch-info" style="font-size: 13px; font-weight: bold;">1 - 10</span>
            <button onclick="changeBatch(1)" style="padding: 5px 10px; cursor: pointer;">ë‹¤ìŒ â–¶</button>
        </div>
        <div id="search-box">
            <input type="text" id="search-input" placeholder="ì í¬ëª… ë˜ëŠ” ì£¼ì†Œ ê²€ìƒ‰...">
        </div>
        <div id="shop-list"></div>
    </div>

    <div id="main-content">
        <div id="rv-container">
            <div id="roadview"></div>
            <div id="controls">
                <button class="btn btn-move" onclick="shiftRV(360)">â¬†ï¸ ë¶</button>
                <button class="btn btn-move" onclick="shiftRV(180)">â¬‡ï¸ ë‚¨</button>
                <button class="btn btn-move" onclick="shiftRV(270)">â¬…ï¸ ì„œ</button>
                <button class="btn btn-move" onclick="shiftRV(90)">â¡ï¸ ë™</button>
                <div style="width: 2px; background: #eee; margin: 0 10px;"></div>
                <button class="btn btn-capture" onclick="capturePOV()">ğŸ“¸ í˜„ì¬ POV ìº¡ì²˜</button>
            </div>
        </div>
        <div id="output-area">
            <div class="output-header">
                <span>ğŸ“‹ ìˆ˜ì§‘ëœ í”„ë¦¬ì…‹ (JSON)</span>
                <div class="header-btns">
                    <button class="btn-small btn-paste" onclick="openPasteModal()">ğŸ“¥ ì¼ê´„ ë¶™ì—¬ë„£ê¸°</button>
                    <button class="btn-small btn-copy" onclick="copyAllOutput()">ë¡œê·¸ ì „ì²´ ë³µì‚¬</button>
                </div>
            </div>
            <div id="output-content"></div>
        </div>
    </div>

    <script>


        let roadview, rvClient;
        let shops = [{"n": "25ì‹œìŠˆí¼", "a": "ê²½ë‚¨ ì°½ì›ì‹œ ë§ˆì‚°íšŒì›êµ¬ ë´‰ì•”ë™ 462-30", "w": 4, "lat": 35.221142783256575, "lng": 128.59536744057274}, {"n": "25ì‹œìŠˆí¼", "a": "ê²½ê¸° ì‹œí¥ì‹œ ì •ì™•ë™ 1882-11í™ìµí”„ë¼ì1ì¸µ107í˜¸", "w": 4, "lat": 37.3624825577737, "lng": 126.72995551003}, {"n": "CU(ëŒ€ë¦¼ì¤‘ì•™ì )", "a": "ì„œìš¸ ì˜ë“±í¬êµ¬ ëŒ€ë¦¼3ë™ 775-7 ì„œì´ˆí•œê°•ì•„íŒŒíŠ¸", "w": 4, "lat": 37.4992842484815, "lng": 126.897704642697}, {"n": "GS25(ë‘ì •ë©”íŠ¸ë¡œì )", "a": "ì¶©ë‚¨ ì²œì•ˆì‹œ ì„œë¶êµ¬ ì„±ì •ë™ 1451", "w": 4, "lat": 36.8265041259081, "lng": 127.141364212763}, {"n": "GS25(ì–‘ì‚°í˜œì¸ì )", "a": "ê²½ë‚¨ ì–‘ì‚°ì‹œ í‰ì‚°ë™ 31-5", "w": 4, "lat": 35.384586102557215, "lng": 129.15503345857658}, {"n": "GS25(ì¢…ë¡œë‚™ì›)", "a": "ì„œìš¸ ì¢…ë¡œêµ¬ ë‚™ì›ë™ 230", "w": 4, "lat": 37.5722657951174, "lng": 126.988621256241}, {"n": "GS25(ì¤‘ì´Œí˜„ëŒ€)", "a": "ëŒ€ì „ ì¤‘êµ¬ ì¤‘ì´Œë™ 17-2", "w": 4, "lat": 36.3374236359498, "lng": 127.412499285155}, {"n": "Gë§ˆíŠ¸", "a": "ì„œìš¸ ì˜ë“±í¬êµ¬ ë””ì§€í„¸ë¡œ 387", "w": 4, "lat": 37.49168720963678, "lng": 126.90225391677112}, {"n": "HXë³µê¶Œë°©", "a": "ê²½ê¸° ì´ì²œì‹œ ë¶€ë°œì ì•„ë¯¸ë¦¬ 726-9 í˜„ëŒ€ì‹œí‹°í”Œë¼ì106í˜¸", "w": 4, "lat": 37.2527985722684, "lng": 127.489415629017}, {"n": "NBA(ì—”ë¹„ì—ì´)", "a": "ì¸ì²œ ì¤‘êµ¬ ì‹ ë„ì‹œë‚¨ë¡œ142ë²ˆê¸¸ 6 1ë™ 1ì¸µ 128í˜¸", "w": 4, "lat": 37.49368828753151, "lng": 126.49163883026826}, {"n": "êµí†µì¹´ë“œíŒë§¤ëŒ€", "a": "ì„œìš¸ ê°•ë™êµ¬ ê³ ë•ë™ 210-1 êµ¬ì„œìš¸ìŠ¹í•©ì¢…ì ì•", "w": 4, "lat": 37.5576094801473, "lng": 127.170103050262}, {"n": "ëŸ­í‚¤ìŠˆí¼", "a": "ì„œìš¸ ìš©ì‚°êµ¬ í›„ì•”ë™ 446", "w": 4, "lat": 37.5543759425223, "lng": 126.976755883096}, {"n": "ë©”íŠ¸ë¡œì„¼í„°ì ", "a": "ëŒ€êµ¬ ì¤‘êµ¬ ë•ì‚°ë™ 88 ë©”íŠ¸ë¡œì„¼í„°C412í˜¸", "w": 4, "lat": 35.8644215787926, "lng": 128.593341393289}, {"n": "ì™•ëŒ€ë°•ë³µê¶Œ", "a": "ì¸ì²œ ë¶€í‰êµ¬ ì‹­ì •ë™ 577-6", "w": 4, "lat": 37.4773513046613, "lng": 126.709834722586}];
        let currentShop = null;
        let currentBatch = 0;
        const BATCH_SIZE = 10;
        let capturedShops = new Set(JSON.parse(localStorage.getItem('captured_shops') || '[]'));

        window.onload = async () => {
            const rvContainer = document.getElementById('roadview');
            roadview = new kakao.maps.Roadview(rvContainer);
            rvClient = new kakao.maps.RoadviewClient();
            renderBatch();
            document.getElementById('loading').style.display = 'none';
        };

        function saveProgress() {
            localStorage.setItem('captured_shops', JSON.stringify(Array.from(capturedShops)));
        }

        function resetProgress() {
            if (confirm('ëª¨ë“  ì‘ì—… ë‚´ì—­ì„ ì´ˆê¸°í™”í•˜ê³  ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í• ê¹Œìš”?')) {
                localStorage.removeItem('captured_shops');
                capturedShops = new Set();
                renderBatch();
            }
        }

        function changeBatch(delta) {
            // í˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ” ì í¬ë“¤ì„ ì™„ë£Œ ì²˜ë¦¬í•¨
            const remainingShops = shops.filter(s => !capturedShops.has(s.n + '|' + s.a));
            const end = Math.min(BATCH_SIZE, remainingShops.length);

            for (let i = 0; i < end; i++) {
                const shop = remainingShops[i];
                capturedShops.add(shop.n + '|' + shop.a);
            }

            saveProgress();

            const nextRemaining = shops.filter(s => !capturedShops.has(s.n + '|' + s.a));
            if (nextRemaining.length === 0) {
                alert('ëª¨ë“  ì‘ì—…ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!');
            }

            renderBatch();
        }

        function renderBatch() {
            const remainingShops = shops.filter(s => !capturedShops.has(s.n + '|' + s.a));
            const end = Math.min(BATCH_SIZE, remainingShops.length);
            const batchShops = remainingShops.slice(0, end);

            document.getElementById('batch-info').innerHTML = `
                ë‚¨ì€ ì‘ì—…: ${remainingShops.length}ê°œì†Œ 
                <button onclick="resetProgress()" style="margin-left:10px; font-size:10px; padding:2px 5px;">ì§„í–‰ ë¦¬ì…‹</button>
            `;
            renderList(batchShops);
        }


        function renderList(list) {
            const container = document.getElementById('shop-list');
            container.innerHTML = '';
            list.forEach(shop => {
                const item = document.createElement('div');
                item.className = 'shop-item';
                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <span class="shop-name">${shop.n}</span>
                            <span class="shop-addr">${shop.a}</span>
                            <span class="shop-wins">${shop.w}íšŒ ë‹¹ì²¨</span>
                        </div>
                        <button class="btn-small" style="background:#e0e0e0; font-size:10px; padding:4px 8px; margin-left:5px;" 
                                onclick="event.stopPropagation(); copyAddress('${shop.a}')">ì£¼ì†Œ ë³µì‚¬</button>
                    </div>
                `;
                item.onclick = () => selectShop(shop, item);
                container.appendChild(item);
            });
        }

        // Search Filter
        document.getElementById('search-input').oninput = (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = shops.filter(s =>
                s.n.toLowerCase().includes(query) || s.a.toLowerCase().includes(query)
            );
            renderList(filtered);
        };

        function selectShop(shop, element) {
            // UI Toggle
            document.querySelectorAll('.shop-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            currentShop = shop;

            console.log(`Loading Shop: ${shop.n} at (${shop.lat}, ${shop.lng})`);

            // 1. If special startPano is defined in JSON, use it first (For Jamsil Maejeom)
            if (shop.startPano) {
                roadview.setPanoId(shop.startPano, new kakao.maps.LatLng(shop.lat, shop.lng));
                // Set initial viewpoint to look at the shop direction (Approximately North for Jamsil)
                roadview.setViewpoint({ pan: 350, tilt: 3, zoom: 0 });
                return;
            }

            // 2. Otherwise use direct coordinates
            if (shop.lat && shop.lng) {
                const targetPos = new kakao.maps.LatLng(shop.lat, shop.lng);
                loadRV(targetPos);
            } else {
                // Fallback: Search by clean address if lat/lng is missing
                const cleanAddr = shop.a.split(' ').filter(part =>
                    !part.includes('ì¶œêµ¬') && !part.includes('ê°€íŒ') && !part.includes('ì§€í•˜')
                ).join(' ');

                const ps = new kakao.maps.services.Places();
                ps.keywordSearch(`${cleanAddr} ${shop.n}`, (data, status) => {
                    if (status === kakao.maps.services.Status.OK) {
                        const first = data.find(p => p.category_name.includes('ë³µê¶Œ')) || data[0];
                        loadRV(new kakao.maps.LatLng(first.y, first.x));
                    } else {
                        alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                });
            }
        }

        function loadRV(pos) {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').innerText = 'ë¡œë“œë·° íƒìƒ‰ ì¤‘...';

            // Increased radius and added manual input fallback
            rvClient.getNearestPanoId(pos, 150, (panoId) => {
                document.getElementById('loading').style.display = 'none';
                if (panoId) {
                    roadview.setPanoId(panoId, pos);
                } else {
                    const manualPano = prompt('ì£¼ë³€ 150m ì´ë‚´ì— ë¡œë“œë·° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.\nì¹´ì¹´ì˜¤ë§µ ê³µìœ  ë§í¬ ë“±ì—ì„œ í™•ì¸í•œ Pano IDê°€ ìˆë‹¤ë©´ ì…ë ¥í•´ ë³´ì„¸ìš”.\n(ë¹„ì›Œë‘ë©´ gray í™”ë©´ ìœ ì§€)');
                    if (manualPano) {
                        roadview.setPanoId(Number(manualPano), pos);
                    }
                }
            });
        }

        // Move Roadview Position (North/South/East/West)
        function shiftRV(angle) {
            const currentPos = roadview.getPosition();
            const step = 0.00008; // ì•½ 10m
            const r = angle * (Math.PI / 180);
            const lat = currentPos.getLat() + (step * Math.cos(r));
            const lng = currentPos.getLng() + (step * Math.sin(r));
            const nextPos = new kakao.maps.LatLng(lat, lng);

            rvClient.getNearestPanoId(nextPos, 50, (panoId) => {
                if (panoId) {
                    roadview.setPanoId(panoId, nextPos);
                }
            });
        }

        function capturePOV() {
            if (!currentShop || !roadview) return;
            const vp = roadview.getViewpoint();
            const panoId = roadview.getPanoId();

            // Clean up address (use shortest identifiable part)
            const miniAddr = currentShop.a.split(' ').slice(0, 3).join(' '); // "ì„œìš¸ ë…¸ì›êµ¬ ìƒê³„ë™" ë“±

            const entry = `{ name: "${currentShop.n}", addr: "${miniAddr}", panoId: ${panoId}, pov: { pan: ${vp.pan.toFixed(2)}, tilt: ${vp.tilt.toFixed(2)}, zoom: ${vp.zoom} } },`;

            const logItem = document.createElement('div');
            logItem.style.marginBottom = '5px';
            logItem.style.color = '#55efc4';
            logItem.innerText = entry;
            document.getElementById('output-content').appendChild(logItem);

            // Scroll to bottom
            const area = document.getElementById('output-area');
            area.scrollTop = area.scrollHeight;
        }

        function copyAllOutput() {
            const content = document.getElementById('output-content').innerText;
            if (!content.trim()) { alert('ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            navigator.clipboard.writeText(content).then(() => {
                alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. index.htmlì˜ ROADVIEW_PRESETSì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
            });
        }

        // Paste Modal Functions
        function openPasteModal() {
            document.getElementById('paste-modal').style.display = 'flex';
            document.getElementById('paste-area').focus();
        }

        function closePasteModal() {
            document.getElementById('paste-modal').style.display = 'none';
            document.getElementById('paste-area').value = '';
        }

        function importData() {
            const rawText = document.getElementById('paste-area').value;
            if (!rawText.trim()) return;

            const lines = rawText.split('\n');
            let count = 0;
            const container = document.getElementById('output-content');

            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed.startsWith('{') && trimmed.endsWith('},')) {
                    const logItem = document.createElement('div');
                    logItem.style.marginBottom = '5px';
                    logItem.style.color = '#55efc4';
                    logItem.innerText = trimmed;
                    container.appendChild(logItem);
                    count++;
                }
            });

            if (count > 0) {
                alert(`${count}ê°œì˜ í•­ëª©ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`);
                const area = document.getElementById('output-area');
                area.scrollTop = area.scrollHeight;
                closePasteModal();
            } else {
                alert('ìœ íš¨í•œ ë°ì´í„° í˜•ì‹ì´ ì—†ìŠµë‹ˆë‹¤. { name: "...", ... }, í˜•ì‹ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
            }
        }

        // Copy Address Function
        function copyAddress(addr) {
            navigator.clipboard.writeText(addr).then(() => {
                // Show temporary toast or alert
                const toast = document.createElement('div');
                toast.innerText = 'ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ' + addr;
                Object.assign(toast.style, {
                    position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)',
                    background: 'rgba(0,0,0,0.8)', color: 'white', padding: '10px 20px', borderRadius: '20px',
                    zIndex: 3000, fontSize: '13px'
                });
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            });
        }
    </script>
</body>

</html>